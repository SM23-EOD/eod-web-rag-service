<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRAGA â€” Plataforma (Nivel 1)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M8 68 Q8 60 18 56 H74 Q84 56 86 68 Z' fill='%237c3aed'/><rect x='20' y='42' width='24' height='14' rx='4' fill='%23a78bfa'/><rect x='24' y='46' width='7' height='7' rx='2' fill='%23312e81'/><rect x='33' y='46' width='7' height='7' rx='2' fill='%23312e81'/><path d='M54 54 L54 26 L80 48' stroke='%23c4b5fd' stroke-width='5' stroke-linecap='round' stroke-linejoin='round' fill='none'/><path d='M76 44 L86 44 L84 54 L78 54 Z' fill='%23fbbf24'/><rect x='28' y='32' width='8' height='10' rx='2' fill='%236d28d9'/><circle cx='32' cy='28' r='4' fill='%23c4b5fd' opacity='.5'/><circle cx='37' cy='23' r='3' fill='%23c4b5fd' opacity='.3'/><path d='M2 78 Q14 72 26 78 Q38 84 50 78 Q62 72 74 78 Q86 84 98 78' fill='none' stroke='%23818cf8' stroke-width='3' stroke-linecap='round'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="src/auth.js"></script>
    <script src="src/api-client.js"></script>
    <style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAGA PLATFORM ADMIN â€” DESIGN TOKENS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
    --draga-accent:#7c3aed;--draga-accent-light:#a78bfa;--draga-accent-alpha:rgba(124,58,237,0.15);
    --draga-gradient:linear-gradient(135deg,#7c3aed 0%,#4f46e5 50%,#2563eb 100%);
    --draga-glow:0 0 40px rgba(124,58,237,0.25);
    --success:#22c55e;--danger:#ef4444;--warning:#f59e0b;--info:#3b82f6;
    --bg-dark:#0c0f1a;--bg-main:#131a2b;--bg-card:#1a2236;--bg-card-hover:#212b42;--bg-input:#242e44;
    --text-primary:#f0f2f5;--text-secondary:#94a3b8;--text-muted:#64748b;
    --border:#243049;--border-light:#334155;
    --shadow:0 4px 24px rgba(0,0,0,0.35);
    --radius:12px;--radius-sm:8px;--radius-lg:16px;--transition:0.25s ease;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Lato',-apple-system,sans-serif;background:var(--bg-dark);color:var(--text-primary);min-height:100vh;overflow-x:hidden;}

/* â•â•â• LAYOUT â•â•â• */
.app{display:grid;grid-template-columns:220px 1fr;grid-template-rows:56px 1fr;height:100vh;}

/* â•â•â• HEADER â•â•â• */
.header{grid-column:1/-1;background:var(--bg-main);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;z-index:100;}
.header-brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit;}
.header-brand .logo{width:32px;height:32px;background:var(--draga-gradient);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:var(--draga-glow);}
.header-brand .name{font-size:18px;font-weight:900;background:var(--draga-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px;}
.header-brand .subtitle{font-size:10px;color:var(--text-muted);margin-top:-2px;}
.header-right{display:flex;align-items:center;gap:14px;}
.health-pill{display:flex;align-items:center;gap:6px;padding:5px 14px;border-radius:20px;font-size:11px;font-weight:700;}
.health-pill.online{background:rgba(34,197,94,0.1);color:var(--success);}
.health-pill.offline{background:rgba(239,68,68,0.1);color:var(--danger);}
.di{display:inline-block;width:1em;height:1em;vertical-align:-0.15em;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M8 68 Q8 60 18 56 H74 Q84 56 86 68 Z' fill='%237c3aed'/%3E%3Crect x='20' y='42' width='24' height='14' rx='4' fill='%23a78bfa'/%3E%3Crect x='24' y='46' width='7' height='7' rx='2' fill='%23312e81'/%3E%3Crect x='33' y='46' width='7' height='7' rx='2' fill='%23312e81'/%3E%3Cpath d='M54 54 L54 26 L80 48' stroke='%23c4b5fd' stroke-width='5' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M76 44 L86 44 L84 54 L78 54 Z' fill='%23fbbf24'/%3E%3Crect x='28' y='32' width='8' height='10' rx='2' fill='%236d28d9'/%3E%3Ccircle cx='32' cy='28' r='4' fill='%23c4b5fd' opacity='.5'/%3E%3Ccircle cx='37' cy='23' r='3' fill='%23c4b5fd' opacity='.3'/%3E%3Cpath d='M2 78 Q14 72 26 78 Q38 84 50 78 Q62 72 74 78 Q86 84 98 78' fill='none' stroke='%23818cf8' stroke-width='3' stroke-linecap='round'/%3E%3C/svg%3E") center/contain no-repeat;font-style:normal;}
.health-pill.degraded{background:rgba(245,158,11,0.1);color:var(--warning);}
.health-dot{width:7px;height:7px;border-radius:50%;background:currentColor;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

/* â•â•â• SIDEBAR â•â•â• */
.sidebar{background:var(--bg-main);border-right:1px solid var(--border);padding:16px 0;overflow-y:auto;}
.sidebar-section{padding:0 16px;margin-bottom:20px;}
.sidebar-label{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);font-weight:700;margin-bottom:8px;padding:0 8px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 16px;border-radius:var(--radius-sm);cursor:pointer;font-size:13px;font-weight:600;color:var(--text-secondary);transition:var(--transition);text-decoration:none;margin-bottom:2px;}
.nav-item:hover{background:var(--bg-card-hover);color:var(--text-primary);}
.nav-item.active{background:var(--draga-accent-alpha);color:var(--draga-accent-light);}
.nav-item .icon{font-size:18px;width:24px;text-align:center;}
.nav-item .badge{margin-left:auto;background:var(--draga-accent-alpha);color:var(--draga-accent-light);padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;}

/* â•â•â• MAIN CONTENT â•â•â• */
.main{overflow-y:auto;padding:24px 32px;background:var(--bg-dark);}
.module{display:none;}
.module.active{display:block;}
.page-title{font-size:24px;font-weight:900;margin-bottom:6px;}
.page-desc{font-size:13px;color:var(--text-muted);margin-bottom:24px;}

/* â•â•â• CARDS & GRIDS â•â•â• */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;margin-bottom:24px;}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:var(--transition);}
.stat-card:hover{border-color:var(--draga-accent);box-shadow:var(--draga-glow);}
.stat-card .label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:6px;}
.stat-card .value{font-size:28px;font-weight:900;}

.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-bottom:24px;}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:var(--transition);}
.card:hover{border-color:var(--border-light);}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.card-title{font-weight:700;font-size:15px;}
.card-meta{font-size:12px;color:var(--text-muted);margin-bottom:12px;}
.card-actions{display:flex;gap:8px;flex-wrap:wrap;}

/* â•â•â• BUTTONS â•â•â• */
.btn{padding:8px 16px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);font-size:12px;font-weight:600;cursor:pointer;transition:var(--transition);font-family:inherit;text-decoration:none;display:inline-flex;align-items:center;gap:6px;}
.btn:hover{border-color:var(--draga-accent);color:var(--text-primary);}
.btn-primary{background:var(--draga-gradient);color:#fff;border-color:transparent;}
.btn-primary:hover{opacity:0.9;border-color:transparent;}
.btn-danger{background:rgba(239,68,68,0.1);color:var(--danger);border-color:rgba(239,68,68,0.3);}
.btn-danger:hover{background:rgba(239,68,68,0.2);}
.btn-sm{padding:5px 12px;font-size:11px;}

/* â•â•â• BADGES â•â•â• */
.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:10px;font-size:10px;font-weight:700;text-transform:uppercase;}
.badge-success{background:rgba(34,197,94,0.12);color:var(--success);}
.badge-danger{background:rgba(239,68,68,0.12);color:var(--danger);}
.badge-warning{background:rgba(245,158,11,0.12);color:var(--warning);}
.badge-info{background:rgba(59,130,246,0.12);color:var(--info);}
.badge-muted{background:rgba(100,116,139,0.12);color:var(--text-muted);}
.badge-draga{background:var(--draga-accent-alpha);color:var(--draga-accent-light);}

/* â•â•â• TABLES â•â•â• */
table{width:100%;border-collapse:collapse;font-size:13px;}
th{text-align:left;padding:10px 12px;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);border-bottom:1px solid var(--border);font-weight:700;}
td{padding:10px 12px;border-bottom:1px solid rgba(36,48,73,0.5);}
tr:hover td{background:var(--bg-card);}

/* â•â•â• FORMS â•â•â• */
.form-group{margin-bottom:14px;}
.form-group label{display:block;font-size:12px;font-weight:700;color:var(--text-secondary);margin-bottom:5px;}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:9px 12px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;font-family:inherit;transition:var(--transition);}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--draga-accent);}
.form-group textarea{resize:vertical;min-height:80px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}

/* â•â•â• MODALS â•â•â• */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);width:90%;max-width:520px;max-height:80vh;overflow-y:auto;padding:28px;}
.modal-title{font-size:18px;font-weight:900;margin-bottom:20px;display:flex;align-items:center;gap:10px;}
.modal-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border);}

/* â•â•â• TENANT GROUP (Level 2) â•â•â• */
.tenant-group{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:0;margin-bottom:20px;overflow:hidden;transition:var(--transition);}
.tenant-group:hover{border-color:color-mix(in srgb, var(--info) 60%, transparent);}
.tg-header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;background:linear-gradient(135deg, color-mix(in srgb, var(--info) 8%, transparent), transparent);border-bottom:1px solid var(--border);cursor:pointer;}
.tg-header:hover{background:linear-gradient(135deg, color-mix(in srgb, var(--info) 14%, transparent), transparent);}
.tg-name{font-size:17px;font-weight:900;display:flex;align-items:center;gap:10px;}
.tg-name .tg-badge{font-size:9px;padding:2px 8px;border-radius:6px;font-weight:600;}
.tg-id{font-size:10px;color:var(--text-muted);font-family:monospace;margin-top:2px;}
.tg-summary{display:flex;gap:16px;align-items:center;font-size:12px;color:var(--text-secondary);}
.tg-summary .tg-stat{display:flex;align-items:center;gap:4px;}
.tg-body{padding:16px 24px 20px;}
.tg-meta{display:flex;flex-wrap:wrap;gap:12px;font-size:11px;color:var(--text-muted);margin-bottom:16px;}
.tg-actions{display:flex;gap:8px;margin-bottom:16px;}
.tg-dragas-title{font-size:13px;font-weight:700;color:var(--text-secondary);margin-bottom:10px;display:flex;align-items:center;gap:6px;}

/* â•â•â• DRAGA SUB-CARDS (Level 3 inside tenant) â•â•â• */
.draga-subcard{display:flex;align-items:center;gap:14px;padding:12px 16px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);transition:var(--transition);text-decoration:none;color:inherit;position:relative;overflow:hidden;}
.draga-subcard::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--draga-gradient);}
.draga-subcard:hover{border-color:var(--draga-accent);background:var(--bg-card-hover,var(--bg-card));transform:translateX(4px);box-shadow:var(--draga-glow);}
.draga-subcard .ds-icon{flex-shrink:0;}
.draga-subcard .ds-info{flex:1;min-width:0;}
.draga-subcard .ds-name{font-size:14px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.draga-subcard .ds-id{font-size:10px;color:var(--text-muted);font-family:monospace;}
.draga-subcard .ds-stats{display:flex;gap:12px;font-size:11px;color:var(--text-muted);flex-shrink:0;}
.draga-subcard .ds-actions{display:flex;gap:6px;flex-shrink:0;}
.draga-subcards{display:flex;flex-direction:column;gap:8px;}

/* â•â•â• SECTION â•â•â• */
.section{margin-bottom:32px;}
.section-title{font-size:16px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.section-title .icon{font-size:20px;}

/* â•â•â• EMPTY STATE â•â•â• */
.empty-state{text-align:center;padding:48px 20px;color:var(--text-muted);}
.empty-state .icon{font-size:48px;margin-bottom:12px;}
.empty-state h3{font-size:16px;margin-bottom:6px;color:var(--text-secondary);}
.empty-state p{font-size:13px;}

/* â•â•â• LOADING â•â•â• */
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--draga-accent);border-radius:50%;animation:spin .6s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading{text-align:center;padding:40px;color:var(--text-muted);}

/* â•â•â• TOAST â•â•â• */
.toast-container{position:fixed;top:64px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px;}
.toast{padding:10px 18px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;animation:slideIn .3s ease;max-width:360px;}
.toast-error{background:#991b1b;color:#fecaca;}
.toast-info{background:#1e3a5f;color:#93c5fd;}
.toast-success{background:#166534;color:#bbf7d0;}
.toast-warning{background:#78350f;color:#fde68a;}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* â•â•â• PROGRESS BAR â•â•â• */
.progress-bar{height:8px;background:var(--bg-input);border-radius:4px;overflow:hidden;}
.progress-bar .fill{height:100%;border-radius:4px;background:var(--draga-gradient);transition:width 1s ease;}

/* â•â•â• ROADMAP â•â•â• */
.phase-banner{border-radius:var(--radius-lg);padding:28px;margin-bottom:32px;position:relative;overflow:hidden;}
.phase-banner .phase-num{font-size:10px;text-transform:uppercase;letter-spacing:2px;font-weight:700;opacity:0.7;margin-bottom:4px;}
.phase-banner .phase-title{font-size:24px;font-weight:900;margin-bottom:4px;}
.phase-banner .phase-desc{font-size:13px;opacity:0.8;max-width:600px;}
.timeline{position:relative;padding-left:36px;}
.timeline::before{content:'';position:absolute;left:14px;top:0;bottom:0;width:2px;background:var(--border);}
.timeline-node{position:relative;margin-bottom:32px;}
.timeline-node::before{content:'';position:absolute;left:-30px;top:4px;width:16px;height:16px;border-radius:50%;border:3px solid var(--border);background:var(--bg-dark);z-index:1;}
.timeline-node.done::before{background:var(--success);border-color:var(--success);}
.timeline-node.active::before{background:var(--draga-accent);border-color:var(--draga-accent);box-shadow:0 0 10px rgba(124,58,237,0.5);}
.sprint-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
.sprint-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;cursor:pointer;transition:var(--transition);}
.sprint-header:hover{background:var(--bg-card-hover);}
.sprint-header .s-name{font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px;}
.sprint-header .s-badge{padding:3px 10px;border-radius:10px;font-size:10px;font-weight:700;text-transform:uppercase;}
.sprint-header .s-toggle{font-size:12px;color:var(--text-muted);transition:transform .2s;}
.sprint-body{display:none;padding:0 18px 18px;border-top:1px solid var(--border);}
.sprint-body.open{display:block;padding-top:14px;}
.task-list{list-style:none;}
.task-list li{display:flex;align-items:flex-start;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:12px;}
.task-list li:last-child{border:none;}
.task-check{flex-shrink:0;width:18px;text-align:center;}
.task-text{flex:1;color:var(--text-secondary);}
.task-actor{flex-shrink:0;padding:2px 8px;border-radius:6px;font-size:9px;font-weight:700;text-transform:uppercase;}
.actor-copilot{background:rgba(124,58,237,0.15);color:var(--draga-accent-light);}
.actor-human{background:rgba(236,137,81,0.15);color:#ec8951;}
.actor-hybrid{background:rgba(59,130,246,0.15);color:var(--info);}

/* â•â•â• MCP CARD â•â•â• */
.mcp-item{margin-bottom:12px;padding:14px;background:var(--bg-input);border-radius:var(--radius-sm);border:1px solid var(--border);}
.mcp-item .name{font-weight:700;font-size:13px;color:var(--draga-accent-light);margin-bottom:4px;}
.mcp-item .desc{font-size:11px;color:var(--text-muted);margin-bottom:6px;}
.mcp-item .params{display:flex;flex-wrap:wrap;gap:4px;}

/* â•â•â• RESPONSIVE â•â•â• */
@media(max-width:900px){
    .app{grid-template-columns:1fr;grid-template-rows:56px 48px 1fr;}
    .sidebar{overflow-x:auto;display:flex;flex-direction:row;padding:0 12px;gap:4px;align-items:center;border-right:none;border-bottom:1px solid var(--border);}
    .sidebar-section{display:flex;gap:4px;margin:0;padding:0;}
    .sidebar-label{display:none;}
    .nav-item{white-space:nowrap;padding:8px 12px;}
    .main{padding:16px;}
    .card-grid{grid-template-columns:1fr;}
    .form-row{grid-template-columns:1fr;}
}
    </style>
</head>
<body>

<!-- â•â•â• HEADER â•â•â• -->
<div class="app">
<header class="header">
    <a href="index.html" class="header-brand">
        <div class="logo"><i class="di" style="font-size:18px;width:18px;height:18px"></i></div>
        <div><div class="name">DRAGA</div><div class="subtitle">Plataforma</div></div>
    </a>
    <div class="header-right">
        <div class="health-pill online" id="healthPill">
            <div class="health-dot"></div>
            <span id="healthText">checking...</span>
        </div>
        <a href="index.html" class="btn btn-sm">ğŸ  Home</a>
    </div>
</header>

<!-- â•â•â• SIDEBAR â•â•â• -->
<nav class="sidebar">
    <div class="sidebar-section">
        <div class="sidebar-label">Plataforma</div>
        <a class="nav-item active" onclick="nav('dashboard')" data-mod="dashboard">
            <span class="icon">ğŸ“Š</span> Dashboard
        </a>
        <a class="nav-item" onclick="nav('tenants')" data-mod="tenants">
            <span class="icon">ğŸ¢</span> Tenants
            <span class="badge" id="tenantCount">â€”</span>
        </a>
        <a class="nav-item" onclick="nav('agents')" data-mod="agents">
            <span class="icon"><i class="di"></i></span> DRAGAs
            <span class="badge" id="agentCount">â€”</span>
        </a>
        <a class="nav-item" onclick="nav('apikeys')" data-mod="apikeys">
            <span class="icon">ğŸ”‘</span> API Keys
            <span class="badge" id="apikeyCount">â€”</span>
        </a>
    </div>
    <div class="sidebar-section">
        <div class="sidebar-label">Operaciones</div>
        <a class="nav-item" onclick="nav('analytics')" data-mod="analytics">
            <span class="icon">ğŸ“ˆ</span> Analytics
        </a>
        <a class="nav-item" onclick="nav('system')" data-mod="system">
            <span class="icon">âš™ï¸</span> Sistema
        </a>
        <a class="nav-item" onclick="nav('roadmap')" data-mod="roadmap">
            <span class="icon">ğŸ—ºï¸</span> Roadmap
        </a>
    </div>
    <div class="sidebar-section" style="margin-top:auto;border-top:1px solid var(--border);padding-top:12px;">
        <div class="sidebar-label">SesiÃ³n</div>
        <a class="nav-item" id="navUserInfo" style="font-size:11px;color:var(--text-muted);cursor:default;pointer-events:none;">
            <span class="icon">ğŸ‘¤</span> <span id="navUserEmail">â€”</span>
        </a>
        <a class="nav-item" onclick="handleLogout()" style="color:var(--warning);">
            <span class="icon">ğŸšª</span> Cerrar SesiÃ³n
        </a>
    </div>
</nav>

<!-- â•â•â• MAIN CONTENT â•â•â• -->
<main class="main">

<!-- â”€â”€ MODULE: DASHBOARD â”€â”€ -->
<div class="module active" id="mod-dashboard">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div>
            <h1 class="page-title" style="margin-bottom:4px">ğŸ—ï¸ Dashboard de la Plataforma</h1>
            <p class="page-desc" style="margin-bottom:0">Nivel 1: Vista global organizasada por tenants y sus DRAGAs</p>
        </div>
        <button class="btn btn-primary" onclick="showDragaModal()" style="white-space:nowrap">
            <i class="di" style="width:14px;height:14px;vertical-align:middle"></i> Nueva DRAGA
        </button>
    </div>

    <!-- LEVEL 1: Global platform stats -->
    <div class="section">
        <div class="section-title"><span class="icon">ğŸŒ</span> MÃ©tricas Globales</div>
        <div class="stats-grid" id="heroStats">
            <div class="stat-card"><div class="label">Tenants</div><div class="value" id="statTenants">â€”</div></div>
            <div class="stat-card"><div class="label">DRAGAs</div><div class="value" id="statDragas">â€”</div></div>
            <div class="stat-card"><div class="label">Documentos</div><div class="value" id="statDocs">â€”</div></div>
            <div class="stat-card"><div class="label">Chunks</div><div class="value" id="statChunks" style="color:var(--info)">â€”</div></div>
            <div class="stat-card"><div class="label">API Keys</div><div class="value" id="statKeys" style="color:var(--warning)">â€”</div></div>
            <div class="stat-card"><div class="label">Anti-AlucinaciÃ³n</div><div class="value" id="statAntiHalluc" style="color:var(--success)">â€”</div></div>
        </div>
    </div>

    <!-- LEVEL 2 + 3: Tenants â†’ DRAGAs -->
    <div class="section">
        <div class="section-title"><span class="icon">ğŸ¢</span> Tenants y sus DRAGAs</div>
        <div id="tenantHierarchy">
            <div class="loading"><div class="spinner"></div> Cargando jerarquÃ­a...</div>
        </div>
    </div>
</div>

<!-- â”€â”€ MODULE: TENANTS â”€â”€ -->
<div class="module" id="mod-tenants">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
        <div>
            <h1 class="page-title">GestiÃ³n de Tenants</h1>
            <p class="page-desc" style="margin-bottom:0">CRUD completo de tenants multi-tenant</p>
        </div>
        <button class="btn btn-primary" onclick="showTenantModal()">â• Nuevo Tenant</button>
    </div>
    <div class="card-grid" id="tenantCards">
        <div class="loading"><div class="spinner"></div> Cargando...</div>
    </div>
</div>

<!-- â”€â”€ MODULE: AGENTS â”€â”€ -->
<div class="module" id="mod-agents">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
        <div>
            <h1 class="page-title">GestiÃ³n de DRAGAs</h1>
            <p class="page-desc" style="margin-bottom:0">Cada DRAGA pertenece a un tenant. Un tenant puede tener mÃºltiples DRAGAs.</p>
        </div>
        <button class="btn btn-primary" onclick="showDragaModal()"><i class="di" style="width:14px;height:14px;vertical-align:middle"></i> Nueva DRAGA</button>
    </div>
    <div id="agentCards">
        <div class="loading"><div class="spinner"></div> Cargando...</div>
    </div>
</div>

<!-- â”€â”€ MODULE: API KEYS â”€â”€ -->
<div class="module" id="mod-apikeys">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
        <div>
            <h1 class="page-title">API Keys</h1>
            <p class="page-desc" style="margin-bottom:0">GestiÃ³n de claves de acceso por tenant (SHA-256 hashed, scoped)</p>
        </div>
        <button class="btn btn-primary" onclick="showApiKeyModal()">ğŸ”‘ Nueva API Key</button>
    </div>
    <div class="section">
        <div class="section-title"><span class="icon">ğŸ”</span> Claves Activas</div>
        <div id="apiKeysList"><div class="loading"><div class="spinner"></div></div></div>
    </div>
</div>

<!-- â”€â”€ MODULE: ANALYTICS â”€â”€ -->
<div class="module" id="mod-analytics">
    <h1 class="page-title">Analytics & Feedback</h1>
    <p class="page-desc">Salud del sistema, satisfacciÃ³n de usuarios y mÃ©tricas</p>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ¥</span> Estado de Servicios</div>
        <div class="stats-grid" id="healthGrid"></div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
        <div class="section">
            <div class="section-title"><span class="icon">ğŸ’¬</span> SatisfacciÃ³n</div>
            <div class="card" id="feedbackPanel"><div class="loading"><div class="spinner"></div></div></div>
        </div>
        <div class="section">
            <div class="section-title"><span class="icon">ğŸ“Š</span> Sistema</div>
            <div class="card" id="systemPanel"><div class="loading"><div class="spinner"></div></div></div>
        </div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ›¡ï¸</span> Calidad Agregada <span style="font-size:11px;color:var(--text-muted);font-weight:400;margin-left:8px">(datos de referencia â€” el detalle estÃ¡ a nivel de cada DRAGA)</span></div>
        <div class="stats-grid" id="qualityGlobalGrid" style="grid-template-columns:repeat(auto-fill,minmax(150px,1fr));">
            <div class="stat-card"><div class="label">Documentos</div><div class="value" id="gqDocs">â€”</div></div>
            <div class="stat-card"><div class="label">Chunks</div><div class="value" id="gqChunks">â€”</div></div>
            <div class="stat-card"><div class="label">Cobertura</div><div class="value" id="gqCoverage">â€”</div></div>
            <div class="stat-card"><div class="label">Grounding</div><div class="value" id="gqGrounding">â€”</div></div>
            <div class="stat-card"><div class="label">Confianza Avg</div><div class="value" id="gqConfidence">â€”</div></div>
            <div class="stat-card"><div class="label">Cache Hit</div><div class="value" id="gqCacheHit">â€”</div></div>
            <div class="stat-card"><div class="label">Feedback Total</div><div class="value" id="gqFeedback">â€”</div></div>
        </div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ“</span> Feedback Reciente</div>
        <div class="card" style="overflow-x:auto;">
            <table>
                <thead><tr><th>Query</th><th>Rating</th><th>Confianza</th><th>Comentario</th><th>Revisado</th><th>AcciÃ³n</th></tr></thead>
                <tbody id="feedbackTableBody"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<!-- â”€â”€ MODULE: SYSTEM â”€â”€ -->
<div class="module" id="mod-system">
    <h1 class="page-title">Sistema & MCP</h1>
    <p class="page-desc">Herramientas MCP, modelos, cachÃ© y operaciones de mantenimiento</p>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
        <div class="section">
            <div class="section-title"><span class="icon">ğŸ”§</span> MCP Tools</div>
            <div id="mcpToolsPanel"><div class="loading"><div class="spinner"></div></div></div>
        </div>
        <div class="section">
            <div class="section-title"><span class="icon">ğŸ“</span> MCP Prompts</div>
            <div id="mcpPromptsPanel"><div class="loading"><div class="spinner"></div></div></div>
        </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
        <div class="section">
            <div class="section-title"><span class="icon">ğŸ“‚</span> MCP Resources</div>
            <div id="mcpResourcesPanel"><div class="loading"><div class="spinner"></div></div></div>
        </div>
        <div class="section">
            <div class="section-title"><span class="icon">ğŸ§ </span> Modelos</div>
            <div id="modelsPanel"><div class="loading"><div class="spinner"></div></div></div>
        </div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ› ï¸</span> Mantenimiento</div>
        <div class="card" style="display:flex;flex-wrap:wrap;gap:16px;align-items:flex-end;">
            <div class="form-group" style="margin:0;flex:1;min-width:200px;">
                <label>Tenant ID para cachÃ©</label>
                <select id="cacheTenantId"><option value="">Cargando...</option></select>
            </div>
            <button class="btn" onclick="clearCacheAction()">ğŸ§¹ Limpiar CachÃ©</button>
            <button class="btn btn-danger" onclick="resetReindexAction()">â˜¢ï¸ Reset Nuclear</button>
        </div>
    </div>
</div>

<!-- â”€â”€ MODULE: ROADMAP â”€â”€ -->
<div class="module" id="mod-roadmap">
    <h1 class="page-title">Roadmap SaaS</h1>
    <p class="page-desc">3 fases, 8 sprints, 57 tareas â€” De SaaS interno a General Availability</p>

    <div class="stats-grid" style="margin-bottom:32px;">
        <div class="stat-card"><div class="label">Fases</div><div class="value">3</div></div>
        <div class="stat-card"><div class="label">Sprints</div><div class="value">8</div></div>
        <div class="stat-card"><div class="label">Tareas</div><div class="value">57</div></div>
        <div class="stat-card"><div class="label">Progreso</div><div class="value" id="roadmapPct">0%</div></div>
    </div>

    <div class="section" style="margin-bottom:16px;">
        <div class="progress-bar" style="height:14px;border-radius:7px;">
            <div class="fill" id="roadmapFill" style="width:0%"></div>
        </div>
    </div>

    <!-- PHASE 1 -->
    <div class="phase-banner" style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);">
        <div class="phase-num" style="color:var(--info)">Fase 1</div>
        <div class="phase-title" style="color:var(--info)">ğŸ—ï¸ Foundation â†’ Internal SaaS</div>
        <div class="phase-desc">PostgreSQL, Hybrid Search, JWT Auth, Observability, CI/CD</div>
    </div>
    <div class="timeline">
        <div class="timeline-node active">
            <div class="sprint-card">
                <div class="sprint-header" onclick="toggleSprint(this)">
                    <span class="s-name">ğŸ—ï¸ Sprint 1 â€” Data & Persistence</span>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <span class="s-badge" style="background:rgba(59,130,246,0.15);color:var(--info)">8 tareas</span>
                        <span class="s-toggle">â–¸</span>
                    </div>
                </div>
                <div class="sprint-body">
                    <ul class="task-list">
                        <li><span class="task-check">â¬œ</span><span class="task-text">PostgreSQL adapter (puerto SQL en hexagonal)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Alembic migrations (tenants, documents, feedback, sessions)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">pgvector extension + hybrid search adapter</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Redis cache adapter (reemplaza in-memory)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">MigraciÃ³n de datos vector DB â†’ pgvector</span><span class="task-actor actor-hybrid">Hybrid</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Tests de integraciÃ³n DB</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Docker compose con PG + Redis</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">ADR-017: Decision PostgreSQL + pgvector</span><span class="task-actor actor-human">Human</span></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="timeline-node upcoming">
            <div class="sprint-card">
                <div class="sprint-header" onclick="toggleSprint(this)">
                    <span class="s-name">ğŸ” Sprint 2 â€” Auth & Multi-tenancy</span>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <span class="s-badge" style="background:rgba(59,130,246,0.15);color:var(--info)">8 tareas</span>
                        <span class="s-toggle">â–¸</span>
                    </div>
                </div>
                <div class="sprint-body">
                    <ul class="task-list">
                        <li><span class="task-check">â¬œ</span><span class="task-text">JWT auth middleware (access + refresh tokens)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">RBAC: admin, tenant_admin, user roles</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Row-level security en PostgreSQL</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">API key management (create/revoke/rotate)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Tenant provisioning automatizado</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Login page + OAuth2 (Google/GitHub)</span><span class="task-actor actor-hybrid">Hybrid</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Audit log (quiÃ©n hizo quÃ©, cuÃ¡ndo)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Tests de seguridad + penetration basic</span><span class="task-actor actor-hybrid">Hybrid</span></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="timeline-node upcoming">
            <div class="sprint-card">
                <div class="sprint-header" onclick="toggleSprint(this)">
                    <span class="s-name">ğŸ“¡ Sprint 3 â€” Observability & Quality</span>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <span class="s-badge" style="background:rgba(59,130,246,0.15);color:var(--info)">8 tareas</span>
                        <span class="s-toggle">â–¸</span>
                    </div>
                </div>
                <div class="sprint-body">
                    <ul class="task-list">
                        <li><span class="task-check">â¬œ</span><span class="task-text">OpenTelemetry traces en pipeline</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Prometheus metrics (latencia, throughput, errores)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Grafana dashboards pre-configurados</span><span class="task-actor actor-hybrid">Hybrid</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Structured logging (JSON, correlation-id)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Health check avanzado (/health/detailed)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Alertas Slack/Discord en anomalÃ­as</span><span class="task-actor actor-hybrid">Hybrid</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Dashboard de calidad en DRAGA frontend</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">SLA monitoring (uptime, latency P99)</span><span class="task-actor actor-copilot">Copilot</span></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="timeline-node upcoming">
            <div class="sprint-card">
                <div class="sprint-header" onclick="toggleSprint(this)">
                    <span class="s-name">ğŸš€ Sprint 4 â€” CI/CD & Internal Launch</span>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <span class="s-badge" style="background:rgba(59,130,246,0.15);color:var(--info)">8 tareas</span>
                        <span class="s-toggle">â–¸</span>
                    </div>
                </div>
                <div class="sprint-body">
                    <ul class="task-list">
                        <li><span class="task-check">â¬œ</span><span class="task-text">GitHub Actions pipeline (lint, test, build, deploy)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Docker multi-stage build optimizado</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Blue-green deployment en DigitalOcean</span><span class="task-actor actor-hybrid">Hybrid</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Backup automatizado (PG + volumes)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Rate limiting por tenant (nginx + app)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Documentation site (Docusaurus/MkDocs)</span><span class="task-actor actor-hybrid">Hybrid</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Smoke tests post-deploy</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Internal SaaS launch para Envios23</span><span class="task-actor actor-human">Human</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- PHASE 2 -->
    <div class="phase-banner" style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);margin-top:40px;">
        <div class="phase-num" style="color:var(--warning)">Fase 2</div>
        <div class="phase-title" style="color:var(--warning)">ğŸŒ Self-Service â†’ SDK & Marketplace</div>
        <div class="phase-desc">Portal self-service, SDK Python/JS, Marketplace de conectores</div>
    </div>
    <div class="timeline">
        <div class="timeline-node upcoming">
            <div class="sprint-card">
                <div class="sprint-header" onclick="toggleSprint(this)">
                    <span class="s-name">ğŸ–¥ï¸ Sprint 5 â€” Self-Service Portal</span>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <span class="s-badge" style="background:rgba(245,158,11,0.15);color:var(--warning)">8 tareas</span>
                        <span class="s-toggle">â–¸</span>
                    </div>
                </div>
                <div class="sprint-body">
                    <ul class="task-list">
                        <li><span class="task-check">â¬œ</span><span class="task-text">Onboarding wizard (create tenant â†’ upload docs â†’ test chat)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Usage dashboard (queries/dÃ­a, tokens, storage)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Billing integration (Stripe/Paddle)</span><span class="task-actor actor-hybrid">Hybrid</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Plan management (Free, Pro, Enterprise)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Team management (invite, roles, permissions)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Webhook configurator</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Custom domain mapping por tenant</span><span class="task-actor actor-hybrid">Hybrid</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Tenant isolation audit + compliance</span><span class="task-actor actor-human">Human</span></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="timeline-node upcoming">
            <div class="sprint-card">
                <div class="sprint-header" onclick="toggleSprint(this)">
                    <span class="s-name">ğŸ“¦ Sprint 6 â€” SDK & Developer Experience</span>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <span class="s-badge" style="background:rgba(245,158,11,0.15);color:var(--warning)">7 tareas</span>
                        <span class="s-toggle">â–¸</span>
                    </div>
                </div>
                <div class="sprint-body">
                    <ul class="task-list">
                        <li><span class="task-check">â¬œ</span><span class="task-text">Python SDK (pip install draga)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">JavaScript SDK (npm install @draga/sdk)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">OpenAPI spec auto-generated + Swagger UI</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Postman/Insomnia collection auto-gen</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">CLI tool (draga init, draga deploy, draga query)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Marketplace de conectores (Notion, Confluence, GDrive)</span><span class="task-actor actor-hybrid">Hybrid</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Developer portal con tutorials</span><span class="task-actor actor-hybrid">Hybrid</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- PHASE 3 -->
    <div class="phase-banner" style="background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);margin-top:40px;">
        <div class="phase-num" style="color:var(--success)">Fase 3</div>
        <div class="phase-title" style="color:var(--success)">ğŸŒ Scale â†’ General Availability</div>
        <div class="phase-desc">TaxonomÃ­as avanzadas, escala horizontal, marketplace pÃºblico</div>
    </div>
    <div class="timeline">
        <div class="timeline-node upcoming">
            <div class="sprint-card">
                <div class="sprint-header" onclick="toggleSprint(this)">
                    <span class="s-name">ğŸ§¬ Sprint 7 â€” TaxonomÃ­as & Advanced RAG</span>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <span class="s-badge" style="background:rgba(34,197,94,0.15);color:var(--success)">5 tareas</span>
                        <span class="s-toggle">â–¸</span>
                    </div>
                </div>
                <div class="sprint-body">
                    <ul class="task-list">
                        <li><span class="task-check">â¬œ</span><span class="task-text">Taxonomy Agent (auto-clasificaciÃ³n de documentos)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Knowledge Graph builder (relaciones entre entidades)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Multi-modal RAG (imÃ¡genes, tablas, diagramas)</span><span class="task-actor actor-hybrid">Hybrid</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Agentic RAG (multi-step reasoning)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Evaluation framework automatizado (RAGAS)</span><span class="task-actor actor-copilot">Copilot</span></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="timeline-node upcoming">
            <div class="sprint-card">
                <div class="sprint-header" onclick="toggleSprint(this)">
                    <span class="s-name">ğŸŒ Sprint 8 â€” Scale & GA</span>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <span class="s-badge" style="background:rgba(34,197,94,0.15);color:var(--success)">5 tareas</span>
                        <span class="s-toggle">â–¸</span>
                    </div>
                </div>
                <div class="sprint-body">
                    <ul class="task-list">
                        <li><span class="task-check">â¬œ</span><span class="task-text">Horizontal scaling (Kubernetes/Nomad)</span><span class="task-actor actor-hybrid">Hybrid</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Multi-region deployment</span><span class="task-actor actor-hybrid">Hybrid</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Enterprise SSO (SAML, OIDC)</span><span class="task-actor actor-copilot">Copilot</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">SOC2 compliance preparation</span><span class="task-actor actor-human">Human</span></li>
                        <li><span class="task-check">â¬œ</span><span class="task-text">Public launch + ProductHunt</span><span class="task-actor actor-human">Human</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

</main>
</div>

<!-- â•â•â• DRAGA CREATION MODAL â•â•â• -->
<div class="modal-overlay" id="dragaModal">
    <div class="modal" style="max-width:560px">
        <div class="modal-title"><i class="di" style="width:20px;height:20px;vertical-align:middle"></i> Nueva DRAGA</div>
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Crea una nueva instancia DRAGA dentro de un tenant (organizaciÃ³n) existente.</p>

        <!-- Tenant selection mode -->
        <div class="form-group">
            <label>Tenant (organizaciÃ³n)</label>
            <div style="display:flex;gap:8px;margin-bottom:10px">
                <button class="btn btn-sm btn-primary" id="dragaTenantModeExist" onclick="toggleDragaTenantMode('existing')" style="flex:1">ğŸ“‹ Usar existente</button>
                <button class="btn btn-sm" id="dragaTenantModeNew" onclick="requestNewTenantMode()" style="flex:1;opacity:0.6;font-size:11px" title="Requiere confirmaciÃ³n de admin">ğŸ”’ Crear tenant nuevo</button>
            </div>
        </div>

        <!-- Existing tenant selector -->
        <div id="dragaTenantExisting">
            <div class="form-group">
                <label>Seleccionar Tenant (organizaciÃ³n)</label>
                <select id="dragaTenantSelect" onchange="onDragaTenantSelected()">
                    <option value="">â€” Selecciona la organizaciÃ³n para esta DRAGA â€”</option>
                </select>
                <small style="color:var(--text-muted);font-size:10px">Cada DRAGA pertenece a un tenant. Las DRAGAs comparten la base de conocimiento de su tenant.</small>
            </div>
            <div id="dragaTenantInfo" style="display:none;padding:10px;background:var(--bg-input);border-radius:var(--radius-sm);margin-bottom:14px;font-size:12px;"></div>
        </div>

        <!-- New tenant form -->
        <div id="dragaTenantNew" style="display:none">
            <div style="background:#382a0a;border:1px solid #6b5b1e;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:11px;color:#f5c542;line-height:1.5;">
                âš ï¸ <strong>AcciÃ³n administrativa:</strong> Crear un tenant nuevo genera una organizaciÃ³n independiente con su propia base de conocimiento, facturaciÃ³n y aislamiento de datos. Solo hacerlo si realmente se necesita una cuenta nueva.
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ID del Tenant <span style="color:var(--danger)">*</span></label>
                    <input type="text" id="dragaNewTenantId" placeholder="mi-empresa" pattern="[a-z0-9_\-]+">
                    <small style="color:var(--text-muted);font-size:10px">Solo minÃºsculas, nÃºmeros, guiones</small>
                </div>
                <div class="form-group">
                    <label>Nombre <span style="color:var(--danger)">*</span></label>
                    <input type="text" id="dragaNewTenantName" placeholder="Mi Empresa">
                </div>
            </div>
            <div class="form-group">
                <label>DescripciÃ³n</label>
                <input type="text" id="dragaNewTenantDesc" placeholder="DescripciÃ³n del tenant">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Modelo LLM</label>
                    <input type="text" id="dragaNewTenantModel" value="anthropic/claude-3-haiku" placeholder="anthropic/claude-3-haiku">
                </div>
                <div class="form-group">
                    <label>Idioma</label>
                    <select id="dragaNewTenantLang">
                        <option value="es">EspaÃ±ol</option>
                        <option value="en">English</option>
                        <option value="pt">PortuguÃªs</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>System Prompt (opcional, mÃ­n. 10 chars)</label>
                <textarea id="dragaNewTenantPrompt" placeholder="Instrucciones especÃ­ficas para el modelo..."></textarea>
            </div>
        </div>

        <!-- DRAGA (Agent) Fields -->
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
            <div style="font-size:12px;font-weight:700;color:var(--text-secondary);margin-bottom:10px"><i class="di" style="width:14px;height:14px;vertical-align:-2px"></i> Datos del DRAGA</div>
            <div class="form-row">
                <div class="form-group">
                    <label>DRAGA ID <span style="color:var(--danger)">*</span></label>
                    <input type="text" id="dragaAgentId" placeholder="soporte-v1" pattern="[a-z0-9_\-]+">
                    <small style="color:var(--text-muted);font-size:10px">Solo minÃºsculas, nÃºmeros, guiones</small>
                </div>
                <div class="form-group">
                    <label>Nombre <span style="color:var(--danger)">*</span></label>
                    <input type="text" id="dragaAgentName" placeholder="Soporte v1">
                </div>
            </div>
            <div class="form-group">
                <label>DescripciÃ³n (opcional)</label>
                <input type="text" id="dragaAgentDesc" placeholder="DescripciÃ³n del DRAGA...">
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn" onclick="closeModal('dragaModal')">Cancelar</button>
            <button class="btn btn-primary" id="dragaCreateBtn" onclick="createDraga()">
                <i class="di" style="width:14px;height:14px;vertical-align:middle"></i> Crear DRAGA
            </button>
        </div>
    </div>
</div>

<!-- â•â•â• TENANT MODAL â•â•â• -->
<div class="modal-overlay" id="tenantModal">
    <div class="modal">
        <div class="modal-title">ğŸ¢ <span id="tenantModalTitle">Nuevo Tenant</span></div>
        <div class="form-row">
            <div class="form-group">
                <label>ID del Tenant</label>
                <input type="text" id="tenantIdInput" placeholder="mi-empresa" pattern="[a-z0-9_\-]+">
            </div>
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" id="tenantNameInput" placeholder="Mi Empresa">
            </div>
        </div>
        <div class="form-group">
            <label>DescripciÃ³n</label>
            <input type="text" id="tenantDescInput" placeholder="DescripciÃ³n del tenant">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Modelo LLM</label>
                <input type="text" id="tenantModelInput" value="anthropic/claude-3-haiku" placeholder="anthropic/claude-3-haiku">
            </div>
            <div class="form-group">
                <label>Idioma</label>
                <select id="tenantLangInput">
                    <option value="es">EspaÃ±ol</option>
                    <option value="en">English</option>
                    <option value="pt">PortuguÃªs</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>System Prompt (opcional, mÃ­n. 10 chars)</label>
            <textarea id="tenantPromptInput" placeholder="Instrucciones especÃ­ficas para el modelo..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('tenantModal')">Cancelar</button>
            <button class="btn btn-primary" onclick="saveTenant()">ğŸ’¾ Guardar</button>
        </div>
    </div>
</div>

<!-- agentModal removed â€” consolidated into dragaModal -->

<!-- â•â•â• API KEY MODAL â•â•â• -->
<div class="modal-overlay" id="apiKeyModal">
    <div class="modal" style="max-width:480px">
        <div class="modal-title">ğŸ”‘ Nueva API Key</div>
        <div class="form-group">
            <label>Tenant</label>
            <select id="akTenantSelect"><option value="">Cargando...</option></select>
        </div>
        <div class="form-group">
            <label>Label</label>
            <input type="text" id="akLabelInput" placeholder="mi-clave-produccion">
        </div>
        <div class="form-group">
            <label>Scopes</label>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
                <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer"><input type="checkbox" value="query" checked class="akScope"> query</label>
                <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer"><input type="checkbox" value="ingest" class="akScope"> ingest</label>
                <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer"><input type="checkbox" value="admin" class="akScope"> admin</label>
                <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer"><input type="checkbox" value="feedback" class="akScope"> feedback</label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('apiKeyModal')">Cancelar</button>
            <button class="btn btn-primary" onclick="createApiKeyAction()">ğŸ”‘ Crear</button>
        </div>
    </div>
</div>

<!-- â•â•â• TOAST CONTAINER â•â•â• -->
<div class="toast-container" id="toasts"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAGA PLATFORM ADMIN â€” JavaScript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ AUTH: display user info + logout â”€â”€
function _showUserInfo() {
    const user = AuthSession.getUser();
    const el = document.getElementById('navUserEmail');
    if (el && user) el.textContent = user.email || user.role || 'â€”';
}
async function handleLogout() {
    try { await api.logout(); } catch (_) { /* best-effort */ }
    AuthSession.clear();
    window.location.href = '/login.html';
}
_showUserInfo();

const modules = ['dashboard', 'tenants', 'agents', 'apikeys', 'analytics', 'system', 'roadmap'];

// â”€â”€ NAVIGATION â”€â”€
function nav(mod) {
    if (!modules.includes(mod)) mod = 'dashboard';
    modules.forEach(m => {
        document.getElementById('mod-' + m).classList.toggle('active', m === mod);
        document.querySelector(`[data-mod="${m}"]`)?.classList.toggle('active', m === mod);
    });
    window.location.hash = mod;

    // Load module data
    const loaders = {
        dashboard: loadDashboard,
        tenants: loadTenants,
        agents: loadAgents,
        apikeys: loadApiKeys,
        analytics: loadAnalytics,
        system: loadSystem,
        roadmap: calcRoadmapProgress
    };
    loaders[mod]?.();
}

// â”€â”€ TOAST â”€â”€
function toast(msg, type = 'info', duration = 4000) {
    const el = document.createElement('div');
    el.className = 'toast toast-' + type;
    el.textContent = msg;
    document.getElementById('toasts').appendChild(el);
    setTimeout(() => el.remove(), duration);
}

// â”€â”€ MODALS â”€â”€
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// â”€â”€ HEALTH CHECK (F14: deep health with degraded state + service detail) â”€â”€
let _adminServiceHealth = null;
async function checkHealth() {
    const pill = document.getElementById('healthPill');
    const text = document.getElementById('healthText');
    try {
        const deep = await api.healthDeep();
        const status = deep.status || 'unknown';
        const checks = deep.checks || {};
        _adminServiceHealth = checks;
        const failed = Object.entries(checks).filter(([,v]) => !v.ok).map(([k]) => k);

        if (failed.length === 0) {
            pill.className = 'health-pill online';
            text.textContent = 'online';
        } else if (status === 'degraded') {
            pill.className = 'health-pill degraded';
            text.textContent = `degradado (${failed.join(', ')})`;
        } else {
            pill.className = 'health-pill offline';
            text.textContent = `error (${failed.join(', ')})`;
        }
    } catch {
        pill.className = 'health-pill offline';
        text.textContent = 'offline';
        _adminServiceHealth = null;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAGA CREATION FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _dragaTenantMode = 'existing';
let _dragaTenantList = [];

async function showDragaModal() {
    _dragaTenantMode = 'existing';
    toggleDragaTenantMode('existing');

    // Load tenants into the selector
    try {
        const data = await api.listTenants(true);
        _dragaTenantList = data.tenants || [];
        const select = document.getElementById('dragaTenantSelect');
        select.innerHTML = '<option value="">â€” Selecciona un tenant â€”</option>' +
            _dragaTenantList.map(t => `<option value="${t.tenant_id}">${t.name} (${t.tenant_id}) â€” ${t.document_count || 0} docs</option>`).join('');
    } catch (e) {
        _dragaTenantList = [];
        document.getElementById('dragaTenantSelect').innerHTML = '<option value="">Error cargando tenants</option>';
    }

    document.getElementById('dragaTenantInfo').style.display = 'none';
    // Clear new tenant fields
    document.getElementById('dragaNewTenantId').value = '';
    document.getElementById('dragaNewTenantName').value = '';
    document.getElementById('dragaNewTenantDesc').value = '';
    document.getElementById('dragaNewTenantModel').value = 'anthropic/claude-3-haiku';
    document.getElementById('dragaNewTenantLang').value = 'es';
    document.getElementById('dragaNewTenantPrompt').value = '';

    // Clear DRAGA fields
    document.getElementById('dragaAgentId').value = '';
    document.getElementById('dragaAgentName').value = '';
    document.getElementById('dragaAgentDesc').value = '';

    openModal('dragaModal');
}

/** Open DRAGA creation modal pre-selecting a specific tenant */
async function showDragaModalForTenant(tenantId) {
    await showDragaModal();
    // Modal is now open and tenants loaded â€” select the specified tenant
    const sel = document.getElementById('dragaTenantSelect');
    if (sel) {
        sel.value = tenantId;
        onDragaTenantSelected();
    }
    toggleDragaTenantMode('existing');
}

// Legacy alias (agentModal removed â€” use dragaModal)
function showAgentModal() { showDragaModal(); }

function requestNewTenantMode() {
    const confirmed = confirm(
        'âš ï¸ Crear un tenant nuevo = crear una organizaciÃ³n nueva.\n\n' +
        'Cada tenant es una unidad de facturaciÃ³n y aislamiento de datos independiente.\n\n' +
        'Â¿Seguro que necesitÃ¡s crear un tenant nuevo en lugar de usar uno existente?'
    );
    if (confirmed) {
        toggleDragaTenantMode('new');
    }
}

function toggleDragaTenantMode(mode) {
    _dragaTenantMode = mode;
    const existBtn = document.getElementById('dragaTenantModeExist');
    const newBtn = document.getElementById('dragaTenantModeNew');
    const existDiv = document.getElementById('dragaTenantExisting');
    const newDiv = document.getElementById('dragaTenantNew');

    if (mode === 'existing') {
        existBtn.className = 'btn btn-sm btn-primary';
        newBtn.className = 'btn btn-sm';
        newBtn.style.opacity = '0.6';
        existDiv.style.display = '';
        newDiv.style.display = 'none';
    } else {
        existBtn.className = 'btn btn-sm';
        newBtn.className = 'btn btn-sm btn-primary';
        newBtn.style.opacity = '1';
        existDiv.style.display = 'none';
        newDiv.style.display = '';
    }
}

function onDragaTenantSelected() {
    const id = document.getElementById('dragaTenantSelect').value;
    const info = document.getElementById('dragaTenantInfo');
    if (!id) { info.style.display = 'none'; return; }

    const t = _dragaTenantList.find(x => x.tenant_id === id);
    if (!t) { info.style.display = 'none'; return; }

    info.style.display = '';
    info.innerHTML = `
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
            <span>ğŸ¢ <strong>${t.name}</strong></span>
            <span>ğŸ“„ ${t.document_count || 0} docs</span>
            <span>ğŸ§  ${(t.default_model || 'â€”').split('/').pop()}</span>
            <span>ğŸŒ ${t.response_language || 'â€”'}</span>
            ${t.is_active !== false ? '<span class="badge badge-success" style="font-size:10px">Activo</span>' : '<span class="badge badge-muted" style="font-size:10px">Inactivo</span>'}
        </div>
        ${t.description ? '<div style="margin-top:6px;color:var(--text-secondary)">' + t.description + '</div>' : ''}`;
}

async function createDraga() {
    const btn = document.getElementById('dragaCreateBtn');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner" style="width:14px;height:14px"></div> Creando...';

    try {
        let tenantId;

        if (_dragaTenantMode === 'existing') {
            tenantId = document.getElementById('dragaTenantSelect').value;
            if (!tenantId) {
                toast('Selecciona un tenant existente', 'error');
                return;
            }
        } else {
            // Create new tenant â€” requires explicit confirmation
            tenantId = document.getElementById('dragaNewTenantId').value.trim();
            const name = document.getElementById('dragaNewTenantName').value.trim();
            if (!tenantId || !name) {
                toast('ID y Nombre del tenant son requeridos', 'error');
                return;
            }

            // Validate ID pattern
            if (!/^[a-z0-9][a-z0-9_\-]*[a-z0-9]$|^[a-z0-9]$/.test(tenantId)) {
                toast('ID invÃ¡lido: solo minÃºsculas, nÃºmeros, guiones y underscores', 'error');
                return;
            }

            // Check if tenant already exists
            const existing = _dragaTenantList.find(t => t.tenant_id === tenantId);
            if (existing) {
                toast(`El tenant "${tenantId}" ya existe. Usa "Usar existente" o elige otro ID.`, 'error');
                return;
            }

            // Final confirmation before creating a new organizational tenant
            if (!confirm(`Vas a crear el tenant "${name}" (${tenantId}).\n\nEsto crea una organizaciÃ³n nueva con aislamiento de datos y facturaciÃ³n independiente.\n\nÂ¿Confirmar?`)) {
                return;
            }

            const payload = { tenant_id: tenantId, name };
            const desc = document.getElementById('dragaNewTenantDesc').value.trim();
            const model = document.getElementById('dragaNewTenantModel').value.trim();
            const lang = document.getElementById('dragaNewTenantLang').value;
            const prompt = document.getElementById('dragaNewTenantPrompt').value.trim();
            if (desc) payload.description = desc;
            if (model) payload.default_model = model;
            if (lang) payload.response_language = lang;
            if (prompt && prompt.length >= 10) payload.system_prompt = prompt;

            await api.createTenant(payload);

            // Verify the tenant was actually created before redirecting
            try {
                await api.getTenant(tenantId);
            } catch (verifyErr) {
                console.error('[createDraga] Tenant creation returned OK but tenant not found:', verifyErr);
                toast(`Error: El tenant "${tenantId}" no se creÃ³ correctamente en el backend. Intente de nuevo.`, 'error', 5000);
                return;
            }

            toast(`Tenant "${name}" creado exitosamente`, 'success');
        }

        // Create the DRAGA (agent) within the tenant
        const dragaId = document.getElementById('dragaAgentId').value.trim();
        const dragaName = document.getElementById('dragaAgentName').value.trim();
        const dragaDesc = document.getElementById('dragaAgentDesc').value.trim();

        if (!dragaId || !dragaName) {
            toast('DRAGA ID y Nombre son requeridos', 'error');
            return;
        }
        if (!/^[a-z0-9][a-z0-9_\-]*$/.test(dragaId)) {
            toast('DRAGA ID invÃ¡lido: solo minÃºsculas, nÃºmeros, guiones', 'error');
            return;
        }

        await api.createAgent({
            tenant_id: tenantId, agent_id: dragaId,
            name: dragaName, description: dragaDesc || ''
        });
        toast(`DRAGA "${dragaName}" creada`, 'success');

        closeModal('dragaModal');
        toast('Redirigiendo al dashboard...', 'info', 2000);
        setTimeout(() => {
            window.location.href = `draga.html?tenant=${tenantId}&agent=${dragaId}`;
        }, 800);

    } catch (e) {
        toast('Error: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="di" style="width:14px;height:14px;vertical-align:middle"></i> Crear DRAGA';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE: DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard() {
    const grid = document.getElementById('tenantHierarchy');
    grid.innerHTML = '<div class="loading"><div class="spinner"></div> Cargando jerarquÃ­a...</div>';

    try {
        // Fetch tenants + overview (real counts from backend)
        // Use a race with timeout so user sees error quickly if backend is down
        const timeoutErr = new Error('El servidor no responde. Verifica que el backend estÃ© activo.');
        const raceTimeout = ms => new Promise((_, rej) => setTimeout(() => rej(timeoutErr), ms));

        const [tenantsData, overview, grounding] = await Promise.race([
            Promise.all([
                api.listTenants(true),
                api.adminDashboardOverview().catch(() => null),
                api.metricsGrounding().catch(() => null)
            ]),
            raceTimeout(20000)
        ]);
        const tenants = tenantsData.tenants || [];

        // Fetch actual DRAGA (agent) count across all tenants
        let allAgents = [];
        try {
            allAgents = await api.listAgents().catch(() => []);
            if (!Array.isArray(allAgents)) allAgents = [];
        } catch { allAgents = []; }
        const dragaCount = allAgents.length || tenants.length;

        // â”€â”€ Fetch per-agent documentStats (accurate per-DRAGA docs/chunks) â”€â”€
        const agentStatsMap = {};
        try {
            const docStatsResults = await Promise.all(
                allAgents.map(a => api.documentStats(a.tenant_id, a.agent_id).catch(() => ({})))
            );
            allAgents.forEach((a, i) => {
                agentStatsMap[`${a.tenant_id}/${a.agent_id}`] = docStatsResults[i] || {};
            });
        } catch {}

        // â”€â”€ Hero stats: per-agent documentStats (accurate), fallback to overview â”€â”€
        const agentDocSum = Object.values(agentStatsMap).reduce((s, st) => s + (st.total_documents || 0), 0);
        const agentChunkSum = Object.values(agentStatsMap).reduce((s, st) => s + (st.total_chunks || 0), 0);
        const overviewDocs = overview?.platform?.total_documents;
        const overviewChunks = overview?.platform?.total_chunks;
        const totalDocs = agentDocSum || overviewDocs || tenants.reduce((s, t) => s + (t.document_count || 0), 0);
        const totalChunks = agentChunkSum || overviewChunks || 0;

        document.getElementById('tenantCount').textContent = tenants.length;
        document.getElementById('agentCount').textContent = dragaCount;
        document.getElementById('statTenants').textContent = tenants.length;
        document.getElementById('statDragas').textContent = dragaCount;
        document.getElementById('statDocs').textContent = totalDocs;
        document.getElementById('statChunks').textContent = totalChunks;

        // Anti-hallucination â€” from grounding metrics
        const groundingRate = grounding?.avg_grounding_rate;
        const hallucinationRate = grounding?.avg_nli_hallucination_rate;
        if (groundingRate != null) {
            document.getElementById('statAntiHalluc').textContent = `${(groundingRate * 100).toFixed(0)}%`;
        } else if (hallucinationRate != null) {
            document.getElementById('statAntiHalluc').textContent = `${((1 - hallucinationRate) * 100).toFixed(0)}%`;
        } else {
            document.getElementById('statAntiHalluc').textContent = 'â€”';
        }

        // Load API keys count (auth-scoped, no tenant param needed)
        let totalKeys = 0;
        try {
            const kd = await api.listApiKeys().catch(() => ({ keys: [] }));
            totalKeys = (kd.keys || []).length;
        } catch {}
        document.getElementById('apikeyCount').textContent = totalKeys;
        document.getElementById('statKeys').textContent = totalKeys;

        if (tenants.length === 0) {
            grid.innerHTML = `<div class="empty-state"><div class="icon"><i class="di" style="font-size:36px;width:36px;height:36px"></i></div>
                <h3>Sin Tenants</h3><p>Crea tu primera DRAGA para comenzar</p>
                <button class="btn btn-primary" onclick="showDragaModal()" style="margin-top:12px"><i class="di" style="width:14px;height:14px;vertical-align:middle"></i> Nueva DRAGA</button></div>`;
            return;
        }

        // Build per-tenant doc/chunk counts from overview data
        const overviewTenants = (overview?.tenants || []).reduce((m, t) => { m[t.tenant_id] = t; return m; }, {});

        // Group agents by tenant
        const agentsByTenant = {};
        allAgents.forEach(a => {
            if (!agentsByTenant[a.tenant_id]) agentsByTenant[a.tenant_id] = [];
            agentsByTenant[a.tenant_id].push(a);
        });

        grid.innerHTML = tenants.map(t => {
            const ov = overviewTenants[t.tenant_id] || {};
            const tAgents = agentsByTenant[t.tenant_id] || [];
            // Sum docs/chunks from per-agent documentStats (accurate)
            const agentTotalDocs = tAgents.reduce((s, a) => { const st = agentStatsMap[`${t.tenant_id}/${a.agent_id}`] || {}; return s + (st.total_documents || 0); }, 0);
            const agentTotalChunks = tAgents.reduce((s, a) => { const st = agentStatsMap[`${t.tenant_id}/${a.agent_id}`] || {}; return s + (st.total_chunks || 0); }, 0);
            const docCount = agentTotalDocs || ov.document_count || t.document_count || 0;
            const chunkCount = agentTotalChunks || ov.chunk_count || 0;
            const statusBadge = t.is_active !== false
                ? '<span class="tg-badge" style="background:rgba(34,197,94,0.15);color:var(--success)">Activo</span>'
                : '<span class="tg-badge" style="background:rgba(156,163,175,0.15);color:var(--text-muted)">Inactivo</span>';

            const dragaCards = tAgents.length > 0
                ? tAgents.map(a => {
                    const as = agentStatsMap[`${t.tenant_id}/${a.agent_id}`] || {};
                    const aDocs = as.total_documents || 0;
                    const aChunks = as.total_chunks || 0;
                    return `<a href="draga.html?tenant=${t.tenant_id}&agent=${a.agent_id}" class="draga-subcard">
                        <div class="ds-icon"><i class="di" style="width:22px;height:22px"></i></div>
                        <div class="ds-info">
                            <div class="ds-name">${a.name || a.agent_id}</div>
                            <div class="ds-id">${a.agent_id}</div>
                        </div>
                        <div class="ds-stats">
                            <span>ğŸ“„ ${aDocs}</span>
                            <span>ğŸ“š ${aChunks}</span>
                            <span class="badge badge-success" style="font-size:9px">${a.status || 'active'}</span>
                        </div>
                        <div class="ds-actions">
                            <span class="btn btn-sm" style="font-size:11px;padding:4px 10px;" onclick="event.preventDefault();event.stopPropagation();window.location.href='draga.html?tenant=${t.tenant_id}&agent=${a.agent_id}#knowledge'">ğŸ“š KB</span>
                            <span class="btn btn-sm" style="font-size:11px;padding:4px 10px;" onclick="event.preventDefault();event.stopPropagation();window.location.href='draga.html?tenant=${t.tenant_id}&agent=${a.agent_id}#chat'">ğŸ’¬</span>
                            <span class="btn btn-sm btn-danger" style="font-size:11px;padding:4px 10px;" onclick="event.preventDefault();event.stopPropagation();dashDeleteAgent('${t.tenant_id}','${a.agent_id}','${(a.name||'').replace(/'/g,"\\\'")}')" title="Eliminar DRAGA">ğŸ—‘ï¸</span>
                        </div>
                    </a>`;
                }).join('')
                : '<div style="font-size:12px;color:var(--text-muted);padding:8px 0;text-align:center;">Sin DRAGAs â€” crea una desde el menu superior</div>';

            return `<div class="tenant-group">
                <div class="tg-header" onclick="window.location.href='tenant.html?tenant=${t.tenant_id}'">
                    <div>
                        <div class="tg-name">ğŸ¢ ${t.name} ${statusBadge}</div>
                        <div class="tg-id">${t.tenant_id}</div>
                    </div>
                    <div class="tg-summary">
                        <span class="tg-stat"><i class="di" style="width:14px;height:14px"></i> ${tAgents.length}</span>
                        <span class="tg-stat">ğŸ“„ ${docCount}</span>
                        <span class="tg-stat">ğŸ“š ${chunkCount}</span>
                        <button class="btn btn-sm btn-danger" style="font-size:10px;padding:3px 8px;" onclick="event.stopPropagation();dashDeleteTenant('${t.tenant_id}','${t.name.replace(/'/g,"\\'")}')"
                            title="Eliminar tenant y todas sus DRAGAs (cascada)">ğŸ—‘ï¸ Tenant</button>
                    </div>
                </div>
                <div class="tg-body">
                    <div class="tg-meta">
                        <span>ğŸ§  ${(t.default_model || 'â€”').split('/').pop()}</span>
                        <span>ğŸŒ ${t.response_language || 'â€”'}</span>
                    </div>
                    <div class="tg-dragas-title"><i class="di" style="width:14px;height:14px"></i> DRAGAs (${tAgents.length})</div>
                    <div class="draga-subcards">${dragaCards}</div>
                </div>
            </div>`;
        }).join('');
    } catch (e) {
        grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="icon">âŒ</div>
            <h3>Error</h3><p>${e.message}</p>
            <button class="btn" onclick="loadDashboard()" style="margin-top:12px">ğŸ”„ Reintentar</button></div>`;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE: TENANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTenants() {
    const container = document.getElementById('tenantCards');
    container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    try {
        const data = await api.listTenants(true);
        const tenants = data.tenants || [];
        document.getElementById('tenantCount').textContent = tenants.length;

        if (tenants.length === 0) {
            container.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="icon">ğŸ¢</div>
                <h3>Sin tenants</h3><p>Crea un tenant para comenzar</p></div>`;
            return;
        }

        container.innerHTML = tenants.map(t => `<div class="card">
            <div class="card-header">
                <span class="card-title">${t.name}</span>
                ${t.is_active !== false ? '<span class="badge badge-success">Activo</span>' : '<span class="badge badge-muted">Inactivo</span>'}
            </div>
            <div class="card-meta">
                <code style="background:var(--bg-input);padding:2px 6px;border-radius:4px;font-size:11px;">${t.tenant_id}</code>
            </div>
            ${t.description ? `<div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">${t.description}</div>` : ''}
            <div style="display:flex;gap:10px;font-size:12px;color:var(--text-muted);margin-bottom:14px;flex-wrap:wrap;">
                <span>ğŸ§  ${t.default_model || 'â€”'}</span>
                <span>ğŸŒ ${t.response_language || 'â€”'}</span>
                <span>ğŸ“„ ${t.document_count ?? 0} docs</span>
            </div>
            <div class="card-actions">
                <a href="tenant.html?tenant=${t.tenant_id}" class="btn btn-sm btn-primary" style="text-decoration:none">ğŸ¢ Dashboard</a>
                <button class="btn btn-sm" onclick="editTenant('${t.tenant_id}')">âœï¸ Editar</button>
                <button class="btn btn-sm btn-danger" onclick="deleteTenantAction('${t.tenant_id}','${t.name.replace(/'/g,"\\'")}')">ğŸ—‘ï¸</button>
            </div>
        </div>`).join('');
    } catch (e) {
        container.innerHTML = `<div style="color:var(--danger);padding:20px">âŒ Error: ${e.message}</div>`;
    }
}

function showTenantModal() {
    document.getElementById('tenantModalTitle').textContent = 'Nuevo Tenant';
    document.getElementById('tenantIdInput').value = '';
    document.getElementById('tenantIdInput').disabled = false;
    document.getElementById('tenantNameInput').value = '';
    document.getElementById('tenantDescInput').value = '';
    document.getElementById('tenantModelInput').value = 'anthropic/claude-3-haiku';
    document.getElementById('tenantLangInput').value = 'es';
    document.getElementById('tenantPromptInput').value = '';
    openModal('tenantModal');
}

async function editTenant(id) {
    try {
        const t = await api.getTenant(id);
        document.getElementById('tenantModalTitle').textContent = `Editar: ${t.name}`;
        document.getElementById('tenantIdInput').value = t.tenant_id;
        document.getElementById('tenantIdInput').disabled = true;
        document.getElementById('tenantNameInput').value = t.name || '';
        document.getElementById('tenantDescInput').value = t.description || '';
        document.getElementById('tenantModelInput').value = t.default_model || '';
        document.getElementById('tenantLangInput').value = t.response_language || 'es';
        document.getElementById('tenantPromptInput').value = t.system_prompt || '';
        openModal('tenantModal');
    } catch (e) { toast('Error: ' + e.message, 'error'); }
}

async function saveTenant() {
    const id = document.getElementById('tenantIdInput').value.trim();
    const isEdit = document.getElementById('tenantIdInput').disabled;
    const data = {
        name: document.getElementById('tenantNameInput').value.trim(),
        description: document.getElementById('tenantDescInput').value.trim() || undefined,
        default_model: document.getElementById('tenantModelInput').value.trim() || undefined,
        response_language: document.getElementById('tenantLangInput').value,
    };
    const prompt = document.getElementById('tenantPromptInput').value.trim();
    if (prompt && prompt.length >= 10) data.system_prompt = prompt;

    if (!id || !data.name) { toast('ID y Nombre son requeridos', 'error'); return; }

    try {
        if (isEdit) {
            await api.updateTenant(id, data);
            toast(`Tenant "${data.name}" actualizado`, 'success');
        } else {
            data.tenant_id = id;
            await api.createTenant(data);
            toast(`Tenant "${data.name}" creado`, 'success');
        }
        closeModal('tenantModal');
        loadTenants();
    } catch (e) { toast('Error: ' + e.message, 'error'); }
}

async function deleteTenantAction(id, name) {
    if (!confirm(`Â¿Eliminar tenant "${name}" (${id})?`)) return;
    const delCol = confirm('Â¿Eliminar tambiÃ©n la colecciÃ³n vectorial? (DESTRUCTIVO)');
    try {
        await api.deleteTenant(id, delCol);
        toast(`Tenant "${name}" eliminado`, 'success');
        loadTenants();
    } catch (e) { toast('Error: ' + e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE: AGENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAgents() {
    const container = document.getElementById('agentCards');
    container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    try {
        const [tenantsData, agentsRaw] = await Promise.all([
            api.listTenants(true),
            api.listAgents().catch(() => [])
        ]);
        const tenants = tenantsData.tenants || [];
        const agents = Array.isArray(agentsRaw) ? agentsRaw : [];
        document.getElementById('agentCount').textContent = agents.length;

        // Group agents by tenant
        const agentsByTenant = {};
        agents.forEach(a => {
            if (!agentsByTenant[a.tenant_id]) agentsByTenant[a.tenant_id] = [];
            agentsByTenant[a.tenant_id].push(a);
        });

        if (tenants.length === 0) {
            container.innerHTML = `<div class="empty-state" style="text-align:center;padding:48px 20px;"><div class="icon">ğŸ¢</div>
                <h3>Sin tenants</h3><p>Primero necesitÃ¡s crear un tenant (organizaciÃ³n) para luego agregarle DRAGAs.</p>
                <button class="btn btn-primary" onclick="showTenantModal()" style="margin-top:12px">ğŸ¢ Crear Tenant</button></div>`;
            return;
        }

        // Render tenants as sections, each with its DRAGAs listed
        container.innerHTML = tenants.map(t => {
            const tAgents = agentsByTenant[t.tenant_id] || [];
            const agentRows = tAgents.length > 0
                ? tAgents.map(a => `<div class="card" style="margin:0;padding:12px 16px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <i class="di" style="width:16px;height:16px"></i>
                            <strong style="font-size:14px;">${a.name}</strong>
                            <code style="font-size:10px;background:var(--bg-input);padding:1px 6px;border-radius:4px;">${a.agent_id}</code>
                            <span class="badge badge-success" style="font-size:9px;">${a.status || 'active'}</span>
                        </div>
                        <div style="display:flex;gap:6px;">
                            <a href="draga.html?tenant=${t.tenant_id}&agent=${a.agent_id}" class="btn btn-sm btn-primary" style="text-decoration:none;font-size:11px;"><i class="di" style="width:12px;height:12px"></i> Dashboard</a>
                            <a href="draga.html?tenant=${t.tenant_id}&agent=${a.agent_id}#chat" class="btn btn-sm" style="text-decoration:none;font-size:11px;">ğŸ’¬</a>
                            <button class="btn btn-sm btn-danger" style="font-size:11px;" onclick="deleteAgentAction('${t.tenant_id}','${a.agent_id}','${(a.name||"").replace(/'/g,"\\\'")}')" title="Eliminar DRAGA">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    ${a.description ? `<div style="font-size:11px;color:var(--text-secondary);margin-top:4px;margin-left:24px;">${a.description}</div>` : ''}
                    <div style="display:flex;gap:10px;font-size:10px;color:var(--text-muted);margin-top:6px;margin-left:24px;">
                        <span>Creado: ${a.created_at ? new Date(a.created_at).toLocaleDateString('es') : 'â€”'}</span>
                    </div>
                </div>`).join('')
                : '<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:13px;">Sin DRAGAs en este tenant <button class="btn btn-sm btn-primary" onclick="showDragaModalForTenant(\''+t.tenant_id+'\')"><i class="di" style="width:12px;height:12px;vertical-align:-1px"></i> Crear DRAGA</button></div>';

            return `<div class="section" style="margin-bottom:20px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:16px;">ğŸ¢</span>
                        <span style="font-weight:700;font-size:15px;">${t.name}</span>
                        <code style="font-size:10px;background:var(--bg-input);padding:1px 6px;border-radius:4px;">${t.tenant_id}</code>
                        ${t.is_active !== false ? '<span class="badge badge-success" style="font-size:9px">Activo</span>' : '<span class="badge badge-muted" style="font-size:9px">Inactivo</span>'}
                        <span style="font-size:11px;color:var(--text-muted);margin-left:4px;">${tAgents.length} DRAGA${tAgents.length !== 1 ? 's' : ''}</span>
                    </div>
                    <button class="btn btn-sm" onclick="showDragaModalForTenant('${t.tenant_id}')" title="Crear DRAGA en ${t.name}"><i class="di" style="width:12px;height:12px;vertical-align:-1px"></i> + DRAGA</button>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px;">${agentRows}</div>
            </div>`;
        }).join('');
    } catch (e) {
        container.innerHTML = `<div style="color:var(--danger);padding:20px">âŒ Error: ${e.message}</div>`;
    }
}

// showAgentModal and saveAgent removed â€” consolidated into dragaModal flow (showDragaModal / createDraga)

async function deleteAgentAction(tenantId, agentId, name) {
    if (!confirm(`Â¿Eliminar DRAGA "${name}" (${agentId}) del tenant "${tenantId}"?\n\nEsto eliminarÃ¡ la DRAGA, sus documentos, chunks y vectores (cascada).`)) return;
    try {
        await api.deleteAgent(tenantId, agentId);
        toast(`DRAGA "${name}" eliminada`, 'success');
        loadAgents();
    } catch (e) { toast('Error: ' + e.message, 'error'); }
}

// Dashboard-level delete helpers (reload dashboard after action)
async function dashDeleteTenant(id, name) {
    if (!confirm(`âš ï¸ Â¿Eliminar tenant "${name}" (${id})?\n\nEsto eliminarÃ¡ el tenant Y TODAS sus DRAGAs, documentos, chunks y vectores (borrado en cascada).`)) return;
    if (!confirm(`â˜¢ï¸ CONFIRMACIÃ“N FINAL\n\nVas a eliminar:\nâ€¢ Tenant: ${name}\nâ€¢ Todas sus DRAGAs\nâ€¢ Todos los documentos y vectores\n\nÂ¿Continuar?`)) return;
    try {
        await api.deleteTenant(id, true);
        toast(`Tenant "${name}" y todas sus DRAGAs eliminados`, 'success');
        loadDashboard();
    } catch (e) { toast('Error: ' + e.message, 'error'); }
}

async function dashDeleteAgent(tenantId, agentId, name) {
    if (!confirm(`Â¿Eliminar DRAGA "${name}" (${agentId})?\n\nEsto eliminarÃ¡ la DRAGA, sus documentos, chunks y vectores (cascada).`)) return;
    try {
        await api.deleteAgent(tenantId, agentId);
        toast(`DRAGA "${name}" eliminada`, 'success');
        loadDashboard();
    } catch (e) { toast('Error: ' + e.message, 'error'); }
}

async function viewAgentStats(tenantId, agentId) {
    try {
        const stats = await api.documentStats(tenantId, agentId);
        alert(JSON.stringify(stats, null, 2));
    } catch (e) { toast('Error: ' + e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE: API KEYS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadApiKeys() {
    const container = document.getElementById('apiKeysList');
    container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    try {
        // Load all API keys (auth-scoped)
        const keysData = await api.listApiKeys().catch(() => ({ keys: [] }));
        const allKeys = (keysData.keys || []);

        document.getElementById('apikeyCount').textContent = allKeys.length;

        if (allKeys.length === 0) {
            container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ”‘</div>
                <h3>Sin API Keys</h3><p>Crea una clave de acceso para integrar tus aplicaciones</p>
                <button class="btn btn-primary" onclick="showApiKeyModal()" style="margin-top:12px">ğŸ”‘ Nueva API Key</button></div>`;
            return;
        }

        container.innerHTML = `<div class="card" style="overflow-x:auto;"><table class="table">
            <thead><tr><th>Label</th><th>Tenant</th><th>Prefijo</th><th>Tipo</th><th>Creada</th><th>Expira</th><th></th></tr></thead>
            <tbody>${allKeys.map(k => `<tr>
                <td><strong>${k.label || 'â€”'}</strong></td>
                <td><code style="background:var(--bg-input);padding:2px 6px;border-radius:4px;font-size:11px;">${k._tenant || k.tenant_id}</code></td>
                <td><code style="font-size:11px">${k.key_prefix || 'â€”'}</code></td>
                <td><span class="badge">${k.key_type || 'secret'}</span></td>
                <td style="font-size:12px;color:var(--text-secondary)">${k.created_at ? new Date(k.created_at).toLocaleDateString('es') : 'â€”'}</td>
                <td style="font-size:12px;color:var(--text-secondary)">${k.expires_at ? new Date(k.expires_at).toLocaleDateString('es') : 'Nunca'}</td>
                <td><button class="btn btn-sm btn-danger" onclick="revokeApiKeyAction('${k.key_id}','${(k.label||"").replace(/'/g,"\\'")}')">Revocar</button></td>
            </tr>`).join('')}</tbody></table></div>`;
    } catch (e) {
        container.innerHTML = `<div style="color:var(--danger);padding:20px">âŒ Error: ${e.message}</div>`;
    }
}

async function showApiKeyModal() {
    const sel = document.getElementById('akTenantSelect');
    sel.innerHTML = '<option value="">Cargando...</option>';
    openModal('apiKeyModal');
    try {
        const data = await api.listTenants(true);
        const tenants = data.tenants || [];
        sel.innerHTML = tenants.map(t => `<option value="${t.tenant_id}">${t.name} (${t.tenant_id})</option>`).join('');
    } catch (e) { sel.innerHTML = '<option value="">Error</option>'; }
}

async function createApiKeyAction() {
    const tenantId = document.getElementById('akTenantSelect').value;
    const label = document.getElementById('akLabelInput').value.trim();
    if (!tenantId || !label) { toast('Tenant y Label son requeridos', 'error'); return; }

    const scopes = [...document.querySelectorAll('.akScope:checked')].map(c => c.value);
    if (scopes.length === 0) { toast('Selecciona al menos un scope', 'error'); return; }

    try {
        const result = await api.createApiKey({ tenant_id: tenantId, label, scopes });
        closeModal('apiKeyModal');
        document.getElementById('akLabelInput').value = '';

        // Show the raw key (only shown once)
        const keyDisplay = result.raw_key || result.key || 'â€”';
        const copyMsg = `âœ… API Key creada exitosamente!\n\nğŸ”‘ Clave: ${keyDisplay}\n\nâš ï¸ Guarda esta clave ahora â€” no se podrÃ¡ ver de nuevo.`;
        alert(copyMsg);
        try { await navigator.clipboard.writeText(keyDisplay); toast('Clave copiada al portapapeles', 'success'); } catch {}

        loadApiKeys();
    } catch (e) { toast('Error: ' + e.message, 'error'); }
}

async function revokeApiKeyAction(keyId, label) {
    if (!confirm(`Â¿Revocar API Key "${label}"? Esta acciÃ³n es irreversible.`)) return;
    try {
        await api.revokeApiKey(keyId);
        toast(`API Key "${label}" revocada`, 'success');
        loadApiKeys();
    } catch (e) { toast('Error: ' + e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE: ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadAnalytics() {
    loadHealthStatus();
    loadFeedbackStats();
    loadSystemStats();
    loadQualityGlobal();
    loadFeedbackList();
}

async function loadHealthStatus() {
    const grid = document.getElementById('healthGrid');
    // Map backend service keys â†’ friendly role labels (vector DB is dynamic, not hardcoded)
    const VECTOR_DBS = ['chromadb','chroma','qdrant','pgvector','milvus','weaviate','pinecone','faiss'];
    function serviceLabel(key) {
        const lower = key.toLowerCase();
        if (VECTOR_DBS.some(db => lower.includes(db))) return { role: 'ğŸ—„ï¸ Vector DB', impl: key };
        if (lower === 'redis' || lower.includes('cache'))  return { role: 'âš¡ Cache', impl: key };
        if (lower.includes('embed'))   return { role: 'ğŸ”¢ Embeddings', impl: key };
        if (lower === 'llm' || lower.includes('model'))    return { role: 'ğŸ§  LLM', impl: key };
        return { role: key, impl: null };
    }
    try {
        const deep = await api.healthDeep();
        const status = deep.status || 'unknown';
        const checks = deep.checks || {};
        const statusColor = status === 'healthy' ? 'var(--success)' : status === 'degraded' ? 'var(--warning)' : 'var(--danger)';
        const statusIcon = status === 'healthy' ? 'âœ…' : status === 'degraded' ? 'âš ï¸' : 'âŒ';

        let html = `<div class="stat-card" style="border-left:3px solid ${statusColor}">
            <div class="label">ğŸ§  DRAGA API</div>
            <div class="value" style="color:${statusColor};font-size:16px;">${statusIcon} ${status.charAt(0).toUpperCase() + status.slice(1)}</div></div>`;

        for (const [name, info] of Object.entries(checks)) {
            const ok = info.ok;
            const color = ok ? 'var(--success)' : 'var(--danger)';
            const icon = ok ? 'âœ…' : 'âŒ';
            const latency = info.latency_ms != null ? `${info.latency_ms.toFixed(0)}ms` : '';
            const error = !ok && info.error ? `<div style="font-size:10px;color:var(--text-muted);margin-top:2px">${info.error}</div>` : '';
            const { role, impl } = serviceLabel(name);
            const implTag = impl ? `<div style="font-size:9px;color:var(--text-muted);font-family:monospace;margin-top:1px">${impl}</div>` : '';
            html += `<div class="stat-card" style="border-left:3px solid ${color}">
                <div class="label">${role}</div>${implTag}
                <div class="value" style="color:${color};font-size:14px;">${icon} ${ok ? 'OK' : 'Error'} ${latency ? '<span style="font-size:11px;color:var(--text-muted);font-weight:400">' + latency + '</span>' : ''}</div>${error}</div>`;
        }
        grid.innerHTML = html;
    } catch {
        grid.innerHTML = `<div class="stat-card" style="border-left:3px solid var(--danger)">
            <div class="label">ğŸ§  DRAGA API</div><div class="value" style="color:var(--danger);font-size:16px;">âŒ Offline</div></div>`;
    }
}

async function loadFeedbackStats() {
    const panel = document.getElementById('feedbackPanel');
    try {
        const stats = await api.feedbackStats();
        const posRate = stats.positive_rate || 0;
        panel.innerHTML = `
            <div style="margin-bottom:14px">
                <div style="display:flex;justify-content:space-between;margin-bottom:6px">
                    <span style="font-size:13px">SatisfacciÃ³n</span>
                    <span style="font-size:13px;font-weight:700;color:${posRate >= 70 ? 'var(--success)' : posRate >= 40 ? 'var(--warning)' : 'var(--danger)'}">${posRate.toFixed(0)}%</span>
                </div>
                <div class="progress-bar"><div class="fill" style="width:${posRate}%"></div></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:12px">
                <div>ğŸ‘ Positivos: <strong>${stats.positive_count}</strong></div>
                <div>ğŸ‘ Negativos: <strong>${stats.negative_count}</strong></div>
                <div>ğŸ“Š Total: <strong>${stats.total_feedback || 0}</strong></div>
                <div>ğŸ“‹ Sin revisar: <strong>${stats.unreviewed_count}</strong></div>
            </div>`;
    } catch {
        panel.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text-muted)">
            <div style="font-size:24px;margin-bottom:8px">ğŸ“Š</div>
            <div style="font-size:12px">Feedback service no disponible</div></div>`;
    }
}

async function loadSystemStats() {
    const panel = document.getElementById('systemPanel');
    try {
        const [overview, agents] = await Promise.all([
            api.adminDashboardOverview().catch(() => ({})),
            api.listAgents().catch(() => [])
        ]);
        const p = overview.platform || {};
        const op = overview.operational || {};
        // If adminDashboardOverview docs/chunks are 0 or missing, fetch from per-agent stats
        let sysDocs = p.total_documents || 0;
        let sysChunks = p.total_chunks || 0;
        const agentList = Array.isArray(agents) ? agents : [];
        if ((!sysDocs || !sysChunks) && agentList.length) {
            try {
                const docStats = await Promise.all(agentList.map(a => api.documentStats(a.tenant_id, a.agent_id).catch(() => ({}))));
                const sumD = docStats.reduce((s, st) => s + (st.total_documents || 0), 0);
                const sumC = docStats.reduce((s, st) => s + (st.total_chunks || 0), 0);
                if (!sysDocs) sysDocs = sumD;
                if (!sysChunks) sysChunks = sumC;
            } catch {}
        }
        const items = [
            ['DRAGAs', agentList.length || p.total_tenants || 'â€”'],
            ['Documentos', sysDocs || 'â€”'],
            ['Chunks', sysChunks || 'â€”'],
            ['Requests', op.total_requests ?? 'â€”'],
        ];
        panel.innerHTML = `<div style="font-size:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
            ${items.map(([k, v]) => `<div><span style="color:var(--text-muted)">${k}:</span> <strong>${v}</strong></div>`).join('')}
        </div>`;
    } catch {
        panel.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text-muted)">
            <div style="font-size:20px;margin-bottom:6px">ğŸ“Š</div>
            <div style="font-size:12px">Dashboard no disponible</div></div>`;
    }
}

// Aggregated quality metrics across ALL DRAGAs (reference data at platform level)
async function loadQualityGlobal() {
    try {
        const agents = await api.listAgents().catch(() => []);
        const agentList = Array.isArray(agents) ? agents : [];
        if (!agentList.length) return;

        // Fetch documentStats + grounding + coverage + feedback for all agents in parallel
        const [docStatsRes, groundingRes, coverageRes, fbRes] = await Promise.all([
            Promise.all(agentList.map(a => api.documentStats(a.tenant_id, a.agent_id).catch(() => ({})))),
            api.metricsGrounding().catch(() => ({})),
            Promise.all(agentList.map(a => api.metricsCoverage(a.tenant_id, a.agent_id).catch(() => ({})))),
            api.feedbackStats().catch(() => ({}))
        ]);

        // Aggregate docs & chunks from per-agent documentStats
        let totalDocs = 0, totalChunks = 0;
        docStatsRes.forEach(s => {
            totalDocs += s.total_documents || 0;
            totalChunks += s.total_chunks || 0;
        });
        document.getElementById('gqDocs').textContent = totalDocs || 'â€”';
        document.getElementById('gqChunks').textContent = totalChunks || 'â€”';

        // Coverage â€” average across agents
        const covRates = coverageRes.filter(c => c.coverage_rate != null).map(c => c.coverage_rate);
        document.getElementById('gqCoverage').textContent = covRates.length
            ? (covRates.reduce((a, b) => a + b, 0) / covRates.length * 100).toFixed(0) + '%' : 'â€”';

        // Grounding â€” from global endpoint
        document.getElementById('gqGrounding').textContent = groundingRes.avg_grounding_rate != null
            ? (groundingRes.avg_grounding_rate * 100).toFixed(0) + '%'
            : groundingRes.grounding_rate != null ? (groundingRes.grounding_rate * 100).toFixed(0) + '%' : 'â€”';
        document.getElementById('gqConfidence').textContent = groundingRes.avg_confidence != null
            ? (groundingRes.avg_confidence * 100).toFixed(0) + '%' : 'â€”';
        document.getElementById('gqCacheHit').textContent = groundingRes.cache_hit_rate != null
            ? (groundingRes.cache_hit_rate * 100).toFixed(0) + '%' : 'â€”';

        // Feedback total
        document.getElementById('gqFeedback').textContent = fbRes.total_feedback ?? 'â€”';
    } catch {
        // Silent fail â€” these are reference metrics
    }
}

async function loadFeedbackList() {
    const tbody = document.getElementById('feedbackTableBody');
    try {
        const data = await api.listFeedback({ limit: 20 });
        const items = Array.isArray(data) ? data : (data.entries || data.feedback || data.items || []);
        if (items.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="icon">ğŸ“</div><h3>Sin feedback</h3></div></td></tr>`;
            return;
        }
        tbody.innerHTML = items.map(f => `<tr>
            <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${f.query || ''}">${f.query || 'â€”'}</td>
            <td>${f.rating === 'positive' ? '<span class="badge badge-success">ğŸ‘</span>' : '<span class="badge badge-danger">ğŸ‘</span>'}</td>
            <td>${f.confidence != null ? `${(f.confidence * 100).toFixed(0)}%` : 'â€”'}</td>
            <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${f.comment || 'â€”'}</td>
            <td>${f.reviewed ? '<span class="badge badge-success">âœ“</span>' : '<span class="badge badge-warning">pendiente</span>'}</td>
            <td>${!f.reviewed ? `<button class="btn btn-sm" onclick="markReviewed('${f.feedback_id || f.id}')">âœ“</button>` : ''}</td>
        </tr>`).join('');
    } catch {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:24px;color:var(--text-muted)">
            <div style="font-size:20px;margin-bottom:6px">ğŸ’¬</div>Feedback service no disponible</td></tr>`;
    }
}

async function markReviewed(id) {
    try {
        await api.markReviewed(id, 'Revisado desde admin');
        toast('Feedback revisado', 'success');
        loadFeedbackList();
    } catch (e) { toast('Error: ' + e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE: SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSystem() {
    loadMcpTools();
    loadMcpPrompts();
    loadMcpResources();
    loadModels();
    // Populate tenant selectors in System module
    try {
        const data = await api.listTenants(true);
        const tenants = data.tenants || [];
        const sel = document.getElementById('cacheTenantId');
        sel.innerHTML = tenants.map(t => `<option value="${t.tenant_id}">${t.name} (${t.tenant_id})</option>`).join('') || '<option value="">Sin tenants</option>';
    } catch {}
}

async function loadMcpTools() {
    try {
        const data = await api.mcpTools();
        const tools = data.tools || [];
        document.getElementById('mcpToolsPanel').innerHTML = tools.length ? tools.map(t => `
            <div class="mcp-item">
                <div class="name">ğŸ”§ ${t.name}</div>
                <div class="desc">${(t.description || '').split('\n')[0]}</div>
                <div class="params">${Object.entries(t.parameters || {}).map(([k, v]) =>
                    `<span class="badge badge-muted">${k}: ${v.type}</span>`
                ).join(' ')}</div>
            </div>`).join('') : '<div class="empty-state"><p>Sin tools</p></div>';
    } catch (e) {
        document.getElementById('mcpToolsPanel').innerHTML = `<div style="color:var(--danger);font-size:12px">âŒ ${e.message}</div>`;
    }
}

async function loadMcpPrompts() {
    try {
        const data = await api.mcpPrompts();
        const prompts = data.prompts || [];
        document.getElementById('mcpPromptsPanel').innerHTML = prompts.length ? prompts.map(p => `
            <div class="mcp-item">
                <div class="name">ğŸ“ ${p.name}</div>
                <div class="desc">${(p.description || '').split('\n')[0]}</div>
                <div class="params">${(p.arguments || []).map(a => `<span class="badge badge-info">${a}</span>`).join(' ')}</div>
            </div>`).join('') : '<div class="empty-state"><p>Sin prompts</p></div>';
    } catch (e) {
        document.getElementById('mcpPromptsPanel').innerHTML = `<div style="color:var(--danger);font-size:12px">âŒ ${e.message}</div>`;
    }
}

async function loadMcpResources() {
    try {
        const data = await api.mcpResources();
        const resources = data.resources || [];
        document.getElementById('mcpResourcesPanel').innerHTML = resources.length ? resources.map(r => `
            <div class="mcp-item" style="display:flex;align-items:center;gap:10px;">
                <span style="font-size:12px;font-weight:700;color:var(--info);flex:1">${r.uri}</span>
                <button class="btn btn-sm" onclick="fetchResource('${r.uri}')">ğŸ“¥</button>
            </div>`).join('') : '<div class="empty-state"><p>Sin resources</p></div>';
    } catch (e) {
        document.getElementById('mcpResourcesPanel').innerHTML = `<div style="color:var(--danger);font-size:12px">âŒ ${e.message}</div>`;
    }
}

async function fetchResource(uri) {
    try {
        const path = uri.replace('rag://', '');
        const data = await api.mcpGetResource(path);
        alert(JSON.stringify(data, null, 2));
    } catch (e) { toast('Error: ' + e.message, 'error'); }
}

async function loadModels() {
    try {
        const data = await api.listModels();
        const models = data.data || [];
        document.getElementById('modelsPanel').innerHTML = models.length ? models.map(m => `
            <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
                <span style="font-size:18px">ğŸ§ </span>
                <div><div style="font-weight:700;font-size:13px">${m.id}</div>
                <div style="font-size:11px;color:var(--text-muted)">${m.description || m.owned_by || 'â€”'}</div></div>
            </div>`).join('') : '<div class="empty-state"><p>Sin modelos</p></div>';
    } catch (e) {
        document.getElementById('modelsPanel').innerHTML = `<div style="color:var(--danger);font-size:12px">âŒ ${e.message}</div>`;
    }
}

async function clearCacheAction() {
    const tenantId = document.getElementById('cacheTenantId').value;
    if (!tenantId) { toast('Selecciona un tenant', 'warning'); return; }
    if (!confirm(`Â¿Limpiar cachÃ© del tenant "${tenantId}"?`)) return;
    try {
        await api.clearCache(tenantId);
        toast(`CachÃ© de "${tenantId}" limpiado`, 'success');
    } catch (e) { toast('Error: ' + e.message, 'error'); }
}

async function resetReindexAction() {
    const tenantId = document.getElementById('cacheTenantId').value;
    if (!tenantId) { toast('Selecciona un tenant', 'warning'); return; }
    if (!confirm(`âš ï¸ RESET NUCLEAR para "${tenantId}"\n\nEsto eliminarÃ¡ toda la colecciÃ³n y re-indexarÃ¡.\n\nÂ¿Continuar?`)) return;
    if (!confirm('Â¿ESTÃS SEGURO? No se puede deshacer.')) return;
    try {
        toast('Ejecutando reset...', 'info');
        const result = await api.resetReindex(tenantId);
        toast(`Reset completo: ${result.successful || 0} docs en ${result.elapsed_seconds?.toFixed(1) || '?'}s`, 'success');
    } catch (e) { toast('Error: ' + e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE: ROADMAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSprint(header) {
    const body = header.nextElementSibling;
    const toggle = header.querySelector('.s-toggle');
    body.classList.toggle('open');
    toggle.textContent = body.classList.contains('open') ? 'â–¾' : 'â–¸';
}

function calcRoadmapProgress() {
    const checks = document.querySelectorAll('#mod-roadmap .task-check');
    let done = 0, total = 0;
    checks.forEach(c => { total++; if (c.textContent.trim() === 'â˜‘ï¸') done++; });
    const pct = total ? Math.round(done / total * 100) : 0;
    document.getElementById('roadmapPct').textContent = pct + '%';
    document.getElementById('roadmapFill').style.width = pct + '%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init() {
    // Auth guard: admin requires platform_admin or tenant_admin
    if (!AuthGuard.require({ requiredRole: Roles.TENANT_ADMIN })) return;

    const hash = window.location.hash.replace('#', '') || 'dashboard';
    if (modules.includes(hash)) nav(hash);
    else nav('dashboard');

    checkHealth();
    setInterval(checkHealth, 30000);

    window.addEventListener('hashchange', () => {
        const h = window.location.hash.replace('#', '');
        if (modules.includes(h)) nav(h);
    });
})();
</script>
</body>
</html>

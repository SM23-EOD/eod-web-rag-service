<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envios23 RAG Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“¦</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="src/api-client.js"></script>
    <style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN TOKENS - Envios23 Brand
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
    --primary: #ec8951;
    --primary-dark: #d97a45;
    --primary-light: #fde8d8;
    --primary-alpha: rgba(236,137,81,0.15);
    --secondary: #485ff2;
    --success: #22c55e;
    --danger: #ef4444;
    --warning: #f59e0b;
    --info: #3b82f6;
    --bg-dark: #131a22;
    --bg-main: #1a2332;
    --bg-card: #222d3a;
    --bg-input: #2a3747;
    --bg-hover: #2f3e50;
    --text-primary: #f0f2f5;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --border: #2a3747;
    --border-light: #334155;
    --shadow: 0 4px 24px rgba(0,0,0,0.25);
    --radius: 10px;
    --radius-sm: 6px;
    --radius-lg: 16px;
    --transition: 0.2s ease;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
    font-family: 'Lato', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-dark);
    color: var(--text-primary);
    overflow: hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app {
    display: grid;
    grid-template-columns: 64px 1fr;
    grid-template-rows: 52px 1fr;
    height: calc(100vh - 33px);
}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
    grid-column: 1 / -1;
    background: var(--bg-main);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    z-index: 100;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.header-logo {
    font-size: 20px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--primary);
}

.header-logo span { font-size: 22px; }

.header-title {
    font-size: 13px;
    color: var(--text-muted);
    font-weight: 400;
    border-left: 1px solid var(--border);
    padding-left: 12px;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

.health-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    background: rgba(34,197,94,0.12);
    color: var(--success);
}
.health-badge.offline {
    background: rgba(239,68,68,0.12);
    color: var(--danger);
}
.health-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--success);
    animation: pulse-dot 2s infinite;
}
.health-badge.offline .health-dot {
    background: var(--danger);
    animation: none;
}

@keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

/* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
    background: var(--bg-main);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 0;
    gap: 4px;
    z-index: 90;
}

.nav-btn {
    width: 44px; height: 44px;
    border-radius: var(--radius);
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
    position: relative;
}

.nav-btn:hover {
    background: var(--bg-hover);
    color: var(--text-secondary);
}

.nav-btn.active {
    background: var(--primary-alpha);
    color: var(--primary);
}

.nav-btn .tooltip {
    position: absolute;
    left: 54px;
    background: var(--bg-card);
    color: var(--text-primary);
    padding: 4px 10px;
    border-radius: var(--radius-sm);
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: var(--transition);
    border: 1px solid var(--border);
    z-index: 200;
}

.nav-btn:hover .tooltip {
    opacity: 1;
}

.nav-sep {
    width: 28px;
    height: 1px;
    background: var(--border);
    margin: 6px 0;
}

/* â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main {
    overflow-y: auto;
    padding: 24px;
    background: var(--bg-dark);
}

.main::-webkit-scrollbar { width: 6px; }
.main::-webkit-scrollbar-track { background: transparent; }
.main::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* â”€â”€ MODULE VIEWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.module { display: none; }
.module.active { display: block; }

.module-header {
    margin-bottom: 24px;
}

.module-header h1 {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 4px;
}

.module-header p {
    color: var(--text-muted);
    font-size: 14px;
}

/* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cards-row {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 20px;
    border: 1px solid var(--border);
    transition: var(--transition);
}

.stat-card:hover {
    border-color: var(--primary);
    transform: translateY(-1px);
}

.stat-card .label {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.stat-card .value {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
}

.stat-card .sub {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
}

.stat-card .icon {
    float: right;
    font-size: 24px;
    opacity: 0.5;
}

/* â”€â”€ PANELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel {
    background: var(--bg-card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    margin-bottom: 20px;
    overflow: hidden;
}

.panel-head {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 700;
    font-size: 14px;
}

.panel-body {
    padding: 20px;
}

.panel-body.no-pad { padding: 0; }

/* â”€â”€ TABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.data-table th {
    text-align: left;
    padding: 10px 16px;
    color: var(--text-muted);
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-main);
    position: sticky;
    top: 0;
}

.data-table td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
}

.data-table tr:hover td {
    background: var(--bg-hover);
}

.data-table tr:last-child td { border-bottom: none; }

/* â”€â”€ BADGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
}

.badge-success { background: rgba(34,197,94,0.12); color: var(--success); }
.badge-danger { background: rgba(239,68,68,0.12); color: var(--danger); }
.badge-warning { background: rgba(245,158,11,0.12); color: var(--warning); }
.badge-info { background: rgba(59,130,246,0.12); color: var(--info); }
.badge-muted { background: rgba(100,116,139,0.12); color: var(--text-muted); }

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--bg-input);
    color: var(--text-primary);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
}

.btn:hover { background: var(--bg-hover); border-color: var(--border-light); }

.btn-primary {
    background: var(--primary);
    border-color: var(--primary);
    color: #fff;
}
.btn-primary:hover { background: var(--primary-dark); }

.btn-danger {
    background: transparent;
    border-color: var(--danger);
    color: var(--danger);
}
.btn-danger:hover { background: rgba(239,68,68,0.12); }

.btn-sm { padding: 5px 10px; font-size: 12px; }

.btn-icon {
    width: 32px; height: 32px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
}

/* â”€â”€ FORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-control {
    width: 100%;
    padding: 10px 14px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--bg-input);
    color: var(--text-primary);
    font-size: 14px;
    font-family: inherit;
    transition: var(--transition);
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-alpha);
}

textarea.form-control { min-height: 80px; resize: vertical; }

select.form-control { cursor: pointer; }

/* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.modal-overlay.show { display: flex; }

.modal {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    width: 90%;
    max-width: 560px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: var(--shadow);
}

.modal-head {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 700;
    font-size: 16px;
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 20px;
    cursor: pointer;
}

.modal-body { padding: 24px; }

.modal-foot {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast-container {
    position: fixed;
    top: 64px;
    right: 20px;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.toast {
    padding: 12px 20px;
    border-radius: var(--radius);
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    animation: toast-in 0.3s ease;
    box-shadow: var(--shadow);
    min-width: 280px;
}

.toast-success { background: #166534; color: #bbf7d0; }
.toast-error { background: #991b1b; color: #fecaca; }
.toast-info { background: #1e3a5f; color: #bfdbfe; }

@keyframes toast-in {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* â”€â”€ GRID HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }

/* â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 20px;
    height: calc(100vh - 100px);
}

.chat-main {
    display: flex;
    flex-direction: column;
    background: var(--bg-card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    overflow: hidden;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.chat-messages::-webkit-scrollbar { width: 5px; }
.chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.chat-input-bar {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 10px;
}

.chat-input-bar input {
    flex: 1;
    padding: 10px 16px;
    border-radius: 24px;
    border: 1px solid var(--border);
    background: var(--bg-input);
    color: var(--text-primary);
    font-size: 14px;
    font-family: inherit;
}

.chat-input-bar input:focus {
    outline: none;
    border-color: var(--primary);
}

.chat-input-bar button {
    width: 42px; height: 42px;
    border-radius: 50%;
    border: none;
    background: var(--primary);
    color: #fff;
    font-size: 18px;
    cursor: pointer;
    transition: var(--transition);
}

.chat-input-bar button:hover { background: var(--primary-dark); }
.chat-input-bar button:disabled { opacity: 0.4; cursor: not-allowed; }

.msg {
    margin-bottom: 16px;
    display: flex;
    gap: 10px;
}

.msg-avatar {
    width: 32px; height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
}

.msg.user .msg-avatar { background: var(--primary-alpha); }
.msg.assistant .msg-avatar { background: rgba(59,130,246,0.15); }

.msg-body {
    flex: 1;
    min-width: 0;
}

.msg-sender {
    font-size: 12px;
    font-weight: 700;
    margin-bottom: 4px;
    color: var(--text-muted);
}

.msg-content {
    font-size: 14px;
    line-height: 1.6;
    color: var(--text-secondary);
}

.msg-content p { margin-bottom: 8px; }
.msg-content p:last-child { margin-bottom: 0; }
.msg-content code {
    background: var(--bg-input);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 13px;
}

.msg-content ul, .msg-content ol {
    margin-left: 20px;
    margin-bottom: 8px;
}

.msg-meta {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    align-items: center;
    flex-wrap: wrap;
}

.feedback-comment-form {
    display: flex;
    gap: 6px;
    width: 100%;
    margin-top: 6px;
    align-items: flex-start;
}

.feedback-comment-form textarea {
    flex: 1;
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-family: inherit;
    resize: vertical;
    min-height: 36px;
    max-height: 100px;
    background: var(--bg-input);
    color: var(--text);
}

.feedback-comment-form textarea:focus {
    outline: none;
    border-color: var(--primary);
}

.feedback-comment-form .btn-send-comment {
    padding: 6px 14px;
    font-size: 12px;
    white-space: nowrap;
    align-self: flex-end;
}

.feedback-rating-selected {
    opacity: 1 !important;
    font-size: 18px;
}

.msg-sources {
    margin-top: 10px;
    padding: 10px 14px;
    background: var(--bg-input);
    border-radius: var(--radius-sm);
    font-size: 12px;
    color: var(--text-muted);
}

.msg-sources summary {
    cursor: pointer;
    font-weight: 600;
    color: var(--text-secondary);
}

.chat-sidebar {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.chat-config {
    background: var(--bg-card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 16px;
}

.chat-config h3 {
    font-size: 13px;
    font-weight: 700;
    margin-bottom: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* â”€â”€ UPLOAD ZONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.upload-zone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 40px 20px;
    text-align: center;
    color: var(--text-muted);
    cursor: pointer;
    transition: var(--transition);
    margin-bottom: 20px;
}

.upload-zone:hover, .upload-zone.dragover {
    border-color: var(--primary);
    background: var(--primary-alpha);
    color: var(--primary);
}

.upload-zone .icon { font-size: 36px; margin-bottom: 8px; }
.upload-zone p { font-size: 14px; }
.upload-zone .sub { font-size: 12px; margin-top: 4px; }

/* â”€â”€ HEALTH GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.health-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
}

.health-item {
    background: var(--bg-input);
    border-radius: var(--radius-sm);
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    border: 1px solid var(--border);
}

.health-item .dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
}

.health-item .name {
    font-weight: 600;
    font-size: 13px;
}

.health-item .status {
    font-size: 11px;
    color: var(--text-muted);
}

/* â”€â”€ PROGRESS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.progress-bar {
    height: 8px;
    background: var(--bg-input);
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar .fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
}

/* â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state {
    text-align: center;
    padding: 48px 20px;
    color: var(--text-muted);
}

.empty-state .icon { font-size: 48px; margin-bottom: 12px; }
.empty-state h3 { font-size: 16px; color: var(--text-secondary); margin-bottom: 6px; }
.empty-state p { font-size: 13px; }

/* â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.spinner {
    width: 20px; height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    display: inline-block;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-overlay {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    gap: 10px;
    color: var(--text-muted);
    font-size: 14px;
}

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 1024px) {
    .chat-layout { grid-template-columns: 1fr; }
    .chat-sidebar { display: none; }
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
}

@media (max-width: 768px) {
    .app { grid-template-columns: 1fr; grid-template-rows: 52px 1fr 56px; }
    .sidebar {
        grid-row: 3;
        flex-direction: row;
        border-right: none;
        border-top: 1px solid var(--border);
        padding: 0 8px;
        justify-content: space-around;
    }
    .nav-sep { display: none; }
    .nav-btn .tooltip { display: none; }
    .main { padding: 16px; }
    .cards-row { grid-template-columns: repeat(2, 1fr); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOCUMENTS MODULE â€” Enhanced Components
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Doc Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.doc-toolbar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
    flex-wrap: wrap;
}
.doc-toolbar .search-input {
    flex: 1;
    min-width: 200px;
    max-width: 360px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    padding: 8px 12px 8px 34px;
    font-size: 13px;
    font-family: inherit;
}
.doc-toolbar .search-input:focus { outline: none; border-color: var(--primary); }
.doc-toolbar .search-wrap { position: relative; flex: 1; min-width: 200px; max-width: 360px; }
.doc-toolbar .search-wrap::before {
    content: 'ğŸ”';
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 13px;
}

.filter-pill {
    padding: 5px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-family: inherit;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: var(--transition);
}
.filter-pill:hover { color: var(--text-primary); background: var(--bg-hover); }
.filter-pill.active { background: var(--primary-alpha); color: var(--primary); border-color: var(--primary); }

/* â”€â”€ Tenant Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.doc-tenant-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding: 14px 18px;
    background: var(--bg-card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
}
.doc-tenant-bar label { font-size: 13px; font-weight: 600; color: var(--text-secondary); white-space: nowrap; }
.doc-tenant-bar select {
    background: var(--bg-input);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    padding: 8px 30px 8px 12px;
    font-size: 13px;
    font-family: inherit;
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    min-width: 280px;
}
.doc-tenant-bar select:focus { outline: none; border-color: var(--primary); }
.doc-tenant-info {
    font-size: 12px;
    color: var(--text-muted);
    margin-left: auto;
    display: flex;
    gap: 16px;
}
.doc-tenant-info span { white-space: nowrap; }

/* â”€â”€ Modal Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
}
.modal-overlay.show { display: flex; }

.modal {
    background: var(--bg-main);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    width: 560px;
    max-width: 90vw;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: var(--shadow);
}

.modal-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 22px;
    border-bottom: 1px solid var(--border);
}
.modal-head h2 { font-size: 17px; font-weight: 700; }
.modal-close-btn {
    width: 30px; height: 30px;
    border-radius: 50%;
    border: none;
    background: var(--bg-card);
    color: var(--text-muted);
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
}
.modal-close-btn:hover { background: var(--bg-hover); color: var(--text-primary); }

.modal-body { padding: 22px; }
.modal-foot {
    padding: 14px 22px;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 10px;
}

/* â”€â”€ Drop Zone (modal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.drop-zone-modal {
    border: 2px dashed var(--border-light);
    border-radius: var(--radius);
    padding: 44px 20px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
}
.drop-zone-modal:hover, .drop-zone-modal.drag-over {
    border-color: var(--primary);
    background: var(--primary-alpha);
}
.drop-zone-modal .dz-icon { font-size: 44px; margin-bottom: 10px; opacity: 0.7; }
.drop-zone-modal .dz-text { font-size: 15px; color: var(--text-secondary); margin-bottom: 4px; }
.drop-zone-modal .dz-hint { font-size: 12px; color: var(--text-muted); }
.drop-zone-modal .dz-formats { margin-top: 10px; display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
.dz-format-tag { padding: 2px 7px; background: var(--bg-input); border-radius: 4px; font-size: 11px; color: var(--text-muted); }

/* File list in upload */
.upload-file-list { margin-top: 14px; display: flex; flex-direction: column; gap: 6px; }
.upload-file-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 9px 12px;
    background: var(--bg-card);
    border-radius: var(--radius-sm);
    font-size: 13px;
}
.upload-file-item .uf-name { flex: 1; font-weight: 600; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.upload-file-item .uf-size { color: var(--text-muted); font-size: 12px; }
.upload-file-item .uf-remove {
    width: 22px; height: 22px; border-radius: 50%; border: none; background: transparent;
    color: var(--text-muted); cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center;
}
.upload-file-item .uf-remove:hover { color: var(--danger); }

.upload-opts {
    margin-top: 14px;
    padding: 12px;
    background: var(--bg-card);
    border-radius: var(--radius-sm);
    display: flex;
    gap: 18px;
    font-size: 13px;
    color: var(--text-secondary);
}
.upload-opts input[type="checkbox"] { accent-color: var(--primary); }

/* â”€â”€ Detail Slide Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.doc-detail-panel {
    position: fixed;
    right: -400px;
    top: 0;
    width: 400px;
    height: 100vh;
    background: var(--bg-main);
    border-left: 1px solid var(--border);
    z-index: 300;
    display: flex;
    flex-direction: column;
    transition: right 0.3s ease;
    box-shadow: -4px 0 24px rgba(0,0,0,0.3);
}
.doc-detail-panel.open { right: 0; }
.doc-detail-panel .dp-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 18px; border-bottom: 1px solid var(--border);
}
.doc-detail-panel .dp-header h3 { font-size: 14px; }
.doc-detail-panel .dp-body { flex: 1; overflow-y: auto; padding: 18px; }
.doc-detail-panel .dp-actions {
    padding: 14px 18px; border-top: 1px solid var(--border); display: flex; gap: 8px;
}
.dp-field { margin-bottom: 14px; }
.dp-field .dp-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.7px; color: var(--text-muted); margin-bottom: 3px; }
.dp-field .dp-value { font-size: 13px; color: var(--text-primary); word-break: break-all; }

/* â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.doc-pagination {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 16px;
    font-size: 12px;
    color: var(--text-muted);
    border-top: 1px solid var(--border);
    background: var(--bg-card);
    border-radius: 0 0 var(--radius) var(--radius);
}
.doc-pagination .page-btns { display: flex; gap: 6px; }
.doc-page-btn {
    padding: 4px 10px; background: var(--bg-input); border: 1px solid var(--border-light);
    border-radius: var(--radius-sm); color: var(--text-secondary); font-size: 12px;
    font-family: inherit; cursor: pointer; transition: var(--transition);
}
.doc-page-btn:hover { background: var(--bg-hover); }
.doc-page-btn:disabled { opacity: 0.3; cursor: not-allowed; }

/* â”€â”€ Selection Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sel-badge { display: none; font-size: 12px; color: var(--primary); font-weight: 600; margin-left: 8px; }
.sel-badge.visible { display: inline; }

/* â”€â”€ Confirm Dialog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.confirm-content { text-align: center; padding: 16px 0; }
.confirm-content .ci { font-size: 44px; margin-bottom: 14px; }
.confirm-content h3 { font-size: 17px; margin-bottom: 6px; }
.confirm-content p { color: var(--text-secondary); font-size: 13px; line-height: 1.5; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOURCE SELECTOR PANEL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.src-panel {
    margin-bottom: 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg-card);
    overflow: hidden;
}
.src-panel-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    cursor: pointer;
    user-select: none;
    transition: background 0.15s ease;
}
.src-panel-head:hover { background: var(--bg-hover); }
.src-panel-head .src-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    font-weight: 700;
    color: var(--text-primary);
}
.src-panel-head .src-count {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
    color: var(--text-muted);
}
.src-panel-head .src-arrow {
    transition: transform 0.2s ease;
    font-size: 12px;
    color: var(--text-muted);
}
.src-panel.open .src-arrow { transform: rotate(180deg); }
.src-count-badge {
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
}
.src-count-badge.all { background: rgba(34,197,94,0.15); color: var(--success); }
.src-count-badge.partial { background: rgba(245,158,11,0.15); color: var(--warning); }
.src-count-badge.none { background: rgba(239,68,68,0.15); color: var(--danger); }

.src-panel-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}
.src-panel.open .src-panel-body {
    max-height: 2000px;
}

.src-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    background: var(--bg-main);
}
.src-toolbar .src-search {
    flex: 1;
    min-width: 140px;
    max-width: 260px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    padding: 6px 10px;
    font-size: 12px;
    font-family: inherit;
}
.src-toolbar .src-search:focus { outline: none; border-color: var(--primary); }

.src-list {
    max-height: 380px;
    overflow-y: auto;
    padding: 4px 0;
}
.src-list::-webkit-scrollbar { width: 6px; }
.src-list::-webkit-scrollbar-track { background: transparent; }
.src-list::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }

.src-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 9px 16px;
    transition: background 0.1s ease;
}
.src-item:hover { background: var(--bg-hover); }
.src-item.disabled { opacity: 0.45; }

.src-item .src-toggle {
    position: relative;
    width: 36px;
    height: 20px;
    flex-shrink: 0;
}
.src-item .src-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}
.src-item .src-toggle .slider {
    position: absolute;
    inset: 0;
    background: var(--bg-input);
    border-radius: 10px;
    border: 1px solid var(--border-light);
    cursor: pointer;
    transition: 0.2s;
}
.src-item .src-toggle .slider::before {
    content: '';
    position: absolute;
    width: 14px;
    height: 14px;
    left: 2px;
    top: 2px;
    background: var(--text-muted);
    border-radius: 50%;
    transition: 0.2s;
}
.src-item .src-toggle input:checked + .slider {
    background: var(--primary-alpha);
    border-color: var(--primary);
}
.src-item .src-toggle input:checked + .slider::before {
    transform: translateX(16px);
    background: var(--primary);
}

.src-item .src-icon { font-size: 16px; flex-shrink: 0; }

.src-item .src-info {
    flex: 1;
    min-width: 0;
}
.src-item .src-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.src-item .src-meta {
    font-size: 11px;
    color: var(--text-muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.src-item .src-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.15s;
    flex-shrink: 0;
}
.src-item:hover .src-actions { opacity: 1; }
.src-actions .src-act-btn {
    width: 26px; height: 26px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
}
.src-actions .src-act-btn:hover { background: var(--bg-input); color: var(--text-primary); }
.src-actions .src-act-btn.danger:hover { color: var(--danger); }

/* Edit Name Modal (inline) */
.src-edit-inline {
    display: flex;
    align-items: center;
    gap: 6px;
}
.src-edit-inline input {
    flex: 1;
    background: var(--bg-input);
    border: 1px solid var(--primary);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    padding: 4px 8px;
    font-size: 13px;
    font-family: inherit;
    font-weight: 600;
}
.src-edit-inline input:focus { outline: none; }
.src-edit-inline button {
    width: 24px; height: 24px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
}
.src-edit-inline button:hover { background: var(--bg-hover); }

/* Source info bar below panel when collapsed */
.src-active-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    padding: 8px 14px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 12px;
    color: var(--text-muted);
}
.src-active-bar .src-active-chips {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    flex: 1;
}
.src-active-chip {
    padding: 2px 8px;
    background: var(--primary-alpha);
    color: var(--primary);
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    max-width: 160px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.src-disabled-chip {
    padding: 2px 8px;
    background: rgba(239,68,68,0.1);
    color: var(--danger);
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
}
    </style>
</head>
<body>
<nav id="site-breadcrumb" style="display:flex;align-items:center;gap:8px;padding:6px 20px;background:#0f172a;font-size:12px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;border-bottom:1px solid #1e293b;flex-wrap:wrap;"><a href="integration.html" style="color:#93c5fd;text-decoration:none;font-weight:600;">ğŸ  Hub</a><span style="color:#475569;">â€º</span><a href="integration.html" style="color:#94a3b8;text-decoration:none;">Operaciones</a><span style="color:#475569;">â€º</span><span style="color:#cbd5e1;font-weight:500;">Admin Dashboard</span><span style="color:#334155;margin:0 4px 0 auto;">|</span><a href="chat-interface.html" style="color:#64748b;text-decoration:none;font-size:11px;padding:2px 6px;">ğŸ’¬ Chat</a><a href="document-management.html" style="color:#64748b;text-decoration:none;font-size:11px;padding:2px 6px;">ğŸ“„ Documentos</a></nav>
<div class="app">
    <!-- â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â• -->
    <header class="header">
        <div class="header-left">
            <div class="header-logo">
                <span>ğŸ“¦</span> Envios23
            </div>
            <span class="header-title" id="headerTitle">RAG Dashboard</span>
        </div>
        <div class="header-right">
            <div class="health-badge" id="healthBadge">
                <div class="health-dot"></div>
                <span id="healthText">checking...</span>
            </div>
        </div>
    </header>

    <!-- â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â• -->
    <nav class="sidebar">
        <button class="nav-btn active" data-module="chat" onclick="nav('chat')">
            ğŸ’¬ <span class="tooltip">Chat</span>
        </button>
        <button class="nav-btn" data-module="documents" onclick="nav('documents')">
            ğŸ“„ <span class="tooltip">Documentos</span>
        </button>
        <button class="nav-btn" data-module="tenants" onclick="nav('tenants')">
            ğŸ¢ <span class="tooltip">Tenants</span>
        </button>
        <button class="nav-btn" data-module="agents" onclick="nav('agents')">
            ğŸ¤– <span class="tooltip">Agentes</span>
        </button>
        <div class="nav-sep"></div>
        <button class="nav-btn" data-module="analytics" onclick="nav('analytics')">
            ğŸ“Š <span class="tooltip">Analytics</span>
        </button>
        <button class="nav-btn" data-module="admin" onclick="nav('admin')">
            âš™ï¸ <span class="tooltip">Admin</span>
        </button>
    </nav>

    <!-- â•â•â•â•â•â•â•â•â•â•â• MAIN CONTENT â•â•â•â•â•â•â•â•â•â•â• -->
    <main class="main">

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     MODULE: CHAT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="module active" id="mod-chat">
    <div class="chat-layout">
        <div class="chat-main">
            <div class="chat-messages" id="chatMessages">
                <div class="empty-state" id="chatEmpty">
                    <div class="icon">ğŸ’¬</div>
                    <h3>Consulta la base de conocimientos</h3>
                    <p>Escribe una pregunta para consultar el RAG de Envios23</p>
                </div>
            </div>
            <div class="chat-input-bar">
                <input type="text" id="chatInput" placeholder="Escribe tu pregunta..." 
                       onkeydown="if(event.key==='Enter')sendChat()">
                <button onclick="sendChat()" id="chatSendBtn">â¤</button>
            </div>
        </div>
        <div class="chat-sidebar">
            <div class="chat-config">
                <h3>âš™ï¸ ConfiguraciÃ³n</h3>
                <div class="form-group">
                    <label>Modo</label>
                    <select class="form-control" id="chatMode">
                        <option value="mcp">MCP Tool (generate_rag_answer)</option>
                        <option value="query">Query Directo (pipeline 12 pasos)</option>
                        <option value="openai">OpenAI Compatible (streaming)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Prompt Template</label>
                    <select class="form-control" id="chatPrompt">
                        <option value="">â€” Ninguno â€”</option>
                        <option value="customer_support">Soporte al Cliente</option>
                        <option value="faq_expert">Experto FAQ</option>
                        <option value="shipping_regulations_advisor">Regulaciones</option>
                        <option value="debug_assistant">Debug</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Top K</label>
                    <input type="number" class="form-control" id="chatTopK" value="5" min="1" max="20">
                </div>
                <div class="form-group">
                    <label>Session ID</label>
                    <input type="text" class="form-control" id="chatSessionId" value="eval-dashboard">
                </div>
            </div>
            <div class="chat-config">
                <h3>ğŸ“Š Ãšltima respuesta</h3>
                <div id="chatMeta" style="font-size:12px;color:var(--text-muted)">
                    Sin datos aÃºn
                </div>
            </div>
        </div>
    </div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     MODULE: DOCUMENTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="module" id="mod-documents">
    <div class="module-header">
        <h1>ğŸ“„ Knowledge Base</h1>
        <p>GestiÃ³n de documentos del sistema RAG â€” Multi-tenant</p>
    </div>

    <!-- Tenant Selector -->
    <div class="doc-tenant-bar">
        <label>ğŸ¢ Tenant:</label>
        <select id="docTenantSelect" onchange="DocMgr.selectTenant(this.value)">
            <option value="">Cargando...</option>
        </select>
        <div class="doc-tenant-info" id="docTenantInfo">
            <span id="dti-collection">â€”</span>
            <span id="dti-model">â€”</span>
            <span id="dti-lang">â€”</span>
        </div>
    </div>

    <!-- Stats -->
    <div class="cards-row" id="docStats">
        <div class="stat-card"><div class="label">Documentos</div><div class="value" id="docTotal">â€”</div></div>
        <div class="stat-card"><div class="label">Chunks</div><div class="value" id="docChunks">â€”</div></div>
        <div class="stat-card"><div class="label">TamaÃ±o</div><div class="value" id="docSize">â€”</div></div>
        <div class="stat-card"><div class="label">Indexados</div><div class="value" id="docIndexed" style="color:var(--success)">â€”</div></div>
        <div class="stat-card"><div class="label">CategorÃ­as</div><div class="value" id="docCategories">â€”</div></div>
        <div class="stat-card"><div class="label">Errores</div><div class="value" id="docErrors" style="color:var(--danger)">â€”</div></div>
    </div>

    <!-- Source Selector Panel -->
    <div class="src-panel" id="srcPanel">
        <div class="src-panel-head" onclick="SrcMgr.togglePanel()">
            <div class="src-title">ğŸ“š Fuentes <span class="src-count-badge all" id="srcBadge">â€”</span></div>
            <div class="src-count">
                <span id="srcCountText">Cargando fuentes...</span>
                <span class="src-arrow" id="srcArrow">â–¼</span>
            </div>
        </div>
        <div class="src-panel-body">
            <div class="src-toolbar">
                <input type="text" class="src-search" id="srcSearchInput" placeholder="Buscar fuente..." oninput="SrcMgr.renderList()">
                <button class="btn btn-sm" onclick="SrcMgr.enableAll()" title="Activar todas">âœ… Todas</button>
                <button class="btn btn-sm" onclick="SrcMgr.disableAll()" title="Desactivar todas">â¬œ Ninguna</button>
            </div>
            <div class="src-list" id="srcList">
                <div class="loading-overlay" style="padding:20px;"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <!-- Source Active Summary Bar (visible when panel is collapsed and not all active) -->
    <div class="src-active-bar" id="srcActiveBar" style="display:none;">
        <span>ğŸ“š Fuentes activas:</span>
        <div class="src-active-chips" id="srcActiveChips"></div>
    </div>

    <!-- Toolbar -->
    <div class="doc-toolbar">
        <div class="search-wrap">
            <input type="text" class="search-input" id="docSearchInput" placeholder="Buscar documentos..." oninput="DocMgr.filter()">
        </div>
        <div style="display:flex;gap:4px;flex-wrap:wrap;">
            <button class="filter-pill active" data-f="all" onclick="DocMgr.setFilter('all', this)">Todos</button>
            <button class="filter-pill" data-f="indexed" onclick="DocMgr.setFilter('indexed', this)">âœ… Indexados</button>
            <button class="filter-pill" data-f="pending" onclick="DocMgr.setFilter('pending', this)">â³ Pendientes</button>
            <button class="filter-pill" data-f="error" onclick="DocMgr.setFilter('error', this)">âŒ Errores</button>
            <button class="filter-pill" data-f="deleted" onclick="DocMgr.setFilter('deleted', this)">ğŸ—‘ï¸ Eliminados</button>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;">
            <button class="btn btn-sm" onclick="DocMgr.reload()">ğŸ”„ Recargar</button>
            <button class="btn btn-sm btn-primary" onclick="DocMgr.openUpload()">ğŸ“¤ Subir</button>
        </div>
    </div>

    <!-- Document Table -->
    <div class="panel" style="margin-bottom:0;">
        <div class="panel-head">
            <span>Documentos Registrados <span class="sel-badge" id="docSelBadge"></span></span>
            <div style="display:flex;gap:8px;align-items:center;">
                <button class="btn btn-sm" onclick="DocMgr.processPending()" title="Procesar pendientes">â³ Pendientes</button>
                <button class="btn btn-sm" onclick="DocMgr.openSyncDir()" title="Sincronizar directorio">ğŸ”„ Sync Dir</button>
                <div style="position:relative;display:inline-block;">
                    <button class="btn btn-sm btn-danger" onclick="this.nextElementSibling.classList.toggle('show')" style="font-size:11px;">âš ï¸ â–¾</button>
                    <div style="display:none;position:absolute;right:0;top:110%;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);z-index:50;min-width:180px;box-shadow:var(--shadow);" class="dm-dropdown">
                        <button class="btn" style="width:100%;border:none;border-radius:0;justify-content:flex-start;" onclick="DocMgr.confirmReset(); this.parentElement.classList.remove('show');">â˜¢ï¸ Reset + Re-indexar</button>
                        <button class="btn" style="width:100%;border:none;border-radius:0;justify-content:flex-start;color:var(--danger);" onclick="DocMgr.confirmDeleteAll(); this.parentElement.classList.remove('show');">ğŸ—‘ï¸ Eliminar Todo</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel-body no-pad">
            <table class="data-table" id="docTable">
                <thead>
                    <tr>
                        <th style="width:36px;text-align:center;"><input type="checkbox" id="docCheckAll" onchange="DocMgr.toggleAll(this.checked)" style="accent-color:var(--primary);cursor:pointer;"></th>
                        <th>Documento</th>
                        <th>Estado</th>
                        <th>CategorÃ­a</th>
                        <th>Chunks</th>
                        <th>VersiÃ³n</th>
                        <th>TamaÃ±o</th>
                        <th>Indexado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="docTableBody">
                    <tr><td colspan="9"><div class="loading-overlay"><div class="spinner"></div> Cargando...</div></td></tr>
                </tbody>
            </table>
        </div>
        <div class="doc-pagination" id="docPagination" style="display:none;">
            <div><span id="docPagInfo">â€”</span></div>
            <div class="page-btns">
                <button class="doc-page-btn" id="docPrev" onclick="DocMgr.prevPage()" disabled>â† Anterior</button>
                <span id="docPageNum">1/1</span>
                <button class="doc-page-btn" id="docNext" onclick="DocMgr.nextPage()" disabled>Siguiente â†’</button>
            </div>
        </div>
    </div>
</div>

<!-- â”€â”€ DOCUMENT UPLOAD MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="docUploadModal">
    <div class="modal">
        <div class="modal-head">
            <h2>ğŸ“¤ Subir Documentos</h2>
            <button class="modal-close-btn" onclick="DocMgr.closeUpload()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="drop-zone-modal" id="docDropZone" onclick="document.getElementById('docFileInput').click()">
                <div class="dz-icon">ğŸ“</div>
                <div class="dz-text">Arrastra archivos aquÃ­ o haz clic para seleccionar</div>
                <div class="dz-hint">Sube documentos para agregar a la base de conocimientos del tenant</div>
                <div class="dz-formats">
                    <span class="dz-format-tag">PDF</span><span class="dz-format-tag">MD</span>
                    <span class="dz-format-tag">TXT</span><span class="dz-format-tag">DOCX</span>
                    <span class="dz-format-tag">ODT</span><span class="dz-format-tag">XLSX</span>
                    <span class="dz-format-tag">JSON</span><span class="dz-format-tag">XML</span>
                </div>
            </div>
            <input type="file" id="docFileInput" hidden multiple accept=".pdf,.md,.txt,.docx,.odt,.xlsx,.xls,.json,.xml" onchange="DocMgr.addFiles([...this.files]); this.value='';">
            <div id="docUploadFileList" class="upload-file-list"></div>
            <div id="docUploadOpts" class="upload-opts" style="display:none;">
                <label><input type="checkbox" id="docOptAutoIdx" checked> Auto-indexar</label>
                <label><input type="checkbox" id="docOptBg"> Background</label>
            </div>
        </div>
        <div class="modal-foot" id="docUploadFoot" style="display:none;">
            <button class="btn btn-sm" onclick="DocMgr.clearFiles()">Limpiar</button>
            <button class="btn btn-sm btn-primary" id="docUploadBtn" onclick="DocMgr.doUpload()">ğŸ“¤ Subir <span id="docUploadCount"></span></button>
        </div>
    </div>
</div>

<!-- â”€â”€ CONFIRM MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="docConfirmModal">
    <div class="modal" style="width:420px;">
        <div class="modal-head">
            <h2 id="dcm-title">Confirmar</h2>
            <button class="modal-close-btn" onclick="DocMgr.closeConfirm()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="confirm-content">
                <div class="ci" id="dcm-icon">âš ï¸</div>
                <h3 id="dcm-heading">Â¿EstÃ¡s seguro?</h3>
                <p id="dcm-text"></p>
            </div>
        </div>
        <div class="modal-foot">
            <button class="btn btn-sm" onclick="DocMgr.closeConfirm()">Cancelar</button>
            <button class="btn btn-sm btn-danger" id="dcm-action">Confirmar</button>
        </div>
    </div>
</div>

<!-- â”€â”€ SYNC DIRECTORY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="docSyncModal">
    <div class="modal" style="width:460px;">
        <div class="modal-head">
            <h2>ğŸ”„ Sincronizar Directorio</h2>
            <button class="modal-close-btn" onclick="DocMgr.closeSyncDir()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Ruta del directorio en el servidor</label>
                <input type="text" class="form-control" id="docSyncPath" placeholder="/app/storage/sources/envios23" style="width:100%;">
            </div>
            <div style="display:flex;gap:16px;margin-top:10px;">
                <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;">
                    <input type="checkbox" id="docSyncRecursive" checked style="accent-color:var(--primary);"> Recursivo
                </label>
                <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;">
                    <input type="checkbox" id="docSyncForce" style="accent-color:var(--primary);"> Forzar re-indexado
                </label>
            </div>
        </div>
        <div class="modal-foot">
            <button class="btn btn-sm" onclick="DocMgr.closeSyncDir()">Cancelar</button>
            <button class="btn btn-sm btn-primary" onclick="DocMgr.doSyncDir()">ğŸ”„ Sincronizar</button>
        </div>
    </div>
</div>

<!-- â”€â”€ DOCUMENT DETAIL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="doc-detail-panel" id="docDetailPanel">
    <div class="dp-header">
        <h3>ğŸ“‹ Detalle del Documento</h3>
        <button class="modal-close-btn" onclick="DocMgr.closeDetail()">âœ•</button>
    </div>
    <div class="dp-body" id="docDetailBody"></div>
    <div class="dp-actions" id="docDetailActions"></div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     MODULE: TENANTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="module" id="mod-tenants">
    <div class="module-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
            <h1>ğŸ¢ Tenants</h1>
            <p>GestiÃ³n multi-tenant del sistema RAG</p>
        </div>
        <button class="btn btn-primary" onclick="showTenantModal()">+ Nuevo Tenant</button>
    </div>

    <div class="cards-row" id="tenantCards">
        <div class="loading-overlay"><div class="spinner"></div> Cargando tenants...</div>
    </div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     MODULE: AGENTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="module" id="mod-agents">
    <div class="module-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
            <h1>ğŸ¤– Agentes RAG</h1>
            <p>Instancias independientes con su propia base de conocimientos</p>
        </div>
        <button class="btn btn-primary" onclick="showAgentModal()">+ Nuevo Agente</button>
    </div>

    <div class="cards-row" id="agentCards">
        <div class="loading-overlay"><div class="spinner"></div> Cargando agentes...</div>
    </div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     MODULE: ANALYTICS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="module" id="mod-analytics">
    <div class="module-header">
        <h1>ğŸ“Š Analytics</h1>
        <p>MÃ©tricas y estadÃ­sticas del sistema RAG</p>
    </div>

    <div class="panel">
        <div class="panel-head">
            <span>ğŸ¥ Estado de Servicios</span>
            <button class="btn btn-sm" onclick="loadHealthStatus()">ğŸ”„ Refrescar</button>
        </div>
        <div class="panel-body">
            <div class="health-grid" id="healthGrid">
                <div class="loading-overlay"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <div class="grid-2">
        <div class="panel">
            <div class="panel-head"><span>ğŸ‘ Feedback</span></div>
            <div class="panel-body" id="feedbackPanel">
                <div class="loading-overlay"><div class="spinner"></div></div>
            </div>
        </div>
        <div class="panel">
            <div class="panel-head"><span>ğŸ“ˆ Sistema</span></div>
            <div class="panel-body" id="systemPanel">
                <div class="loading-overlay"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-head">
            <span>ğŸ“ Feedback Reciente</span>
            <button class="btn btn-sm" onclick="loadFeedbackList()">ğŸ”„</button>
        </div>
        <div class="panel-body no-pad">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Query</th>
                        <th>Rating</th>
                        <th>Confianza</th>
                        <th>Comentario</th>
                        <th>Revisado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="feedbackTableBody">
                    <tr><td colspan="6"><div class="loading-overlay"><div class="spinner"></div></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     MODULE: ADMIN
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="module" id="mod-admin">
    <div class="module-header">
        <h1>âš™ï¸ AdministraciÃ³n</h1>
        <p>Herramientas de administraciÃ³n y exploraciÃ³n MCP</p>
    </div>

    <div class="grid-2">
        <!-- MCP Tools -->
        <div class="panel">
            <div class="panel-head">
                <span>ğŸ”§ MCP Tools</span>
                <button class="btn btn-sm" onclick="loadMcpTools()">ğŸ”„</button>
            </div>
            <div class="panel-body" id="mcpToolsPanel">
                <div class="loading-overlay"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- MCP Prompts -->
        <div class="panel">
            <div class="panel-head">
                <span>ğŸ“ MCP Prompts</span>
                <button class="btn btn-sm" onclick="loadMcpPrompts()">ğŸ”„</button>
            </div>
            <div class="panel-body" id="mcpPromptsPanel">
                <div class="loading-overlay"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <div class="grid-2">
        <!-- Models -->
        <div class="panel">
            <div class="panel-head"><span>ğŸ§  Modelos Disponibles</span></div>
            <div class="panel-body" id="modelsPanel">
                <div class="loading-overlay"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="panel" style="border-color:var(--danger)">
            <div class="panel-head" style="color:var(--danger)"><span>âš ï¸ Zona Peligrosa</span></div>
            <div class="panel-body">
                <div class="form-group">
                    <label>Limpiar CachÃ©</label>
                    <div style="display:flex;gap:8px">
                        <input type="text" class="form-control" id="cacheTenantId" 
                               value="default" placeholder="tenant_id" style="flex:1">
                        <button class="btn btn-danger btn-sm" onclick="clearCacheAction()">ğŸ—‘ï¸ Limpiar</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Reset & Reindex (Nuclear)</label>
                    <p style="font-size:12px;color:var(--text-muted);margin-bottom:8px">
                        Elimina toda la colecciÃ³n ChromaDB y re-indexa desde sources
                    </p>
                    <button class="btn btn-danger" onclick="resetReindexAction()">
                        â˜¢ï¸ Reset Completo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-head"><span>ğŸ”— MCP Resources</span></div>
        <div class="panel-body" id="mcpResourcesPanel">
            <div class="loading-overlay"><div class="spinner"></div></div>
        </div>
    </div>
</div>

    </main>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Tenant Modal -->
<div class="modal-overlay" id="tenantModal">
    <div class="modal">
        <div class="modal-head">
            <span id="tenantModalTitle">Nuevo Tenant</span>
            <button class="modal-close" onclick="closeModal('tenantModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Tenant ID</label>
                <input type="text" class="form-control" id="tenantIdInput" 
                       placeholder="mi-tenant" pattern="^[a-z0-9][a-z0-9_-]*$">
            </div>
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" class="form-control" id="tenantNameInput" placeholder="Mi Tenant">
            </div>
            <div class="form-group">
                <label>DescripciÃ³n</label>
                <textarea class="form-control" id="tenantDescInput" placeholder="DescripciÃ³n opcional"></textarea>
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label>Modelo LLM</label>
                    <input type="text" class="form-control" id="tenantModelInput" 
                           value="anthropic/claude-3-haiku">
                </div>
                <div class="form-group">
                    <label>Idioma</label>
                    <select class="form-control" id="tenantLangInput">
                        <option value="es">EspaÃ±ol</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>System Prompt</label>
                <textarea class="form-control" id="tenantPromptInput" 
                          placeholder="System prompt personalizado (mÃ­nimo 10 caracteres)"
                          style="min-height:100px"></textarea>
            </div>
        </div>
        <div class="modal-foot">
            <button class="btn" onclick="closeModal('tenantModal')">Cancelar</button>
            <button class="btn btn-primary" onclick="saveTenant()">Guardar</button>
        </div>
    </div>
</div>

<!-- Agent Modal -->
<div class="modal-overlay" id="agentModal">
    <div class="modal">
        <div class="modal-head">
            <span>Nuevo Agente RAG</span>
            <button class="modal-close" onclick="closeModal('agentModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Tenant ID (identificador Ãºnico)</label>
                <input type="text" class="form-control" id="agentIdInput" 
                       placeholder="mi-agente" pattern="^[a-z0-9][a-z0-9_-]*$">
            </div>
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" class="form-control" id="agentNameInput" placeholder="Mi Agente">
            </div>
            <div class="form-group">
                <label>DescripciÃ³n</label>
                <textarea class="form-control" id="agentDescInput" placeholder="DescripciÃ³n del agente"></textarea>
            </div>
        </div>
        <div class="modal-foot">
            <button class="btn" onclick="closeModal('agentModal')">Cancelar</button>
            <button class="btn btn-primary" onclick="saveAgent()">Crear Agente</button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â• JAVASCRIPT â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€ Globals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const modules = ['chat', 'documents', 'tenants', 'agents', 'analytics', 'admin'];
const moduleLabels = {
    chat: 'Chat & EvaluaciÃ³n',
    documents: 'Knowledge Base',
    tenants: 'Tenants',
    agents: 'Agentes RAG',
    analytics: 'Analytics',
    admin: 'AdministraciÃ³n'
};

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nav(mod) {
    modules.forEach(m => {
        document.getElementById(`mod-${m}`).classList.toggle('active', m === mod);
        document.querySelector(`.nav-btn[data-module="${m}"]`).classList.toggle('active', m === mod);
    });
    document.getElementById('headerTitle').textContent = moduleLabels[mod];
    window.location.hash = mod;

    // Lazy load module data
    const loaders = {
        documents: loadDocuments,
        tenants: loadTenants,
        agents: loadAgents,
        analytics: loadAnalytics,
        admin: loadAdmin
    };
    if (loaders[mod]) loaders[mod]();
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(message, type = 'info') {
    const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' };
    const el = document.createElement('div');
    el.className = `toast toast-${type}`;
    el.innerHTML = `${icons[type] || ''} ${message}`;
    document.getElementById('toastContainer').appendChild(el);
    setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 4000);
}

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

// â”€â”€ Format Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatBytes(b) {
    if (!b || b === 0) return '0 B';
    const k = 1024, s = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(b) / Math.log(k));
    return parseFloat((b / Math.pow(k, i)).toFixed(1)) + ' ' + s[i];
}

function statusBadge(status) {
    const map = { active: 'success', indexed: 'success', inactive: 'muted', processing: 'warning', error: 'danger', failed: 'danger' };
    return `<span class="badge badge-${map[status] || 'info'}">${status}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE: CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let chatLoading = false;

async function sendChat() {
    const input = document.getElementById('chatInput');
    const query = input.value.trim();
    if (!query || chatLoading) return;

    // Clear empty state
    const empty = document.getElementById('chatEmpty');
    if (empty) empty.remove();

    // Add user message
    addMessage('user', query);
    input.value = '';
    chatLoading = true;
    document.getElementById('chatSendBtn').disabled = true;

    const mode = document.getElementById('chatMode').value;
    const topK = parseInt(document.getElementById('chatTopK').value) || 5;
    const sessionId = document.getElementById('chatSessionId').value || 'default';

    // Add loading message
    const loadId = addMessage('assistant', '<div class="spinner"></div> Pensando...', true);

    try {
        let result;
        if (mode === 'mcp') {
            result = await api.mcpCallTool('generate_rag_answer', {
                query, session_id: sessionId, include_sources: true
            }, sessionId);
            updateChatMessage(loadId, result.result || result.error || 'Sin respuesta', result);
        } else if (mode === 'query') {
            result = await api.query({ query, top_k: topK, use_cache: true });
            const md = result.answer || 'Sin respuesta';
            updateChatMessage(loadId, md, result);
        } else if (mode === 'openai') {
            let fullText = '';
            const msgEl = document.getElementById(loadId);
            const contentEl = msgEl.querySelector('.msg-content');

            await api.chatCompletionsStream(
                { model: 'eod-rag', messages: [{ role: 'user', content: query }], top_k: topK },
                (chunk) => {
                    const delta = chunk.choices?.[0]?.delta?.content || '';
                    fullText += delta;
                    contentEl.innerHTML = marked.parse(fullText);
                },
                () => {
                    updateChatMeta({ mode: 'OpenAI streaming', cached: false });
                }
            );
        }
    } catch (e) {
        updateChatMessage(loadId, `âŒ Error: ${e.message}`);
    }

    chatLoading = false;
    document.getElementById('chatSendBtn').disabled = false;
}

function addMessage(role, content, isLoading = false) {
    const id = 'msg-' + Date.now();
    const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
    const sender = role === 'user' ? 'TÃº' : 'RAG Assistant';
    const html = `
        <div class="msg ${role}" id="${id}">
            <div class="msg-avatar">${avatar}</div>
            <div class="msg-body">
                <div class="msg-sender">${sender}</div>
                <div class="msg-content">${isLoading ? content : marked.parse(content)}</div>
                <div class="msg-meta" id="${id}-meta"></div>
            </div>
        </div>`;
    document.getElementById('chatMessages').insertAdjacentHTML('beforeend', html);
    document.getElementById('chatMessages').scrollTop = 99999;
    return id;
}

function updateChatMessage(id, content, meta = null) {
    const el = document.getElementById(id);
    if (!el) return;
    el.querySelector('.msg-content').innerHTML = marked.parse(content);

    if (meta) {
        updateChatMeta(meta);

        // Show sources if available
        if (meta.sources && meta.sources.length) {
            const srcHtml = `<details class="msg-sources"><summary>ğŸ“ ${meta.sources.length} fuentes</summary>
                <ul>${meta.sources.map(s => `<li>${s}</li>`).join('')}</ul></details>`;
            el.querySelector('.msg-content').insertAdjacentHTML('beforeend', srcHtml);
        }

        // Feedback buttons
        const metaEl = document.getElementById(`${id}-meta`);
        if (metaEl) {
            metaEl.innerHTML = `
                <button class="btn btn-sm" onclick="selectRating('${id}', 'positive')" id="${id}-btn-pos" title="Buena respuesta">ğŸ‘</button>
                <button class="btn btn-sm" onclick="selectRating('${id}', 'negative')" id="${id}-btn-neg" title="Mala respuesta">ğŸ‘</button>
                ${meta.confidence !== undefined ? `<span class="badge ${meta.confidence > 0.7 ? 'badge-success' : meta.confidence > 0.4 ? 'badge-warning' : 'badge-danger'}">
                    Confianza: ${(meta.confidence * 100).toFixed(0)}%</span>` : ''}
                ${meta.cached ? '<span class="badge badge-info">cached</span>' : ''}
            `;
        }
    }
    document.getElementById('chatMessages').scrollTop = 99999;
}

function updateChatMeta(meta) {
    const el = document.getElementById('chatMeta');
    if (!el) return;
    const lines = [];
    if (meta.confidence !== undefined) lines.push(`Confianza: ${(meta.confidence * 100).toFixed(0)}%`);
    if (meta.sources) lines.push(`Fuentes: ${meta.sources.length}`);
    if (meta.cached !== undefined) lines.push(`CachÃ©: ${meta.cached ? 'SÃ­' : 'No'}`);
    if (meta.metadata?.processing_time) lines.push(`Tiempo: ${meta.metadata.processing_time}ms`);
    if (meta.mode) lines.push(`Modo: ${meta.mode}`);
    if (meta.retrieved_chunks) lines.push(`Chunks: ${meta.retrieved_chunks.length}`);
    el.innerHTML = lines.join('<br>') || 'Sin datos';
}

function selectRating(msgId, rating) {
    const meta = document.getElementById(`${msgId}-meta`);
    if (!meta) return;

    // Highlight selected rating
    const posBtn = document.getElementById(`${msgId}-btn-pos`);
    const negBtn = document.getElementById(`${msgId}-btn-neg`);
    if (posBtn) { posBtn.disabled = true; posBtn.style.opacity = rating === 'positive' ? '1' : '0.3'; }
    if (negBtn) { negBtn.disabled = true; negBtn.style.opacity = rating === 'negative' ? '1' : '0.3'; }

    // Remove existing comment form if any
    const existing = meta.querySelector('.feedback-comment-form');
    if (existing) existing.remove();

    // Add comment form
    const form = document.createElement('div');
    form.className = 'feedback-comment-form';
    form.innerHTML = `
        <textarea placeholder="Â¿Por quÃ©? Escribe un comentario opcional..." id="${msgId}-comment"></textarea>
        <button class="btn btn-sm btn-send-comment" onclick="sendFeedback('${msgId}', '${rating}')">Enviar</button>
        <button class="btn btn-sm" onclick="sendFeedback('${msgId}', '${rating}', true)" title="Enviar sin comentario" style="padding:6px 8px;font-size:11px;color:var(--text-muted)">Omitir</button>
    `;
    meta.appendChild(form);

    // Focus textarea
    setTimeout(() => meta.querySelector('textarea')?.focus(), 50);
}

async function sendFeedback(msgId, rating, skipComment = false) {
    const msgEl = document.getElementById(msgId);
    if (!msgEl) return;
    const content = msgEl.querySelector('.msg-content')?.textContent || '';
    // Find the preceding user message
    const prev = msgEl.previousElementSibling;
    const query = prev?.querySelector('.msg-content')?.textContent || '';
    const comment = skipComment ? '' : (document.getElementById(`${msgId}-comment`)?.value || '');

    try {
        const payload = { query, response: content, rating };
        if (comment.trim()) payload.comment = comment.trim();
        await api.submitFeedback(payload);
        toast(`Feedback ${rating === 'positive' ? 'ğŸ‘' : 'ğŸ‘'} guardado${comment.trim() ? ' con comentario' : ''}`, 'success');
        // Replace with confirmation
        const meta = document.getElementById(`${msgId}-meta`);
        if (meta) {
            const form = meta.querySelector('.feedback-comment-form');
            if (form) form.remove();
            meta.querySelectorAll('button').forEach(b => { b.disabled = true; b.style.opacity = '0.4'; });
            const conf = document.createElement('span');
            conf.className = 'badge badge-success';
            conf.textContent = `âœ… ${rating === 'positive' ? 'ğŸ‘' : 'ğŸ‘'} Enviado`;
            meta.appendChild(conf);
        }
    } catch (e) {
        toast(`Error guardando feedback: ${e.message}`, 'error');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE: DOCUMENTS (Multi-tenant Document Manager)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DocMgr = {
    tenants: [],
    currentTenant: null,
    docs: [],
    filtered: [],
    selected: new Set(),
    statusFilter: 'all',
    page: 1,
    perPage: 20,
    uploadFiles: [],
    uploading: false,
    initialized: false,

    async init() {
        if (this.initialized) { this.reload(); return; }
        this.initialized = true;
        try {
            const data = await api.listTenants(true);
            this.tenants = data.tenants || [];
            const sel = document.getElementById('docTenantSelect');
            sel.innerHTML = this.tenants.map(t =>
                `<option value="${t.tenant_id}">${t.name} (${t.tenant_id}) â€” ${t.document_count} docs</option>`
            ).join('');
            if (this.tenants.length > 0) this.selectTenant(this.tenants[0].tenant_id);
        } catch (e) {
            toast('Error cargando tenants: ' + e.message, 'error');
        }
        this.setupDropZone();
    },

    async selectTenant(tid) {
        this.currentTenant = this.tenants.find(t => t.tenant_id === tid);
        if (!this.currentTenant) return;
        const c = this.currentTenant;
        document.getElementById('dti-collection').textContent = 'ğŸ“¦ ' + (c.collection_name || 'â€”');
        document.getElementById('dti-model').textContent = 'ğŸ¤– ' + (c.default_model?.split('/').pop() || 'â€”');
        document.getElementById('dti-lang').textContent = 'ğŸŒ ' + (c.response_language || 'â€”');
        this.page = 1;
        this.statusFilter = 'all';
        document.querySelectorAll('.filter-pill').forEach(b => b.classList.toggle('active', b.dataset.f === 'all'));
        document.getElementById('docSearchInput').value = '';
        document.getElementById('srcSearchInput').value = '';
        SrcMgr.editing = null;
        await Promise.all([this.loadDocs(), this.loadStats()]);
    },

    async loadDocs() {
        const tbody = document.getElementById('docTableBody');
        tbody.innerHTML = '<tr><td colspan="9"><div class="loading-overlay"><div class="spinner"></div> Cargando...</div></td></tr>';
        try {
            const data = await api.listDocuments(this.currentTenant.tenant_id);
            this.docs = data.documents || data || [];
            this.selected.clear();
            this.applyFilter();
            SrcMgr.refresh();
        } catch (e) {
            tbody.innerHTML = `<tr><td colspan="9" style="color:var(--danger);padding:20px;">âŒ Error: ${e.message}</td></tr>`;
        }
    },

    async loadStats() {
        try {
            const s = await api.documentStats(this.currentTenant.tenant_id);
            document.getElementById('docTotal').textContent = s.total_documents ?? 0;
            document.getElementById('docChunks').textContent = s.total_chunks ?? 0;
            document.getElementById('docSize').textContent = formatBytes(s.total_size_bytes || 0);
            document.getElementById('docIndexed').textContent = s.by_status?.indexed ?? 0;
            document.getElementById('docErrors').textContent = (s.by_status?.error ?? 0) + (s.by_status?.deleted ?? 0);
            document.getElementById('docCategories').textContent = s.by_category ? Object.keys(s.by_category).length : 0;
        } catch (e) {
            console.warn('Stats error:', e.message);
        }
    },

    applyFilter() {
        let list = [...this.docs];
        if (this.statusFilter !== 'all') list = list.filter(d => d.status === this.statusFilter);
        const q = document.getElementById('docSearchInput').value.toLowerCase().trim();
        if (q) list = list.filter(d => d.filename.toLowerCase().includes(q) || d.document_id.includes(q));
        this.filtered = list;
        const total = Math.max(1, Math.ceil(list.length / this.perPage));
        if (this.page > total) this.page = total;
        this.render();
        this.updatePag();
    },

    filter() { this.page = 1; this.applyFilter(); },

    setFilter(f, btn) {
        this.statusFilter = f;
        this.page = 1;
        document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        this.applyFilter();
    },

    prevPage() { if (this.page > 1) { this.page--; this.render(); this.updatePag(); } },
    nextPage() { const tp = Math.ceil(this.filtered.length / this.perPage); if (this.page < tp) { this.page++; this.render(); this.updatePag(); } },

    updatePag() {
        const total = this.filtered.length;
        const tp = Math.max(1, Math.ceil(total / this.perPage));
        const start = (this.page - 1) * this.perPage;
        const end = Math.min(start + this.perPage, total);
        const pag = document.getElementById('docPagination');
        pag.style.display = total > 0 ? 'flex' : 'none';
        document.getElementById('docPagInfo').textContent = total === 0 ? 'Sin resultados' : `${start + 1}â€“${end} de ${total}`;
        document.getElementById('docPageNum').textContent = `${this.page}/${tp}`;
        document.getElementById('docPrev').disabled = this.page <= 1;
        document.getElementById('docNext').disabled = this.page >= tp;
        const sel = document.getElementById('docSelBadge');
        if (this.selected.size > 0) { sel.classList.add('visible'); sel.textContent = `(${this.selected.size} seleccionados)`; }
        else { sel.classList.remove('visible'); }
    },

    render() {
        const tbody = document.getElementById('docTableBody');
        const start = (this.page - 1) * this.perPage;
        const page = this.filtered.slice(start, start + this.perPage);
        if (this.filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9"><div class="empty-state"><div class="icon">ğŸ“­</div><h3>Sin documentos</h3><p>No se encontraron documentos con los filtros actuales</p></div></td></tr>`;
            return;
        }
        const allChk = page.every(d => this.selected.has(d.document_id));
        document.getElementById('docCheckAll').checked = allChk;
        tbody.innerHTML = page.map(d => {
            const ext = (d.filename || '').split('.').pop().toLowerCase();
            const icons = { md:'ğŸ“', pdf:'ğŸ“•', txt:'ğŸ“ƒ', docx:'ğŸ“˜', json:'ğŸ”§', xml:'ğŸ“', xlsx:'ğŸ“Š', xls:'ğŸ“Š', odt:'ğŸ““' };
            const ico = icons[ext] || 'ğŸ“„';
            const chk = this.selected.has(d.document_id) ? 'checked' : '';
            const dt = d.indexed_at ? new Date(d.indexed_at).toLocaleDateString('es', { day:'2-digit', month:'short', year:'2-digit' }) : 'â€”';
            const err = d.error ? `<br><span style="font-size:11px;color:var(--danger)">âš ï¸ ${d.error}</span>` : '';
            const displayName = SrcMgr.getDisplayName(d);
            const srcEnabled = SrcMgr.isEnabled(d.document_id);
            const rowStyle = srcEnabled ? '' : ' style="opacity:0.45;"';
            return `<tr${rowStyle}>
                <td style="text-align:center;"><input type="checkbox" ${chk} onchange="DocMgr.toggleSel('${d.document_id}',this.checked)" style="accent-color:var(--primary);cursor:pointer;"></td>
                <td>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:18px;">${ico}</span>
                        <div>
                            <div style="color:var(--text-primary);font-weight:600;max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${d.filename}">${displayName}</div>
                            <div style="font-size:11px;color:var(--text-muted);">${d.document_id}${!srcEnabled ? ' Â· â¸ï¸ desactivada' : ''}</div>
                        </div>
                    </div>
                </td>
                <td>${statusBadge(d.status)}${err}</td>
                <td><span class="badge badge-info">${d.category || 'â€”'}</span></td>
                <td style="text-align:center;">${d.chunk_count || 0}</td>
                <td style="text-align:center;">v${d.version || 1}</td>
                <td>${formatBytes(d.file_size_bytes || 0)}</td>
                <td style="font-size:12px;">${dt}</td>
                <td>
                    <button class="btn btn-icon btn-sm" onclick="DocMgr.showDetail('${d.document_id}')" title="Ver detalle">ğŸ”</button>
                    <button class="btn btn-icon btn-sm" onclick="DocMgr.reindex('${d.document_id}')" title="Re-indexar">ğŸ”„</button>
                    <button class="btn btn-icon btn-sm" onclick="DocMgr.confirmDeleteOne('${d.document_id}','${d.filename.replace(/'/g,"\\'")}')" title="Eliminar">ğŸ—‘ï¸</button>
                </td>
            </tr>`;
        }).join('');
    },

    toggleAll(checked) {
        const start = (this.page - 1) * this.perPage;
        this.filtered.slice(start, start + this.perPage).forEach(d => {
            checked ? this.selected.add(d.document_id) : this.selected.delete(d.document_id);
        });
        this.render(); this.updatePag();
    },

    toggleSel(id, checked) {
        checked ? this.selected.add(id) : this.selected.delete(id);
        this.updatePag();
    },

    // â”€â”€ Detail Panel â”€â”€
    async showDetail(docId) {
        const panel = document.getElementById('docDetailPanel');
        const body = document.getElementById('docDetailBody');
        const actions = document.getElementById('docDetailActions');
        body.innerHTML = '<div style="text-align:center;padding:40px;"><div class="spinner"></div></div>';
        actions.innerHTML = '';
        panel.classList.add('open');
        try {
            const doc = await api.getDocument(docId, this.currentTenant.tenant_id);
            const displayName = SrcMgr.getDisplayName(doc);
            body.innerHTML = [
                ['Nombre', displayName],
                ...(displayName !== doc.filename ? [['Archivo', doc.filename]] : []),
                ['ID', `<span style="font-size:11px;font-family:monospace;">${doc.document_id}</span>`],
                ['Estado', statusBadge(doc.status)],
                ['CategorÃ­a', doc.category || 'â€”'],
                ['Chunks', doc.chunk_count || 0],
                ['TamaÃ±o', formatBytes(doc.file_size_bytes || 0)],
                ['VersiÃ³n', 'v' + (doc.version || 1)],
                ['Hash', `<span style="font-size:11px;font-family:monospace;">${doc.content_hash || 'â€”'}</span>`],
                ['Indexado', doc.indexed_at ? new Date(doc.indexed_at).toLocaleString('es') : 'â€”'],
                ...(doc.error ? [['Error', `<span style="color:var(--danger)">${doc.error}</span>`]] : [])
            ].map(([l,v]) => `<div class="dp-field"><div class="dp-label">${l}</div><div class="dp-value">${v}</div></div>`).join('');
            actions.innerHTML = `
                <button class="btn btn-sm btn-primary" style="flex:1;" onclick="DocMgr.reindex('${doc.document_id}')">ğŸ”„ Re-indexar</button>
                <button class="btn btn-sm btn-danger" style="flex:1;" onclick="DocMgr.confirmDeleteOne('${doc.document_id}','${(doc.filename||'').replace(/'/g,"\\'")}')">ğŸ—‘ï¸ Eliminar</button>`;
        } catch (e) {
            body.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${e.message}</p></div>`;
        }
    },

    closeDetail() { document.getElementById('docDetailPanel').classList.remove('open'); },

    // â”€â”€ Upload â”€â”€
    openUpload() {
        this.uploadFiles = [];
        this.renderUploadFiles();
        document.getElementById('docUploadModal').classList.add('show');
    },
    closeUpload() { document.getElementById('docUploadModal').classList.remove('show'); },

    setupDropZone() {
        const z = document.getElementById('docDropZone');
        if (!z) return;
        ['dragenter','dragover'].forEach(e => z.addEventListener(e, ev => { ev.preventDefault(); z.classList.add('drag-over'); }));
        ['dragleave','drop'].forEach(e => z.addEventListener(e, ev => { ev.preventDefault(); z.classList.remove('drag-over'); }));
        z.addEventListener('drop', ev => this.addFiles([...ev.dataTransfer.files]));
    },

    addFiles(files) {
        const allowed = ['.pdf','.md','.txt','.docx','.odt','.xlsx','.xls','.json','.xml'];
        files.forEach(f => {
            const ext = '.' + f.name.split('.').pop().toLowerCase();
            if (!allowed.includes(ext)) { toast(`Formato no soportado: ${f.name}`, 'error'); return; }
            if (this.uploadFiles.find(u => u.name === f.name && u.size === f.size)) return;
            this.uploadFiles.push(f);
        });
        this.renderUploadFiles();
    },

    clearFiles() { this.uploadFiles = []; this.renderUploadFiles(); },

    removeFile(i) { this.uploadFiles.splice(i, 1); this.renderUploadFiles(); },

    renderUploadFiles() {
        const list = document.getElementById('docUploadFileList');
        const foot = document.getElementById('docUploadFoot');
        const opts = document.getElementById('docUploadOpts');
        const cnt = document.getElementById('docUploadCount');
        if (this.uploadFiles.length === 0) { list.innerHTML = ''; foot.style.display = 'none'; opts.style.display = 'none'; return; }
        foot.style.display = 'flex'; opts.style.display = 'flex';
        cnt.textContent = `(${this.uploadFiles.length})`;
        const icons = { md:'ğŸ“', pdf:'ğŸ“•', txt:'ğŸ“ƒ', docx:'ğŸ“˜', json:'ğŸ”§', xml:'ğŸ“', xlsx:'ğŸ“Š', xls:'ğŸ“Š', odt:'ğŸ““' };
        list.innerHTML = this.uploadFiles.map((f, i) => {
            const ext = f.name.split('.').pop().toLowerCase();
            return `<div class="upload-file-item">
                <span style="font-size:18px;">${icons[ext] || 'ğŸ“„'}</span>
                <span class="uf-name">${f.name}</span>
                <span class="uf-size">${formatBytes(f.size)}</span>
                <button class="uf-remove" onclick="DocMgr.removeFile(${i})">âœ•</button>
            </div>`;
        }).join('');
    },

    async doUpload() {
        if (this.uploading || this.uploadFiles.length === 0) return;
        this.uploading = true;
        const btn = document.getElementById('docUploadBtn');
        btn.disabled = true; btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;"></div> Subiendo...';
        try {
            const autoIdx = document.getElementById('docOptAutoIdx').checked;
            const bg = document.getElementById('docOptBg').checked;
            await api.uploadDocuments(this.uploadFiles, this.currentTenant.tenant_id, autoIdx, bg);
            toast(`âœ… ${this.uploadFiles.length} documento(s) subidos`, 'success');
            setTimeout(() => { this.closeUpload(); this.reload(); }, 800);
        } catch (e) {
            toast(`âŒ Error: ${e.message}`, 'error');
        } finally {
            this.uploading = false; btn.disabled = false;
            btn.innerHTML = `ğŸ“¤ Subir <span id="docUploadCount">(${this.uploadFiles.length})</span>`;
        }
    },

    // â”€â”€ Document Actions â”€â”€
    async reindex(id) {
        toast('ğŸ”„ Re-indexando...', 'info');
        try {
            await api.reindexDocument(id, this.currentTenant.tenant_id);
            toast('âœ… Re-indexado', 'success');
            this.reload();
        } catch (e) { toast(`âŒ ${e.message}`, 'error'); }
    },

    confirmDeleteOne(id, name) {
        this.showConfirm('Eliminar Documento', 'ğŸ—‘ï¸', `Â¿Eliminar "${name}"?`,
            'Se eliminarÃ¡ de la base de conocimientos, el registro y el vector store.',
            () => this.doDelete(id));
    },

    async doDelete(id) {
        this.closeConfirm();
        toast('Eliminando...', 'info');
        try {
            await api.deleteDocument(id, this.currentTenant.tenant_id);
            toast('âœ… Eliminado', 'success');
            this.closeDetail();
            this.reload();
        } catch (e) { toast(`âŒ ${e.message}`, 'error'); }
    },

    confirmDeleteAll() {
        this.showConfirm('Eliminar TODOS', 'â˜¢ï¸', 'Â¿Eliminar TODOS los documentos?',
            `Se eliminarÃ¡n TODOS los documentos del tenant "${this.currentTenant?.tenant_id}". NO se puede deshacer.`,
            () => this.doDeleteAll());
    },

    async doDeleteAll() {
        this.closeConfirm();
        toast('âš ï¸ Eliminando todos...', 'info');
        try {
            await api.deleteAllDocuments(this.currentTenant.tenant_id);
            toast('âœ… Todos eliminados', 'success');
            this.reload();
        } catch (e) { toast(`âŒ ${e.message}`, 'error'); }
    },

    async processPending() {
        toast('â³ Procesando pendientes...', 'info');
        try {
            await api.processPending(this.currentTenant.tenant_id);
            toast('âœ… Procesamiento completado', 'success');
            this.reload();
        } catch (e) { toast(`âŒ ${e.message}`, 'error'); }
    },

    confirmReset() {
        this.showConfirm('Reset + Re-indexar', 'â˜¢ï¸', 'Â¿Reset NUCLEAR?',
            `Se limpiarÃ¡n TODOS los chunks del tenant "${this.currentTenant?.tenant_id}" y se re-indexarÃ¡ todo. Puede demorar.`,
            () => this.doReset());
    },

    async doReset() {
        this.closeConfirm();
        toast('âš ï¸ Reset + re-indexando...', 'info');
        try {
            await api.resetReindex(this.currentTenant.tenant_id);
            toast('âœ… Completado', 'success');
            this.reload();
        } catch (e) { toast(`âŒ ${e.message}`, 'error'); }
    },

    // â”€â”€ Sync Directory â”€â”€
    openSyncDir() {
        const path = `/app/storage/sources/${this.currentTenant?.tenant_id || ''}`;
        document.getElementById('docSyncPath').value = path;
        document.getElementById('docSyncModal').classList.add('show');
    },
    closeSyncDir() { document.getElementById('docSyncModal').classList.remove('show'); },

    async doSyncDir() {
        const dir = document.getElementById('docSyncPath').value.trim();
        if (!dir) { toast('Especifica un directorio', 'error'); return; }
        const recursive = document.getElementById('docSyncRecursive').checked;
        const force = document.getElementById('docSyncForce').checked;
        this.closeSyncDir();
        toast('ğŸ”„ Sincronizando...', 'info');
        try {
            await api.syncDirectory(dir, this.currentTenant.tenant_id, recursive, force);
            toast('âœ… SincronizaciÃ³n completada', 'success');
            this.reload();
        } catch (e) { toast(`âŒ ${e.message}`, 'error'); }
    },

    // â”€â”€ Confirm Modal â”€â”€
    showConfirm(title, icon, heading, text, action) {
        document.getElementById('dcm-title').textContent = title;
        document.getElementById('dcm-icon').textContent = icon;
        document.getElementById('dcm-heading').textContent = heading;
        document.getElementById('dcm-text').textContent = text;
        document.getElementById('dcm-action').onclick = action;
        document.getElementById('docConfirmModal').classList.add('show');
    },
    closeConfirm() { document.getElementById('docConfirmModal').classList.remove('show'); },

    async reload() {
        if (!this.currentTenant) return;
        await Promise.all([this.loadDocs(), this.loadStats()]);
        SrcMgr.refresh();
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOURCE MANAGER â€” Select, edit, delete sources
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SrcMgr = {
    open: false,
    editing: null, // document_id being edited

    // â”€â”€ Storage helpers (localStorage) â”€â”€
    _storeKey(suffix) {
        const tid = DocMgr.currentTenant?.tenant_id || 'default';
        return `srcmgr_${tid}_${suffix}`;
    },

    getNames() {
        try { return JSON.parse(localStorage.getItem(this._storeKey('names')) || '{}'); } catch { return {}; }
    },
    setName(docId, name) {
        const names = this.getNames();
        if (name && name.trim()) names[docId] = name.trim();
        else delete names[docId];
        localStorage.setItem(this._storeKey('names'), JSON.stringify(names));
    },

    getEnabled() {
        try {
            const stored = localStorage.getItem(this._storeKey('enabled'));
            return stored ? JSON.parse(stored) : null; // null = all enabled (default)
        } catch { return null; }
    },
    setEnabled(enabledMap) {
        localStorage.setItem(this._storeKey('enabled'), JSON.stringify(enabledMap));
    },

    isEnabled(docId) {
        const map = this.getEnabled();
        if (!map) return true; // default: all enabled
        return map[docId] !== false;
    },

    getDisplayName(doc) {
        const names = this.getNames();
        return names[doc.document_id] || doc.filename || doc.document_id;
    },

    // â”€â”€ Counts â”€â”€
    getActiveSources() {
        return DocMgr.docs.filter(d => this.isEnabled(d.document_id));
    },

    getActiveIds() {
        return this.getActiveSources().map(d => d.document_id);
    },

    // â”€â”€ Panel toggle â”€â”€
    togglePanel() {
        this.open = !this.open;
        document.getElementById('srcPanel').classList.toggle('open', this.open);
        this.updateBar();
    },

    // â”€â”€ Refresh after docs loaded â”€â”€
    refresh() {
        this.updateBadge();
        this.renderList();
        this.updateBar();
    },

    // â”€â”€ Badge â”€â”€
    updateBadge() {
        const total = DocMgr.docs.length;
        const active = this.getActiveSources().length;
        const badge = document.getElementById('srcBadge');
        const text = document.getElementById('srcCountText');

        badge.textContent = `${active}/${total}`;
        badge.className = 'src-count-badge';
        if (active === total) badge.classList.add('all');
        else if (active === 0) badge.classList.add('none');
        else badge.classList.add('partial');

        if (total === 0) text.textContent = 'Sin fuentes';
        else if (active === total) text.textContent = 'Todas las fuentes activas';
        else if (active === 0) text.textContent = 'âš ï¸ Ninguna fuente activa';
        else text.textContent = `${total - active} fuente(s) desactivada(s)`;
    },

    // â”€â”€ Summary bar (when collapsed) â”€â”€
    updateBar() {
        const bar = document.getElementById('srcActiveBar');
        const total = DocMgr.docs.length;
        const active = this.getActiveSources();

        // Show bar only when collapsed and not all active
        if (this.open || active.length === total || total === 0) {
            bar.style.display = 'none';
            return;
        }

        bar.style.display = 'flex';
        const chips = document.getElementById('srcActiveChips');
        if (active.length === 0) {
            chips.innerHTML = '<span class="src-disabled-chip">âš ï¸ Ninguna activa â€” El RAG no buscarÃ¡ en fuentes</span>';
        } else if (active.length <= 6) {
            chips.innerHTML = active.map(d =>
                `<span class="src-active-chip" title="${d.filename}">${this.getDisplayName(d)}</span>`
            ).join('');
        } else {
            const shown = active.slice(0, 4);
            chips.innerHTML = shown.map(d =>
                `<span class="src-active-chip" title="${d.filename}">${this.getDisplayName(d)}</span>`
            ).join('') + `<span class="src-active-chip">+${active.length - 4} mÃ¡s</span>`;
        }
    },

    // â”€â”€ Render source list â”€â”€
    renderList() {
        const list = document.getElementById('srcList');
        const q = (document.getElementById('srcSearchInput')?.value || '').toLowerCase().trim();
        let docs = [...DocMgr.docs];
        if (q) {
            docs = docs.filter(d =>
                d.filename.toLowerCase().includes(q) ||
                d.document_id.includes(q) ||
                this.getDisplayName(d).toLowerCase().includes(q)
            );
        }

        if (docs.length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:13px;">Sin fuentes</div>';
            return;
        }

        const icons = { md:'ğŸ“', pdf:'ğŸ“•', txt:'ğŸ“ƒ', docx:'ğŸ“˜', json:'ğŸ”§', xml:'ğŸ“', xlsx:'ğŸ“Š', xls:'ğŸ“Š', odt:'ğŸ““' };

        list.innerHTML = docs.map(d => {
            const ext = (d.filename || '').split('.').pop().toLowerCase();
            const ico = icons[ext] || 'ğŸ“„';
            const enabled = this.isEnabled(d.document_id);
            const displayName = this.getDisplayName(d);
            const isSystemName = displayName === d.filename || displayName === d.document_id;
            const checkedAttr = enabled ? 'checked' : '';
            const disabledClass = enabled ? '' : ' disabled';

            if (this.editing === d.document_id) {
                return `<div class="src-item${disabledClass}">
                    <label class="src-toggle">
                        <input type="checkbox" ${checkedAttr} onchange="SrcMgr.toggle('${d.document_id}', this.checked)">
                        <span class="slider"></span>
                    </label>
                    <span class="src-icon">${ico}</span>
                    <div class="src-edit-inline">
                        <input type="text" id="srcEditInput" value="${displayName.replace(/"/g, '&quot;')}" 
                               onkeydown="if(event.key==='Enter')SrcMgr.saveEdit('${d.document_id}'); if(event.key==='Escape')SrcMgr.cancelEdit();">
                        <button onclick="SrcMgr.saveEdit('${d.document_id}')" title="Guardar">âœ“</button>
                        <button onclick="SrcMgr.cancelEdit()" title="Cancelar">âœ•</button>
                    </div>
                </div>`;
            }

            return `<div class="src-item${disabledClass}">
                <label class="src-toggle">
                    <input type="checkbox" ${checkedAttr} onchange="SrcMgr.toggle('${d.document_id}', this.checked)">
                    <span class="slider"></span>
                </label>
                <span class="src-icon">${ico}</span>
                <div class="src-info">
                    <div class="src-name" title="${displayName}">${displayName}</div>
                    <div class="src-meta">${d.document_id} Â· ${statusBadge(d.status)} Â· ${d.chunk_count || 0} chunks Â· ${formatBytes(d.file_size_bytes || 0)}${!isSystemName ? ' Â· ğŸ“ nombre editado' : ''}</div>
                </div>
                <div class="src-actions">
                    <button class="src-act-btn" onclick="SrcMgr.startEdit('${d.document_id}')" title="Editar nombre">âœï¸</button>
                    <button class="src-act-btn" onclick="DocMgr.reindex('${d.document_id}')" title="Re-indexar">ğŸ”„</button>
                    <button class="src-act-btn danger" onclick="DocMgr.confirmDeleteOne('${d.document_id}','${(d.filename||'').replace(/'/g, "\\'") }')" title="Eliminar">ğŸ—‘ï¸</button>
                </div>
            </div>`;
        }).join('');

        // Auto-focus edit input
        if (this.editing) {
            const inp = document.getElementById('srcEditInput');
            if (inp) { inp.focus(); inp.select(); }
        }
    },

    // â”€â”€ Toggle source â”€â”€
    toggle(docId, checked) {
        let map = this.getEnabled();
        if (!map) {
            // First toggle: create map from current state (all enabled)
            map = {};
            DocMgr.docs.forEach(d => { map[d.document_id] = true; });
        }
        map[docId] = checked;
        this.setEnabled(map);
        this.updateBadge();
        this.renderList();
        this.updateBar();
        // Notify â€” will be used by backend when source filtering is available
        this.onSelectionChange();
    },

    enableAll() {
        // Remove the enabled map entirely = default all enabled
        localStorage.removeItem(this._storeKey('enabled'));
        this.updateBadge();
        this.renderList();
        this.updateBar();
        this.onSelectionChange();
    },

    disableAll() {
        const map = {};
        DocMgr.docs.forEach(d => { map[d.document_id] = false; });
        this.setEnabled(map);
        this.updateBadge();
        this.renderList();
        this.updateBar();
        this.onSelectionChange();
    },

    // â”€â”€ Edit name â”€â”€
    startEdit(docId) {
        this.editing = docId;
        this.renderList();
    },

    cancelEdit() {
        this.editing = null;
        this.renderList();
    },

    saveEdit(docId) {
        const inp = document.getElementById('srcEditInput');
        if (!inp) return;
        const newName = inp.value.trim();
        const doc = DocMgr.docs.find(d => d.document_id === docId);
        // If user clears the name or sets it back to the system name, remove custom name
        if (!newName || (doc && (newName === doc.filename || newName === doc.document_id))) {
            this.setName(docId, '');
        } else {
            this.setName(docId, newName);
        }
        this.editing = null;
        this.renderList();
        this.updateBar();
        toast('âœ… Nombre actualizado', 'success');
    },

    // â”€â”€ Selection change callback â”€â”€
    // This is called when sources are toggled. Currently stores state for future
    // backend integration. When backend supports source_filter, this will send
    // the active document_ids to filter vector search.
    onSelectionChange() {
        const activeIds = this.getActiveIds();
        const total = DocMgr.docs.length;
        console.log(`[SrcMgr] Sources: ${activeIds.length}/${total} active`, activeIds);
        // TODO: When backend supports source_filter in /query and /chat/completions,
        // update the API calls to include document_ids filter.
        // e.g. api.setSourceFilter(activeIds.length < total ? activeIds : null);
    }
};

// Override documents loader to use DocMgr
async function loadDocuments() { DocMgr.init(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE: TENANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTenants() {
    try {
        const data = await api.listTenants(true);
        const container = document.getElementById('tenantCards');

        if (!data.tenants || data.tenants.length === 0) {
            container.innerHTML = `<div class="empty-state" style="grid-column:1/-1">
                <div class="icon">ğŸ¢</div><h3>Sin tenants</h3>
                <p>Crea un tenant para comenzar</p></div>`;
            return;
        }

        container.innerHTML = data.tenants.map(t => `
            <div class="stat-card" style="cursor:default">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <span style="font-weight:700;font-size:15px">${t.name}</span>
                    ${t.is_active !== false ? '<span class="badge badge-success">Activo</span>' : '<span class="badge badge-muted">Inactivo</span>'}
                </div>
                <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">
                    <code style="background:var(--bg-input);padding:2px 6px;border-radius:4px">${t.tenant_id}</code>
                </div>
                ${t.description ? `<div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">${t.description}</div>` : ''}
                <div style="display:flex;gap:12px;font-size:12px;color:var(--text-muted);margin-bottom:12px">
                    <span>ğŸ§  ${t.default_model || 'â€”'}</span>
                    <span>ğŸŒ ${t.response_language || 'â€”'}</span>
                    <span>ğŸ“„ ${t.document_count ?? 0} docs</span>
                </div>
                <div style="display:flex;gap:8px">
                    <button class="btn btn-sm" onclick="editTenant('${t.tenant_id}')">âœï¸ Editar</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteTenantAction('${t.tenant_id}','${t.name}')">ğŸ—‘ï¸</button>
                </div>
            </div>
        `).join('');
    } catch (e) {
        document.getElementById('tenantCards').innerHTML = 
            `<div style="color:var(--danger);padding:20px">âŒ Error: ${e.message}</div>`;
    }
}

function showTenantModal() {
    document.getElementById('tenantModalTitle').textContent = 'Nuevo Tenant';
    document.getElementById('tenantIdInput').value = '';
    document.getElementById('tenantIdInput').disabled = false;
    document.getElementById('tenantNameInput').value = '';
    document.getElementById('tenantDescInput').value = '';
    document.getElementById('tenantModelInput').value = 'anthropic/claude-3-haiku';
    document.getElementById('tenantLangInput').value = 'es';
    document.getElementById('tenantPromptInput').value = '';
    openModal('tenantModal');
}

async function editTenant(id) {
    try {
        const t = await api.getTenant(id);
        document.getElementById('tenantModalTitle').textContent = `Editar: ${t.name}`;
        document.getElementById('tenantIdInput').value = t.tenant_id;
        document.getElementById('tenantIdInput').disabled = true;
        document.getElementById('tenantNameInput').value = t.name || '';
        document.getElementById('tenantDescInput').value = t.description || '';
        document.getElementById('tenantModelInput').value = t.default_model || '';
        document.getElementById('tenantLangInput').value = t.response_language || 'es';
        document.getElementById('tenantPromptInput').value = '';
        openModal('tenantModal');
    } catch (e) {
        toast(`âŒ Error cargando tenant: ${e.message}`, 'error');
    }
}

async function saveTenant() {
    const id = document.getElementById('tenantIdInput').value.trim();
    const isEdit = document.getElementById('tenantIdInput').disabled;
    const data = {
        name: document.getElementById('tenantNameInput').value.trim(),
        description: document.getElementById('tenantDescInput').value.trim() || undefined,
        default_model: document.getElementById('tenantModelInput').value.trim() || undefined,
        response_language: document.getElementById('tenantLangInput').value,
    };
    const prompt = document.getElementById('tenantPromptInput').value.trim();
    if (prompt && prompt.length >= 10) data.system_prompt = prompt;

    if (!id || !data.name) { toast('ID y Nombre son requeridos', 'error'); return; }

    try {
        if (isEdit) {
            await api.updateTenant(id, data);
            toast(`âœ… Tenant "${data.name}" actualizado`, 'success');
        } else {
            data.tenant_id = id;
            await api.createTenant(data);
            toast(`âœ… Tenant "${data.name}" creado`, 'success');
        }
        closeModal('tenantModal');
        loadTenants();
    } catch (e) {
        toast(`âŒ Error: ${e.message}`, 'error');
    }
}

async function deleteTenantAction(id, name) {
    const del = confirm(`Â¿Eliminar tenant "${name}" (${id})?\n\nâš ï¸ Â¿TambiÃ©n eliminar la colecciÃ³n de documentos?`);
    if (!del) return;
    const delCol = confirm('Â¿Eliminar tambiÃ©n la colecciÃ³n ChromaDB? (DESTRUCTIVO)');
    try {
        await api.deleteTenant(id, delCol);
        toast(`ğŸ—‘ï¸ Tenant "${name}" eliminado`, 'success');
        loadTenants();
    } catch (e) {
        toast(`âŒ Error: ${e.message}`, 'error');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE: AGENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAgents() {
    try {
        const data = await api.listAgents();
        const container = document.getElementById('agentCards');
        const agents = Array.isArray(data) ? data : (data.agents || []);

        if (agents.length === 0) {
            container.innerHTML = `<div class="empty-state" style="grid-column:1/-1">
                <div class="icon">ğŸ¤–</div><h3>Sin agentes</h3>
                <p>Crea un agente RAG con su propia base de conocimientos</p></div>`;
            return;
        }

        container.innerHTML = agents.map(a => `
            <div class="stat-card" style="cursor:default">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <span style="font-weight:700;font-size:15px">${a.name}</span>
                    ${statusBadge(a.status)}
                </div>
                <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">
                    <code style="background:var(--bg-input);padding:2px 6px;border-radius:4px">${a.tenant_id}</code>
                </div>
                ${a.description ? `<div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">${a.description}</div>` : ''}
                <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px">
                    Creado: ${new Date(a.created_at).toLocaleDateString('es')}
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <button class="btn btn-sm btn-primary" onclick="queryAgentUI('${a.tenant_id}')">ğŸ’¬ Consultar</button>
                    <button class="btn btn-sm" onclick="viewAgentStats('${a.tenant_id}')">ğŸ“Š Stats</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteAgentAction('${a.tenant_id}','${a.name}')">ğŸ—‘ï¸</button>
                </div>
            </div>
        `).join('');
    } catch (e) {
        document.getElementById('agentCards').innerHTML = 
            `<div style="color:var(--danger);padding:20px">âŒ Error: ${e.message}</div>`;
    }
}

function showAgentModal() { openModal('agentModal'); }

async function saveAgent() {
    const id = document.getElementById('agentIdInput').value.trim();
    const name = document.getElementById('agentNameInput').value.trim();
    const desc = document.getElementById('agentDescInput').value.trim();

    if (!id || !name) { toast('ID y Nombre son requeridos', 'error'); return; }

    try {
        await api.createAgent({ tenant_id: id, name, description: desc || '' });
        toast(`âœ… Agente "${name}" creado`, 'success');
        closeModal('agentModal');
        loadAgents();
    } catch (e) {
        toast(`âŒ Error: ${e.message}`, 'error');
    }
}

async function deleteAgentAction(id, name) {
    if (!confirm(`Â¿Eliminar agente "${name}"?\n\nâš ï¸ Esto elimina:\n- ColecciÃ³n de vectores\n- CachÃ©\n- ConfiguraciÃ³n`)) return;
    try {
        await api.deleteAgent(id);
        toast(`ğŸ—‘ï¸ Agente "${name}" eliminado`, 'success');
        loadAgents();
    } catch (e) {
        toast(`âŒ Error: ${e.message}`, 'error');
    }
}

function queryAgentUI(tenantId) {
    // Switch to chat and set session
    document.getElementById('chatSessionId').value = `agent-${tenantId}`;
    toast(`ğŸ’¬ Consulta al agente ${tenantId} â€” usa el chat`, 'info');
    nav('chat');
}

async function viewAgentStats(tenantId) {
    try {
        const stats = await api.agentStats(tenantId);
        alert(JSON.stringify(stats, null, 2));
    } catch (e) {
        toast(`âŒ Error: ${e.message}`, 'error');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE: ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAnalytics() {
    loadHealthStatus();
    loadFeedbackStats();
    loadSystemStats();
    loadFeedbackList();
}

async function loadHealthStatus() {
    const grid = document.getElementById('healthGrid');
    const services = [
        { name: 'RAG API', check: () => api.health() },
        { name: 'MCP Server', check: () => api.mcpHealth() },
    ];

    let html = '';
    for (const svc of services) {
        try {
            await svc.check();
            html += `<div class="health-item"><div class="dot" style="background:var(--success)"></div>
                <div><div class="name">${svc.name}</div><div class="status">healthy</div></div></div>`;
        } catch {
            html += `<div class="health-item"><div class="dot" style="background:var(--danger)"></div>
                <div><div class="name">${svc.name}</div><div class="status">offline</div></div></div>`;
        }
    }
    grid.innerHTML = html;
}

async function loadFeedbackStats() {
    try {
        const stats = await api.feedbackStats();
        const panel = document.getElementById('feedbackPanel');

        const total = stats.total_feedback || 0;
        const posRate = stats.positive_rate || 0;
        const negRate = 100 - posRate;

        panel.innerHTML = `
            <div style="margin-bottom:16px">
                <div style="display:flex;justify-content:space-between;margin-bottom:6px">
                    <span style="font-size:13px">SatisfacciÃ³n</span>
                    <span style="font-size:13px;font-weight:700;color:${posRate >= 70 ? 'var(--success)' : posRate >= 40 ? 'var(--warning)' : 'var(--danger)'}">${posRate.toFixed(0)}%</span>
                </div>
                <div class="progress-bar">
                    <div class="fill" style="width:${posRate}%;background:var(--success)"></div>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:13px">
                <div>ğŸ‘ Positivos: <strong>${stats.positive_count}</strong></div>
                <div>ğŸ‘ Negativos: <strong>${stats.negative_count}</strong></div>
                <div>ğŸ“Š Total: <strong>${total}</strong></div>
                <div>âš ï¸ Baja confianza: <strong>${stats.low_confidence_count}</strong></div>
                <div>ğŸ“‹ Sin revisar: <strong>${stats.unreviewed_count}</strong></div>
            </div>
            ${stats.common_negative_queries?.length ? `
                <div style="margin-top:12px;font-size:12px;color:var(--text-muted)">
                    <strong>Queries negativas frecuentes:</strong><br>
                    ${stats.common_negative_queries.map(q => `â€¢ ${q}`).join('<br>')}
                </div>
            ` : ''}
        `;
    } catch (e) {
        document.getElementById('feedbackPanel').innerHTML = 
            `<div style="color:var(--danger)">âŒ ${e.message}</div>`;
    }
}

async function loadSystemStats() {
    try {
        const stats = await api.getStats();
        const panel = document.getElementById('systemPanel');
        panel.innerHTML = `
            <div style="font-size:13px">
                <div style="margin-bottom:8px"><strong>Tenant:</strong> ${stats.tenant_id}</div>
                <div style="margin-bottom:8px"><strong>Vector DB:</strong></div>
                <pre style="background:var(--bg-input);padding:10px;border-radius:6px;font-size:11px;overflow-x:auto;color:var(--text-secondary)">${JSON.stringify(stats.vector_database, null, 2)}</pre>
                <div style="margin:8px 0"><strong>Cache:</strong></div>
                <pre style="background:var(--bg-input);padding:10px;border-radius:6px;font-size:11px;overflow-x:auto;color:var(--text-secondary)">${JSON.stringify(stats.cache, null, 2)}</pre>
            </div>
        `;
    } catch (e) {
        document.getElementById('systemPanel').innerHTML = 
            `<div style="color:var(--danger)">âŒ ${e.message}</div>`;
    }
}

async function loadFeedbackList() {
    try {
        const data = await api.listFeedback({ limit: 20 });
        const tbody = document.getElementById('feedbackTableBody');
        const items = Array.isArray(data) ? data : (data.feedback || data.items || []);

        if (items.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state">
                <div class="icon">ğŸ“</div><h3>Sin feedback</h3>
                <p>Los feedback de las evaluaciones aparecerÃ¡n aquÃ­</p></div></td></tr>`;
            return;
        }

        tbody.innerHTML = items.map(f => `
            <tr>
                <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${f.query || ''}">${f.query || 'â€”'}</td>
                <td>${f.rating === 'positive' ? '<span class="badge badge-success">ğŸ‘</span>' : '<span class="badge badge-danger">ğŸ‘</span>'}</td>
                <td>${f.confidence !== null && f.confidence !== undefined ? `${(f.confidence * 100).toFixed(0)}%` : 'â€”'}</td>
                <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${f.comment || 'â€”'}</td>
                <td>${f.reviewed ? '<span class="badge badge-success">âœ“</span>' : '<span class="badge badge-warning">pendiente</span>'}</td>
                <td>
                    ${!f.reviewed ? `<button class="btn btn-sm" onclick="markReviewed('${f.feedback_id || f.id}')">âœ“ Revisar</button>` : ''}
                </td>
            </tr>
        `).join('');
    } catch (e) {
        document.getElementById('feedbackTableBody').innerHTML = 
            `<tr><td colspan="6" style="color:var(--danger);padding:20px">âŒ ${e.message}</td></tr>`;
    }
}

async function markReviewed(id) {
    try {
        await api.markReviewed(id, 'Revisado desde dashboard');
        toast('âœ… Feedback marcado como revisado', 'success');
        loadFeedbackList();
    } catch (e) {
        toast(`âŒ Error: ${e.message}`, 'error');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE: ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAdmin() {
    loadMcpTools();
    loadMcpPrompts();
    loadMcpResources();
    loadModels();
}

async function loadMcpTools() {
    try {
        const data = await api.mcpTools();
        const tools = data.tools || [];
        document.getElementById('mcpToolsPanel').innerHTML = tools.map(t => `
            <div style="margin-bottom:16px;padding:12px;background:var(--bg-input);border-radius:var(--radius-sm)">
                <div style="font-weight:700;font-size:14px;color:var(--primary);margin-bottom:6px">ğŸ”§ ${t.name}</div>
                <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">${(t.description || '').trim().split('\n')[0].trim()}</div>
                <div style="font-size:11px">
                    <strong>ParÃ¡metros:</strong>
                    ${Object.entries(t.parameters || {}).map(([k,v]) => 
                        `<span class="badge badge-muted" style="margin:2px">${k}: ${v.type}${v.default !== undefined ? ` = ${v.default}` : ''}</span>`
                    ).join(' ')}
                </div>
            </div>
        `).join('') || '<div class="empty-state">Sin tools</div>';
    } catch (e) {
        document.getElementById('mcpToolsPanel').innerHTML = `<div style="color:var(--danger)">âŒ ${e.message}</div>`;
    }
}

async function loadMcpPrompts() {
    try {
        const data = await api.mcpPrompts();
        const prompts = data.prompts || [];
        document.getElementById('mcpPromptsPanel').innerHTML = prompts.map(p => `
            <div style="margin-bottom:16px;padding:12px;background:var(--bg-input);border-radius:var(--radius-sm)">
                <div style="font-weight:700;font-size:14px;color:var(--secondary);margin-bottom:6px">ğŸ“ ${p.name}</div>
                <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">${(p.description || '').trim().split('\n')[0].trim()}</div>
                <div style="font-size:11px">
                    <strong>Args:</strong>
                    ${(p.arguments || []).map(a => `<span class="badge badge-info" style="margin:2px">${a}</span>`).join(' ')}
                </div>
            </div>
        `).join('') || '<div class="empty-state">Sin prompts</div>';
    } catch (e) {
        document.getElementById('mcpPromptsPanel').innerHTML = `<div style="color:var(--danger)">âŒ ${e.message}</div>`;
    }
}

async function loadMcpResources() {
    try {
        const data = await api.mcpResources();
        const resources = data.resources || [];
        document.getElementById('mcpResourcesPanel').innerHTML = resources.map(r => `
            <div style="display:inline-flex;align-items:center;gap:8px;margin:4px;padding:10px 14px;background:var(--bg-input);border-radius:var(--radius-sm)">
                <span style="font-size:12px;font-weight:700;color:var(--info)">${r.uri}</span>
                <span style="font-size:11px;color:var(--text-muted)">${(r.description || '').trim().split('\n')[0].trim()}</span>
                <button class="btn btn-sm" onclick="fetchResource('${r.uri}')">ğŸ“¥</button>
            </div>
        `).join('') || '<div class="empty-state">Sin resources</div>';
    } catch (e) {
        document.getElementById('mcpResourcesPanel').innerHTML = `<div style="color:var(--danger)">âŒ ${e.message}</div>`;
    }
}

async function fetchResource(uri) {
    try {
        const path = uri.replace('rag://', '');
        const data = await api.mcpGetResource(path);
        alert(JSON.stringify(data, null, 2));
    } catch (e) {
        toast(`âŒ Error: ${e.message}`, 'error');
    }
}

async function loadModels() {
    try {
        const data = await api.listModels();
        const models = data.data || [];
        document.getElementById('modelsPanel').innerHTML = models.map(m => `
            <div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)">
                <span style="font-size:20px">ğŸ§ </span>
                <div>
                    <div style="font-weight:700;font-size:14px">${m.id}</div>
                    <div style="font-size:12px;color:var(--text-muted)">${m.description || m.owned_by || 'â€”'}</div>
                </div>
            </div>
        `).join('') || '<div class="empty-state">Sin modelos</div>';
    } catch (e) {
        document.getElementById('modelsPanel').innerHTML = `<div style="color:var(--danger)">âŒ ${e.message}</div>`;
    }
}

async function clearCacheAction() {
    const tenantId = document.getElementById('cacheTenantId').value.trim() || 'default';
    if (!confirm(`Â¿Limpiar cachÃ© del tenant "${tenantId}"?`)) return;
    try {
        await api.clearCache(tenantId);
        toast(`âœ… CachÃ© de "${tenantId}" limpiado`, 'success');
    } catch (e) {
        toast(`âŒ Error: ${e.message}`, 'error');
    }
}

async function resetReindexAction() {
    if (!confirm('âš ï¸ RESET NUCLEAR\n\nEsto eliminarÃ¡:\n- Toda la colecciÃ³n ChromaDB\n- El registro de documentos\n\nY re-indexarÃ¡ todo desde sources.\n\nÂ¿Continuar?')) return;
    if (!confirm('Â¿ESTÃS SEGURO? Esta operaciÃ³n no se puede deshacer.')) return;

    try {
        toast('â˜¢ï¸ Ejecutando reset completo...', 'info');
        const result = await api.resetReindex();
        toast(`âœ… Reset completo: ${result.successful} docs re-indexados en ${result.elapsed_seconds?.toFixed(1)}s`, 'success');
    } catch (e) {
        toast(`âŒ Error: ${e.message}`, 'error');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEALTH CHECK (header badge)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkHealth() {
    const badge = document.getElementById('healthBadge');
    const text = document.getElementById('healthText');
    try {
        await api.health();
        badge.classList.remove('offline');
        text.textContent = 'healthy';
    } catch {
        badge.classList.add('offline');
        text.textContent = 'offline';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init() {
    // Route from hash
    const hash = window.location.hash.replace('#', '') || 'chat';
    if (modules.includes(hash)) nav(hash);

    // Health check
    checkHealth();
    setInterval(checkHealth, 30000);

    // Hash change
    window.addEventListener('hashchange', () => {
        const h = window.location.hash.replace('#', '');
        if (modules.includes(h)) nav(h);
    });
})();
</script>
</body>
</html>

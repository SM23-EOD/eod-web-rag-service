<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRAGA â€” Instance Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M8 68 Q8 60 18 56 H74 Q84 56 86 68 Z' fill='%237c3aed'/><rect x='20' y='42' width='24' height='14' rx='4' fill='%23a78bfa'/><rect x='24' y='46' width='7' height='7' rx='2' fill='%23312e81'/><rect x='33' y='46' width='7' height='7' rx='2' fill='%23312e81'/><path d='M54 54 L54 26 L80 48' stroke='%23c4b5fd' stroke-width='5' stroke-linecap='round' stroke-linejoin='round' fill='none'/><path d='M76 44 L86 44 L84 54 L78 54 Z' fill='%23fbbf24'/><rect x='28' y='32' width='8' height='10' rx='2' fill='%236d28d9'/><circle cx='32' cy='28' r='4' fill='%23c4b5fd' opacity='.5'/><circle cx='37' cy='23' r='3' fill='%23c4b5fd' opacity='.3'/><path d='M2 78 Q14 72 26 78 Q38 84 50 78 Q62 72 74 78 Q86 84 98 78' fill='none' stroke='%23818cf8' stroke-width='3' stroke-linecap='round'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="src/api-client.js"></script>
    <style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAGA INSTANCE DASHBOARD â€” DESIGN TOKENS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
    --draga-accent:#7c3aed;--draga-accent-light:#a78bfa;--draga-accent-alpha:rgba(124,58,237,0.15);
    --draga-gradient:linear-gradient(135deg,#7c3aed 0%,#4f46e5 50%,#2563eb 100%);
    --draga-glow:0 0 40px rgba(124,58,237,0.25);
    --success:#22c55e;--danger:#ef4444;--warning:#f59e0b;--info:#3b82f6;
    --bg-dark:#0c0f1a;--bg-main:#131a2b;--bg-card:#1a2236;--bg-card-hover:#212b42;--bg-input:#242e44;
    --text-primary:#f0f2f5;--text-secondary:#94a3b8;--text-muted:#64748b;
    --border:#243049;--border-light:#334155;
    --radius:12px;--radius-sm:8px;--radius-lg:16px;--transition:0.25s ease;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Lato',-apple-system,sans-serif;background:var(--bg-dark);color:var(--text-primary);min-height:100vh;overflow-x:hidden;}
.di{display:inline-block;width:1em;height:1em;vertical-align:-0.15em;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M8 68 Q8 60 18 56 H74 Q84 56 86 68 Z' fill='%237c3aed'/%3E%3Crect x='20' y='42' width='24' height='14' rx='4' fill='%23a78bfa'/%3E%3Crect x='24' y='46' width='7' height='7' rx='2' fill='%23312e81'/%3E%3Crect x='33' y='46' width='7' height='7' rx='2' fill='%23312e81'/%3E%3Cpath d='M54 54 L54 26 L80 48' stroke='%23c4b5fd' stroke-width='5' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M76 44 L86 44 L84 54 L78 54 Z' fill='%23fbbf24'/%3E%3Crect x='28' y='32' width='8' height='10' rx='2' fill='%236d28d9'/%3E%3Ccircle cx='32' cy='28' r='4' fill='%23c4b5fd' opacity='.5'/%3E%3Ccircle cx='37' cy='23' r='3' fill='%23c4b5fd' opacity='.3'/%3E%3Cpath d='M2 78 Q14 72 26 78 Q38 84 50 78 Q62 72 74 78 Q86 84 98 78' fill='none' stroke='%23818cf8' stroke-width='3' stroke-linecap='round'/%3E%3C/svg%3E") center/contain no-repeat;font-style:normal;}

/* â•â•â• LAYOUT â•â•â• */
.app{display:grid;grid-template-columns:200px 1fr;grid-template-rows:56px 1fr;height:100vh;}

/* â•â•â• HEADER â•â•â• */
.header{grid-column:1/-1;background:var(--bg-main);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:100;}
.header-left{display:flex;align-items:center;gap:12px;}
.header-brand{display:flex;align-items:center;gap:8px;text-decoration:none;color:inherit;}
.header-brand .logo{width:30px;height:30px;background:var(--draga-gradient);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:var(--draga-glow);}
.header-brand .name{font-size:16px;font-weight:900;background:var(--draga-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.header-sep{width:1px;height:28px;background:var(--border);}
.tenant-selector{display:flex;align-items:center;gap:8px;}
.tenant-selector select{background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);padding:6px 12px;font-size:12px;font-family:inherit;}
.tenant-name{font-size:14px;font-weight:700;color:var(--text-primary);}
.scope-sep{color:var(--text-muted);font-size:14px;font-weight:300;margin:0 2px;}
.header-right{display:flex;align-items:center;gap:10px;}
.health-dot{width:7px;height:7px;border-radius:50%;background:var(--success);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

/* â•â•â• SIDEBAR â•â•â• */
.sidebar{background:var(--bg-main);border-right:1px solid var(--border);padding:12px 0;overflow-y:auto;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 16px;font-size:13px;font-weight:600;color:var(--text-secondary);cursor:pointer;transition:var(--transition);text-decoration:none;border-left:3px solid transparent;}
.nav-item:hover{background:var(--bg-card-hover);color:var(--text-primary);}
.nav-item.active{background:var(--draga-accent-alpha);color:var(--draga-accent-light);border-left-color:var(--draga-accent);}
.nav-item .icon{font-size:16px;width:22px;text-align:center;}
.nav-item .badge{margin-left:auto;background:var(--draga-accent-alpha);color:var(--draga-accent-light);padding:2px 7px;border-radius:8px;font-size:9px;font-weight:700;}
.nav-sep{height:1px;background:var(--border);margin:12px 16px;}

/* â•â•â• MAIN â•â•â• */
.main{overflow-y:auto;padding:24px 28px;}
.module{display:none;}
.module.active{display:block;}
#mod-chat.active{padding-top:0;}
.page-title{font-size:22px;font-weight:900;margin-bottom:4px;}
.page-desc{font-size:13px;color:var(--text-muted);margin-bottom:20px;}
.section{margin-bottom:28px;}
.section-title{font-size:15px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px;}

/* â•â•â• CARDS â•â•â• */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-bottom:20px;}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;transition:var(--transition);}
.stat-card:hover{border-color:var(--draga-accent);}
.stat-card .label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:4px;}
.stat-card .value{font-size:24px;font-weight:900;}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:14px;}

/* â•â•â• BUTTONS â•â•â• */
.btn{padding:7px 14px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);font-size:12px;font-weight:600;cursor:pointer;transition:var(--transition);font-family:inherit;text-decoration:none;display:inline-flex;align-items:center;gap:5px;}
.btn:hover{border-color:var(--draga-accent);color:var(--text-primary);}
.btn-primary{background:var(--draga-gradient);color:#fff;border-color:transparent;}
.btn-primary:hover{opacity:0.9;border-color:transparent;}
.btn-danger{background:rgba(239,68,68,0.1);color:var(--danger);border-color:rgba(239,68,68,0.3);}
.btn-sm{padding:5px 10px;font-size:11px;}
.btn-icon{padding:5px 8px;font-size:14px;background:transparent;border:none;cursor:pointer;color:var(--text-muted);border-radius:var(--radius-sm);}
.btn-icon:hover{background:var(--bg-card-hover);color:var(--text-primary);}

/* â•â•â• BADGES â•â•â• */
.badge{display:inline-flex;align-items:center;padding:3px 9px;border-radius:10px;font-size:10px;font-weight:700;text-transform:uppercase;}
.badge-success{background:rgba(34,197,94,0.12);color:var(--success);}
.badge-danger{background:rgba(239,68,68,0.12);color:var(--danger);}
.badge-warning{background:rgba(245,158,11,0.12);color:var(--warning);}
.badge-info{background:rgba(59,130,246,0.12);color:var(--info);}
.badge-muted{background:rgba(100,116,139,0.12);color:var(--text-muted);}
.badge-draga{background:var(--draga-accent-alpha);color:var(--draga-accent-light);}

/* â•â•â• TABLES â•â•â• */
table{width:100%;border-collapse:collapse;font-size:12px;}
th{text-align:left;padding:8px 10px;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);border-bottom:1px solid var(--border);font-weight:700;}
td{padding:8px 10px;border-bottom:1px solid rgba(36,48,73,0.5);}
tr:hover td{background:var(--bg-card);}

/* â•â•â• FORMS â•â•â• */
.form-group{margin-bottom:12px;}
.form-group label{display:block;font-size:11px;font-weight:700;color:var(--text-secondary);margin-bottom:4px;}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:8px 11px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:12px;font-family:inherit;transition:var(--transition);}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--draga-accent);}
.form-group textarea{resize:vertical;min-height:70px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}

/* â•â•â• MODALS â•â•â• */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);width:90%;max-width:520px;max-height:80vh;overflow-y:auto;padding:24px;}
.modal-title{font-size:16px;font-weight:900;margin-bottom:16px;}
.modal-footer{display:flex;justify-content:flex-end;gap:8px;margin-top:16px;padding-top:14px;border-top:1px solid var(--border);}

/* â•â•â• PROGRESS BAR â•â•â• */
.progress-bar{height:8px;background:var(--bg-input);border-radius:4px;overflow:hidden;}
.progress-bar .fill{height:100%;border-radius:4px;background:var(--draga-gradient);transition:width 1s ease;}
.progress-bar .fill.complete{background:var(--success);}

/* â•â•â• INGESTION TRACKER â•â•â• */
.ingest-tracker{background:var(--bg-card);border:1px solid var(--draga-accent);border-radius:var(--radius);padding:14px 16px;margin-bottom:16px;animation:slideIn .3s ease;}
.ingest-tracker.done{border-color:var(--success);}
.ingest-tracker.error{border-color:var(--danger);}
.ingest-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.ingest-header .title{font-weight:700;font-size:13px;display:flex;align-items:center;gap:8px;}
.ingest-header .title .spinner{width:14px;height:14px;}
.ingest-header .meta{font-size:11px;color:var(--text-muted);}
.ingest-files{display:flex;flex-direction:column;gap:4px;margin-top:8px;max-height:180px;overflow-y:auto;}
.ingest-file{display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:var(--radius-sm);background:var(--bg-input);font-size:12px;}
.ingest-file .f-icon{font-size:14px;flex-shrink:0;}
.ingest-file .f-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.ingest-file .f-status{flex-shrink:0;font-size:11px;font-weight:600;}
.ingest-file .f-status.processing{color:var(--info);}
.ingest-file .f-status.done{color:var(--success);}
.ingest-file .f-status.failed{color:var(--danger);}
.ingest-file .f-status.pending{color:var(--text-muted);}
.ingest-file .f-status.duplicate{color:var(--warning);}
.ingest-dismiss{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px;padding:0 4px;}
.ingest-dismiss:hover{color:var(--text-primary);}

/* â•â•â• TOAST â•â•â• */
.toast-container{position:fixed;top:64px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:6px;}
.toast{padding:9px 16px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;animation:slideIn .3s ease;max-width:340px;}
.toast-error{background:#991b1b;color:#fecaca;}.toast-info{background:#1e3a5f;color:#93c5fd;}.toast-success{background:#166534;color:#bbf7d0;}.toast-warning{background:#78350f;color:#fde68a;}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* â•â•â• SPINNER â•â•â• */
.spinner{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--draga-accent);border-radius:50%;animation:spin .6s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading{text-align:center;padding:32px;color:var(--text-muted);}
.empty-state{text-align:center;padding:40px 16px;color:var(--text-muted);}
.empty-state .icon{font-size:40px;margin-bottom:10px;}
.empty-state h3{font-size:15px;margin-bottom:4px;color:var(--text-secondary);}

/* â•â•â• PIPELINE STEPS â•â•â• */
.pipeline-phases{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.phase-col{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;position:relative;}
.phase-col::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:var(--radius) var(--radius) 0 0;}
.phase-col:nth-child(1)::before{background:var(--info);}
.phase-col:nth-child(2)::before{background:var(--success);}
.phase-col:nth-child(3)::before{background:var(--warning);}
.phase-col:nth-child(4)::before{background:var(--danger);}
.phase-col .phase-name{font-size:11px;text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:10px;}
.phase-col:nth-child(1) .phase-name{color:var(--info);}
.phase-col:nth-child(2) .phase-name{color:var(--success);}
.phase-col:nth-child(3) .phase-name{color:var(--warning);}
.phase-col:nth-child(4) .phase-name{color:var(--danger);}
.step-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:var(--radius-sm);margin-bottom:4px;font-size:11px;color:var(--text-secondary);background:var(--bg-input);transition:var(--transition);}
.step-item:hover{background:var(--bg-card-hover);color:var(--text-primary);}
.step-num{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:900;flex-shrink:0;}
.phase-col:nth-child(1) .step-num{background:rgba(59,130,246,0.15);color:var(--info);}
.phase-col:nth-child(2) .step-num{background:rgba(34,197,94,0.15);color:var(--success);}
.phase-col:nth-child(3) .step-num{background:rgba(245,158,11,0.15);color:var(--warning);}
.phase-col:nth-child(4) .step-num{background:rgba(239,68,68,0.15);color:var(--danger);}

/* â•â•â• DOCUMENT TABLE â•â•â• */
.doc-toolbar{display:flex;gap:10px;align-items:center;margin-bottom:14px;flex-wrap:wrap;}
.doc-toolbar input[type="text"]{flex:1;min-width:200px;padding:7px 12px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:12px;}
.filter-pills{display:flex;gap:4px;}
.filter-pill{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:600;background:var(--bg-input);color:var(--text-muted);border:none;cursor:pointer;transition:var(--transition);}
.filter-pill.active{background:var(--draga-accent-alpha);color:var(--draga-accent-light);}
.filter-pill:hover{color:var(--text-primary);}
.pagination{display:flex;align-items:center;gap:8px;justify-content:center;margin-top:14px;font-size:12px;color:var(--text-muted);}

/* â•â•â• UPLOAD â•â•â• */
.drop-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:32px;text-align:center;cursor:pointer;transition:var(--transition);margin-bottom:14px;}
.drop-zone:hover,.drop-zone.drag-over{border-color:var(--draga-accent);background:var(--draga-accent-alpha);}
.drop-zone .dz-icon{font-size:36px;margin-bottom:8px;}
.drop-zone .dz-text{font-size:13px;color:var(--text-muted);}
.upload-file-item{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-input);border-radius:var(--radius-sm);margin-bottom:4px;font-size:12px;}
.upload-file-item .uf-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.upload-file-item .uf-size{color:var(--text-muted);font-size:11px;}
.upload-file-item .uf-remove{background:none;border:none;color:var(--danger);cursor:pointer;font-size:14px;padding:2px 6px;}

/* â•â•â• CHAT â•â•â• */
.chat-container{display:flex;flex-direction:column;height:calc(100vh - 150px);min-height:300px;}
.chat-messages{flex:1;overflow-y:auto;padding:16px 0;}
.chat-msg{margin-bottom:14px;padding:12px 16px;border-radius:var(--radius);max-width:85%;font-size:13px;line-height:1.6;}
.chat-msg.user{background:var(--draga-accent-alpha);margin-left:auto;border-bottom-right-radius:4px;}
.chat-msg.assistant{background:var(--bg-card);border:1px solid var(--border);border-bottom-left-radius:4px;}
.chat-msg.assistant pre{background:var(--bg-input);padding:10px;border-radius:var(--radius-sm);overflow-x:auto;font-size:12px;margin:8px 0;}
.chat-msg.assistant code{background:var(--bg-input);padding:1px 5px;border-radius:3px;font-size:12px;}
.chat-msg.assistant pre code{background:none;padding:0;}
.chat-msg.assistant ul,.chat-msg.assistant ol{padding-left:18px;margin:6px 0;}
.chat-input-bar{display:flex;gap:8px;padding-top:12px;border-top:1px solid var(--border);}
/* â•â•â• CHAT FEEDBACK â•â•â• */
.chat-feedback{display:flex;align-items:center;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:11px;color:var(--text-muted);}
.chat-fb-btn{background:none;border:1px solid var(--border);border-radius:6px;padding:3px 10px;cursor:pointer;font-size:13px;transition:var(--transition);color:var(--text-muted);display:inline-flex;align-items:center;gap:3px;}
.chat-fb-btn:hover{border-color:var(--draga-accent);color:var(--text-primary);background:var(--draga-accent-alpha);}
.chat-fb-btn.selected{border-color:var(--success);background:rgba(34,197,94,0.15);color:var(--success);}
.chat-fb-btn.selected.negative{border-color:var(--danger);background:rgba(239,68,68,0.15);color:var(--danger);}
.chat-fb-comment{display:flex;gap:6px;align-items:center;margin-top:6px;}
.chat-fb-comment input{flex:1;padding:6px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:11px;font-family:inherit;}
.chat-fb-comment input:focus{outline:none;border-color:var(--draga-accent);}
.chat-fb-comment button{padding:4px 12px;font-size:11px;}
.chat-fb-sent{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--success);}
.chat-input-bar input{flex:1;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:13px;font-family:inherit;}
.chat-input-bar input:focus{outline:none;border-color:var(--draga-accent);}

/* â•â•â• QUALITY METRIC CARDS â•â•â• */
.metric-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;text-align:center;}
.metric-card .mc-value{font-size:32px;font-weight:900;margin-bottom:2px;}
.metric-card .mc-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);}

/* â•â•â• DETAIL PANEL â•â•â• */
.detail-panel{position:fixed;top:0;right:-420px;width:400px;height:100vh;background:var(--bg-card);border-left:1px solid var(--border);z-index:200;transition:right .3s ease;overflow-y:auto;padding:24px;}
.detail-panel.open{right:0;}
.dp-field{margin-bottom:10px;}
.dp-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:2px;}
.dp-value{font-size:13px;}

/* â•â•â• GAP CARD â•â•â• */
.gap-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;margin-bottom:8px;}
.gap-card .gc-query{font-size:13px;font-weight:600;margin-bottom:6px;}
.gap-card .gc-meta{font-size:11px;color:var(--text-muted);display:flex;gap:12px;}

/* â•â•â• ANTI-HALLUC TECHNIQUES â•â•â• */
.technique-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:20px;}
.technique-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;text-align:center;}
.technique-card .tc-icon{font-size:24px;margin-bottom:6px;}
.technique-card .tc-name{font-size:12px;font-weight:700;margin-bottom:4px;}
.technique-card .tc-desc{font-size:11px;color:var(--text-muted);line-height:1.4;}

/* â•â•â• WIDGET PREVIEW â•â•â• */
.color-input-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.color-input-row input[type="color"]{width:36px;height:28px;border:none;cursor:pointer;background:none;padding:0;}

/* â•â•â• EMBED CODE â•â•â• */
.embed-block{background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;margin-bottom:12px;position:relative;}
.embed-block pre{font-size:11px;color:var(--text-secondary);white-space:pre-wrap;word-break:break-all;margin:0;}
.embed-block .copy-btn{position:absolute;top:8px;right:8px;}

/* â•â•â• DOCUMENT VIEWER â•â•â• */
.doc-viewer-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:1500;display:none;backdrop-filter:blur(6px);}
.doc-viewer-overlay.open{display:flex;flex-direction:column;}
.doc-viewer-header{display:flex;align-items:center;justify-content:space-between;padding:12px 24px;background:var(--bg-main);border-bottom:1px solid var(--border);}
.doc-viewer-header .dv-title{display:flex;align-items:center;gap:10px;font-weight:700;font-size:15px;}
.doc-viewer-header .dv-meta{display:flex;align-items:center;gap:12px;font-size:11px;color:var(--text-muted);}
.doc-viewer-body{flex:1;overflow-y:auto;padding:24px 32px;}
.chunk-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:12px;position:relative;transition:var(--transition);}
.chunk-card:hover{border-color:var(--draga-accent);}
.chunk-card .cc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.chunk-card .cc-id{font-size:10px;font-family:monospace;color:var(--text-muted);}
.chunk-card .cc-type{font-size:10px;text-transform:uppercase;font-weight:700;}
.chunk-card .cc-content{font-size:13px;line-height:1.7;color:var(--text-secondary);}
.chunk-card .cc-content table{margin:8px 0;font-size:12px;}
.chunk-card .cc-content table th{background:var(--bg-input);font-size:10px;}
.chunk-card .cc-content table td{font-size:11px;}
.chunk-card .cc-score{position:absolute;top:12px;right:14px;font-size:10px;font-weight:700;padding:2px 8px;border-radius:8px;}
.chunk-card .cc-meta{display:flex;gap:12px;margin-top:8px;font-size:10px;color:var(--text-muted);flex-wrap:wrap;}
.source-link{color:var(--draga-accent-light);cursor:pointer;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:3px;transition:var(--transition);}
.source-link:hover{color:var(--text-primary);text-decoration-style:solid;}
.source-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:14px;font-size:11px;font-weight:600;background:var(--draga-accent-alpha);color:var(--draga-accent-light);cursor:pointer;transition:var(--transition);margin:2px 2px;border:1px solid transparent;}
.source-chip:hover{border-color:var(--draga-accent);background:rgba(124,58,237,0.25);}

/* â•â•â• LABELS â•â•â• */
.label-bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:14px;padding:10px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);}
.label-bar .lb-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);margin-right:4px;}
.label-pill{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:14px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid transparent;transition:var(--transition);white-space:nowrap;}
.label-pill:hover{opacity:0.85;}
.label-pill .lp-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.label-pill .lp-x{margin-left:2px;font-size:13px;opacity:0.5;cursor:pointer;line-height:1;}
.label-pill .lp-x:hover{opacity:1;color:var(--danger);}
.label-add-btn{padding:3px 10px;border-radius:14px;font-size:11px;font-weight:600;background:var(--bg-input);color:var(--text-muted);border:1px dashed var(--border);cursor:pointer;transition:var(--transition);}
.label-add-btn:hover{border-color:var(--draga-accent);color:var(--draga-accent-light);}
.label-picker{position:absolute;top:100%;left:0;z-index:50;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px;min-width:200px;box-shadow:0 8px 24px rgba(0,0,0,0.4);max-height:240px;overflow-y:auto;}
.label-picker-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:var(--radius-sm);cursor:pointer;font-size:12px;transition:var(--transition);}
.label-picker-item:hover{background:var(--bg-card-hover);}
.label-picker-item .lpi-check{width:16px;height:16px;border:1px solid var(--border);border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;}
.label-picker-item .lpi-check.checked{background:var(--draga-accent);border-color:var(--draga-accent);color:#fff;}
.doc-labels-cell{position:relative;}
.doc-labels-wrap{display:flex;flex-wrap:wrap;gap:3px;align-items:center;}
.doc-label-mini{display:inline-flex;align-items:center;gap:3px;padding:1px 7px;border-radius:10px;font-size:9px;font-weight:600;white-space:nowrap;}
.doc-label-add{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;background:var(--bg-input);border:1px dashed var(--border);color:var(--text-muted);cursor:pointer;flex-shrink:0;transition:var(--transition);}
.doc-label-add:hover{border-color:var(--draga-accent);color:var(--draga-accent-light);}

/* â•â•â• DRAGA CATALOG â•â•â• */
.draga-catalog{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;}

/* â•â•â• WIDGET GENERATOR â•â•â• */
.wg-layout{display:grid;grid-template-columns:380px 1fr;gap:20px;align-items:start;}
.wg-config .section{margin-bottom:16px;}
.wg-list{display:flex;flex-direction:column;gap:6px;max-height:200px;overflow-y:auto;}
.wg-item{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:var(--transition);font-size:13px;}
.wg-item:hover{background:var(--bg-card-hover);border-color:var(--draga-accent-light);}
.wg-item.active{border-color:var(--draga-accent);background:var(--draga-accent-alpha);}
.wg-item .wg-item-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.wg-item .wg-item-name{font-weight:700;color:var(--text-primary);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.wg-item .wg-item-proto{font-size:9px;padding:2px 6px;border-radius:8px;font-weight:600;text-transform:uppercase;letter-spacing:.3px;flex-shrink:0;}
.wg-item .wg-item-proto.openai{background:rgba(34,197,94,.15);color:var(--success);}
.wg-item .wg-item-proto.rag{background:rgba(59,130,246,.15);color:var(--info);}
.wg-item .wg-item-proto.mcp{background:rgba(168,85,247,.15);color:#a855f7;}
.wg-item .wg-item-lock{font-size:11px;flex-shrink:0;}
.wg-preview-box{background:var(--bg-main);border:2px dashed var(--border);border-radius:var(--radius);min-height:420px;position:relative;overflow:hidden;}
.wg-preview-box iframe{display:block;}
.wg-code{background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;font-size:11px;line-height:1.6;font-family:'Consolas','Monaco',monospace;color:var(--text-secondary);overflow-x:auto;white-space:pre-wrap;word-break:break-all;max-height:500px;overflow-y:auto;}
.wg-tab{display:none;}.wg-tab.active{display:block;}
.wg-token-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:8px;font-size:9px;font-weight:700;}
.wg-token-badge.on{background:rgba(34,197,94,.15);color:var(--success);}
.wg-token-badge.off{background:rgba(100,116,139,.15);color:var(--text-muted);}
@media(max-width:900px){.wg-layout{grid-template-columns:1fr;}}
.draga-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;cursor:pointer;transition:var(--transition);position:relative;overflow:hidden;}
.draga-card:hover{background:var(--bg-card-hover);border-color:var(--draga-accent-light);transform:translateY(-2px);box-shadow:var(--draga-glow);}
.draga-card.active{border-color:var(--draga-accent);background:var(--draga-accent-alpha);}
.draga-card .dc-header{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.draga-card .dc-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.draga-card .dc-name{font-size:15px;font-weight:700;color:var(--text-primary);}
.draga-card .dc-tid{font-size:11px;color:var(--text-muted);font-family:monospace;}
.draga-card .dc-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px;}
.draga-card .dc-stat{text-align:center;padding:6px 4px;background:var(--bg-input);border-radius:var(--radius-sm);}
.draga-card .dc-stat .val{font-size:16px;font-weight:700;color:var(--text-primary);}
.draga-card .dc-stat .lbl{font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-top:2px;}
.draga-card .dc-badge{position:absolute;top:12px;right:12px;font-size:9px;padding:2px 8px;border-radius:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;}
.draga-card .dc-badge.online{background:rgba(34,197,94,.15);color:var(--success);}
.draga-card .dc-badge.offline{background:rgba(239,68,68,.15);color:var(--danger);}
.draga-card .dc-badge.loading{background:rgba(245,158,11,.15);color:var(--warning);}

/* â•â•â• RESPONSIVE â•â•â• */
@media(max-width:900px){
    .app{grid-template-columns:1fr;grid-template-rows:56px 44px 1fr;}
    .sidebar{display:flex;overflow-x:auto;padding:0 8px;gap:2px;align-items:center;border-right:none;border-bottom:1px solid var(--border);}
    .nav-item{white-space:nowrap;padding:8px 10px;border-left:none;border-bottom:3px solid transparent;font-size:12px;}
    .nav-item.active{border-left-color:transparent;border-bottom-color:var(--draga-accent);}
    .nav-sep{display:none;}
    .main{padding:14px;}
    .pipeline-phases{grid-template-columns:1fr 1fr;}
    .form-row{grid-template-columns:1fr;}
    .chat-container{height:calc(100vh - 120px);}
    #mod-chat > div:nth-child(3){grid-template-columns:1fr !important;}
    #mod-chat > div:nth-child(3) > .card{display:none;}
}
    </style>
</head>
<body>

<div class="app">
<!-- â•â•â• HEADER â•â•â• -->
<header class="header">
    <div class="header-left">
        <a href="index.html" class="header-brand">
            <div class="logo"><i class="di" style="font-size:16px;width:16px;height:16px"></i></div>
            <span class="name">DRAGA</span>
        </a>
        <div class="header-sep"></div>
        <div class="tenant-selector">
            <select id="tenantSelect" onchange="App.switchTenant(this.value)"></select>
            <span class="scope-sep">/</span>
            <select id="agentSelect" onchange="App.switchAgent(this.value)"></select>
        </div>
    </div>
    <div class="header-right">
        <span class="tenant-name" id="tenantDisplayName"></span>
        <div class="health-dot" id="healthDot" title="API Status"></div>
        <a href="admin.html" class="btn btn-sm">âš™ï¸ Admin</a>
    </div>
</header>

<!-- â•â•â• SIDEBAR â•â•â• -->
<nav class="sidebar">
    <a class="nav-item active" onclick="App.nav('overview')" data-mod="overview"><span class="icon"><i class="di"></i></span> Overview</a>
    <a class="nav-item" onclick="App.nav('knowledge')" data-mod="knowledge"><span class="icon">ğŸ“š</span> Knowledge Base <span class="badge" id="navDocCount">â€”</span></a>
    <a class="nav-item" onclick="App.nav('pipeline')" data-mod="pipeline"><span class="icon">âš™ï¸</span> Pipeline</a>
    <a class="nav-item" onclick="App.nav('quality')" data-mod="quality"><span class="icon">ğŸ›¡ï¸</span> Quality</a>
    <div class="nav-sep"></div>
    <a class="nav-item" onclick="App.nav('chat')" data-mod="chat"><span class="icon">ğŸ’¬</span> Chat</a>
    <a class="nav-item" onclick="App.nav('widgets')" data-mod="widgets"><span class="icon">ğŸ§©</span> Widgets</a>
    <a class="nav-item" onclick="App.nav('config')" data-mod="config"><span class="icon">ğŸ”§</span> Config</a>
</nav>

<!-- â•â•â• MAIN â•â•â• -->
<main class="main">

<!-- â”€â”€ OVERVIEW â”€â”€ -->
<div class="module active" id="mod-overview">
    <h1 class="page-title" id="overviewTitle">DRAGA Dashboard</h1>
    <p class="page-desc">AnatomÃ­a, arquitectura y estado del DRAGA</p>

    <div class="stats-grid" id="overviewStats">
        <div class="stat-card"><div class="label">Documentos</div><div class="value" id="ovDocs">â€”</div></div>
        <div class="stat-card"><div class="label">Chunks</div><div class="value" id="ovChunks">â€”</div></div>
        <div class="stat-card"><div class="label">Pipeline Steps</div><div class="value" style="color:var(--info)" id="ovPipelineSteps">â€”</div></div>
        <div class="stat-card"><div class="label">Modelo</div><div class="value" style="font-size:14px" id="ovModel">â€”</div></div>
        <div class="stat-card"><div class="label">Idioma</div><div class="value" id="ovLang">â€”</div></div>
        <div class="stat-card"><div class="label">ColecciÃ³n</div><div class="value" style="font-size:14px" id="ovCollection">â€”</div></div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ‰</span> DRAGAs en la Plataforma</div>
        <div id="dragaCatalog" class="draga-catalog"><div class="loading"><div class="spinner"></div> Cargando DRAGAs...</div></div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ§¬</span> AnatomÃ­a DRAGA</div>
        <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);">
            <div class="stat-card" style="text-align:center;border-top:3px solid var(--info)">
                <div style="font-size:28px;margin-bottom:6px">ğŸ¢</div>
                <div class="label">Tenant</div>
                <div style="font-size:12px;color:var(--text-secondary);margin-top:4px">Aislamiento, config, KB propia</div>
            </div>
            <div class="stat-card" style="text-align:center;border-top:3px solid var(--success)">
                <div style="font-size:28px;margin-bottom:6px">ğŸ“š</div>
                <div class="label">Knowledge Base</div>
                <div style="font-size:12px;color:var(--text-secondary);margin-top:4px">Documentos + chunks + vectores</div>
            </div>
            <div class="stat-card" style="text-align:center;border-top:3px solid var(--warning)">
                <div style="font-size:28px;margin-bottom:6px">âš™ï¸</div>
                <div class="label">Orchestrator</div>
                <div style="font-size:12px;color:var(--text-secondary);margin-top:4px">14 pasos en 4 fases</div>
            </div>
            <div class="stat-card" style="text-align:center;border-top:3px solid var(--draga-accent)">
                <div style="font-size:28px;margin-bottom:6px">ğŸ¤–</div>
                <div class="label">Agent Crew</div>
                <div style="font-size:12px;color:var(--text-secondary);margin-top:4px">6 agentes especializados</div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ¤–</span> Agent Crew (6 activos + 1 roadmap)</div>
        <div class="stats-grid" style="grid-template-columns:repeat(auto-fill,minmax(140px,1fr));">
            <div class="stat-card" style="text-align:center;padding:12px;"><div style="font-size:20px">ğŸ”</div><div style="font-size:11px;font-weight:700;margin-top:4px">Retrieval</div><div style="font-size:9px;color:var(--text-muted)">BÃºsqueda + adaptive top_k</div></div>
            <div class="stat-card" style="text-align:center;padding:12px;"><div style="font-size:20px">ğŸ›¡ï¸</div><div style="font-size:11px;font-weight:700;margin-top:4px">Grounding</div><div style="font-size:9px;color:var(--text-muted)">NLI + verificaciÃ³n</div></div>
            <div class="stat-card" style="text-align:center;padding:12px;"><div style="font-size:20px">ğŸŒ</div><div style="font-size:11px;font-weight:700;margin-top:4px">Language</div><div style="font-size:9px;color:var(--text-muted)">DetecciÃ³n + traducciÃ³n</div></div>
            <div class="stat-card" style="text-align:center;padding:12px;"><div style="font-size:20px">ğŸ“¥</div><div style="font-size:11px;font-weight:700;margin-top:4px">Ingestion</div><div style="font-size:9px;color:var(--text-muted)">Chunking + NER</div></div>
            <div class="stat-card" style="text-align:center;padding:12px;"><div style="font-size:20px">ğŸ’¬</div><div style="font-size:11px;font-weight:700;margin-top:4px">Feedback</div><div style="font-size:9px;color:var(--text-muted)">Aprendizaje continuo</div></div>
            <div class="stat-card" style="text-align:center;padding:12px;"><div style="font-size:20px">ğŸ“Š</div><div style="font-size:11px;font-weight:700;margin-top:4px">Quality</div><div style="font-size:9px;color:var(--text-muted)">Gaps + cobertura</div></div>
            <div class="stat-card" style="text-align:center;padding:12px;opacity:0.5;border-style:dashed;"><div style="font-size:20px">ğŸ§¬</div><div style="font-size:11px;font-weight:700;margin-top:4px">Taxonomy</div><div style="font-size:9px;color:var(--text-muted)">Roadmap</div></div>
        </div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ”Œ</span> Triple Protocolo</div>
        <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);">
            <div class="stat-card" id="protoRest" style="text-align:center"><div style="font-size:20px">ğŸŒ</div><div class="label" style="margin-top:6px">REST API</div><div style="font-size:11px;color:var(--text-muted);margin-top:4px" id="protoRestStatus">checking...</div></div>
            <div class="stat-card" id="protoOpenai" style="text-align:center"><div style="font-size:20px">ğŸ¤–</div><div class="label" style="margin-top:6px">OpenAI Compatible</div><div style="font-size:11px;color:var(--text-muted);margin-top:4px" id="protoOpenaiStatus">checking...</div></div>
            <div class="stat-card" id="protoMcp" style="text-align:center"><div style="font-size:20px">ğŸ”Œ</div><div class="label" style="margin-top:6px">MCP Protocol</div><div style="font-size:11px;color:var(--text-muted);margin-top:4px" id="protoMcpStatus">checking...</div></div>
        </div>
    </div>
</div>

<!-- â”€â”€ KNOWLEDGE BASE â”€â”€ -->
<div class="module" id="mod-knowledge">
    <h1 class="page-title">Knowledge Base</h1>
    <p class="page-desc">Documentos, indexaciÃ³n y gestiÃ³n de la base de conocimientos</p>

    <div class="stats-grid" id="kbStats">
        <div class="stat-card"><div class="label">Total Docs</div><div class="value" id="kbTotal">â€”</div></div>
        <div class="stat-card"><div class="label">Chunks</div><div class="value" id="kbChunks">â€”</div></div>
        <div class="stat-card"><div class="label">TamaÃ±o</div><div class="value" id="kbSize">â€”</div></div>
        <div class="stat-card"><div class="label">Indexados</div><div class="value" style="color:var(--success)" id="kbIndexed">â€”</div></div>
        <div class="stat-card"><div class="label">Errores</div><div class="value" style="color:var(--danger)" id="kbErrors">â€”</div></div>
        <div class="stat-card"><div class="label">Cobertura</div><div class="value" id="kbCoverage">â€”</div></div>
    </div>

    <div class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
            <div class="section-title" style="margin-bottom:0"><span class="icon">ğŸ“„</span> Documentos</div>
            <div style="display:flex;gap:8px;">
                <button class="btn btn-primary btn-sm" onclick="KB.openUpload()">ğŸ“¤ Subir</button>
                <button class="btn btn-sm" onclick="KB.syncDir()">ğŸ“‚ Sync Dir</button>
                <button class="btn btn-sm" onclick="KB.processPending()">â³ Procesar</button>
                <button class="btn btn-sm btn-danger" onclick="KB.confirmReset()">â˜¢ï¸ Reset</button>
            </div>
        </div>
        <!-- Ingestion progress tracker (hidden by default) -->
        <div id="ingestTracker" style="display:none;"></div>

        <div class="doc-toolbar">
            <input type="text" id="docSearch" placeholder="ğŸ” Buscar documentos..." oninput="KB.filter()">
            <div class="filter-pills">
                <button class="filter-pill active" data-f="all" onclick="KB.setFilter('all',this)">Todos</button>
                <button class="filter-pill" data-f="indexed" onclick="KB.setFilter('indexed',this)">Indexados</button>
                <button class="filter-pill" data-f="pending" onclick="KB.setFilter('pending',this)">Pendientes</button>
                <button class="filter-pill" data-f="error" onclick="KB.setFilter('error',this)">Errores</button>
            </div>
        </div>
        <!-- Label Management Bar (DISABLED â€” pending rate-limit solution) -->
        <!--
        <div class="label-bar" id="labelBar">
            <span class="lb-title">ğŸ·ï¸ Etiquetas</span>
            <div id="labelPills" style="display:contents;"></div>
            <button class="label-add-btn" onclick="KB.openLabelModal()">+ Nueva Etiqueta</button>
        </div>
        -->

        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>Archivo</th><th>Estado</th><th>CategorÃ­a</th><th>Chunks</th><th>TamaÃ±o</th><th>Fecha</th><th>Acciones</th></tr></thead>
                <tbody id="docTableBody"><tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
            </table>
        </div>
        <div class="pagination" id="docPagination" style="display:none;">
            <button class="btn btn-sm" id="docPrev" onclick="KB.prevPage()">â—‚</button>
            <span id="docPagInfo">â€”</span>
            <button class="btn btn-sm" id="docNext" onclick="KB.nextPage()">â–¸</button>
        </div>
    </div>
</div>

<!-- â”€â”€ PIPELINE â”€â”€ -->
<div class="module" id="mod-pipeline">
    <h1 class="page-title">Pipeline Monitor</h1>
    <p class="page-desc">14 pasos en 4 fases â€” Pre-Retrieval â†’ Retrieval â†’ Post-Retrieval â†’ Generation</p>

    <div class="pipeline-phases">
        <div class="phase-col">
            <div class="phase-name">Pre-Retrieval</div>
            <div class="step-item"><div class="step-num">1</div>Query Reception</div>
            <div class="step-item"><div class="step-num">2</div>Cache Check</div>
            <div class="step-item"><div class="step-num">3</div>Query Analysis</div>
            <div class="step-item"><div class="step-num">4</div>Query Expansion</div>
        </div>
        <div class="phase-col">
            <div class="phase-name">Retrieval</div>
            <div class="step-item"><div class="step-num">5</div>Embedding</div>
            <div class="step-item"><div class="step-num">6</div>Vector Search</div>
            <div class="step-item"><div class="step-num">7</div>Result Fusion</div>
        </div>
        <div class="phase-col">
            <div class="phase-name">Post-Retrieval</div>
            <div class="step-item"><div class="step-num">8</div>Reranking</div>
            <div class="step-item"><div class="step-num">9</div>Context Assembly</div>
            <div class="step-item"><div class="step-num">10</div>Gap Detection</div>
            <div class="step-item"><div class="step-num">11</div>Prompt Building</div>
        </div>
        <div class="phase-col">
            <div class="phase-name">Generation</div>
            <div class="step-item"><div class="step-num">12</div>LLM Generation</div>
            <div class="step-item"><div class="step-num">13</div>Grounding Verify</div>
            <div class="step-item"><div class="step-num">14</div>Response Format</div>
        </div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ§ª</span> Live Test</div>
        <div class="card">
            <div style="display:flex;gap:10px;margin-bottom:14px;">
                <input type="text" id="pipelineQuery" placeholder="Escribe una consulta para probar el pipeline..." style="flex:1;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:13px;" onkeydown="if(event.key==='Enter')Pipeline.run()">
                <button class="btn btn-primary" onclick="Pipeline.run()">â–¶ Ejecutar</button>
            </div>
            <div id="pipelineResult"></div>
        </div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ”’</span> Invariantes del Dominio</div>
        <div class="stats-grid" style="grid-template-columns:repeat(auto-fill,minmax(240px,1fr));">
            <div class="stat-card" style="font-size:12px;border-left:3px solid var(--success)"><strong>Sin documentos â†’ no_answer</strong><div style="color:var(--text-muted);margin-top:4px">Nunca inventa si no hay fuentes</div></div>
            <div class="stat-card" style="font-size:12px;border-left:3px solid var(--success)"><strong>Confidence < umbral â†’ warning</strong><div style="color:var(--text-muted);margin-top:4px">Alerta explÃ­cita en baja confianza</div></div>
            <div class="stat-card" style="font-size:12px;border-left:3px solid var(--success)"><strong>Fuentes siempre citadas</strong><div style="color:var(--text-muted);margin-top:4px">Toda respuesta incluye sources[]</div></div>
            <div class="stat-card" style="font-size:12px;border-left:3px solid var(--success)"><strong>Tenant isolation</strong><div style="color:var(--text-muted);margin-top:4px">KB separada por tenant</div></div>
            <div class="stat-card" style="font-size:12px;border-left:3px solid var(--success)"><strong>Idempotent ingestion</strong><div style="color:var(--text-muted);margin-top:4px">Mismo doc = mismos chunks</div></div>
            <div class="stat-card" style="font-size:12px;border-left:3px solid var(--success)"><strong>Cache = misma respuesta</strong><div style="color:var(--text-muted);margin-top:4px">Determinismo en cache hits</div></div>
        </div>
    </div>
</div>

<!-- â”€â”€ QUALITY â”€â”€ -->
<div class="module" id="mod-quality">
    <h1 class="page-title">Quality Dashboard</h1>
    <p class="page-desc">Framework anti-alucinaciÃ³n, mÃ©tricas y gestiÃ³n de gaps</p>

    <div class="stats-grid" id="qualityMetrics" style="grid-template-columns:repeat(auto-fill,minmax(150px,1fr));">
        <div class="stat-card"><div class="label">Documentos</div><div class="value" id="qmDocs">â€”</div></div>
        <div class="stat-card"><div class="label">Chunks</div><div class="value" id="qmChunks">â€”</div></div>
        <div class="stat-card"><div class="label">Cobertura</div><div class="value" id="qmCoverage">â€”</div></div>
        <div class="stat-card"><div class="label">Grounding</div><div class="value" id="qmGrounding">â€”</div></div>
        <div class="stat-card"><div class="label">Confianza Avg</div><div class="value" id="qmConfidence">â€”</div></div>
        <div class="stat-card"><div class="label">Cache Hit</div><div class="value" id="qmCacheHit">â€”</div></div>
        <div class="stat-card"><div class="label">Feedback</div><div class="value" id="qmFeedback">â€”</div></div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ›¡ï¸</span> TÃ©cnicas Anti-AlucinaciÃ³n</div>
        <div class="technique-grid">
            <div class="technique-card"><div class="tc-icon">ğŸ”¬</div><div class="tc-name">NLI Verification</div><div class="tc-desc">Natural Language Inference para validar coherencia respuesta-fuente</div></div>
            <div class="technique-card"><div class="tc-icon">ğŸ”¢</div><div class="tc-name">Token Overlap</div><div class="tc-desc">VerificaciÃ³n de solapamiento token-a-token con documentos fuente</div></div>
            <div class="technique-card"><div class="tc-icon">ğŸ”„</div><div class="tc-name">Self-RAG</div><div class="tc-desc">Auto-evaluaciÃ³n: Â¿la respuesta estÃ¡ fundamentada en los chunks?</div></div>
            <div class="technique-card"><div class="tc-icon">ğŸ“Š</div><div class="tc-name">Confidence Score</div><div class="tc-desc">Score compuesto de confianza en cada respuesta</div></div>
            <div class="technique-card"><div class="tc-icon">ğŸ•³ï¸</div><div class="tc-name">Gap Detection</div><div class="tc-desc">Identifica preguntas sin cobertura en la KB</div></div>
            <div class="technique-card"><div class="tc-icon">âš¡</div><div class="tc-name">Source Citing</div><div class="tc-desc">Cita obligatoria de fuentes en toda respuesta</div></div>
        </div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ•³ï¸</span> Knowledge Gaps</div>
        <div id="gapsContainer"><div class="loading"><div class="spinner"></div></div></div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ’¬</span> Feedback Reciente</div>
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>Query</th><th>Rating</th><th>Comentario</th><th>Revisado</th></tr></thead>
                <tbody id="qualityFeedback"><tr><td colspan="4"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<!-- â”€â”€ CHAT â”€â”€ -->
<div class="module" id="mod-chat">
    <div style="display:flex;gap:10px;margin-bottom:8px;align-items:center;flex-wrap:wrap;">
        <h1 class="page-title" style="margin:0;font-size:18px;">ğŸ’¬ Chat</h1>
        <select id="chatProtocol" onchange="Chat.onProtocolChange()" style="padding:4px 8px;font-size:11px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);">
            <option value="openai" selected>OpenAI (streaming)</option>
            <option value="mcp">MCP Tool Call</option>
            <option value="rag">RAG Query</option>
        </select>
        <select id="chatModel" style="padding:4px 8px;font-size:11px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);" id="chatModelGroup">
            <option value="eod-rag">DRAGA RAG</option><option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
        </select>
        <span id="chatModelGroup2"></span>
        <input type="number" id="chatTopK" value="5" min="1" max="50" style="width:50px;padding:4px 6px;font-size:11px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);" title="Top K">
        <select id="chatToolName" style="display:none;padding:4px 8px;font-size:11px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);">
            <option value="rag_query">rag_query</option>
        </select>
        <label style="display:flex;align-items:center;gap:3px;font-size:11px;color:var(--text-muted);cursor:pointer;" id="chatStreamToggle">
            <input type="checkbox" id="chatStream" checked> Stream
        </label>
        <button class="btn btn-sm" onclick="Chat.clear()" style="margin-left:auto;padding:2px 8px;font-size:11px;">ğŸ—‘ï¸</button>
    </div>

    <div style="display:grid;grid-template-columns:1fr 260px;gap:16px;">
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="chat-msg assistant">Â¡Hola! Soy el DRAGA de este tenant. Puedo responder preguntas basÃ¡ndome en la base de conocimientos indexada. Â¿En quÃ© puedo ayudarte?</div>
            </div>
            <div class="chat-input-bar">
                <input type="text" id="chatInput" placeholder="Escribe tu pregunta..." onkeydown="if(event.key==='Enter')Chat.send()">
                <button class="btn btn-primary" id="chatSendBtn" onclick="Chat.send()">â–¶ Enviar</button>
            </div>
        </div>
        <div class="card" style="padding:12px;height:fit-content;max-height:600px;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <h3 style="font-size:13px;margin:0;">ğŸ’¬ Historial</h3>
                <button class="btn btn-sm" onclick="ConvHistory.load()" style="padding:2px 6px;font-size:10px;">ğŸ”„</button>
            </div>
            <div id="convHistoryList" style="font-size:12px;"><span style="color:var(--text-muted)">Cargando...</span></div>
        </div>
    </div>
</div>

<!-- â”€â”€ WIDGETS â”€â”€ -->
<div class="module" id="mod-widgets">
    <h1 class="page-title">ğŸ§© Widget Generator</h1>
    <p class="page-desc">Genera widgets embebibles para integrar este DRAGA en cualquier pÃ¡gina web</p>

    <div class="wg-layout">
        <!-- LEFT: Config panel -->
        <div class="wg-config">
            <div class="section">
                <div class="section-title"><span class="icon">ğŸ“‹</span> Mis Widgets</div>
                <div id="wgWidgetList" class="wg-list"></div>
                <button class="btn btn-primary" onclick="Widgets.create()" style="width:100%;margin-top:10px;">+ Nuevo Widget</button>
            </div>

            <div class="section" id="wgEditorSection" style="display:none;">
                <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;">
                    <span><span class="icon">âš™ï¸</span> ConfiguraciÃ³n</span>
                    <button class="btn btn-sm btn-danger" onclick="Widgets.deleteSelected()" title="Eliminar widget">ğŸ—‘ï¸</button>
                </div>

                <div class="form-row" style="grid-template-columns:1fr;">
                    <label class="form-label">Nombre del Widget
                        <input type="text" id="wgName" class="form-input" placeholder="Mi Widget de Soporte" oninput="Widgets.onConfigChange()">
                    </label>
                </div>

                <div class="form-row">
                    <label class="form-label">Protocolo
                        <select id="wgProtocol" class="form-input" onchange="Widgets.onConfigChange()">
                            <option value="openai">OpenAI (streaming chat)</option>
                            <option value="rag">RAG Query (directo)</option>
                            <option value="mcp">MCP Tool Call</option>
                        </select>
                    </label>
                    <label class="form-label">Modelo
                        <input type="text" id="wgModel" class="form-input" value="eod-rag" oninput="Widgets.onConfigChange()">
                    </label>
                </div>

                <div class="form-row">
                    <label class="form-label">PosiciÃ³n
                        <select id="wgPosition" class="form-input" onchange="Widgets.onConfigChange()">
                            <option value="bottom-right">Abajo-Derecha</option>
                            <option value="bottom-left">Abajo-Izquierda</option>
                        </select>
                    </label>
                    <label class="form-label">Idioma
                        <select id="wgLocale" class="form-input" onchange="Widgets.onConfigChange()">
                            <option value="es">EspaÃ±ol</option>
                            <option value="en">English</option>
                        </select>
                    </label>
                </div>

                <div class="form-row" style="grid-template-columns:1fr;">
                    <label class="form-label">Color principal
                        <div style="display:flex;gap:8px;align-items:center;">
                            <input type="color" id="wgColor" value="#7c3aed" onchange="Widgets.onConfigChange()" style="width:40px;height:32px;border:none;cursor:pointer;background:none;">
                            <span id="wgColorHex" style="font-size:11px;color:var(--text-muted);font-family:monospace;">#7c3aed</span>
                        </div>
                    </label>
                </div>

                <div class="form-row" style="grid-template-columns:1fr 1fr 1fr;">
                    <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary);cursor:pointer;">
                        <input type="checkbox" id="wgStream" checked onchange="Widgets.onConfigChange()"> Streaming
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary);cursor:pointer;">
                        <input type="checkbox" id="wgSources" checked onchange="Widgets.onConfigChange()"> Fuentes
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary);cursor:pointer;">
                        <input type="checkbox" id="wgFeedback" checked onchange="Widgets.onConfigChange()"> Feedback
                    </label>
                </div>

                <div class="nav-sep" style="margin:16px 0;"></div>

                <!-- Security Token -->
                <div class="section-title" style="font-size:13px;"><span class="icon">ğŸ”</span> Seguridad</div>
                <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text-secondary);cursor:pointer;margin-bottom:10px;">
                    <input type="checkbox" id="wgTokenEnabled" onchange="Widgets.toggleToken()"> Habilitar token de seguridad
                </label>
                <div id="wgTokenConfig" style="display:none;">
                    <div class="form-row" style="grid-template-columns:1fr;">
                        <label class="form-label">API Key
                            <div style="display:flex;gap:6px;">
                                <input type="text" id="wgApiKey" class="form-input" placeholder="sk-..." style="font-family:monospace;font-size:11px;" oninput="Widgets.onConfigChange()">
                                <button class="btn btn-sm" onclick="Widgets.useExistingKey()" title="Usar una key existente de este DRAGA">ğŸ“‹ Usar existente</button>
                            </div>
                        </label>
                    </div>
                    <p style="font-size:10px;color:var(--text-muted);margin-top:4px;">âš ï¸ El token se incluirÃ¡ en el cÃ³digo embed. Para producciÃ³n, usa un proxy backend que inyecte las credenciales.</p>
                </div>

                <div class="nav-sep" style="margin:16px 0;"></div>

                <!-- Base URL -->
                <div class="section-title" style="font-size:13px;"><span class="icon">ğŸŒ</span> ConexiÃ³n</div>
                <div class="form-row" style="grid-template-columns:1fr;">
                    <label class="form-label">Base URL del backend
                        <input type="text" id="wgBaseUrl" class="form-input" style="font-family:monospace;font-size:11px;" oninput="Widgets.onConfigChange()">
                    </label>
                </div>
                <p style="font-size:10px;color:var(--text-muted);margin-top:4px;">URL base del API (incluye <code>/api/v2</code>). El widget la usa para conectarse al backend.</p>
            </div>
        </div>

        <!-- RIGHT: Preview + Code -->
        <div class="wg-output">
            <div class="section">
                <div style="display:flex;gap:8px;margin-bottom:12px;">
                    <button class="filter-pill active" data-wgtab="preview" onclick="Widgets.switchTab('preview',this)">ğŸ‘ï¸ Preview</button>
                    <button class="filter-pill" data-wgtab="embed" onclick="Widgets.switchTab('embed',this)">ğŸ“‹ Embed Code</button>
                    <button class="filter-pill" data-wgtab="iframe" onclick="Widgets.switchTab('iframe',this)">ğŸ–¼ï¸ iFrame</button>
                </div>

                <div id="wgTabPreview" class="wg-tab active">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div class="section-title" style="margin:0;"><span class="icon">ğŸ‘ï¸</span> Vista Previa</div>
                        <div style="display:flex;gap:4px;" id="wgPreviewModeBar">
                            <button class="filter-pill active" data-wgprev="live" onclick="Widgets.switchPreviewMode('live',this)">ğŸŸ¢ En Vivo</button>
                            <button class="filter-pill" data-wgprev="mockup" onclick="Widgets.switchPreviewMode('mockup',this)">ğŸ¨ Mockup</button>
                        </div>
                    </div>
                    <div id="wgPreviewLive" class="wg-preview-box" style="padding:0;">
                        <p style="color:var(--text-muted);text-align:center;padding:40px;">Selecciona o crea un widget para probarlo en vivo</p>
                    </div>
                    <div id="wgPreviewMockup" class="wg-preview-box" style="display:none;">
                    </div>
                </div>

                <div id="wgTabEmbed" class="wg-tab">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div class="section-title" style="margin:0;"><span class="icon">ğŸ“‹</span> CÃ³digo Embed (Web Component)</div>
                        <button class="btn btn-sm btn-primary" onclick="Widgets.copyCode('embed')">ğŸ“‹ Copiar</button>
                    </div>
                    <pre id="wgEmbedCode" class="wg-code"></pre>
                </div>

                <div id="wgTabIframe" class="wg-tab">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div class="section-title" style="margin:0;"><span class="icon">ğŸ–¼ï¸</span> CÃ³digo iFrame</div>
                        <button class="btn btn-sm btn-primary" onclick="Widgets.copyCode('iframe')">ğŸ“‹ Copiar</button>
                    </div>
                    <pre id="wgIframeCode" class="wg-code"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- â”€â”€ CONFIG â”€â”€ -->
<div class="module" id="mod-config">
    <h1 class="page-title">ConfiguraciÃ³n</h1>
    <p class="page-desc">API Keys, retrieval config, widget, embed codes y tareas</p>

    <div class="section">
        <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;">
            <span><span class="icon">ğŸ”‘</span> API Keys</span>
            <button class="btn btn-sm btn-primary" onclick="ApiKeys.create()">+ Nueva Key</button>
        </div>
        <div id="dragaApiKeys"><div class="loading"><div class="spinner"></div></div></div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">âš™ï¸</span> Retrieval Config</div>
        <div class="card" id="retrievalConfig"><div class="loading"><div class="spinner"></div></div></div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ§ </span> System Prompt</div>
        <div class="card" id="systemPromptConfig"><div class="loading"><div class="spinner"></div></div></div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ“œ</span> MCP Prompts</div>
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Prompts predefinidos del servidor MCP â€” Ãºsalos para configurar el comportamiento del chat.</p>
        <div id="mcpPromptsList"><div class="loading"><div class="spinner"></div></div></div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ¨</span> Widget Config</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <div>
                <div class="card"><h3 style="font-size:14px;margin-bottom:12px;">ğŸ¨ Tema</h3><div id="widgetThemeForm"></div></div>
                <div class="card"><h3 style="font-size:14px;margin-bottom:12px;">ğŸ“ Branding</h3><div id="widgetBrandingForm"></div></div>
                <div class="card"><h3 style="font-size:14px;margin-bottom:12px;">âš¡ Comportamiento</h3><div id="widgetBehaviorForm"></div></div>
                <div style="display:flex;gap:8px;margin-top:12px;">
                    <button class="btn btn-primary" onclick="WidgetCfg.save()">ğŸ’¾ Guardar Widget</button>
                    <button class="btn btn-danger" onclick="WidgetCfg.reset()">ğŸ”„ Reset</button>
                </div>
            </div>
            <div>
                <div class="card"><h3 style="font-size:14px;margin-bottom:12px;">ğŸ‘ï¸ Preview</h3><div id="widgetPreview"></div></div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">ğŸ“‹</span> Embed Codes</div>
        <div id="embedCodes"></div>
    </div>

    <div class="section">
        <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;">
            <span><span class="icon">ğŸ“‹</span> Tareas</span>
            <div style="display:flex;gap:8px;">
                <select id="taskStateFilter" onchange="TasksMod.refresh()" style="padding:5px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:11px;">
                    <option value="">Todas</option>
                    <option value="pending">Pendientes</option>
                    <option value="processing">Procesando</option>
                    <option value="completed">Completadas</option>
                    <option value="failed">Fallidas</option>
                </select>
                <button class="btn btn-sm" onclick="TasksMod.cleanup()">ğŸ§¹ Limpiar</button>
            </div>
        </div>
        <div id="taskTable"><div class="loading"><div class="spinner"></div></div></div>
    </div>
</div>

</main>
</div>

<!-- â•â•â• UPLOAD MODAL â•â•â• -->
<div class="modal-overlay" id="uploadModal">
    <div class="modal" style="max-width:560px">
        <div class="modal-title">ğŸ“¤ Subir Documentos</div>
        <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <div class="dz-icon">ğŸ“</div>
            <div class="dz-text">Arrastra archivos aquÃ­ o haz click para seleccionar<br><small>PDF, MD, TXT, DOCX, JSON, XML, XLSX</small></div>
        </div>
        <input type="file" id="fileInput" multiple accept=".pdf,.md,.txt,.docx,.odt,.xlsx,.xls,.json,.xml" style="display:none" onchange="KB.addFiles([...this.files]);this.value='';">
        <div id="uploadFileList"></div>
        <div id="uploadOptions" style="display:none;margin-top:12px;">
            <div class="form-row">
                <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="optAutoIdx" checked> Auto-indexar</label>
                <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="optBg" checked> En background</label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('uploadModal')">Cancelar</button>
            <button class="btn btn-primary" id="uploadBtn" onclick="KB.doUpload()">ğŸ“¤ Subir</button>
        </div>
    </div>
</div>

<!-- â•â•â• CONFIRM MODAL â•â•â• -->
<div class="modal-overlay" id="confirmModal">
    <div class="modal" style="max-width:420px">
        <div class="modal-title" id="confirmTitle">Confirmar</div>
        <p id="confirmMsg" style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;"></p>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('confirmModal')">Cancelar</button>
            <button class="btn btn-danger" id="confirmAction">Confirmar</button>
        </div>
    </div>
</div>

<!-- â•â•â• LABEL MODAL â•â•â• -->
<div class="modal-overlay" id="labelModal">
    <div class="modal" style="max-width:420px">
        <div class="modal-title" id="labelModalTitle">ğŸ·ï¸ Nueva Etiqueta</div>
        <input type="hidden" id="labelEditId">
        <div class="form-group">
            <label>Nombre</label>
            <input type="text" id="labelName" placeholder="Ej: Importante, FAQ, Legal...">
        </div>
        <div class="form-group">
            <label>Color</label>
            <div class="color-input-row">
                <input type="color" id="labelColor" value="#7c3aed">
                <span id="labelColorHex" style="font-size:12px;color:var(--text-muted)">#7c3aed</span>
                <div style="display:flex;gap:4px;margin-left:auto;" id="labelColorPresets">
                    <span style="width:22px;height:22px;border-radius:50%;cursor:pointer;background:#7c3aed;" onclick="KB.setLabelColor('#7c3aed')"></span>
                    <span style="width:22px;height:22px;border-radius:50%;cursor:pointer;background:#3b82f6;" onclick="KB.setLabelColor('#3b82f6')"></span>
                    <span style="width:22px;height:22px;border-radius:50%;cursor:pointer;background:#22c55e;" onclick="KB.setLabelColor('#22c55e')"></span>
                    <span style="width:22px;height:22px;border-radius:50%;cursor:pointer;background:#f59e0b;" onclick="KB.setLabelColor('#f59e0b')"></span>
                    <span style="width:22px;height:22px;border-radius:50%;cursor:pointer;background:#ef4444;" onclick="KB.setLabelColor('#ef4444')"></span>
                    <span style="width:22px;height:22px;border-radius:50%;cursor:pointer;background:#ec4899;" onclick="KB.setLabelColor('#ec4899')"></span>
                    <span style="width:22px;height:22px;border-radius:50%;cursor:pointer;background:#64748b;" onclick="KB.setLabelColor('#64748b')"></span>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label>DescripciÃ³n <small style="color:var(--text-muted)">(opcional)</small></label>
            <input type="text" id="labelDesc" placeholder="Breve descripciÃ³n de esta etiqueta">
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('labelModal')">Cancelar</button>
            <button class="btn btn-primary" onclick="KB.saveLabel()">ğŸ’¾ Guardar</button>
        </div>
    </div>
</div>

<!-- â•â•â• DETAIL PANEL â•â•â• -->
<div class="detail-panel" id="detailPanel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <span style="font-weight:700;font-size:14px">Detalle</span>
        <button class="btn-icon" onclick="document.getElementById('detailPanel').classList.remove('open')">âœ•</button>
    </div>
    <div id="detailBody"></div>
    <div id="detailActions" style="display:flex;gap:8px;margin-top:16px;"></div>
</div>

<!-- â•â•â• DOCUMENT VIEWER â•â•â• -->
<div class="doc-viewer-overlay" id="docViewer">
    <div class="doc-viewer-header">
        <div class="dv-title">
            <span id="dvIcon">ğŸ“„</span>
            <span id="dvFilename">â€”</span>
        </div>
        <div class="dv-meta">
            <span id="dvDocId"></span>
            <span id="dvChunkCount"></span>
            <span id="dvSize"></span>
            <div style="display:flex;gap:6px;align-items:center">
                <button class="btn btn-sm" id="dvTabSource" onclick="DocViewer.switchTab('source')" style="background:var(--draga-accent);color:#fff">ğŸ“„ Fuente</button>
                <button class="btn btn-sm" id="dvTabChunks" onclick="DocViewer.switchTab('chunks')">ğŸ§© Chunks</button>
                <a class="btn btn-sm" id="dvDownload" href="#" target="_blank" style="display:none">â¬‡ï¸ Descargar</a>
                <button class="btn btn-sm" onclick="DocViewer.close()">âœ• Cerrar</button>
            </div>
        </div>
    </div>
    <div class="doc-viewer-body" id="dvBody">
        <div class="loading"><div class="spinner"></div></div>
    </div>
</div>

<div class="toast-container" id="toasts"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAGA INSTANCE DASHBOARD â€” JavaScript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const MODULES = ['overview','knowledge','pipeline','quality','chat','widgets','config'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOCUMENT VIEWER â€” View source document chunks
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DocViewer = {
    _currentDocId: null,
    _currentFilename: null,
    _chunks: [],
    _activeTab: 'source',

    // Open viewer by document_id â€” shows original source file
    async openById(docId, filename) {
        this._currentDocId = docId;
        this._currentFilename = filename;
        this._chunks = [];
        this._show(filename);
        const body = document.getElementById('dvBody');
        try {
            // Get document detail for metadata
            const doc = await api.getDocument(docId, App.tenantId, App.agentId).catch(() => null);
            if (doc) {
                document.getElementById('dvDocId').textContent = `ID: ${docId}`;
                document.getElementById('dvChunkCount').textContent = `${doc.chunk_count || '?'} chunks`;
                document.getElementById('dvSize').textContent = fileSize(doc.file_size_bytes || 0);
            }
            // Show source file
            this._renderSource(body, docId, filename);
            // Pre-fetch chunks in background for the chunks tab
            api.getDocumentChunks(docId, App.tenantId, 20, filename, App.agentId)
                .then(chunks => { this._chunks = chunks; })
                .catch(() => {});
        } catch (e) {
            body.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><h3>Error cargando contenido</h3><p style="font-size:12px">${esc(e.message)}</p></div>`;
        }
    },

    // Open viewer by filename â€” resolve doc_id first
    async openByFilename(filename) {
        this._show(filename);
        const body = document.getElementById('dvBody');
        try {
            const data = await api.listDocuments(App.tenantId, null, null, App.agentId);
            const docs = data.documents || data || [];
            const doc = docs.find(d => d.filename === filename || (d.filename || '').endsWith(filename.split('/').pop()));
            if (doc) {
                return this.openById(doc.document_id, doc.filename);
            }
            // No exact match â€” try a broad search with filename as query
            body.innerHTML = '<div class="loading"><div class="spinner"></div> Buscando contenido...</div>';
            const res = await api.query({ query: filename.replace(/\.[^.]+$/, ''), tenant_id: App.tenantId, agent_id: App.agentId, top_k: 20 });
            const allChunks = res.retrieved_chunks || [];
            if (allChunks.length) {
                this._chunks = allChunks;
                this._renderChunks(body, allChunks, false);
                this.switchTab('chunks');
            } else {
                body.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><h3>Sin contenido recuperable</h3><p>Este documento no tiene chunks indexados.</p></div>';
            }
        } catch (e) {
            body.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${esc(e.message)}</p></div>`;
        }
    },

    // Open viewer showing pre-loaded chunks (from pipeline/chat results)
    openWithChunks(title, chunks) {
        this._currentDocId = null;
        this._currentFilename = title;
        this._chunks = chunks;
        this._show(title);
        document.getElementById('dvChunkCount').textContent = `${chunks.length} chunks`;
        // Hide source tab if no doc ID
        document.getElementById('dvTabSource').style.display = 'none';
        document.getElementById('dvDownload').style.display = 'none';
        this.switchTab('chunks');
        this._renderChunks(document.getElementById('dvBody'), chunks, true);
    },

    // Render original source file in viewer
    _renderSource(container, docId, filename) {
        const ext = (filename || '').split('.').pop().toLowerCase();
        const sourceUrl = api.getDocumentSourceUrl(docId, App.tenantId, App.agentId);
        // Show download link
        const dlBtn = document.getElementById('dvDownload');
        dlBtn.href = sourceUrl;
        dlBtn.style.display = '';

        if (ext === 'pdf') {
            container.innerHTML = `<iframe src="${sourceUrl}" style="width:100%;height:100%;border:none;border-radius:8px;background:#fff"></iframe>`;
        } else if (['png','jpg','jpeg','gif','svg','webp'].includes(ext)) {
            container.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;padding:20px"><img src="${sourceUrl}" style="max-width:100%;max-height:100%;border-radius:8px;box-shadow:0 4px 24px rgba(0,0,0,0.4)" /></div>`;
        } else if (['txt','md','json','xml','csv'].includes(ext)) {
            container.innerHTML = '<div class="loading"><div class="spinner"></div> Cargando texto...</div>';
            const fetchHeaders = {};
            if (api.apiKey) fetchHeaders['X-API-Key'] = api.apiKey;
            fetch(sourceUrl, { headers: fetchHeaders }).then(r => r.text()).then(text => {
                const isJson = ext === 'json';
                const isMd = ext === 'md';
                container.innerHTML = `<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;height:100%;overflow:auto"><pre style="white-space:pre-wrap;word-break:break-word;font-size:13px;line-height:1.7;color:var(--text-secondary);font-family:${isJson ? 'monospace' : 'inherit'}">${esc(text)}</pre></div>`;
            }).catch(e => {
                container.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>Error: ${esc(e.message)}</p></div>`;
            });
        } else {
            // DOCX, XLSX, ODT etc. â€” show download prompt + chunks
            container.innerHTML = `<div class="empty-state" style="padding-top:60px">
                <div class="icon" style="font-size:48px">${ext === 'docx' || ext === 'odt' ? 'ğŸ“˜' : ext === 'xlsx' || ext === 'xls' ? 'ğŸ“Š' : 'ğŸ“„'}</div>
                <h3>${esc(filename)}</h3>
                <p style="color:var(--text-muted);margin:12px 0">Los archivos .${ext} no pueden previsualizarse en el navegador.</p>
                <a href="${sourceUrl}" target="_blank" class="btn btn-primary" style="text-decoration:none;margin:8px 0">â¬‡ï¸ Descargar archivo original</a>
                <p style="color:var(--text-muted);font-size:12px;margin-top:16px">Cambia a la pestaÃ±a <strong>ğŸ§© Chunks</strong> para ver el contenido indexado.</p>
            </div>`;
        }
    },

    switchTab(tab) {
        this._activeTab = tab;
        const srcBtn = document.getElementById('dvTabSource');
        const chkBtn = document.getElementById('dvTabChunks');
        const body = document.getElementById('dvBody');
        if (tab === 'source') {
            srcBtn.style.background = 'var(--draga-accent)'; srcBtn.style.color = '#fff';
            chkBtn.style.background = ''; chkBtn.style.color = '';
            if (this._currentDocId) {
                this._renderSource(body, this._currentDocId, this._currentFilename);
            }
        } else {
            chkBtn.style.background = 'var(--draga-accent)'; chkBtn.style.color = '#fff';
            srcBtn.style.background = ''; srcBtn.style.color = '';
            if (this._chunks.length) {
                this._renderChunks(body, this._chunks, true);
            } else {
                body.innerHTML = '<div class="loading"><div class="spinner"></div> Cargando chunks...</div>';
                if (this._currentDocId) {
                    api.getDocumentChunks(this._currentDocId, App.tenantId, 20, this._currentFilename, App.agentId)
                        .then(chunks => {
                            this._chunks = chunks;
                            this._renderChunks(body, this._chunks, true);
                        }).catch(e => {
                            body.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${esc(e.message)}</p></div>`;
                        });
                } else {
                    body.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><h3>Sin chunks disponibles</h3></div>';
                }
            }
        }
    },

    _show(filename) {
        const ext = (filename || '').split('.').pop().toLowerCase();
        const icons = { md:'ğŸ“', pdf:'ğŸ“•', txt:'ğŸ“ƒ', docx:'ğŸ“˜', json:'ğŸ”§', xml:'ğŸ“', xlsx:'ğŸ“Š', odt:'ğŸ““' };
        document.getElementById('dvIcon').textContent = icons[ext] || 'ğŸ“„';
        document.getElementById('dvFilename').textContent = filename || 'Documento';
        document.getElementById('dvDocId').textContent = '';
        document.getElementById('dvChunkCount').textContent = '';
        document.getElementById('dvSize').textContent = '';
        document.getElementById('dvBody').innerHTML = '<div class="loading"><div class="spinner"></div> Cargando contenido...</div>';
        document.getElementById('dvTabSource').style.display = '';
        document.getElementById('dvDownload').style.display = 'none';
        document.getElementById('dvTabSource').style.background = 'var(--draga-accent)'; document.getElementById('dvTabSource').style.color = '#fff';
        document.getElementById('dvTabChunks').style.background = ''; document.getElementById('dvTabChunks').style.color = '';
        this._activeTab = 'source';
        document.getElementById('docViewer').classList.add('open');
    },

    close() { document.getElementById('docViewer').classList.remove('open'); },

    _renderChunks(container, chunks, exactMatch) {
        if (!chunks.length) {
            container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><h3>Sin chunks</h3></div>';
            return;
        }
        // Sort by chunk_id if possible
        chunks.sort((a, b) => (a.chunk_id || a.metadata?.chunk_id || '').localeCompare(b.chunk_id || b.metadata?.chunk_id || ''));

        container.innerHTML = (!exactMatch ? '<div style="padding:6px 12px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:8px;font-size:11px;color:var(--warning);margin-bottom:14px;">âš ï¸ Mostrando chunks mÃ¡s relevantes (no fue posible filtrar exactamente por documento)</div>' : '') +
            chunks.map((c, i) => {
                const chunkId = c.chunk_id || c.metadata?.chunk_id || `chunk-${i}`;
                const chunkType = c.metadata?.chunk_type || c.chunk_type || 'text';
                const score = c.similarity_score != null ? c.similarity_score : null;
                const source = c.metadata?.source || '';
                const page = c.metadata?.page_number || null;
                const docId = c.document_id || c.metadata?.document_id || '';

                // Render content â€” check for table_metadata with structured_data
                let contentHtml = '';
                const tableMeta = c.metadata?.table_metadata;
                if (tableMeta) {
                    try {
                        const td = typeof tableMeta === 'string' ? JSON.parse(tableMeta.replace(/'/g, '"')) : tableMeta;
                        if (td.structured_data && td.headers) {
                            contentHtml = `<table><thead><tr>${td.headers.map(h => `<th>${esc(h)}</th>`).join('')}</tr></thead><tbody>${td.structured_data.map(row => `<tr>${td.headers.map(h => `<td>${esc(row[h] || '')}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
                        }
                    } catch { /* fall through */ }
                }
                if (!contentHtml) {
                    contentHtml = `<div style="white-space:pre-wrap;word-break:break-word;">${esc(c.content || 'Sin contenido')}</div>`;
                }

                const typeColors = { table:'var(--info)', text:'var(--text-muted)', header:'var(--warning)' };
                const scoreColor = score > 0.7 ? 'var(--success)' : score > 0.4 ? 'var(--warning)' : 'var(--text-muted)';

                return `<div class="chunk-card">
                    <div class="cc-header">
                        <div style="display:flex;align-items:center;gap:8px">
                            <span style="font-size:16px">${chunkType === 'table' ? 'ğŸ“Š' : 'ğŸ“'}</span>
                            <span class="cc-id">${chunkId}</span>
                            <span class="cc-type badge" style="background:${(typeColors[chunkType] || 'var(--text-muted)')}22;color:${typeColors[chunkType] || 'var(--text-muted)'}">${chunkType}</span>
                        </div>
                    </div>
                    ${score != null ? `<div class="cc-score" style="background:${scoreColor}22;color:${scoreColor}">${(score * 100).toFixed(0)}%</div>` : ''}
                    <div class="cc-content">${contentHtml}</div>
                    <div class="cc-meta">
                        ${page ? `<span>ğŸ“„ PÃ¡g. ${page}</span>` : ''}
                        ${source ? `<span>ğŸ“‚ ${source.split('/').pop()}</span>` : ''}
                        ${docId ? `<span>ğŸ”— ${docId}</span>` : ''}
                    </div>
                </div>`;
            }).join('');
    }
};

// Key binding: Escape closes viewer
document.addEventListener('keydown', e => { if (e.key === 'Escape' && document.getElementById('docViewer').classList.contains('open')) DocViewer.close(); });

// â”€â”€ Utilities â”€â”€
function toast(msg, type = 'info', dur = 4000) {
    const el = document.createElement('div');
    el.className = 'toast toast-' + type;
    el.textContent = msg;
    document.getElementById('toasts').appendChild(el);
    setTimeout(() => el.remove(), dur);
}
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = String(s); return d.innerHTML; }
function fileSize(bytes) {
    if (!bytes) return '0 B';
    const u = ['B','KB','MB','GB']; let i = 0;
    while (bytes >= 1024 && i < u.length - 1) { bytes /= 1024; i++; }
    return bytes.toFixed(i ? 1 : 0) + ' ' + u[i];
}
function statusBadge(s) {
    const m = { indexed: 'badge-success', active: 'badge-success', error: 'badge-danger', failed: 'badge-danger', pending: 'badge-warning', processing: 'badge-info', uploaded: 'badge-info' };
    return `<span class="badge ${m[s] || 'badge-muted'}">${s || '?'}</span>`;
}

function showConfirm(title, msg, action) {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMsg').innerHTML = msg;
    const btn = document.getElementById('confirmAction');
    const clone = btn.cloneNode(true);
    btn.parentNode.replaceChild(clone, btn);
    clone.onclick = () => { closeModal('confirmModal'); action(); };
    openModal('confirmModal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP CONTROLLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const App = {
    tenantId: null,
    tenantData: null,
    tenants: [],
    agentId: null,   // ADR-018: active agent within tenant
    agents: [],       // agents for current tenant

    async init() {
        // Load tenants
        try {
            const data = await api.listTenants(true);
            this.tenants = data.tenants || [];
        } catch { this.tenants = [{ tenant_id: 'default', name: 'Default' }]; }

        const sel = document.getElementById('tenantSelect');
        sel.innerHTML = this.tenants.map(t => `<option value="${t.tenant_id}">${t.name} (${t.tenant_id})</option>`).join('');

        // Pick tenant from URL â€” validate it exists in tenant list
        const params = new URLSearchParams(window.location.search);
        const urlTenant = params.get('tenant');
        const tenantExists = urlTenant && this.tenants.some(t => t.tenant_id === urlTenant);

        let tid;
        if (tenantExists) {
            tid = urlTenant;
        } else if (urlTenant) {
            console.warn(`[App] Tenant "${urlTenant}" from URL not found in tenant list, falling back`);
            toast(`El tenant "${urlTenant}" no existe. Se seleccionÃ³ el primero disponible.`, 'warning', 4000);
            tid = this.tenants[0]?.tenant_id || 'default';
            const fixUrl = new URL(window.location);
            fixUrl.searchParams.set('tenant', tid);
            window.history.replaceState({}, '', fixUrl);
        } else {
            tid = this.tenants[0]?.tenant_id || 'default';
        }

        sel.value = tid;
        this.tenantId = tid;
        this.tenantData = this.tenants.find(t => t.tenant_id === tid) || { tenant_id: tid, name: tid };

        // ADR-018: Load agents for this tenant and pick from URL
        await this.loadAgents(tid);
        const urlAgent = params.get('agent');
        if (urlAgent && this.agents.some(a => a.agent_id === urlAgent)) {
            this.agentId = urlAgent;
        } else {
            this.agentId = this.agents[0]?.agent_id || 'default';
        }
        document.getElementById('agentSelect').value = this.agentId;
        this._updateDisplayName();
        this._updateUrl();

        // Setup drop zone
        KB.setupDropZone();

        // Label color sync
        const lc = document.getElementById('labelColor');
        if (lc) lc.addEventListener('input', () => { document.getElementById('labelColorHex').textContent = lc.value; });

        // Nav from hash
        const hash = window.location.hash.replace('#', '') || 'overview';
        this.nav(hash);

        // Health
        this.checkHealth();
        setInterval(() => this.checkHealth(), 30000);

        window.addEventListener('hashchange', () => {
            const h = window.location.hash.replace('#', '');
            if (MODULES.includes(h)) this.nav(h);
        });
    },

    // ADR-018: Load agents for a tenant and populate agent selector
    async loadAgents(tenantId) {
        const sel = document.getElementById('agentSelect');
        const sep = document.querySelector('.scope-sep');
        try {
            const data = await api.listAgents(tenantId);
            this.agents = data.agents || data || [];
        } catch {
            this.agents = [];
        }
        // Track if no DRAGAs exist for this tenant
        this._noDragas = !this.agents.length;
        if (!this.agents.length) {
            // No DRAGAs â€” hide selector, work at tenant level
            this.agents = [{ agent_id: 'default', name: tenantId }];
            sel.style.display = 'none';
            if (sep) sep.style.display = 'none';
        } else {
            sel.style.display = '';
            if (sep) sep.style.display = '';
        }
        sel.innerHTML = this.agents.map(a => {
            const label = a.name || a.agent_id;
            return `<option value="${a.agent_id}">${label}</option>`;
        }).join('');
    },

    async switchTenant(tid) {
        this.tenantId = tid;
        this.tenantData = this.tenants.find(t => t.tenant_id === tid) || { tenant_id: tid, name: tid };
        // Reload agents for new tenant
        await this.loadAgents(tid);
        this.agentId = this.agents[0]?.agent_id || 'default';
        document.getElementById('agentSelect').value = this.agentId;
        this._updateDisplayName();
        this._updateUrl();
        // Reload current module
        const active = MODULES.find(m => document.getElementById('mod-' + m).classList.contains('active')) || 'overview';
        this.nav(active);
    },

    switchAgent(aid) {
        this.agentId = aid;
        this._updateDisplayName();
        this._updateUrl();
        const active = MODULES.find(m => document.getElementById('mod-' + m).classList.contains('active')) || 'overview';
        this.nav(active);
    },

    _updateDisplayName() {
        const tName = this.tenantData?.name || this.tenantId;
        const aName = (this.agentId && this.agentId !== 'default')
            ? ` / ${this.agents.find(a => a.agent_id === this.agentId)?.name || this.agentId}`
            : '';
        document.getElementById('tenantDisplayName').textContent = tName + aName;
    },

    _updateUrl() {
        const url = new URL(window.location);
        url.searchParams.set('tenant', this.tenantId);
        if (this.agentId && this.agentId !== 'default') {
            url.searchParams.set('agent', this.agentId);
        } else {
            url.searchParams.delete('agent');
        }
        window.history.replaceState({}, '', url);
    },

    nav(mod) {
        if (!MODULES.includes(mod)) mod = 'overview';
        MODULES.forEach(m => {
            document.getElementById('mod-' + m).classList.toggle('active', m === mod);
            document.querySelector(`[data-mod="${m}"]`)?.classList.toggle('active', m === mod);
        });
        window.location.hash = mod;

        const loaders = {
            overview: () => Overview.load(),
            knowledge: () => KB.load(),
            pipeline: () => {},
            quality: () => Quality.load(),
            chat: () => ConvHistory.load(),
            widgets: () => Widgets.load(),
            config: () => Config.load()
        };
        loaders[mod]?.();
    },

    async checkHealth() {
        const dot = document.getElementById('healthDot');
        try { await api.health(); dot.style.background = 'var(--success)'; }
        catch { dot.style.background = 'var(--danger)'; }
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Overview = {
    async load() {
        const t = App.tenantData;
        document.getElementById('overviewTitle').innerHTML = `<i class="di" style="font-size:28px;width:28px;height:28px;vertical-align:-4px"></i> ${t.name || App.tenantId}`;

        // Clean up old banner if present
        const oldBanner = document.getElementById('noDragaBanner');
        if (oldBanner) oldBanner.remove();

        document.getElementById('ovModel').textContent = (t.default_model || 'â€”').split('/').pop();
        document.getElementById('ovLang').textContent = t.response_language || 'â€”';
        document.getElementById('ovCollection').textContent = t.collection_name || 'â€”';

        // Fetch real doc/chunk counts from documentStats (tenant.document_count is unreliable)
        try {
            const ds = await api.documentStats(App.tenantId, App.agentId);
            const bs = ds.by_status || {};
            const activeDocs = (ds.total_documents || 0) - (bs.deleted || 0) - (bs.pending_delete || 0);
            document.getElementById('ovDocs').textContent = activeDocs;
            document.getElementById('ovChunks').textContent = ds.total_chunks ?? 'â€”';
        } catch {
            // Fallback: count from listDocuments instead of unreliable tenant.document_count
            try {
                const docList = await api.listDocuments(App.tenantId, null, null, App.agentId);
                const allDocs = docList.documents || [];
                document.getElementById('ovDocs').textContent = allDocs.length;
                document.getElementById('ovChunks').textContent = allDocs.reduce((s, d) => s + (d.chunk_count || 0), 0) || 'â€”';
            } catch {
                document.getElementById('ovDocs').textContent = 'â€”';
                document.getElementById('ovChunks').textContent = 'â€”';
            }
        }

        // Check protocols
        this.checkProtocols();

        // Pipeline steps â€” from backend deep health
        try {
            const deep = await api.healthDeep();
            const steps = deep?.pipeline_steps ?? deep?.steps ?? null;
            document.getElementById('ovPipelineSteps').textContent = steps ?? 'â€”';
        } catch { document.getElementById('ovPipelineSteps').textContent = 'â€”'; }

        // Load DRAGA catalog
        this.loadCatalog();
    },

    async loadCatalog() {
        const container = document.getElementById('dragaCatalog');
        if (!container) return;
        container.innerHTML = '<div class="loading"><div class="spinner"></div> Cargando DRAGAs...</div>';

        const cards = [];
        try {
            const data = await api.listTenants(true);
            const tenants = data.tenants || [];

            for (const t of tenants) {
                let agents = [];
                try {
                    const ad = await api.listAgents(t.tenant_id);
                    agents = ad.agents || ad || [];
                } catch { agents = []; }

                if (!agents.length) agents = [{ agent_id: 'default', name: t.name || t.tenant_id }];

                for (const a of agents) {
                    const isActive = t.tenant_id === App.tenantId && (a.agent_id || 'default') === (App.agentId || 'default');
                    let docs = 'â€”', chunks = 'â€”', model = 'â€”';

                    // Try to get stats (non-blocking)
                    try {
                        const ds = await api.documentStats(t.tenant_id, a.agent_id);
                        const bs = ds.by_status || {};
                        docs = (ds.total_documents || 0) - (bs.deleted || 0) - (bs.pending_delete || 0);
                        chunks = ds.total_chunks ?? 'â€”';
                    } catch {
                        try {
                            const dl = await api.listDocuments(t.tenant_id, null, null, a.agent_id);
                            docs = (dl.documents || []).length;
                            chunks = (dl.documents || []).reduce((s, d) => s + (d.chunk_count || 0), 0) || 'â€”';
                        } catch {}
                    }

                    // Model from agent config
                    try {
                        const ag = await api.getAgent(t.tenant_id, a.agent_id);
                        model = (ag.default_model || ag.model || 'â€”').split('/').pop();
                    } catch { model = t.default_model ? t.default_model.split('/').pop() : 'â€”'; }

                    const colors = ['#7c3aed','#2563eb','#059669','#d97706','#dc2626','#8b5cf6','#0891b2','#c026d3'];
                    const colorIdx = (t.tenant_id + (a.agent_id || '')).split('').reduce((s, c) => s + c.charCodeAt(0), 0) % colors.length;
                    const bg = colors[colorIdx];
                    const initial = (a.name || a.agent_id || 'D')[0].toUpperCase();

                    cards.push(`
                        <div class="draga-card${isActive ? ' active' : ''}" onclick="Overview.selectDraga('${t.tenant_id}','${a.agent_id || 'default'}')" title="${t.tenant_id} / ${a.agent_id || 'default'}">
                            <div class="dc-badge loading">cargado</div>
                            <div class="dc-header">
                                <div class="dc-icon" style="background:${bg}22;color:${bg}">${initial}</div>
                                <div>
                                    <div class="dc-name">${esc(a.name || a.agent_id || 'default')}</div>
                                    <div class="dc-tid">${esc(t.tenant_id)}${a.agent_id && a.agent_id !== 'default' ? ' / ' + esc(a.agent_id) : ''}</div>
                                </div>
                            </div>
                            <div class="dc-stats">
                                <div class="dc-stat"><div class="val">${docs}</div><div class="lbl">Docs</div></div>
                                <div class="dc-stat"><div class="val">${chunks}</div><div class="lbl">Chunks</div></div>
                                <div class="dc-stat"><div class="val" style="font-size:11px">${esc(String(model))}</div><div class="lbl">Modelo</div></div>
                            </div>
                        </div>
                    `);
                }
            }

            container.innerHTML = cards.length ? cards.join('') : '<p style="color:var(--text-muted);text-align:center;padding:20px;">No se encontraron DRAGAs en la plataforma</p>';

            // Update badges with health check
            container.querySelectorAll('.dc-badge').forEach(b => {
                b.className = 'dc-badge online';
                b.textContent = 'â— online';
            });
        } catch (e) {
            container.innerHTML = `<p style="color:var(--danger);text-align:center;padding:20px;">Error cargando DRAGAs: ${esc(e.message)}</p>`;
        }
    },

    async selectDraga(tenantId, agentId) {
        if (tenantId !== App.tenantId) {
            document.getElementById('tenantSelect').value = tenantId;
            await App.switchTenant(tenantId);
        }
        if (agentId !== App.agentId) {
            document.getElementById('agentSelect').value = agentId;
            await App.switchAgent(agentId);
        }
    },

    async checkProtocols() {
        const checks = [
            { id: 'protoRest', statusId: 'protoRestStatus', check: () => api.health() },
            { id: 'protoOpenai', statusId: 'protoOpenaiStatus', check: () => api.listModels() },
            { id: 'protoMcp', statusId: 'protoMcpStatus', check: () => api.mcpHealth() },
        ];
        for (const c of checks) {
            try {
                await c.check();
                document.getElementById(c.id).style.borderColor = 'var(--success)';
                document.getElementById(c.statusId).innerHTML = '<span style="color:var(--success)">âœ… Online</span>';
            } catch {
                document.getElementById(c.id).style.borderColor = 'var(--danger)';
                document.getElementById(c.statusId).innerHTML = '<span style="color:var(--danger)">âŒ Offline</span>';
            }
        }
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOURCE FILTER â€” Restricts RAG queries to active documents
// Backend: document_ids[] in POST /query and /chat/completions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SourceFilter = {
    _key() { return `srcfilter_${App.tenantId}_${App.agentId || 'default'}`; },

    /** Get enabled map: { docId: true/false } â€” null means all enabled */
    getMap() {
        try {
            const raw = localStorage.getItem(this._key());
            return raw ? JSON.parse(raw) : null;
        } catch { return null; }
    },

    /** Save map to localStorage */
    saveMap(map) {
        if (!map || Object.keys(map).length === 0) {
            localStorage.removeItem(this._key());
        } else {
            localStorage.setItem(this._key(), JSON.stringify(map));
        }
    },

    /**
     * Get active document IDs to pass as document_ids to query/chat.
     * Returns null if all docs are active (no filter needed).
     * Returns string[] if some docs are disabled.
     */
    getActiveIds() {
        const map = this.getMap();
        if (!map) return null;
        const activeIds = Object.entries(map).filter(([, enabled]) => enabled).map(([id]) => id);
        // If no docs excluded, return null (no filter)
        const allEnabled = Object.values(map).every(v => v);
        return allEnabled ? null : activeIds;
    },

    /** Toggle a document on/off. If all docs are disabled creates the map. */
    toggle(docId) {
        let map = this.getMap();
        if (!map) {
            // Initialize: all enabled, then disable this one
            map = {};
            (KB.docs || []).forEach(d => { map[d.document_id] = d.document_id !== docId; });
        } else {
            map[docId] = !map[docId];
        }
        this.saveMap(map);
    },

    /** Check if a document is active (enabled for search) */
    isActive(docId) {
        const map = this.getMap();
        if (!map) return true; // null map = all active
        return map[docId] !== false;
    },

    /** Reset filter â€” enable all documents */
    reset() {
        localStorage.removeItem(this._key());
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KNOWLEDGE BASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const KB = {
    docs: [], filtered: [], statusFilter: 'all', page: 1, perPage: 25,
    uploadFiles: [], uploading: false,
    labels: [], docLabels: {}, openPickerDocId: null,

    _stabilizeTimer: null,
    _stabilizeRetries: 0,

    async load() {
        // Sequential: docs first, then stats (stats must reflect current doc state)
        await this.loadDocs();
        await this.loadStats();
        // Labels disabled: await this.loadLabels();
    },

    /**
     * After a mutating operation (upload, delete, reindex, reset),
     * poll until all documents reach a stable state (indexed|failed|deleted)
     * or until max retries. This ensures transactional consistency between
     * the document registry and the vector store.
     */
    async loadAndStabilize(maxRetries = 8, intervalMs = 2000) {
        this._stabilizeRetries = 0;
        if (this._stabilizeTimer) { clearTimeout(this._stabilizeTimer); this._stabilizeTimer = null; }
        await this.load();
        const unstable = ['pending', 'processing', 'uploaded', 'outdated', 'pending_delete'];
        const hasUnstable = () => this.docs.some(d => unstable.includes(d.status));
        if (!hasUnstable()) return; // already stable
        toast('Esperando indexaciÃ³n...', 'info');
        return new Promise(resolve => {
            const poll = async () => {
                this._stabilizeRetries++;
                await this.load();
                if (!hasUnstable() || this._stabilizeRetries >= maxRetries) {
                    this._stabilizeTimer = null;
                    if (hasUnstable()) toast('Algunos documentos aÃºn procesÃ¡ndose', 'warning');
                    resolve();
                } else {
                    this._stabilizeTimer = setTimeout(poll, intervalMs);
                }
            };
            this._stabilizeTimer = setTimeout(poll, intervalMs);
        });
    },

    async loadStats() {
        try {
            const s = await api.documentStats(App.tenantId, App.agentId);
            const bs = s.by_status || {};
            const deletedDocs = (bs.deleted || 0) + (bs.pending_delete || 0);
            const totalDocs = (s.total_documents || 0) - deletedDocs;
            const indexed = bs.indexed || 0;
            const coverage = totalDocs ? Math.round(indexed / totalDocs * 100) : 0;
            document.getElementById('kbTotal').textContent = totalDocs;
            document.getElementById('kbChunks').textContent = s.total_chunks ?? 0;
            document.getElementById('kbSize').textContent = fileSize(s.total_size_bytes || 0);
            document.getElementById('kbIndexed').textContent = indexed;
            document.getElementById('kbErrors').textContent = (bs.error || 0) + (bs.failed || 0);
            document.getElementById('kbCoverage').textContent = coverage + '%';
            document.getElementById('navDocCount').textContent = totalDocs;

            // If documentStats shows 0 docs but vector DB has chunks, show chunks count from stats
            if (totalDocs === 0) {
                try {
                    const vs = await api.getStats(App.tenantId, App.agentId);
                    const vc = vs.vector_database?.total_chunks || 0;
                    if (vc > 0) {
                        document.getElementById('kbChunks').textContent = vc;
                        document.getElementById('navDocCount').textContent = `${vc}âœ‚`;
                    }
                } catch {}
            }
        } catch (e) {
            console.warn('KB Stats error:', e);
            // Fallback to vector DB stats
            try {
                const vs = await api.getStats(App.tenantId, App.agentId);
                const db = vs.vector_database || {};
                document.getElementById('kbTotal').textContent = 'â€”';
                document.getElementById('kbChunks').textContent = db.total_chunks || 0;
                document.getElementById('kbSize').textContent = 'â€”';
                document.getElementById('kbIndexed').textContent = 'â€”';
                document.getElementById('kbErrors').textContent = 'â€”';
                document.getElementById('kbCoverage').textContent = 'â€”';
                document.getElementById('navDocCount').textContent = db.total_chunks ? `${db.total_chunks}âœ‚` : '0';
            } catch {
                document.getElementById('kbTotal').textContent = 'â€”';
                document.getElementById('kbChunks').textContent = 'â€”';
            }
        }
    },

    // â”€â”€ Labels â”€â”€
    async loadLabels() {
        try {
            const data = await api.listLabels(App.tenantId);
            this.labels = data.labels || data || [];
        } catch (e) {
            console.warn('Labels load error:', e);
            this.labels = [];
        }
        this.renderLabelBar();
    },

    renderLabelBar() {
        const container = document.getElementById('labelPills');
        if (!container) return;
        if (this.labels.length === 0) {
            container.innerHTML = '<span style="font-size:11px;color:var(--text-muted);font-style:italic">Sin etiquetas definidas</span>';
            return;
        }
        container.innerHTML = this.labels.map(l => {
            const bg = l.color + '22';
            return `<span class="label-pill" style="background:${bg};color:${l.color}" title="${esc(l.description || l.name)}">
                <span class="lp-dot" style="background:${l.color}"></span>${esc(l.name)}
                <span class="lp-x" onclick="event.stopPropagation();KB.editLabel('${l.id}')" title="Editar">âœ</span>
                <span class="lp-x" onclick="event.stopPropagation();KB.confirmDeleteLabel('${l.id}','${esc(l.name)}')" title="Eliminar">Ã—</span>
            </span>`;
        }).join('');
    },

    openLabelModal(labelId) {
        const isEdit = !!labelId;
        document.getElementById('labelModalTitle').textContent = isEdit ? 'ğŸ·ï¸ Editar Etiqueta' : 'ğŸ·ï¸ Nueva Etiqueta';
        document.getElementById('labelEditId').value = labelId || '';
        if (isEdit) {
            const l = this.labels.find(x => x.id === labelId);
            if (l) {
                document.getElementById('labelName').value = l.name;
                document.getElementById('labelColor').value = l.color || '#7c3aed';
                document.getElementById('labelColorHex').textContent = l.color || '#7c3aed';
                document.getElementById('labelDesc').value = l.description || '';
            }
        } else {
            document.getElementById('labelName').value = '';
            document.getElementById('labelColor').value = '#7c3aed';
            document.getElementById('labelColorHex').textContent = '#7c3aed';
            document.getElementById('labelDesc').value = '';
        }
        openModal('labelModal');
    },

    editLabel(labelId) { this.openLabelModal(labelId); },

    setLabelColor(color) {
        document.getElementById('labelColor').value = color;
        document.getElementById('labelColorHex').textContent = color;
    },

    async saveLabel() {
        const name = document.getElementById('labelName').value.trim();
        if (!name) { toast('El nombre es obligatorio', 'error'); return; }
        const color = document.getElementById('labelColor').value;
        const description = document.getElementById('labelDesc').value.trim();
        const editId = document.getElementById('labelEditId').value;
        try {
            if (editId) {
                await api.updateLabel(App.tenantId, editId, { name, color, description });
                toast('Etiqueta actualizada', 'success');
            } else {
                await api.createLabel(App.tenantId, { name, color, description });
                toast('Etiqueta creada', 'success');
            }
            closeModal('labelModal');
            await this.loadLabels();
            this.render();
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    },

    confirmDeleteLabel(labelId, name) {
        showConfirm('Eliminar Etiqueta', `Â¿Eliminar la etiqueta "${name}"? Se desvincularÃ¡ automÃ¡ticamente de todos los documentos.`,
            async () => {
                try {
                    await api.deleteLabel(App.tenantId, labelId);
                    toast('Etiqueta eliminada', 'success');
                    // Remove from local cache
                    this.labels = this.labels.filter(l => l.id !== labelId);
                    Object.keys(this.docLabels).forEach(docId => {
                        this.docLabels[docId] = (this.docLabels[docId] || []).filter(l => l.id !== labelId);
                    });
                    this.renderLabelBar();
                    this.render();
                } catch (e) { toast('Error: ' + e.message, 'error'); }
            });
    },

    _toggling: false,
    async toggleDocLabel(docId, labelId) {
        if (this._toggling) return; // guard against rapid clicks
        this._toggling = true;
        const current = this.docLabels[docId] || [];
        const has = current.some(l => l.id === labelId);
        try {
            if (has) {
                await api.unassignLabel(App.tenantId, docId, labelId);
                this.docLabels[docId] = current.filter(l => l.id !== labelId);
            } else {
                await api.assignLabel(App.tenantId, docId, labelId);
                const label = this.labels.find(l => l.id === labelId);
                if (label) this.docLabels[docId] = [...current, label];
            }
            // Update picker in-place if still open
            this._refreshPicker(docId);
            this.render();
        } catch (e) { toast('Error: ' + e.message, 'error'); }
        this._toggling = false;
    },

    _renderPickerContent(docId) {
        if (this.labels.length === 0) {
            return '<div style="padding:8px;font-size:12px;color:var(--text-muted);text-align:center">Sin etiquetas.<br><button class="btn btn-sm" style="margin-top:6px" onclick="KB.openLabelModal();document.querySelectorAll(\'.label-picker\').forEach(p=>p.remove())">+ Crear</button></div>';
        }
        const currentIds = (this.docLabels[docId] || []).map(l => l.id);
        return this.labels.map(l => {
            const checked = currentIds.includes(l.id);
            return `<div class="label-picker-item" onclick="KB.toggleDocLabel('${docId}','${l.id}')">
                <div class="lpi-check${checked ? ' checked' : ''}">${checked ? 'âœ“' : ''}</div>
                <span class="lp-dot" style="background:${l.color};width:10px;height:10px;border-radius:50%;flex-shrink:0"></span>
                <span style="flex:1">${esc(l.name)}</span>
            </div>`;
        }).join('') + '<div style="border-top:1px solid var(--border);margin-top:4px;padding-top:4px"><div class="label-picker-item" onclick="KB.openLabelModal();document.querySelectorAll(\'.label-picker\').forEach(p=>p.remove())"><span style="color:var(--draga-accent-light)">+ Nueva Etiqueta</span></div></div>';
    },

    _refreshPicker(docId) {
        const picker = document.querySelector('.label-picker');
        if (picker && this.openPickerDocId === docId) {
            picker.innerHTML = this._renderPickerContent(docId);
        }
    },

    async showLabelPicker(docId, event) {
        event.stopPropagation();
        // Close any previously open picker
        document.querySelectorAll('.label-picker').forEach(p => p.remove());
        if (this.openPickerDocId === docId) { this.openPickerDocId = null; return; }
        this.openPickerDocId = docId;
        const cell = event.target.closest('.doc-labels-cell');
        if (!cell) return;
        const picker = document.createElement('div');
        picker.className = 'label-picker';
        picker.innerHTML = '<div style="padding:12px;text-align:center"><div class="spinner"></div></div>';
        cell.appendChild(picker);
        // Lazy-load labels for this doc
        await this.loadDocLabelsFor(docId);
        picker.innerHTML = this._renderPickerContent(docId);
        // Close on outside click
        const close = (e) => { if (!picker.contains(e.target) && e.target !== event.target) { picker.remove(); this.openPickerDocId = null; document.removeEventListener('click', close); } };
        setTimeout(() => document.addEventListener('click', close), 0);
    },

    async loadDocs() {
        const tbody = document.getElementById('docTableBody');
        tbody.innerHTML = '<tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr>';
        try {
            const data = await api.listDocuments(App.tenantId, null, null, App.agentId);
            this.docs = data.documents || data || [];
            // Filter out deleted/pending_delete docs â€” they shouldn't appear in the KB view
            this.docs = this.docs.filter(d => d.status !== 'deleted' && d.status !== 'pending_delete');
            this.docs.forEach(d => { if (d.category) d.category = d.category.replace(/^DocumentCategory\./i, '').toLowerCase(); });
            this.page = 1;
            this.applyFilter();
        } catch (e) {
            tbody.innerHTML = `<tr><td colspan="7" style="color:var(--danger);padding:16px">âŒ ${e.message}</td></tr>`;
        }
    },

    async loadDocLabelsFor(docId) {
        // Lazy: load labels for a single document (called when picker opens)
        if (this.docLabels[docId]) return this.docLabels[docId];
        try {
            const res = await api.getDocumentLabels(App.tenantId, docId);
            this.docLabels[docId] = res.labels || [];
        } catch { this.docLabels[docId] = []; }
        return this.docLabels[docId];
    },

    applyFilter() {
        let list = [...this.docs];
        if (this.statusFilter !== 'all') list = list.filter(d => d.status === this.statusFilter);
        const q = (document.getElementById('docSearch')?.value || '').toLowerCase().trim();
        if (q) list = list.filter(d => (d.filename || '').toLowerCase().includes(q) || (d.document_id || '').includes(q));
        this.filtered = list;
        const tp = Math.max(1, Math.ceil(list.length / this.perPage));
        if (this.page > tp) this.page = tp;
        this.render();
    },

    filter() { this.page = 1; this.applyFilter(); },

    setFilter(f, btn) {
        this.statusFilter = f;
        document.querySelectorAll('#mod-knowledge .filter-pill').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        this.filter();
    },

    prevPage() { if (this.page > 1) { this.page--; this.render(); } },
    nextPage() { const tp = Math.ceil(this.filtered.length / this.perPage); if (this.page < tp) { this.page++; this.render(); } },

    render() {
        const tbody = document.getElementById('docTableBody');
        const start = (this.page - 1) * this.perPage;
        const page = this.filtered.slice(start, start + this.perPage);
        const total = this.filtered.length;
        const tp = Math.max(1, Math.ceil(total / this.perPage));

        if (total === 0) {
            tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="icon">ğŸ“­</div><h3>Sin documentos</h3></div></td></tr>`;
            document.getElementById('docPagination').style.display = 'none';
            return;
        }

        const icons = { md:'ğŸ“', pdf:'ğŸ“•', txt:'ğŸ“ƒ', docx:'ğŸ“˜', json:'ğŸ”§', xml:'ğŸ“', xlsx:'ğŸ“Š', odt:'ğŸ““' };
        tbody.innerHTML = page.map(d => {
            const ext = (d.filename || '').split('.').pop().toLowerCase();
            const ico = icons[ext] || 'ğŸ“„';
            const dt = d.indexed_at ? new Date(d.indexed_at).toLocaleDateString('es', { day:'2-digit', month:'short' }) : 'â€”';
            const sfActive = SourceFilter.isActive(d.document_id);
            const sfBtn = `<button class="btn-icon" onclick="SourceFilter.toggle('${d.document_id}');KB.render()" title="${sfActive ? 'Excluir de bÃºsquedas' : 'Incluir en bÃºsquedas'}" style="opacity:${sfActive ? 1 : 0.4}">${sfActive ? 'ğŸ”' : 'ğŸš«'}</button>`;
            const displayName = d.display_name && d.display_name !== d.filename ? `<div style="font-size:10px;color:var(--info)">${esc(d.display_name)}</div>` : '';
            return `<tr style="${sfActive ? '' : 'opacity:0.5'}">
                <td><div style="display:flex;align-items:center;gap:6px">
                    <span style="font-size:16px">${ico}</span>
                    <div><div class="source-link" style="font-weight:600;max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${esc(d.filename)}" onclick="DocViewer.openById('${d.document_id}','${esc(d.filename)}')">${esc(d.filename)}</div>
                    ${displayName}
                    <div style="font-size:10px;color:var(--text-muted)">${d.document_id}</div></div>
                </div></td>
                <td>${statusBadge(d.status)}</td>
                <td><span class="badge badge-info">${d.category || 'â€”'}</span></td>
                <td>${d.chunk_count || 0}</td>
                <td>${fileSize(d.file_size_bytes || 0)}</td>
                <td style="font-size:11px">${dt}</td>
                <td>
                    ${sfBtn}
                    <button class="btn-icon" onclick="KB.showDetail('${d.document_id}')" title="Detalle">ğŸ”</button>
                    <button class="btn-icon" onclick="KB.reindex('${d.document_id}')" title="Re-indexar">ğŸ”„</button>
                    <button class="btn-icon" onclick="KB.confirmDelete('${d.document_id}','${esc(d.filename)}')" title="Eliminar">ğŸ—‘ï¸</button>
                </td>
            </tr>`;
        }).join('');

        const pag = document.getElementById('docPagination');
        pag.style.display = total > this.perPage ? 'flex' : 'none';
        document.getElementById('docPagInfo').textContent = `${start + 1}â€“${Math.min(start + this.perPage, total)} de ${total} Â· PÃ¡g ${this.page}/${tp}`;
        document.getElementById('docPrev').disabled = this.page <= 1;
        document.getElementById('docNext').disabled = this.page >= tp;
    },

    async showDetail(docId) {
        const panel = document.getElementById('detailPanel');
        const body = document.getElementById('detailBody');
        const actions = document.getElementById('detailActions');
        body.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        actions.innerHTML = '';
        panel.classList.add('open');
        try {
            const doc = await api.getDocument(docId, App.tenantId, App.agentId);
            body.innerHTML = [
                ['Archivo', esc(doc.filename)],
                ['ID', `<span style="font-size:10px;font-family:monospace">${doc.document_id}</span>`],
                ['Estado', statusBadge(doc.status)],
                ['CategorÃ­a', doc.category || 'â€”'],
                ['Chunks', doc.chunk_count || 0],
                ['TamaÃ±o', fileSize(doc.file_size_bytes || 0)],
                ['VersiÃ³n', 'v' + (doc.version || 1)],
                ['Hash', `<span style="font-size:10px;font-family:monospace">${doc.content_hash || 'â€”'}</span>`],
                ['Indexado', doc.indexed_at ? new Date(doc.indexed_at).toLocaleString('es') : 'â€”'],
                ...(doc.error ? [['Error', `<span style="color:var(--danger)">${esc(doc.error)}</span>`]] : [])
            ].map(([l, v]) => `<div class="dp-field"><div class="dp-label">${l}</div><div class="dp-value">${v}</div></div>`).join('');
            actions.innerHTML = `
                <a class="btn btn-sm" style="flex:1;text-decoration:none;text-align:center" href="${api.getDocumentSourceUrl(doc.document_id, App.tenantId, App.agentId)}" target="_blank">ğŸ“„ Ver Fuente</a>
                <button class="btn btn-sm" style="flex:1" onclick="DocViewer.openById('${doc.document_id}','${esc(doc.filename)}')">ğŸ‘ï¸ Visor</button>
                <button class="btn btn-sm" style="flex:1" onclick="KB.renameDoc('${doc.document_id}','${esc(doc.display_name || doc.filename)}')">âœï¸ Renombrar</button>
                <button class="btn btn-sm btn-primary" style="flex:1" onclick="KB.reindex('${doc.document_id}')">ğŸ”„ Re-indexar</button>
                <button class="btn btn-sm btn-danger" style="flex:1" onclick="KB.confirmDelete('${doc.document_id}','${esc(doc.filename)}')">ğŸ—‘ï¸ Eliminar</button>`;
        } catch (e) {
            body.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${e.message}</p></div>`;
        }
    },

    async reindex(id) {
        toast('Re-indexando...', 'info');
        try {
            await api.reindexDocument(id, App.tenantId, App.agentId);
            toast('Re-indexado', 'success');
            await this.loadAndStabilize(5, 1500);
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    },

    confirmDelete(id, name) {
        showConfirm('Eliminar Documento', `Â¿Eliminar "${name}"? Se eliminarÃ¡ de la KB y el vector store.`,
            async () => {
                try {
                    await api.deleteDocument(id, App.tenantId, App.agentId);
                    toast('Eliminado', 'success');
                    document.getElementById('detailPanel').classList.remove('open');
                    await this.loadAndStabilize(4, 1000);
                } catch (e) { toast('Error: ' + e.message, 'error'); }
            });
    },

    confirmReset() {
        showConfirm('â˜¢ï¸ Reset Nuclear', `Se limpiarÃ¡n TODOS los chunks del agente "${App.agentId}" en tenant "${App.tenantId}". No se puede deshacer.`,
            async () => {
                toast('Reseteando...', 'info');
                try {
                    await api.resetReindex(App.tenantId, App.agentId);
                    toast('Reset completado', 'success');
                    await this.loadAndStabilize(10, 3000);
                } catch (e) { toast('Error: ' + e.message, 'error'); }
            });
    },

    async processPending() {
        toast('Procesando pendientes...', 'info');
        try {
            await api.processPending(App.tenantId, false, App.agentId);
            toast('Completado', 'success');
            await this.loadAndStabilize();
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    },

    async renameDoc(docId, currentName) {
        const newName = prompt('Nuevo nombre para el documento:', currentName);
        if (!newName || newName === currentName) return;
        try {
            await api.renameDocument(docId, newName, App.tenantId, App.agentId);
            toast('Documento renombrado', 'success');
            await this.load(); // rename is instant, no stabilization needed
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    },

    syncDir() {
        const path = `/app/storage/sources/${App.tenantId || ''}/${App.agentId || 'default'}`;
        const dir = prompt('Directorio del servidor a sincronizar:', path);
        if (!dir) return;
        const force = confirm('Â¿Forzar re-indexaciÃ³n de existentes?');
        toast('Sincronizando...', 'info');
        api.syncDirectory(dir, App.tenantId, true, force, App.agentId)
            .then(async () => { toast('SincronizaciÃ³n completada', 'success'); await this.loadAndStabilize(); })
            .catch(e => toast('Error: ' + e.message, 'error'));
    },

    // â”€â”€ Upload â”€â”€
    openUpload() {
        this.uploadFiles = [];
        this.renderUploadFiles();
        openModal('uploadModal');
    },

    setupDropZone() {
        const z = document.getElementById('dropZone');
        if (!z) return;
        ['dragenter','dragover'].forEach(e => z.addEventListener(e, ev => { ev.preventDefault(); z.classList.add('drag-over'); }));
        ['dragleave','drop'].forEach(e => z.addEventListener(e, ev => { ev.preventDefault(); z.classList.remove('drag-over'); }));
        z.addEventListener('drop', ev => this.addFiles([...ev.dataTransfer.files]));
    },

    addFiles(files) {
        const allowed = ['.pdf','.md','.txt','.docx','.odt','.xlsx','.xls','.json','.xml'];
        files.forEach(f => {
            const ext = '.' + f.name.split('.').pop().toLowerCase();
            if (!allowed.includes(ext)) { toast(`Formato no soportado: ${f.name}`, 'error'); return; }
            if (this.uploadFiles.find(u => u.name === f.name && u.size === f.size)) return;
            this.uploadFiles.push(f);
        });
        this.renderUploadFiles();
    },

    renderUploadFiles() {
        const list = document.getElementById('uploadFileList');
        const opts = document.getElementById('uploadOptions');
        if (!this.uploadFiles.length) { list.innerHTML = ''; opts.style.display = 'none'; return; }
        opts.style.display = 'flex';
        const icons = { md:'ğŸ“', pdf:'ğŸ“•', txt:'ğŸ“ƒ', docx:'ğŸ“˜', json:'ğŸ”§', xml:'ğŸ“', xlsx:'ğŸ“Š', odt:'ğŸ““' };
        list.innerHTML = this.uploadFiles.map((f, i) => {
            const ext = f.name.split('.').pop().toLowerCase();
            return `<div class="upload-file-item"><span style="font-size:16px">${icons[ext]||'ğŸ“„'}</span><span class="uf-name">${f.name}</span><span class="uf-size">${fileSize(f.size)}</span><button class="uf-remove" onclick="KB.uploadFiles.splice(${i},1);KB.renderUploadFiles()">âœ•</button></div>`;
        }).join('');
    },

    // â”€â”€ Ingestion Tracker â”€â”€
    _activeTask: null,
    _pollTimer: null,

    _showTracker(fileNames) {
        const container = document.getElementById('ingestTracker');
        const icons = { md:'ğŸ“', pdf:'ğŸ“•', txt:'ğŸ“ƒ', docx:'ğŸ“˜', json:'ğŸ”§', xml:'ğŸ“', xlsx:'ğŸ“Š', odt:'ğŸ““' };
        const fileRows = fileNames.map(name => {
            const ext = name.split('.').pop().toLowerCase();
            return `<div class="ingest-file" data-fname="${esc(name)}">
                <span class="f-icon">${icons[ext] || 'ğŸ“„'}</span>
                <span class="f-name" title="${esc(name)}">${esc(name)}</span>
                <span class="f-status pending">â³ En cola</span>
            </div>`;
        }).join('');
        container.innerHTML = `<div class="ingest-tracker" id="ingestPanel">
            <div class="ingest-header">
                <div class="title"><div class="spinner"></div> Procesando fuentes...</div>
                <div class="meta" id="ingestMeta">0 / ${fileNames.length}</div>
            </div>
            <div class="progress-bar"><div class="fill" id="ingestProgress" style="width:0%"></div></div>
            <div class="ingest-files" id="ingestFiles">${fileRows}</div>
        </div>`;
        container.style.display = 'block';
    },

    _updateTracker(task) {
        const panel = document.getElementById('ingestPanel');
        if (!panel) return;
        const totalFiles = task.total_files || 0;
        const processed = task.processed_files || 0;
        const pct = task.progress_pct ?? (totalFiles ? Math.round(processed / totalFiles * 100) : 0);
        const files = task.files || [];
        const isComplete = task.state === 'completed';
        const isFailed = task.state === 'failed';

        // Update progress bar
        const bar = document.getElementById('ingestProgress');
        if (bar) { bar.style.width = pct + '%'; if (isComplete) bar.classList.add('complete'); }

        // Update meta
        const meta = document.getElementById('ingestMeta');
        if (meta) {
            if (isComplete) {
                const dupes = task.duplicates || 0;
                const ok = (task.successful || 0) - dupes;
                const fail = task.failed || 0;
                let parts = [];
                if (ok > 0) parts.push(`${ok} nuevo(s)`);
                if (dupes > 0) parts.push(`${dupes} duplicado(s)`);
                if (fail > 0) parts.push(`${fail} error(es)`);
                meta.textContent = parts.join(', ') || `${totalFiles} procesados`;
            } else if (isFailed) {
                meta.textContent = 'âŒ Error';
            } else {
                meta.textContent = `${processed} / ${totalFiles}`;
            }
        }

        // Update header
        const title = panel.querySelector('.ingest-header .title');
        if (title) {
            if (isComplete) {
                panel.classList.add('done');
                title.innerHTML = `âœ… Fuentes procesadas <button class="ingest-dismiss" onclick="KB._dismissTracker()" title="Cerrar">âœ•</button>`;
            } else if (isFailed) {
                panel.classList.add('error');
                title.innerHTML = `âŒ Error en procesamiento <button class="ingest-dismiss" onclick="KB._dismissTracker()" title="Cerrar">âœ•</button>`;
            }
        }

        // Update individual file rows
        files.forEach(f => {
            const row = document.querySelector(`.ingest-file[data-fname="${CSS.escape(f.filename)}"]`);
            if (!row) return;
            const statusEl = row.querySelector('.f-status');
            if (!statusEl) return;
            statusEl.className = 'f-status';
            if (f.state === 'completed' || f.state === 'indexed') {
                if (f.is_duplicate) {
                    statusEl.classList.add('duplicate');
                    statusEl.textContent = 'âš  Duplicado';
                } else {
                    statusEl.classList.add('done');
                    statusEl.textContent = `âœ“ ${f.chunk_count || 0} chunks`;
                }
            } else if (f.state === 'failed' || f.error) {
                statusEl.classList.add('failed');
                statusEl.textContent = 'âœ• Error';
                statusEl.title = f.error || '';
            } else if (f.state === 'processing') {
                statusEl.classList.add('processing');
                statusEl.textContent = 'âŸ³ Procesando...';
            } else {
                statusEl.classList.add('pending');
                statusEl.textContent = 'â³ En cola';
            }
        });
    },

    _dismissTracker() {
        const container = document.getElementById('ingestTracker');
        if (container) { container.style.display = 'none'; container.innerHTML = ''; }
        this._activeTask = null;
    },

    async doUpload() {
        if (this.uploading || !this.uploadFiles.length) return;
        this.uploading = true;
        const btn = document.getElementById('uploadBtn');
        const fileNames = this.uploadFiles.map(f => f.name);
        btn.disabled = true; btn.innerHTML = '<div class="spinner" style="width:14px;height:14px"></div> Subiendo...';
        try {
            const autoIdx = document.getElementById('optAutoIdx').checked;
            const bg = document.getElementById('optBg').checked;
            const res = await api.uploadDocuments(this.uploadFiles, App.tenantId, autoIdx, bg, App.agentId);

            closeModal('uploadModal');

            if (bg && res.task_id) {
                // Background mode: show tracker and poll
                this._activeTask = res.task_id;
                this._showTracker(fileNames);
                this._pollIngest(res.task_id);
            } else {
                // Synchronous mode: show tracker with instant result
                this._showTracker(fileNames);
                // Build a fake task object from sync response for the tracker
                const results = res.results || [];
                const fakeTask = {
                    state: 'completed',
                    total_files: results.length,
                    processed_files: results.length,
                    progress_pct: 100,
                    successful: res.successful || 0,
                    failed: res.failed || 0,
                    duplicates: res.duplicates || 0,
                    files: results.map(r => ({
                        filename: r.filename,
                        state: r.success ? 'completed' : 'failed',
                        chunk_count: r.chunk_count || 0,
                        is_duplicate: r.is_duplicate || false,
                        error: r.error
                    }))
                };
                this._updateTracker(fakeTask);
                await this.loadAndStabilize();
            }
        } catch (e) { toast('Error: ' + e.message, 'error'); }
        finally { this.uploading = false; btn.disabled = false; btn.innerHTML = 'ğŸ“¤ Subir'; }
    },

    async _pollIngest(taskId) {
        if (this._pollTimer) clearTimeout(this._pollTimer);
        let consecutive404 = 0;
        const MAX_404 = 8;          // stop after 8 consecutive 404s (~32s)
        const MAX_POLL_TIME = 300000; // 5 min absolute timeout
        const startTime = Date.now();

        const poll = async () => {
            // Absolute timeout guard
            if (Date.now() - startTime > MAX_POLL_TIME) {
                this._pollTimer = null;
                toast('â±ï¸ Timeout â€” la tarea tardÃ³ demasiado. Revisa en ConfiguraciÃ³n > Tareas.', 'warning');
                await this.loadAndStabilize();
                return;
            }
            try {
                const task = await api.getTask(taskId);
                consecutive404 = 0; // reset on success
                this._updateTracker(task);

                if (task.state === 'completed' || task.state === 'failed') {
                    this._pollTimer = null;
                    await this.loadAndStabilize();
                    return;
                }
                this._pollTimer = setTimeout(poll, 2000);
            } catch (err) {
                const is404 = err && (err.status === 404 || (err.message && err.message.includes('404')));
                if (is404) {
                    consecutive404++;
                    if (consecutive404 >= MAX_404) {
                        this._pollTimer = null;
                        // Fallback: try listing tasks to find this one
                        try {
                            const list = await api.listTasks(App.tenantId, null, 5, App.agentId);
                            const found = (list.tasks || []).find(t => t.task_id === taskId);
                            if (found) {
                                this._updateTracker(found);
                                if (found.state !== 'completed' && found.state !== 'failed') {
                                    // Task exists but GET by ID fails â€” retry with list polling
                                    consecutive404 = 0;
                                    this._pollTimer = setTimeout(poll, 3000);
                                    return;
                                }
                            }
                        } catch { /* ignore */ }
                        toast('âŒ No se pudo rastrear la tarea de ingesta. Revisa la lista de documentos.', 'error');
                        await this.loadAndStabilize();
                        return;
                    }
                }
                this._pollTimer = setTimeout(poll, is404 ? 4000 : 3000);
            }
        };
        this._pollTimer = setTimeout(poll, 1000);
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIPELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Pipeline = {
    async run() {
        const query = document.getElementById('pipelineQuery').value.trim();
        if (!query) { toast('Escribe una consulta', 'warning'); return; }

        const result = document.getElementById('pipelineResult');
        result.innerHTML = '<div class="loading"><div class="spinner"></div> Ejecutando pipeline...</div>';
        const t0 = Date.now();

        try {
            const res = await api.query({ query, tenant_id: App.tenantId, agent_id: App.agentId });
            const latency = Date.now() - t0;
            const conf = res.confidence != null ? (res.confidence * 100).toFixed(0) : 'â€”';
            const confColor = res.confidence > 0.7 ? 'var(--success)' : res.confidence > 0.4 ? 'var(--warning)' : 'var(--danger)';

            // Check for pipeline errors (error_step / error_detail from backend)
            const errorStep = res.metadata?.error_step;
            const errorDetail = res.metadata?.error_detail;
            const errorBanner = errorStep ? `<div class="card" style="border-left:3px solid var(--danger);margin-bottom:12px;padding:10px 14px">
                <div style="font-size:12px;color:var(--danger)">âš ï¸ Pipeline fallÃ³ en paso: <strong>${esc(errorStep)}</strong></div>
                ${errorDetail ? `<div style="font-size:11px;color:var(--text-muted);margin-top:4px">${esc(errorDetail)}</div>` : ''}
            </div>` : '';

            // Store chunks for viewer access
            Pipeline._lastChunks = res.retrieved_chunks || [];
            const sourcesHtml = (res.sources || []).map(s => `<span class="source-chip" onclick="DocViewer.openByFilename('${esc(s)}')" title="Ver documento fuente">ğŸ“„ ${esc(s)}</span>`).join('');
            const chunksViewBtn = Pipeline._lastChunks.length ? `<button class="btn btn-sm" style="margin-top:10px" onclick="DocViewer.openWithChunks('Chunks Recuperados', Pipeline._lastChunks)">ğŸ‘ï¸ Ver ${Pipeline._lastChunks.length} chunks recuperados</button>` : '';

            result.innerHTML = `
                ${errorBanner}
                <div class="stats-grid" style="grid-template-columns:repeat(auto-fill,minmax(120px,1fr));margin-bottom:14px;">
                    <div class="stat-card"><div class="label">Confianza</div><div class="value" style="color:${confColor}">${conf}%</div></div>
                    <div class="stat-card"><div class="label">Fuentes</div><div class="value">${res.sources?.length || 0}</div></div>
                    <div class="stat-card"><div class="label">Latencia</div><div class="value" style="font-size:16px">${latency}ms</div></div>
                    <div class="stat-card"><div class="label">Cache</div><div class="value">${res.cached ? 'âš¡ Hit' : 'ğŸ”„ Miss'}</div></div>
                    <div class="stat-card"><div class="label">Chunks</div><div class="value">${res.retrieved_chunks?.length || 0}</div></div>
                </div>
                <div class="card" style="border-left:3px solid var(--draga-accent)">
                    <div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:8px">Respuesta</div>
                    <div style="font-size:13px;line-height:1.7">${marked.parse(res.answer || 'Sin respuesta')}</div>
                    ${sourcesHtml ? `<div style="margin-top:10px">ğŸ“ <span style="font-size:11px;color:var(--text-muted)">Fuentes:</span> ${sourcesHtml}</div>` : ''}
                    ${chunksViewBtn}
                </div>`;
        } catch (e) {
            result.innerHTML = `<div class="card" style="border-left:3px solid var(--danger)"><div style="color:var(--danger)">âŒ ${e.message}</div></div>`;
        }
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUALITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Quality = {
    async load() {
        await Promise.all([this.loadMetrics(), this.loadGaps(), this.loadFeedback()]);
    },

    async loadMetrics() {
        const [docsRes, coverageRes, groundingRes, fbRes] = await Promise.allSettled([
            api.listDocuments(App.tenantId, null, null, App.agentId),
            api.metricsCoverage(App.tenantId, App.agentId),
            api.metricsGrounding(App.tenantId, App.agentId),
            api.feedbackStats(App.tenantId, App.agentId)
        ]);
        const docs = docsRes.status === 'fulfilled' ? (docsRes.value.documents || []) : [];
        const coverage = coverageRes.status === 'fulfilled' ? coverageRes.value : {};
        const grounding = groundingRes.status === 'fulfilled' ? groundingRes.value : {};
        const fb = fbRes.status === 'fulfilled' ? fbRes.value : {};

        const realDocCount = docs.length;
        const realChunkCount = docs.reduce((sum, d) => sum + (d.chunk_count || 0), 0);
        document.getElementById('qmDocs').textContent = realDocCount || 'â€”';
        document.getElementById('qmChunks').textContent = realChunkCount || 'â€”';
        document.getElementById('qmCoverage').textContent = coverage.coverage_rate != null ? (coverage.coverage_rate * 100).toFixed(0) + '%' : 'â€”';
        document.getElementById('qmGrounding').textContent = grounding.grounding_rate != null ? (grounding.grounding_rate * 100).toFixed(0) + '%' : 'â€”';
        document.getElementById('qmConfidence').textContent = grounding.avg_confidence != null ? (grounding.avg_confidence * 100).toFixed(0) + '%' : 'â€”';
        document.getElementById('qmCacheHit').textContent = grounding.cache_hit_rate != null ? (grounding.cache_hit_rate * 100).toFixed(0) + '%' : 'â€”';
        document.getElementById('qmFeedback').textContent = fb.total_feedback ?? 'â€”';
    },

    async loadGaps() {
        const container = document.getElementById('gapsContainer');
        try {
            const data = await api.metricsGaps(App.tenantId, App.agentId, false, 10);
            const gaps = data.gaps || data || [];
            if (!gaps.length) { container.innerHTML = '<div class="empty-state"><div class="icon">âœ…</div><p>No hay gaps detectados</p></div>'; return; }
            container.innerHTML = gaps.map(g => {
                const q = esc(g.query || g.question || '');
                return `<div class="gap-card">
                <div class="gc-query"><span class="source-link" onclick="Quality.testGapQuery('${q.replace(/'/g, '\\\'')}')" title="Probar esta consulta en el pipeline">${q}</span></div>
                <div class="gc-meta">
                    <span>ğŸ“… ${g.created_at ? new Date(g.created_at).toLocaleDateString('es') : 'â€”'}</span>
                    <span>ğŸ“Š Confianza: ${g.confidence != null ? (g.confidence * 100).toFixed(0) + '%' : 'â€”'}</span>
                    <span>${g.resolved ? '<span class="badge badge-success">Resuelto</span>' : '<span class="badge badge-warning">Pendiente</span>'}</span>
                </div>
            </div>`;
            }).join('');
        } catch { container.innerHTML = '<div class="empty-state"><p>Gaps service no disponible</p></div>'; }
    },

    async loadFeedback() {
        const tbody = document.getElementById('qualityFeedback');
        try {
            const data = await api.listFeedback({ limit: 10 }, App.tenantId, App.agentId);
            const items = Array.isArray(data) ? data : (data.entries || data.feedback || data.items || []);
            if (!items.length) { tbody.innerHTML = '<tr><td colspan="4"><div class="empty-state"><p>Sin feedback</p></div></td></tr>'; return; }
            tbody.innerHTML = items.map(f => {
                const q = esc(f.query || '');
                return `<tr>
                <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"><span class="source-link" onclick="Quality.testGapQuery('${q.replace(/'/g, '\\\'')}')" title="Probar esta consulta">${q}</span></td>
                <td>${f.rating === 'positive' ? '<span class="badge badge-success">ğŸ‘</span>' : '<span class="badge badge-danger">ğŸ‘</span>'}</td>
                <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(f.comment || 'â€”')}</td>
                <td>${f.reviewed ? '<span class="badge badge-success">âœ“</span>' : '<span class="badge badge-warning">pendiente</span>'}</td>
            </tr>`;
            }).join('');
        } catch { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--text-muted)">Feedback no disponible</td></tr>'; }
    },

    // Test a gap/feedback query â€” run it through the pipeline and show source chunks
    async testGapQuery(query) {
        toast('Ejecutando consulta...', 'info');
        try {
            const queryBody = { query, tenant_id: App.tenantId, agent_id: App.agentId, top_k: 10 };
            const docFilter = SourceFilter.getActiveIds();
            if (docFilter) queryBody.document_ids = docFilter;
            const res = await api.query(queryBody);
            const chunks = res.retrieved_chunks || [];
            if (chunks.length) {
                DocViewer.openWithChunks(`Fuentes: "${query.slice(0, 50)}"`, chunks);
            } else {
                toast('Sin chunks recuperados para esta consulta', 'warning');
            }
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Chat = {
    messages: [],
    _lastChunks: [],
    _msgCounter: 0,
    _feedbackData: {}, // msgId -> { query, response, confidence, sources }

    onProtocolChange() {
        const proto = document.getElementById('chatProtocol').value;
        // Model selector: show for openai & rag, hide for mcp
        document.getElementById('chatModel').style.display = proto === 'mcp' ? 'none' : '';
        // Tool selector: show only for mcp
        document.getElementById('chatToolName').style.display = proto === 'mcp' ? '' : 'none';
        // Stream toggle: only for openai
        document.getElementById('chatStreamToggle').style.display = proto === 'openai' ? '' : 'none';
        // Load MCP tools list on first switch
        if (proto === 'mcp' && document.getElementById('chatToolName').options.length <= 1) {
            this._loadMcpTools();
        }
    },

    async _loadMcpTools() {
        try {
            const data = await api.mcpTools();
            const sel = document.getElementById('chatToolName');
            sel.innerHTML = '';
            (data.tools || data || []).forEach(t => {
                const name = t.name || t;
                const opt = document.createElement('option');
                opt.value = name; opt.textContent = name;
                sel.appendChild(opt);
            });
        } catch (e) {
            console.warn('Could not load MCP tools', e);
        }
    },

    async send() {
        const input = document.getElementById('chatInput');
        const query = input.value.trim();
        if (!query) return;

        input.value = '';
        this.messages.push({ role: 'user', content: query });
        this.addBubble('user', query);

        const btn = document.getElementById('chatSendBtn');
        btn.disabled = true;

        const msgId = 'chat-msg-' + (++this._msgCounter);
        const thinkEl = document.createElement('div');
        thinkEl.id = msgId;
        thinkEl.className = 'chat-msg assistant';
        thinkEl.innerHTML = '<div class="spinner"></div> Pensando...';
        document.getElementById('chatMessages').appendChild(thinkEl);
        thinkEl.scrollIntoView({ behavior: 'smooth' });

        const protocol = document.getElementById('chatProtocol').value;

        try {
            if (protocol === 'openai') {
                await this._sendOpenAI(query, msgId, thinkEl, btn);
            } else if (protocol === 'mcp') {
                await this._sendMCP(query, msgId, thinkEl, btn);
            } else {
                await this._sendRAG(query, msgId, thinkEl, btn);
            }
        } catch (e) {
            thinkEl.innerHTML = `<span style="color:var(--danger)">Error: ${esc(e.message)}</span>`;
            btn.disabled = false;
        }
    },

    // â”€â”€ OpenAI Protocol (streaming) â”€â”€
    async _sendOpenAI(query, msgId, thinkEl, btn) {
        const topK = parseInt(document.getElementById('chatTopK').value) || 5;
        const model = document.getElementById('chatModel').value;
        const useStream = document.getElementById('chatStream').checked;
        let fullContent = '';
        thinkEl.innerHTML = '';

        const docFilter = SourceFilter.getActiveIds();
        const queryBody = { query, tenant_id: App.tenantId, agent_id: App.agentId, top_k: topK };
        if (docFilter) queryBody.document_ids = docFilter;
        const sourcePromise = api.query(queryBody).catch(() => null);

        const chatBody = { model, messages: this.messages, tenant_id: App.tenantId, agent_id: App.agentId, top_k: topK, stream: useStream };
        if (docFilter) chatBody.document_ids = docFilter;

        if (useStream) {
            await api.chatCompletionsStream(
                chatBody,
                (chunk) => {
                    const delta = chunk.choices?.[0]?.delta?.content || '';
                    if (delta) { fullContent += delta; thinkEl.innerHTML = marked.parse(fullContent); thinkEl.scrollIntoView({ behavior: 'smooth' }); }
                },
                async () => {
                    this.messages.push({ role: 'assistant', content: fullContent });
                    btn.disabled = false;
                    try {
                        await this._appendFooter(msgId, thinkEl, query, fullContent, sourcePromise);
                    } catch (e) {
                        console.warn('[Chat] Footer error, fallback to basic feedback:', e);
                        this._appendFeedbackControls(msgId, thinkEl, null);
                    }
                }
            );
        } else {
            const res = await api.chatCompletions(chatBody);
            fullContent = res.choices?.[0]?.message?.content || JSON.stringify(res);
            thinkEl.innerHTML = marked.parse(fullContent);
            this.messages.push({ role: 'assistant', content: fullContent });
            btn.disabled = false;
            await this._appendFooter(msgId, thinkEl, query, fullContent, sourcePromise);
        }
    },

    // â”€â”€ MCP Protocol (tool call) â”€â”€
    async _sendMCP(query, msgId, thinkEl, btn) {
        thinkEl.innerHTML = '';
        const toolName = document.getElementById('chatToolName').value || 'rag_query';
        const sessionId = `draga-chat-${App.tenantId}-${App.agentId || 'default'}`;
        const args = { query, tenant_id: App.tenantId };
        if (App.agentId) args.agent_id = App.agentId;

        const result = await api.mcpCallTool(toolName, args, sessionId);

        // Extract content from MCP tool response
        let fullContent = '';
        if (result.content) {
            fullContent = result.content.map(c => c.text || JSON.stringify(c)).join('\n');
        } else if (result.result) {
            fullContent = typeof result.result === 'string' ? result.result : JSON.stringify(result.result, null, 2);
        } else {
            fullContent = JSON.stringify(result, null, 2);
        }

        thinkEl.innerHTML = marked.parse(fullContent);
        this.messages.push({ role: 'assistant', content: fullContent });
        btn.disabled = false;

        // Extract sources/confidence from MCP result if available
        const confidence = result.confidence || null;
        const sources = result.sources || [];
        this._feedbackData[msgId] = { query, response: fullContent, confidence, sources };
        this._appendFeedbackControls(msgId, thinkEl, null);
    },

    // â”€â”€ RAG Query Protocol (direct query) â”€â”€
    async _sendRAG(query, msgId, thinkEl, btn) {
        thinkEl.innerHTML = '';
        const topK = parseInt(document.getElementById('chatTopK').value) || 5;
        const docFilter = SourceFilter.getActiveIds();
        const queryBody = { query, tenant_id: App.tenantId, agent_id: App.agentId, top_k: topK };
        if (docFilter) queryBody.document_ids = docFilter;

        const result = await api.query(queryBody);
        const fullContent = result.answer || result.response || JSON.stringify(result, null, 2);

        thinkEl.innerHTML = marked.parse(fullContent);
        this.messages.push({ role: 'assistant', content: fullContent });
        btn.disabled = false;

        await this._appendFooter(msgId, thinkEl, query, fullContent, Promise.resolve(result));
    },

    // â”€â”€ Shared: append sources + metrics + feedback footer â”€â”€
    async _appendFooter(msgId, thinkEl, query, fullContent, sourcePromise) {
        const ragResult = await sourcePromise;
        this._feedbackData[msgId] = {
            query,
            response: fullContent,
            confidence: ragResult?.confidence || null,
            sources: ragResult?.sources || []
        };

        const footer = document.createElement('div');
        footer.style.cssText = 'margin-top:10px;padding-top:8px;border-top:1px solid var(--border);';

        const conf = ragResult?.confidence;
        const confPct = conf != null ? (conf * 100).toFixed(0) : null;
        const confColor = conf > 0.7 ? 'var(--success)' : conf > 0.4 ? 'var(--warning)' : 'var(--danger)';
        const chunksSearched = ragResult?.metadata?.total_chunks_searched || 0;
        const latencyMs = ragResult?.metadata?.query_time_ms;
        let metricsHtml = '';
        if (confPct != null) {
            metricsHtml = `<div style="display:flex;gap:10px;font-size:10px;color:var(--text-muted);margin-bottom:6px;flex-wrap:wrap;">
                <span style="color:${confColor};font-weight:700">ğŸ¯ Confianza: ${confPct}%</span>
                ${chunksSearched ? `<span>ğŸ“¦ ${chunksSearched} chunks buscados</span>` : ''}
                ${latencyMs ? `<span>â±ï¸ ${Math.round(latencyMs)}ms</span>` : ''}
                ${ragResult?.metadata?.grounding_rate != null ? `<span>ğŸ›¡ï¸ Grounding: ${(ragResult.metadata.grounding_rate * 100).toFixed(0)}%</span>` : ''}
            </div>`;
        }

        let srcHtml = '';
        if (ragResult?.sources?.length) {
            const chips = ragResult.sources.map(s => `<span class="source-chip" onclick="DocViewer.openByFilename('${esc(s)}')">ğŸ“„ ${esc(s)}</span>`).join('');
            const chunks = ragResult.retrieved_chunks || [];
            const viewBtn = chunks.length ? `<span class="source-chip" onclick="DocViewer.openWithChunks('Chunks: ${esc(query.slice(0,30))}', Chat._lastChunks)" style="background:rgba(34,197,94,0.1);color:var(--success)">ğŸ‘ï¸ ${chunks.length} chunks</span>` : '';
            Chat._lastChunks = chunks;
            srcHtml = `<div style="font-size:11px;margin-bottom:8px">ğŸ“ ${chips} ${viewBtn}</div>`;
        }

        footer.innerHTML = `${metricsHtml}${srcHtml}
            <div class="chat-feedback" id="fb-${msgId}">
                <span>Â¿Fue Ãºtil?</span>
                <button class="chat-fb-btn" onclick="Chat.rate('${msgId}','positive')" title="Ãštil">ğŸ‘</button>
                <button class="chat-fb-btn" onclick="Chat.rate('${msgId}','negative')" title="No Ãºtil">ğŸ‘</button>
            </div>`;
        thinkEl.appendChild(footer);
    },

    // â”€â”€ Append feedback controls only (for MCP) â”€â”€
    _appendFeedbackControls(msgId, thinkEl, ragResult) {
        const footer = document.createElement('div');
        footer.style.cssText = 'margin-top:10px;padding-top:8px;border-top:1px solid var(--border);';
        footer.innerHTML = `<div class="chat-feedback" id="fb-${msgId}">
            <span>Â¿Fue Ãºtil?</span>
            <button class="chat-fb-btn" onclick="Chat.rate('${msgId}','positive')" title="Ãštil">ğŸ‘</button>
            <button class="chat-fb-btn" onclick="Chat.rate('${msgId}','negative')" title="No Ãºtil">ğŸ‘</button>
        </div>`;
        thinkEl.appendChild(footer);
    },

    // Handle rating selection â€” show comment input
    rate(msgId, rating) {
        const container = document.getElementById('fb-' + msgId);
        if (!container) return;
        const ratingLabel = rating === 'positive' ? 'ğŸ‘ Ãštil' : 'ğŸ‘ No Ãºtil';
        const ratingClass = rating === 'negative' ? ' negative' : '';
        container.innerHTML = `
            <span class="chat-fb-btn selected${ratingClass}" style="cursor:default">${ratingLabel}</span>
            <div class="chat-fb-comment" style="flex:1">
                <input type="text" placeholder="Comentario opcional..." id="fb-comment-${msgId}" onkeydown="if(event.key==='Enter')Chat.submitFeedback('${msgId}','${rating}')" />
                <button class="btn btn-sm btn-primary" onclick="Chat.submitFeedback('${msgId}','${rating}')">Enviar</button>
                <button class="btn btn-sm" onclick="Chat.submitFeedback('${msgId}','${rating}',true)">Omitir</button>
            </div>`;
        const input = container.querySelector('input');
        if (input) input.focus();
    },

    // Submit feedback to the API
    async submitFeedback(msgId, rating, skip = false) {
        const container = document.getElementById('fb-' + msgId);
        const data = this._feedbackData[msgId];
        if (!data || !container) return;

        const commentInput = document.getElementById('fb-comment-' + msgId);
        const comment = skip ? '' : (commentInput?.value?.trim() || '');

        try {
            const payload = {
                tenant_id: App.tenantId,
                agent_id: App.agentId,
                query: data.query,
                response: data.response,
                rating,
                confidence: data.confidence,
                session_id: `draga-chat-${App.tenantId}-${App.agentId || 'default'}`
            };
            if (comment) payload.comment = comment;

            await api.submitFeedback(payload, App.tenantId, App.agentId);

            const icon = rating === 'positive' ? 'ğŸ‘' : 'ğŸ‘';
            container.innerHTML = `<div class="chat-fb-sent">
                <span>${icon}</span>
                <span>Feedback enviado${comment ? ': ' + esc(comment) : ''}</span>
                âœ“
            </div>`;
            toast('Feedback registrado', 'success', 2000);
        } catch (e) {
            // Show non-intrusive error â€” feedback backend may be temporarily unavailable
            container.innerHTML = `<div style="font-size:11px;color:var(--text-muted)">âš ï¸ Feedback no disponible temporalmente</div>`;
        }
    },

    addBubble(role, content) {
        const el = document.createElement('div');
        el.className = 'chat-msg ' + role;
        el.innerHTML = role === 'assistant' ? marked.parse(content) : esc(content);
        document.getElementById('chatMessages').appendChild(el);
        el.scrollIntoView({ behavior: 'smooth' });
    },

    clear() {
        this.messages = [];
        this._msgCounter = 0;
        this._feedbackData = {};
        document.getElementById('chatMessages').innerHTML = '<div class="chat-msg assistant">Â¡Hola! Soy el DRAGA de este tenant. Â¿En quÃ© puedo ayudarte?</div>';
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONVERSATION HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ConvHistory = {
    async load() {
        const container = document.getElementById('convHistoryList');
        container.innerHTML = '<span style="color:var(--text-muted)">Cargando...</span>';
        try {
            const data = await api.listConversations(App.tenantId, 20, App.agentId);
            const sessions = data.sessions || [];

            if (sessions.length === 0) {
                container.innerHTML = '<div style="color:var(--text-muted);font-size:11px;text-align:center;padding:16px 0">Sin conversaciones previas</div>';
                return;
            }

            container.innerHTML = sessions.map(s => {
                const date = s.created_at ? new Date(s.created_at).toLocaleDateString('es', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : 'â€”';
                const msgCount = s.message_count || s.messages?.length || 0;
                const preview = s.last_message || s.preview || s.session_id || 'â€”';
                return `<div onclick="ConvHistory.openSession('${esc(s.session_id)}')" style="padding:8px;margin-bottom:6px;border-radius:6px;border:1px solid var(--border);cursor:pointer;transition:background 0.15s;" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background='transparent'">
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:2px">${date} Â· ${msgCount} msgs</div>
                    <div style="font-size:12px;color:var(--text-primary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:220px;">${esc(String(preview).slice(0, 60))}</div>
                </div>`;
            }).join('');
        } catch (e) {
            container.innerHTML = `<div style="color:var(--text-muted);font-size:11px;text-align:center;padding:16px 0">No hay historial disponible</div>`;
        }
    },

    async openSession(sessionId) {
        try {
            const data = await api.getConversation(sessionId, App.tenantId);
            const messages = data.messages || [];
            if (messages.length === 0) { toast('SesiÃ³n vacÃ­a', 'info'); return; }

            Chat.clear();
            Chat.messages = messages.map(m => ({ role: m.role, content: m.content }));
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            messages.forEach(m => Chat.addBubble(m.role, m.content));
            toast(`SesiÃ³n cargada: ${messages.length} mensajes`, 'success', 2000);
        } catch (e) { toast('Error al cargar sesiÃ³n: ' + e.message, 'error'); }
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WIDGETS GENERATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Widgets = {
    widgets: [],
    selectedId: null,

    _storageKey() {
        return `draga-widgets-${App.tenantId}-${App.agentId}`;
    },

    async load() {
        try {
            const raw = localStorage.getItem(this._storageKey());
            this.widgets = raw ? JSON.parse(raw) : [];
        } catch { this.widgets = []; }
        this.selectedId = null;
        this._renderList();
        document.getElementById('wgEditorSection').style.display = 'none';
        document.getElementById('wgPreviewLive').innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:40px;">Selecciona o crea un widget para probarlo en vivo</p>';
        document.getElementById('wgPreviewMockup').innerHTML = '';
        document.getElementById('wgEmbedCode').textContent = '';
        document.getElementById('wgIframeCode').textContent = '';
        // Default base URL (includes /api/v2 â€” what draga-chat.js expects)
        const origin = window.location.origin;
        document.getElementById('wgBaseUrl').value = origin + '/api/v2';
    },

    create() {
        const id = 'w_' + Date.now();
        const w = {
            id,
            name: `Widget ${this.widgets.length + 1}`,
            protocol: 'openai',
            model: 'eod-rag',
            position: 'bottom-right',
            locale: 'es',
            color: '#7c3aed',
            stream: true,
            sources: true,
            feedback: true,
            tokenEnabled: false,
            apiKey: '',
            baseUrl: window.location.origin + '/api/v2',
            createdAt: new Date().toISOString()
        };
        this.widgets.push(w);
        this._save();
        this.select(id);
    },

    select(id) {
        const w = this.widgets.find(x => x.id === id);
        if (!w) return;
        this.selectedId = id;
        this._renderList();
        document.getElementById('wgEditorSection').style.display = '';

        // Populate form
        document.getElementById('wgName').value = w.name;
        document.getElementById('wgProtocol').value = w.protocol;
        document.getElementById('wgModel').value = w.model;
        document.getElementById('wgPosition').value = w.position;
        document.getElementById('wgLocale').value = w.locale;
        document.getElementById('wgColor').value = w.color;
        document.getElementById('wgColorHex').textContent = w.color;
        document.getElementById('wgStream').checked = w.stream;
        document.getElementById('wgSources').checked = w.sources;
        document.getElementById('wgFeedback').checked = w.feedback;
        document.getElementById('wgTokenEnabled').checked = w.tokenEnabled;
        document.getElementById('wgTokenConfig').style.display = w.tokenEnabled ? '' : 'none';
        document.getElementById('wgApiKey').value = w.apiKey || '';
        document.getElementById('wgBaseUrl').value = w.baseUrl || (window.location.origin + '/api/v2');

        this._generateCode();
    },

    deleteSelected() {
        if (!this.selectedId) return;
        const w = this.widgets.find(x => x.id === this.selectedId);
        if (!confirm(`Â¿Eliminar widget "${w?.name || ''}"?`)) return;
        this.widgets = this.widgets.filter(x => x.id !== this.selectedId);
        this.selectedId = null;
        this._save();
        this._renderList();
        document.getElementById('wgEditorSection').style.display = 'none';
        document.getElementById('wgPreviewLive').innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:40px;">Selecciona o crea un widget para probarlo en vivo</p>';
        document.getElementById('wgPreviewMockup').innerHTML = '';
        document.getElementById('wgEmbedCode').textContent = '';
        document.getElementById('wgIframeCode').textContent = '';
    },

    onConfigChange() {
        if (!this.selectedId) return;
        const w = this.widgets.find(x => x.id === this.selectedId);
        if (!w) return;

        w.name = document.getElementById('wgName').value.trim() || 'Widget';
        w.protocol = document.getElementById('wgProtocol').value;
        w.model = document.getElementById('wgModel').value.trim() || 'eod-rag';
        w.position = document.getElementById('wgPosition').value;
        w.locale = document.getElementById('wgLocale').value;
        w.color = document.getElementById('wgColor').value;
        w.stream = document.getElementById('wgStream').checked;
        w.sources = document.getElementById('wgSources').checked;
        w.feedback = document.getElementById('wgFeedback').checked;
        w.apiKey = document.getElementById('wgApiKey').value.trim();
        w.baseUrl = document.getElementById('wgBaseUrl').value.trim();

        document.getElementById('wgColorHex').textContent = w.color;

        this._save();
        this._renderList();
        this._generateCode();
    },

    toggleToken() {
        const enabled = document.getElementById('wgTokenEnabled').checked;
        document.getElementById('wgTokenConfig').style.display = enabled ? '' : 'none';
        if (this.selectedId) {
            const w = this.widgets.find(x => x.id === this.selectedId);
            if (w) {
                w.tokenEnabled = enabled;
                if (!enabled) w.apiKey = '';
                this._save();
                this._generateCode();
            }
        }
    },

    async useExistingKey() {
        try {
            const data = await api.listApiKeys(App.tenantId);
            const keys = data.keys || [];
            if (keys.length === 0) {
                toast('No hay API Keys. Crea una en la secciÃ³n ConfiguraciÃ³n.', 'warning');
                return;
            }
            const options = keys.map((k, i) => `${i + 1}. ${k.label || 'Sin label'} (${k.key_prefix}...)`).join('\n');
            const choice = prompt(`Selecciona una key (nÃºmero):\n\n${options}`);
            if (!choice) return;
            const idx = parseInt(choice) - 1;
            if (idx < 0 || idx >= keys.length) { toast('SelecciÃ³n invÃ¡lida', 'error'); return; }
            // API keys are created and the raw key is only shown once.
            // We can only paste the prefix as a hint â€” the user must paste the actual key.
            toast('âš ï¸ Las API Keys no se pueden recuperar despuÃ©s de creadas. Pega la key que guardaste al crearla.', 'warning');
            document.getElementById('wgApiKey').focus();
        } catch (e) {
            toast('Error al cargar keys: ' + e.message, 'error');
        }
    },

    switchTab(tab, btn) {
        // Hide all tabs
        ['Preview', 'Embed', 'Iframe'].forEach(t => {
            document.getElementById('wgTab' + t).classList.remove('active');
        });
        // Deactivate all pills
        document.querySelectorAll('[data-wgtab]').forEach(b => b.classList.remove('active'));
        // Show selected
        const tabMap = { preview: 'Preview', embed: 'Embed', iframe: 'Iframe' };
        document.getElementById('wgTab' + tabMap[tab]).classList.add('active');
        btn.classList.add('active');
    },

    copyCode(type) {
        const el = type === 'embed' ? document.getElementById('wgEmbedCode') : document.getElementById('wgIframeCode');
        const text = el.textContent;
        if (!text.trim()) { toast('No hay cÃ³digo para copiar', 'warning'); return; }
        navigator.clipboard.writeText(text).then(() => {
            toast('CÃ³digo copiado al portapapeles', 'success');
        }).catch(() => {
            // Fallback
            const ta = document.createElement('textarea');
            ta.value = text; document.body.appendChild(ta);
            ta.select(); document.execCommand('copy');
            document.body.removeChild(ta);
            toast('CÃ³digo copiado', 'success');
        });
    },

    // â”€â”€ Internal â”€â”€

    _generateCode() {
        const w = this.widgets.find(x => x.id === this.selectedId);
        if (!w) return;

        const baseUrl = w.baseUrl || (window.location.origin + '/api/v2');
        // Script URL uses the origin (strip /api/v2 if present)
        const originUrl = baseUrl.replace(/\/api\/v2\/?$/, '').replace(/\/+$/, '');
        const scriptUrl = originUrl + '/src/draga-chat.js';
        // NOTE: <draga-chat> uses the "agent" attribute as tenant ID in the API URL
        const tenantId = App.tenantId;

        // Build attributes
        const attrs = [];
        attrs.push(`agent="${esc(tenantId)}"`);
        attrs.push(`base-url="${esc(baseUrl)}"`);
        attrs.push(`protocol="${w.protocol}"`);
        attrs.push(`model="${esc(w.model)}"`);
        attrs.push(`position="${w.position}"`);
        attrs.push(`locale="${w.locale}"`);
        attrs.push(`theme="auto"`);
        attrs.push(`streaming="${w.stream}"`);
        attrs.push(`show-sources="${w.sources}"`);
        attrs.push(`feedback="${w.feedback}"`);
        if (w.tokenEnabled && w.apiKey) {
            attrs.push(`api-key="${esc(w.apiKey)}"`);
        }

        // Embed code (Web Component)
        const embed = `<!-- DRAGA Chat Widget â€” ${esc(w.name)} -->\n<script src="${esc(scriptUrl)}"><\/script>\n<draga-chat\n    ${attrs.join('\n    ')}\n><\/draga-chat>`;

        // Custom CSS override (color)
        const cssSnippet = w.color !== '#7c3aed'
            ? `\n\n<!-- Color personalizado -->\n<style>\n  draga-chat { --draga-primary: ${w.color}; }\n</style>`
            : '';

        document.getElementById('wgEmbedCode').textContent = embed + cssSnippet;

        // iFrame code
        const iframeParams = new URLSearchParams({
            tenant: tenantId || '',
            agent: App.agentId || 'default',
            protocol: w.protocol,
            model: w.model,
            locale: w.locale,
            streaming: w.stream,
            sources: w.sources,
            feedback: w.feedback,
        });
        if (w.tokenEnabled && w.apiKey) iframeParams.set('apiKey', w.apiKey);
        const iframeSrc = originUrl + '/demo-draga-chat.html?' + iframeParams.toString();
        const iframeCode = `<!-- DRAGA Chat iFrame â€” ${esc(w.name)} -->\n<iframe\n    src="${esc(iframeSrc)}"\n    style="border:none; position:fixed; bottom:0; right:0; width:420px; height:600px; z-index:9999;"\n    allow="clipboard-write"\n    title="DRAGA Chat"\n></iframe>`;
        document.getElementById('wgIframeCode').textContent = iframeCode;

        // Preview
        this._renderPreview(w, baseUrl);
    },

    switchPreviewMode(mode, btn) {
        document.querySelectorAll('[data-wgprev]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('wgPreviewLive').style.display = mode === 'live' ? '' : 'none';
        document.getElementById('wgPreviewMockup').style.display = mode === 'mockup' ? '' : 'none';
    },

    _renderPreview(w, baseUrl) {
        // â”€â”€ Live preview: real <draga-chat> in an iframe â”€â”€
        this._renderLivePreview(w, baseUrl);
        // â”€â”€ Static mockup â”€â”€
        this._renderMockupPreview(w);
    },

    _renderLivePreview(w, baseUrl) {
        const container = document.getElementById('wgPreviewLive');
        // NOTE: <draga-chat> uses the "agent" attribute as tenant ID in the API URL
        const tenantId = App.tenantId;
        // Script URL uses origin (strip /api/v2 if present)
        const originUrl = baseUrl.replace(/\/api\/v2\/?$/, '').replace(/\/+$/, '');
        const scriptUrl = originUrl + '/src/draga-chat.js';
        const color = w.color || '#7c3aed';

        // Build the attributes for the live widget
        const attrParts = [
            `agent="${tenantId}"`,
            `base-url="${baseUrl}"`,
            `protocol="${w.protocol}"`,
            `model="${w.model}"`,
            `position="none"`,  // inline â€” no floating
            `locale="${w.locale}"`,
            `theme="light"`,
            `streaming="${w.stream}"`,
            `show-sources="${w.sources}"`,
            `feedback="${w.feedback}"`,
        ];
        if (w.tokenEnabled && w.apiKey) {
            attrParts.push(`api-key="${w.apiKey}"`);
        }

        // srcdoc: a self-contained HTML page that loads and renders the widget inline (open)
        const srcdoc = `<!DOCTYPE html>
<html lang="${w.locale}">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; background: #f3f4f6; font-family: system-ui, sans-serif; }
  body { display: flex; align-items: stretch; justify-content: center; }
  draga-chat {
    --draga-primary: ${color};
    width: 100%;
    height: 100%;
  }
</style>
</head>
<body>
<script src="${scriptUrl}"><\/script>
<draga-chat ${attrParts.join(' ')}><\/draga-chat>
<script>
  // Force the widget to render open & inline (not as a floating bubble)
  customElements.whenDefined('draga-chat').then(() => {
    const el = document.querySelector('draga-chat');
    if (el && el.shadowRoot) {
      const style = document.createElement('style');
      style.textContent = ':host { position: static !important; width: 100% !important; height: 100% !important; } .draga-chat-container { position: static !important; width: 100% !important; height: 100% !important; } .draga-toggle { display: none !important; } .draga-window { position: static !important; display: flex !important; flex-direction: column !important; width: 100% !important; height: 100% !important; max-height: 100% !important; border-radius: 0 !important; box-shadow: none !important; opacity: 1 !important; transform: none !important; pointer-events: auto !important; }';
      el.shadowRoot.appendChild(style);
      // Click the toggle if the window is still hidden
      const toggle = el.shadowRoot.querySelector('.draga-toggle');
      if (toggle) toggle.click();
    }
  });
<\/script>
</body>
</html>`;

        container.innerHTML = `<iframe
            id="wgLiveIframe"
            srcdoc="${srcdoc.replace(/"/g, '&quot;')}"
            style="width:100%;height:520px;border:none;border-radius:var(--radius);background:#f3f4f6;"
            sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"
            title="Widget Preview"
        ></iframe>`;
    },

    _renderMockupPreview(w) {
        const color = w.color || '#7c3aed';
        const protocolLabel = { openai: 'OpenAI Streaming', rag: 'RAG Query', mcp: 'MCP Tool Call' }[w.protocol] || w.protocol;
        const features = [];
        if (w.stream) features.push('âš¡ Streaming');
        if (w.sources) features.push('ğŸ“š Fuentes');
        if (w.feedback) features.push('ğŸ‘ Feedback');
        if (w.tokenEnabled && w.apiKey) features.push('ğŸ” Token');

        document.getElementById('wgPreviewMockup').innerHTML = `
            <div style="max-width:340px;margin:0 auto;">
                <div style="border-radius:16px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.15);border:1px solid #e5e7eb;font-family:system-ui,-apple-system,sans-serif;">
                    <div style="background:${color};color:#fff;padding:14px 18px;display:flex;align-items:center;gap:10px;">
                        <div style="width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:16px;">ğŸ‰</div>
                        <div>
                            <div style="font-weight:700;font-size:14px;">${esc(w.name)}</div>
                            <div style="font-size:11px;opacity:0.8;">ğŸŸ¢ En lÃ­nea Â· ${protocolLabel}</div>
                        </div>
                    </div>
                    <div style="background:#f9fafb;padding:16px;min-height:140px;display:flex;flex-direction:column;gap:10px;">
                        <div style="background:#fff;border-radius:12px;padding:10px 14px;font-size:12px;color:#374151;max-width:80%;box-shadow:0 1px 3px rgba(0,0,0,0.06);">Â¡Hola! Â¿En quÃ© puedo ayudarte?</div>
                        <div style="background:${color};color:#fff;border-radius:12px;padding:10px 14px;font-size:12px;max-width:80%;align-self:flex-end;box-shadow:0 1px 3px rgba(0,0,0,0.06);">Â¿CÃ³mo funciona este servicio?</div>
                        <div style="background:#fff;border-radius:12px;padding:10px 14px;font-size:12px;color:#374151;max-width:85%;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
                            Este servicio te permite consultar documentos mediante RAG...
                            ${w.sources ? '<div style="margin-top:6px;padding-top:6px;border-top:1px solid #e5e7eb;font-size:10px;color:#6b7280;">ğŸ“š 2 fuentes consultadas</div>' : ''}
                            ${w.feedback ? '<div style="margin-top:4px;font-size:10px;">ğŸ‘ ğŸ‘</div>' : ''}
                        </div>
                    </div>
                    <div style="background:#fff;border-top:1px solid #e5e7eb;padding:10px 14px;display:flex;gap:8px;align-items:center;">
                        <div style="flex:1;background:#f3f4f6;border-radius:20px;padding:8px 14px;font-size:12px;color:#9ca3af;">${w.locale === 'es' ? 'Escribe tu consulta...' : 'Type your message...'}</div>
                        <div style="width:32px;height:32px;border-radius:50%;background:${color};display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;cursor:pointer;">â†‘</div>
                    </div>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;justify-content:center;">
                    ${features.map(f => `<span style="font-size:10px;background:var(--surface-bg);color:var(--text-secondary);padding:3px 8px;border-radius:10px;border:1px solid var(--border-color);">${f}</span>`).join('')}
                    <span style="font-size:10px;background:var(--surface-bg);color:var(--text-secondary);padding:3px 8px;border-radius:10px;border:1px solid var(--border-color);">ğŸ“ ${w.position}</span>
                    <span style="font-size:10px;background:var(--surface-bg);color:var(--text-secondary);padding:3px 8px;border-radius:10px;border:1px solid var(--border-color);">ğŸŒ ${w.locale.toUpperCase()}</span>
                </div>
                <div style="text-align:center;margin-top:10px;font-size:11px;color:var(--text-muted);">
                    ğŸ‰ DRAGA: <strong>${esc(App.tenantId)}</strong> / <strong>${esc(App.agentId || 'default')}</strong>
                </div>
            </div>`;
    },

    _save() {
        try {
            localStorage.setItem(this._storageKey(), JSON.stringify(this.widgets));
        } catch (e) {
            console.warn('Could not save widgets', e);
        }
    },

    _renderList() {
        const container = document.getElementById('wgWidgetList');
        if (this.widgets.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px;">Sin widgets. Crea uno con el botÃ³n de abajo.</div>';
            return;
        }
        container.innerHTML = this.widgets.map(w => {
            const isActive = w.id === this.selectedId;
            const protocolIcon = { openai: 'âš¡', rag: 'ğŸ”', mcp: 'ğŸ”§' }[w.protocol] || 'ğŸ“¦';
            const tokenBadge = w.tokenEnabled ? '<span class="wg-token-badge on">ğŸ”</span>' : '';
            return `<div class="wg-item${isActive ? ' active' : ''}" onclick="Widgets.select('${w.id}')">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <strong style="font-size:13px;">${esc(w.name)}</strong>
                    ${tokenBadge}
                </div>
                <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">
                    ${protocolIcon} ${w.protocol.toUpperCase()} Â· ğŸ“ ${w.position} Â· ğŸŒ ${w.locale.toUpperCase()}
                </div>
            </div>`;
        }).join('');
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API KEYS (DRAGA instance)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ApiKeys = {
    async load() {
        const container = document.getElementById('dragaApiKeys');
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        try {
            const data = await api.listApiKeys(App.tenantId);
            const keys = data.keys || [];

            if (keys.length === 0) {
                container.innerHTML = `<div class="card" style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px">
                    <div>ğŸ”‘ Sin API Keys para este DRAGA</div>
                    <div style="font-size:11px;margin-top:4px">Crea una clave para integrar aplicaciones externas</div>
                </div>`;
                return;
            }

            container.innerHTML = `<div class="card" style="overflow-x:auto;"><table class="table" style="font-size:12px;">
                <thead><tr><th>Label</th><th>Prefijo</th><th>Tipo</th><th>Expira</th><th></th></tr></thead>
                <tbody>${keys.map(k => `<tr>
                    <td><strong>${k.label || 'â€”'}</strong></td>
                    <td><code style="font-size:11px">${k.key_prefix || 'â€”'}</code></td>
                    <td><span class="badge">${k.key_type || 'secret'}</span></td>
                    <td style="color:var(--text-secondary)">${k.expires_at ? new Date(k.expires_at).toLocaleDateString('es') : 'Nunca'}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="ApiKeys.revoke('${k.key_id}','${(k.label||'').replace(/'/g,"\\'")}')">Revocar</button></td>
                </tr>`).join('')}</tbody></table></div>`;
        } catch (e) {
            container.innerHTML = `<div class="card" style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px">ğŸ”‘ Sin API Keys</div>`;
        }
    },

    async create() {
        const label = prompt('Label para la nueva API Key:');
        if (!label || !label.trim()) return;

        try {
            const result = await api.createApiKey({
                tenant_id: App.tenantId,
                agent_id: App.agentId,
                label: label.trim(),
                scopes: ['query', 'ingest', 'feedback']
            });
            const rawKey = result.raw_key || result.key || 'â€”';
            alert(`âœ… API Key creada!\n\nğŸ”‘ ${rawKey}\n\nâš ï¸ Guarda esta clave â€” no se podrÃ¡ ver de nuevo.`);
            try { await navigator.clipboard.writeText(rawKey); toast('Clave copiada al portapapeles', 'success'); } catch {}
            this.load();
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    },

    async revoke(keyId, label) {
        if (!confirm(`Â¿Revocar API Key "${label}"?`)) return;
        try {
            await api.revokeApiKey(keyId);
            toast(`API Key "${label}" revocada`, 'success');
            this.load();
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Config = {
    async load() {
        await Promise.all([this.loadRetrieval(), this.loadSystemPrompt(), this.loadMcpPrompts(), ApiKeys.load(), WidgetCfg.load(), this.generateEmbed(), TasksMod.refresh()]);
    },

    async loadRetrieval() {
        const container = document.getElementById('retrievalConfig');
        try {
            // DRAGA owns ALL RAG config (per API reference)
            // Read from agent first, fall back to tenant for legacy
            let rc = {};
            let configSource = 'tenant';
            try {
                const agent = await api.getAgent(App.tenantId, App.agentId);
                rc = agent.config || {};
                configSource = 'draga';
            } catch {
                try {
                    const tenant = await api.getTenant(App.tenantId);
                    rc = tenant.retrieval_config || tenant.config || {};
                } catch { /* use defaults */ }
            }
            const sf = SourceFilter.getActiveIds();
            const sfInfo = sf ? `<div style="font-size:11px;color:var(--warning);margin-bottom:8px">ğŸ” Filtro de fuentes activo: ${sf.length} docs seleccionados <button class="btn btn-sm" onclick="SourceFilter.reset();Config.loadRetrieval()">Limpiar filtro</button></div>` : '';
            const srcBadge = configSource === 'draga'
                ? '<span style="font-size:10px;background:rgba(34,197,94,0.15);color:var(--success);padding:2px 8px;border-radius:8px">ğŸ§¬ DRAGA</span>'
                : '<span style="font-size:10px;background:rgba(156,163,175,0.15);color:var(--text-muted);padding:2px 8px;border-radius:8px">ğŸ¢ Tenant (legacy)</span>';
            container.innerHTML = `
                <div style="margin-bottom:8px">${srcBadge}</div>
                ${sfInfo}
                <div class="form-row">
                    <div class="form-group"><label>Top K</label><input type="number" value="${rc.top_k||5}" id="rcTopK" min="1" max="20"></div>
                    <div class="form-group"><label>Umbral Similitud</label><input type="number" value="${rc.similarity_threshold||0.5}" id="rcThreshold" min="0" max="1" step="0.05"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Chunk Size</label><input type="number" value="${rc.chunk_size||500}" id="rcChunkSize" min="100" max="5000"></div>
                    <div class="form-group"><label>Chunk Overlap</label><input type="number" value="${rc.chunk_overlap||50}" id="rcOverlap" min="0" max="500"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Modelo LLM</label><input type="text" value="${rc.llm_model||'anthropic/claude-3-haiku'}" id="rcModel" style="font-size:11px"></div>
                    <div class="form-group"><label>Idioma Respuesta</label><input type="text" value="${rc.response_language||'auto'}" id="rcLang" placeholder="auto, es, en"></div>
                </div>
                <button class="btn btn-primary btn-sm" onclick="Config.saveRetrieval()">ğŸ’¾ Guardar</button>`;
        } catch (e) { container.innerHTML = `<div style="color:var(--danger);font-size:12px">âŒ ${e.message}</div>`; }
    },

    async saveRetrieval() {
        try {
            const config = {
                top_k: parseInt(document.getElementById('rcTopK').value),
                similarity_threshold: parseFloat(document.getElementById('rcThreshold').value),
                chunk_size: parseInt(document.getElementById('rcChunkSize').value),
                chunk_overlap: parseInt(document.getElementById('rcOverlap').value),
                llm_model: document.getElementById('rcModel').value.trim(),
                response_language: document.getElementById('rcLang').value.trim() || 'auto'
            };
            // Try saving to DRAGA agent first (DRAGA owns RAG config)
            try {
                await api.updateAgent(App.tenantId, App.agentId || 'default', { config });
                toast('ConfiguraciÃ³n guardada en DRAGA', 'success');
                return;
            } catch {
                // Fallback: save to tenant (legacy)
                await api.updateTenant(App.tenantId, { retrieval_config: config });
                toast('ConfiguraciÃ³n guardada en tenant', 'success');
            }
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    },

    // â”€â”€ System Prompt â”€â”€
    async loadSystemPrompt() {
        const container = document.getElementById('systemPromptConfig');
        try {
            let currentPrompt = '';
            let source = 'default';

            // Try agent config first
            try {
                const agent = await api.getAgent(App.tenantId, App.agentId);
                currentPrompt = agent.config?.system_prompt || '';
                if (currentPrompt) source = 'draga';
            } catch { /* no agent */ }

            const srcBadge = source === 'draga'
                ? '<span style="font-size:10px;background:rgba(34,197,94,0.15);color:var(--success);padding:2px 8px;border-radius:8px">ğŸ§¬ DRAGA</span>'
                : '<span style="font-size:10px;background:rgba(156,163,175,0.15);color:var(--text-muted);padding:2px 8px;border-radius:8px">ğŸ“„ Default (plataforma)</span>';

            container.innerHTML = `
                <div style="margin-bottom:8px">${srcBadge}</div>
                <div class="form-group">
                    <label>System Prompt <span style="font-size:10px;color:var(--text-muted)">(define la personalidad y reglas del DRAGA)</span></label>
                    <textarea id="spPrompt" rows="8" style="width:100%;padding:10px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:12px;font-family:monospace;resize:vertical;">${esc(currentPrompt)}</textarea>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button class="btn btn-primary btn-sm" onclick="Config.saveSystemPrompt()">ğŸ’¾ Guardar Prompt</button>
                    <button class="btn btn-sm" onclick="Config.previewPrompt()" title="Ver el prompt final compilado">ğŸ‘ï¸ Preview</button>
                    <span style="font-size:10px;color:var(--text-muted);">VacÃ­o = usa el prompt por defecto de la plataforma</span>
                </div>
                <div id="spPreview" style="display:none;margin-top:12px;"></div>`;
        } catch (e) {
            container.innerHTML = `<div style="color:var(--danger);font-size:12px">âŒ ${e.message}</div>`;
        }
    },

    async saveSystemPrompt() {
        try {
            const prompt = document.getElementById('spPrompt').value.trim();
            const config = { system_prompt: prompt || null };
            try {
                await api.updateAgent(App.tenantId, App.agentId || 'default', { config });
                toast('System prompt guardado', 'success');
            } catch {
                // If no agent exists, create one
                await api.createAgent({ tenant_id: App.tenantId, agent_id: App.agentId || 'default', config });
                toast('System prompt guardado (agente creado)', 'success');
            }
            this.loadSystemPrompt();
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    },

    async previewPrompt() {
        const preview = document.getElementById('spPreview');
        preview.style.display = '';
        preview.innerHTML = '<div class="spinner"></div> Compilando prompt...';
        try {
            // Use MCP render to show what the prompt looks like
            const result = await api.mcpRenderPrompt('customer_support', { user_question: '(ejemplo)' });
            preview.innerHTML = `<div style="background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;font-size:11px;font-family:monospace;white-space:pre-wrap;max-height:300px;overflow-y:auto;">${esc(result.rendered || JSON.stringify(result, null, 2))}</div>`;
        } catch (e) {
            preview.innerHTML = `<div style="color:var(--danger);font-size:12px">âŒ ${e.message}</div>`;
        }
    },

    // â”€â”€ MCP Prompts â”€â”€
    async loadMcpPrompts() {
        const container = document.getElementById('mcpPromptsList');
        try {
            const data = await api.mcpPrompts();
            const prompts = data.prompts || data || [];

            if (prompts.length === 0) {
                container.innerHTML = '<div style="color:var(--text-muted);font-size:12px;">No hay prompts MCP configurados</div>';
                return;
            }

            container.innerHTML = prompts.map((p, i) => {
                const args = (p.arguments || []).map(a => `<code style="background:var(--bg-input);padding:1px 6px;border-radius:3px;font-size:10px;">${esc(a)}</code>`).join(' ');
                return `<div class="card" style="margin-bottom:10px;padding:14px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <strong style="font-size:13px;">ğŸ“œ ${esc(p.name)}</strong>
                        <button class="btn btn-sm" onclick="Config.testMcpPrompt('${esc(p.name)}', ${JSON.stringify(p.arguments || []).replace(/"/g, '&quot;')})" style="font-size:10px;">â–¶ Probar</button>
                    </div>
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">${esc(p.description?.trim() || '')}</div>
                    <div style="font-size:10px;">Args: ${args || '<span style="color:var(--text-muted)">ninguno</span>'}</div>
                    <div id="mcpPromptPreview-${i}" style="display:none;margin-top:10px;"></div>
                </div>`;
            }).join('');
        } catch (e) {
            container.innerHTML = `<div style="color:var(--danger);font-size:12px">âŒ ${e.message}</div>`;
        }
    },

    async testMcpPrompt(name, argNames) {
        // Build args object with placeholder values
        const args = {};
        (argNames || []).forEach(a => {
            const val = window.prompt(`Valor para "${a}":`, `(ejemplo ${a})`);
            if (val !== null) args[a] = val;
        });

        // Find the preview container
        const containers = document.querySelectorAll('[id^="mcpPromptPreview-"]');
        let preview = null;
        containers.forEach(c => {
            const card = c.closest('.card');
            if (card && card.querySelector('strong')?.textContent.includes(name)) preview = c;
        });
        if (!preview) return;

        preview.style.display = '';
        preview.innerHTML = '<div class="spinner"></div> Renderizando...';
        try {
            const result = await api.mcpRenderPrompt(name, args);
            preview.innerHTML = `<div style="background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;font-size:11px;font-family:monospace;white-space:pre-wrap;max-height:300px;overflow-y:auto;">${esc(result.rendered || JSON.stringify(result, null, 2))}</div>`;
        } catch (e) {
            preview.innerHTML = `<div style="color:var(--danger);font-size:12px">âŒ ${e.message}</div>`;
        }
    },

    generateEmbed() {
        const baseUrl = location.origin;
        const tid = App.tenantId;
        const aid = App.agentId || 'default';
        const agentAttr = ` agent-id="${aid}"`;
        const agentParam = `&agent=${aid}`;
        document.getElementById('embedCodes').innerHTML = `
            <div class="embed-block"><div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:8px">Script Tag</div>
                <pre id="embedScript">&lt;script src="${baseUrl}/src/draga-chat.js"&gt;&lt;/script&gt;
&lt;draga-chat tenant-id="${tid}"${agentAttr} api-base="${baseUrl}/api/v2"&gt;&lt;/draga-chat&gt;</pre>
                <button class="btn btn-sm copy-btn" onclick="navigator.clipboard.writeText(document.getElementById('embedScript').textContent);toast('Copiado','success')">ğŸ“‹</button></div>
            <div class="embed-block"><div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:8px">iframe</div>
                <pre id="embedIframe">&lt;iframe src="${baseUrl}/demo-draga-chat.html?tenant=${tid}${agentParam}" style="position:fixed;bottom:20px;right:20px;width:400px;height:600px;border:none;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.2);z-index:9999"&gt;&lt;/iframe&gt;</pre>
                <button class="btn btn-sm copy-btn" onclick="navigator.clipboard.writeText(document.getElementById('embedIframe').textContent);toast('Copiado','success')">ğŸ“‹</button></div>`;
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WIDGET CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WidgetCfg = {
    config: null,

    async load() {
        try {
            this.config = await api.getWidgetConfig(App.tenantId, App.agentId);
            this.renderTheme();
            this.renderBranding();
            this.renderBehavior();
            this.renderPreview();
        } catch { document.getElementById('widgetThemeForm').innerHTML = '<div style="font-size:12px;color:var(--text-muted)">Widget config no disponible</div>'; }
    },

    renderTheme() {
        const t = this.config.theme || {};
        const fields = [['primary_color','Primario'],['background_color','Fondo'],['text_color','Texto'],['header_background','Header BG'],['header_text_color','Header Text'],['user_bubble_color','Burbuja User'],['bot_bubble_color','Burbuja Bot']];
        document.getElementById('widgetThemeForm').innerHTML = fields.map(([k,l]) =>
            `<div class="color-input-row"><input type="color" value="${t[k]||'#2563eb'}" id="wt_${k}" onchange="WidgetCfg.renderPreview()"><span style="font-size:11px">${l}</span></div>`
        ).join('');
    },

    renderBranding() {
        const b = this.config.branding || {};
        document.getElementById('widgetBrandingForm').innerHTML = `
            <div class="form-group"><label>TÃ­tulo</label><input type="text" value="${esc(b.title||'')}" id="wb_title" onchange="WidgetCfg.renderPreview()"></div>
            <div class="form-group"><label>SubtÃ­tulo</label><input type="text" value="${esc(b.subtitle||'')}" id="wb_subtitle"></div>
            <div class="form-group"><label>Placeholder</label><input type="text" value="${esc(b.placeholder_text||'')}" id="wb_placeholder_text"></div>
            <div class="form-group"><label>Mensaje Bienvenida</label><textarea id="wb_welcome_message">${esc(b.welcome_message||'')}</textarea></div>`;
    },

    renderBehavior() {
        const bh = this.config.behavior || {};
        document.getElementById('widgetBehaviorForm').innerHTML = `
            <div class="form-row">
                <div class="form-group"><label>PosiciÃ³n</label><select id="wbh_position"><option value="bottom-right" ${bh.position==='bottom-right'?'selected':''}>Abajo Derecha</option><option value="bottom-left" ${bh.position==='bottom-left'?'selected':''}>Abajo Izquierda</option></select></div>
                <div class="form-group"><label>Estado Inicial</label><select id="wbh_initial_state"><option value="closed" ${bh.initial_state==='closed'?'selected':''}>Cerrado</option><option value="open" ${bh.initial_state==='open'?'selected':''}>Abierto</option></select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Rate Limit/min</label><input type="number" value="${bh.rate_limit_per_minute||30}" id="wbh_rate_limit_per_minute" min="1"></div>
                <div class="form-group"><label>MÃ¡x mensaje</label><input type="number" value="${bh.max_message_length||2000}" id="wbh_max_message_length" min="100"></div>
            </div>`;
    },

    renderPreview() {
        const t = this.config?.theme || {};
        const b = this.config?.branding || {};
        const pc = document.getElementById('wt_primary_color')?.value || t.primary_color || '#2563eb';
        const bg = document.getElementById('wt_background_color')?.value || t.background_color || '#fff';
        const hbg = document.getElementById('wt_header_background')?.value || t.header_background || '#2563eb';
        const htc = document.getElementById('wt_header_text_color')?.value || t.header_text_color || '#fff';
        const title = document.getElementById('wb_title')?.value || b.title || 'Chat';
        document.getElementById('widgetPreview').innerHTML = `
            <div style="width:280px;margin:0 auto;border-radius:12px;overflow:hidden;box-shadow:0 4px 24px rgba(0,0,0,0.2);border:1px solid #e5e7eb;">
                <div style="background:${hbg};color:${htc};padding:12px 16px;font-weight:700;font-size:14px">ğŸ’¬ ${esc(title)}</div>
                <div style="background:${bg};padding:14px;min-height:120px">
                    <div style="background:#f3f4f6;padding:8px 12px;border-radius:10px;font-size:12px;max-width:80%;margin-bottom:8px;color:#333">Â¡Hola! Â¿En quÃ© puedo ayudarte?</div>
                    <div style="background:${pc};color:#fff;padding:8px 12px;border-radius:10px;font-size:12px;max-width:80%;margin-left:auto;text-align:right">Â¿CuÃ¡les son las tarifas?</div>
                </div>
                <div style="padding:10px;border-top:1px solid #e5e7eb;background:${bg};display:flex;gap:6px">
                    <input style="flex:1;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px;font-size:11px" placeholder="Escribe..." disabled>
                    <button style="background:${pc};color:#fff;border:none;border-radius:8px;padding:6px 12px;font-size:11px;cursor:pointer">â–¶</button>
                </div>
            </div>`;
    },

    async save() {
        const theme = {};
        ['primary_color','background_color','text_color','header_background','header_text_color','user_bubble_color','bot_bubble_color'].forEach(k => {
            const el = document.getElementById('wt_'+k); if (el) theme[k] = el.value;
        });
        const branding = {};
        ['title','subtitle','placeholder_text','welcome_message'].forEach(k => {
            const el = document.getElementById('wb_'+k); if (el) branding[k] = el.value;
        });
        const behavior = {
            position: document.getElementById('wbh_position')?.value || 'bottom-right',
            initial_state: document.getElementById('wbh_initial_state')?.value || 'closed',
            rate_limit_per_minute: parseInt(document.getElementById('wbh_rate_limit_per_minute')?.value) || 30,
            max_message_length: parseInt(document.getElementById('wbh_max_message_length')?.value) || 2000,
        };
        try {
            await api.updateWidgetConfig(App.tenantId, { theme, branding, behavior }, App.agentId);
            toast('Widget guardado', 'success');
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    },

    async reset() {
        showConfirm('Reset Widget', 'Restaurar configuraciÃ³n del widget a defaults.', async () => {
            try { await api.resetWidgetConfig(App.tenantId, App.agentId); toast('Widget reseteado', 'success'); this.load(); }
            catch (e) { toast('Error: ' + e.message, 'error'); }
        });
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TASKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TasksMod = {
    async refresh() {
        const container = document.getElementById('taskTable');
        const state = document.getElementById('taskStateFilter')?.value || null;
        try {
            const res = await api.listTasks(App.tenantId, state, null, App.agentId);
            const tasks = res.tasks || res || [];
            if (!tasks.length) { container.innerHTML = '<div class="empty-state"><p>No hay tareas</p></div>'; return; }
            container.innerHTML = `<div style="overflow-x:auto"><table><thead><tr><th>ID</th><th>Estado</th><th>Progreso</th><th>Archivos</th><th>Resultado</th><th>Tiempo</th></tr></thead>
                <tbody>${tasks.map(t => {
                    const pct = t.progress_pct ?? t.progress ?? null;
                    const fileInfo = t.total_files ? `${t.processed_files||0}/${t.total_files}` : 'â€”';
                    const resultInfo = [];
                    if (t.successful != null) resultInfo.push(`âœ…${t.successful}`);
                    if (t.failed != null && t.failed > 0) resultInfo.push(`âŒ${t.failed}`);
                    if (t.chunks_created != null) resultInfo.push(`ğŸ“¦${t.chunks_created}`);
                    const elapsed = t.elapsed_seconds != null ? t.elapsed_seconds.toFixed(1) + 's' : 'â€”';
                    return `<tr>
                        <td style="font-size:10px;color:var(--text-muted)">${(t.task_id||t.id||'').slice(0,12)}â€¦</td>
                        <td>${statusBadge(t.state || t.status)}</td>
                        <td>${pct != null ? `<div style="display:flex;align-items:center;gap:4px"><div class="progress-bar" style="flex:1;height:6px"><div class="fill" style="width:${pct}%"></div></div><span style="font-size:10px">${Math.round(pct)}%</span></div>` : 'â€”'}</td>
                        <td style="font-size:11px">${fileInfo}</td>
                        <td style="font-size:10px">${resultInfo.join(' ') || 'â€”'}</td>
                        <td style="font-size:10px;color:var(--text-muted)">${elapsed}</td>
                    </tr>`;
                }).join('')}</tbody></table></div>`;
        } catch (e) { container.innerHTML = `<div style="color:var(--danger);font-size:12px">âŒ ${e.message}</div>`; }
    },

    async cleanup() {
        showConfirm('Limpiar Tareas', 'Eliminar tareas completadas/fallidas.', async () => {
            try { await api.cleanupTasks(App.tenantId, App.agentId); toast('Tareas limpiadas', 'success'); this.refresh(); }
            catch (e) { toast('Error: ' + e.message, 'error'); }
        });
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>

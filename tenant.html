<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRAGA ‚Äî Tenant Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M8 68 Q8 60 18 56 H74 Q84 56 86 68 Z' fill='%237c3aed'/><rect x='20' y='42' width='24' height='14' rx='4' fill='%23a78bfa'/><rect x='24' y='46' width='7' height='7' rx='2' fill='%23312e81'/><rect x='33' y='46' width='7' height='7' rx='2' fill='%23312e81'/><path d='M54 54 L54 26 L80 48' stroke='%23c4b5fd' stroke-width='5' stroke-linecap='round' stroke-linejoin='round' fill='none'/><path d='M76 44 L86 44 L84 54 L78 54 Z' fill='%23fbbf24'/><rect x='28' y='32' width='8' height='10' rx='2' fill='%236d28d9'/><circle cx='32' cy='28' r='4' fill='%23c4b5fd' opacity='.5'/><circle cx='37' cy='23' r='3' fill='%23c4b5fd' opacity='.3'/><path d='M2 78 Q14 72 26 78 Q38 84 50 78 Q62 72 74 78 Q86 84 98 78' fill='none' stroke='%23818cf8' stroke-width='3' stroke-linecap='round'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="src/auth.js"></script>
    <script src="src/api-client.js"></script>
    <style>
/* ‚ïê‚ïê‚ïê DESIGN TOKENS ‚ïê‚ïê‚ïê */
:root {
    --draga-accent:#7c3aed;--draga-accent-light:#a78bfa;--draga-accent-alpha:rgba(124,58,237,0.15);
    --draga-gradient:linear-gradient(135deg,#7c3aed 0%,#4f46e5 50%,#2563eb 100%);
    --draga-glow:0 0 40px rgba(124,58,237,0.25);
    --success:#22c55e;--danger:#ef4444;--warning:#f59e0b;--info:#3b82f6;
    --bg-dark:#0c0f1a;--bg-main:#131a2b;--bg-card:#1a2236;--bg-card-hover:#212b42;--bg-input:#242e44;
    --text-primary:#f0f2f5;--text-secondary:#94a3b8;--text-muted:#64748b;
    --border:#243049;--border-light:#334155;
    --shadow:0 4px 24px rgba(0,0,0,0.35);
    --radius:12px;--radius-sm:8px;--radius-lg:16px;--transition:0.25s ease;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Lato',-apple-system,sans-serif;background:var(--bg-dark);color:var(--text-primary);min-height:100vh;overflow-x:hidden;}

/* ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê */
.app{display:grid;grid-template-columns:220px 1fr;grid-template-rows:56px 1fr;height:100vh;}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.header{grid-column:1/-1;background:var(--bg-main);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;z-index:100;}
.header-brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit;}
.header-brand .logo{width:32px;height:32px;background:var(--draga-gradient);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:var(--draga-glow);}
.header-brand .name{font-size:18px;font-weight:900;background:var(--draga-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px;}
.header-brand .subtitle{font-size:10px;color:var(--text-muted);margin-top:-2px;}
.header-right{display:flex;align-items:center;gap:14px;}
.header-breadcrumb{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text-muted);}
.header-breadcrumb a{color:var(--draga-accent-light);text-decoration:none;}
.header-breadcrumb a:hover{text-decoration:underline;}
.header-breadcrumb .sep{color:var(--text-muted);}
.header-breadcrumb .current{color:var(--text-primary);font-weight:700;}
.health-pill{display:flex;align-items:center;gap:6px;padding:5px 14px;border-radius:20px;font-size:11px;font-weight:700;}
.health-pill.online{background:rgba(34,197,94,0.1);color:var(--success);}
.health-pill.offline{background:rgba(239,68,68,0.1);color:var(--danger);}
.health-dot{width:7px;height:7px;border-radius:50%;background:currentColor;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.di{display:inline-block;width:1em;height:1em;vertical-align:-0.15em;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M8 68 Q8 60 18 56 H74 Q84 56 86 68 Z' fill='%237c3aed'/%3E%3Crect x='20' y='42' width='24' height='14' rx='4' fill='%23a78bfa'/%3E%3Crect x='24' y='46' width='7' height='7' rx='2' fill='%23312e81'/%3E%3Crect x='33' y='46' width='7' height='7' rx='2' fill='%23312e81'/%3E%3Cpath d='M54 54 L54 26 L80 48' stroke='%23c4b5fd' stroke-width='5' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M76 44 L86 44 L84 54 L78 54 Z' fill='%23fbbf24'/%3E%3Crect x='28' y='32' width='8' height='10' rx='2' fill='%236d28d9'/%3E%3Ccircle cx='32' cy='28' r='4' fill='%23c4b5fd' opacity='.5'/%3E%3Ccircle cx='37' cy='23' r='3' fill='%23c4b5fd' opacity='.3'/%3E%3Cpath d='M2 78 Q14 72 26 78 Q38 84 50 78 Q62 72 74 78 Q86 84 98 78' fill='none' stroke='%23818cf8' stroke-width='3' stroke-linecap='round'/%3E%3C/svg%3E") center/contain no-repeat;font-style:normal;}

/* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
.sidebar{background:var(--bg-main);border-right:1px solid var(--border);padding:16px 0;overflow-y:auto;}
.sidebar-section{padding:0 16px;margin-bottom:20px;}
.sidebar-label{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);font-weight:700;margin-bottom:8px;padding:0 8px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 16px;border-radius:var(--radius-sm);cursor:pointer;font-size:13px;font-weight:600;color:var(--text-secondary);transition:var(--transition);text-decoration:none;margin-bottom:2px;}
.nav-item:hover{background:var(--bg-card-hover);color:var(--text-primary);}
.nav-item.active{background:var(--draga-accent-alpha);color:var(--draga-accent-light);}
.nav-item .icon{font-size:18px;width:24px;text-align:center;}
.nav-item .badge{margin-left:auto;background:var(--draga-accent-alpha);color:var(--draga-accent-light);padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;}

/* ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê */
.main{overflow-y:auto;padding:24px 32px;background:var(--bg-dark);}
.module{display:none;}
.module.active{display:block;}
.page-title{font-size:24px;font-weight:900;margin-bottom:6px;}
.page-desc{font-size:13px;color:var(--text-muted);margin-bottom:24px;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;margin-bottom:24px;}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:var(--transition);}
.stat-card:hover{border-color:var(--draga-accent);box-shadow:var(--draga-glow);}
.stat-card .label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:6px;}
.stat-card .value{font-size:28px;font-weight:900;}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;}
.section{margin-bottom:32px;}
.section-title{font-size:16px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.section-title .icon{font-size:20px;}

/* ‚ïê‚ïê‚ïê DRAGA CARDS ‚ïê‚ïê‚ïê */
.draga-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px;margin-bottom:24px;}
.draga-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;transition:var(--transition);position:relative;overflow:hidden;cursor:pointer;text-decoration:none;color:inherit;display:block;}
.draga-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--draga-gradient);}
.draga-card:hover{border-color:var(--draga-accent);transform:translateY(-2px);box-shadow:var(--draga-glow);}
.draga-card .dc-name{font-size:17px;font-weight:900;margin-bottom:4px;display:flex;align-items:center;gap:8px;}
.draga-card .dc-id{font-size:11px;color:var(--text-muted);font-family:monospace;margin-bottom:12px;}
.draga-card .dc-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;}
.dc-stat{text-align:center;padding:8px 4px;background:var(--bg-input);border-radius:var(--radius-sm);font-size:10px;color:var(--text-muted);}
.dc-stat .num{font-size:18px;font-weight:900;color:var(--text-primary);display:block;margin-bottom:2px;}
.draga-card .dc-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;}

/* ‚ïê‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê */
.search-section{margin-bottom:24px;}
.search-box{display:flex;gap:10px;}
.search-box input{flex:1;padding:12px 16px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:14px;font-family:inherit;}
.search-box input:focus{outline:none;border-color:var(--draga-accent);}
.search-box button{padding:12px 24px;}
.search-scope{font-size:11px;color:var(--text-muted);margin-top:8px;display:flex;align-items:center;gap:6px;}
.search-results{margin-top:16px;}
.search-result-item{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;margin-bottom:10px;}
.search-result-item:hover{border-color:var(--border-light);}
.sr-query{font-size:11px;color:var(--text-muted);margin-bottom:6px;}
.sr-answer{font-size:13px;color:var(--text-secondary);margin-bottom:8px;line-height:1.6;}
.sr-meta{display:flex;gap:12px;font-size:10px;color:var(--text-muted);flex-wrap:wrap;}

/* ‚ïê‚ïê‚ïê BUTTONS ‚ïê‚ïê‚ïê */
.btn{padding:8px 16px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);font-size:12px;font-weight:600;cursor:pointer;transition:var(--transition);font-family:inherit;text-decoration:none;display:inline-flex;align-items:center;gap:6px;}
.btn:hover{border-color:var(--draga-accent);color:var(--text-primary);}
.btn-primary{background:var(--draga-gradient);color:#fff;border-color:transparent;}
.btn-primary:hover{opacity:0.9;border-color:transparent;}
.btn-danger{background:rgba(239,68,68,0.1);color:var(--danger);border-color:rgba(239,68,68,0.3);}
.btn-sm{padding:5px 12px;font-size:11px;}
table{width:100%;border-collapse:collapse;font-size:13px;}
th{text-align:left;padding:10px 12px;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);border-bottom:1px solid var(--border);font-weight:700;}
td{padding:10px 12px;border-bottom:1px solid rgba(36,48,73,0.5);}
.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:10px;font-size:10px;font-weight:700;text-transform:uppercase;}
.badge-success{background:rgba(34,197,94,0.12);color:var(--success);}
.badge-danger{background:rgba(239,68,68,0.12);color:var(--danger);}
.badge-warning{background:rgba(245,158,11,0.12);color:var(--warning);}
.badge-info{background:rgba(59,130,246,0.12);color:var(--info);}
.badge-muted{background:rgba(100,116,139,0.12);color:var(--text-muted);}

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
.toast-container{position:fixed;top:64px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px;}
.toast{padding:10px 18px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;animation:slideIn .3s ease;max-width:360px;}
.toast-error{background:#991b1b;color:#fecaca;}
.toast-info{background:#1e3a5f;color:#93c5fd;}
.toast-success{background:#166534;color:#bbf7d0;}
.toast-warning{background:#78350f;color:#fde68a;}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* ‚ïê‚ïê‚ïê LOADING & EMPTY ‚ïê‚ïê‚ïê */
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--draga-accent);border-radius:50%;animation:spin .6s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading{text-align:center;padding:40px;color:var(--text-muted);}
.empty-state{text-align:center;padding:48px 20px;color:var(--text-muted);}
.empty-state .icon{font-size:48px;margin-bottom:12px;}
.empty-state h3{font-size:16px;margin-bottom:6px;color:var(--text-secondary);}
.empty-state p{font-size:13px;}

/* ‚ïê‚ïê‚ïê CONFIG CARD ‚ïê‚ïê‚ïê */
.config-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;}
.config-item{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;}
.config-item .ci-label{font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:4px;}
.config-item .ci-value{font-size:14px;font-weight:700;word-break:break-all;}

/* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
@media(max-width:900px){
    .app{grid-template-columns:1fr;grid-template-rows:56px 48px 1fr;}
    .sidebar{overflow-x:auto;display:flex;flex-direction:row;padding:0 12px;gap:4px;align-items:center;border-right:none;border-bottom:1px solid var(--border);}
    .sidebar-section{display:flex;gap:4px;margin:0;padding:0;}
    .sidebar-label{display:none;}
    .nav-item{white-space:nowrap;padding:8px 12px;}
    .main{padding:16px;}
    .draga-grid{grid-template-columns:1fr;}
}
    </style>
</head>
<body>

<div class="app">

<!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
<header class="header">
    <div style="display:flex;align-items:center;gap:16px;">
        <a href="index.html" class="header-brand">
            <div class="logo"><i class="di" style="font-size:18px;width:18px;height:18px"></i></div>
            <div><div class="name">DRAGA</div><div class="subtitle">Tenant Dashboard</div></div>
        </a>
        <div class="header-breadcrumb">
            <a href="admin.html">üèóÔ∏è Plataforma</a>
            <span class="sep">‚Ä∫</span>
            <span class="current" id="breadcrumbTenant">Tenant</span>
        </div>
    </div>
    <div class="header-right">
        <select id="tenantSelect" onchange="TenantApp.switchTenant(this.value)" style="padding:6px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:12px;"></select>
        <div class="health-pill online" id="healthPill">
            <div class="health-dot"></div>
            <span id="healthText">checking...</span>
        </div>
        <a href="admin.html" class="btn btn-sm">üèóÔ∏è Plataforma</a>
        <a href="index.html" class="btn btn-sm">üè† Home</a>
    </div>
</header>

<!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
<nav class="sidebar">
    <div class="sidebar-section">
        <div class="sidebar-label">Tenant</div>
        <a class="nav-item active" onclick="TenantApp.nav('overview')" data-mod="overview">
            <span class="icon">üìä</span> Overview
        </a>
        <a class="nav-item" onclick="TenantApp.nav('dragas')" data-mod="dragas">
            <span class="icon"><i class="di"></i></span> DRAGAs
            <span class="badge" id="navDragaCount">‚Äî</span>
        </a>
        <a class="nav-item" onclick="TenantApp.nav('analytics')" data-mod="analytics">
            <span class="icon">üìà</span> Analytics
        </a>
        <a class="nav-item" onclick="TenantApp.nav('search')" data-mod="search">
            <span class="icon">üîç</span> Buscar
        </a>
        <a class="nav-item" onclick="TenantApp.nav('config')" data-mod="config">
            <span class="icon">üîß</span> Configuraci√≥n
        </a>
    </div>
</nav>

<!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
<main class="main">

<!-- ‚îÄ‚îÄ MODULE: OVERVIEW ‚îÄ‚îÄ -->
<div class="module active" id="mod-overview">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div>
            <h1 class="page-title" id="overviewTitle">üè¢ Tenant Dashboard</h1>
            <p class="page-desc" id="overviewDesc">Vista a nivel de tenant: m√©tricas agregadas y acceso a cada DRAGA</p>
        </div>
        <div style="display:flex;gap:8px;">
            <button class="btn btn-primary" onclick="TenantApp.nav('dragas')"><i class="di" style="width:14px;height:14px;vertical-align:middle"></i> Ver DRAGAs</button>
            <button class="btn btn-sm" style="border-color:var(--success);color:var(--success)" onclick="TenantApp.openCreateDragaModal()">Ôºã Nueva DRAGA</button>
        </div>
    </div>

    <div class="stats-grid" id="overviewStats">
        <div class="stat-card"><div class="label">DRAGAs</div><div class="value" id="statDragas">‚Äî</div></div>
        <div class="stat-card"><div class="label">Documentos (Total)</div><div class="value" id="statDocs">‚Äî</div></div>
        <div class="stat-card"><div class="label">Chunks (Total)</div><div class="value" id="statChunks">‚Äî</div></div>
        <div class="stat-card"><div class="label">Modelo</div><div class="value" style="font-size:14px" id="statModel">‚Äî</div></div>
        <div class="stat-card"><div class="label">Idioma</div><div class="value" id="statLang">‚Äî</div></div>
        <div class="stat-card"><div class="label">Estado</div><div class="value" id="statStatus">‚Äî</div></div>
    </div>

    <!-- Quick DRAGA overview -->
    <div class="section">
        <div class="section-title"><span class="icon"><i class="di"></i></span> DRAGAs de este Tenant</div>
        <p style="font-size:12px;color:var(--text-muted);margin:-10px 0 16px;">Cada DRAGA tiene su propia base de conocimientos aislada. Seleccion√° una para acceder a sus documentos.</p>
        <div class="draga-grid" id="overviewDragaGrid">
            <div class="loading"><div class="spinner"></div> Cargando DRAGAs...</div>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ MODULE: DRAGAS ‚îÄ‚îÄ -->
<div class="module" id="mod-dragas">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div>
            <h1 class="page-title"><i class="di" style="width:24px;height:24px;vertical-align:-3px"></i> DRAGAs del Tenant</h1>
            <p class="page-desc" id="dragasDesc">Cada DRAGA tiene su propia Knowledge Base. Seleccion√° una para gestionar sus documentos.</p>
        </div>
        <div>
            <button class="btn btn-primary" onclick="TenantApp.openCreateDragaModal()">Ôºã Nueva DRAGA</button>
        </div>
    </div>
    <div class="draga-grid" id="dragasGrid">
        <div class="loading"><div class="spinner"></div> Cargando DRAGAs...</div>
    </div>
</div>

<!-- ‚îÄ‚îÄ MODULE: SEARCH ‚îÄ‚îÄ -->
<div class="module" id="mod-search">
    <h1 class="page-title">üîç B√∫squeda a nivel de Tenant</h1>
    <p class="page-desc">Busca en todas las bases de conocimiento de las DRAGAs de este tenant</p>

    <div class="search-section">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Escribe tu consulta..." onkeydown="if(event.key==='Enter')TenantSearch.run()">
            <select id="searchDragaFilter" style="padding:12px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:13px;min-width:160px;">
                <option value="__all__">üîç Todas las DRAGAs</option>
            </select>
            <button class="btn btn-primary" onclick="TenantSearch.run()">‚ñ∂ Buscar</button>
        </div>
        <div class="search-scope">
            <span>üìå Alcance:</span>
            <strong id="searchScopeLabel">Todas las KBs del tenant</strong>
        </div>
    </div>

    <div class="search-results" id="searchResults"></div>
</div>

<!-- ‚îÄ‚îÄ MODULE: ANALYTICS ‚îÄ‚îÄ -->
<div class="module" id="mod-analytics">
    <h1 class="page-title">üìà Analytics & Feedback</h1>
    <p class="page-desc">Salud del sistema, satisfacci√≥n de usuarios y m√©tricas agregadas del tenant <span style="font-size:11px;color:var(--text-muted)">(datos de referencia ‚Äî el detalle est√° a nivel de cada DRAGA)</span></p>

    <div class="section">
        <div class="section-title"><span class="icon">üè•</span> Estado de Servicios</div>
        <div class="stats-grid" id="tenantHealthGrid"></div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">üõ°Ô∏è</span> Calidad Agregada del Tenant</div>
        <div class="stats-grid" id="tenantQualityGrid" style="grid-template-columns:repeat(auto-fill,minmax(150px,1fr));">
            <div class="stat-card"><div class="label">Documentos</div><div class="value" id="tqDocs">‚Äî</div></div>
            <div class="stat-card"><div class="label">Chunks</div><div class="value" id="tqChunks">‚Äî</div></div>
            <div class="stat-card"><div class="label">Cobertura</div><div class="value" id="tqCoverage">‚Äî</div></div>
            <div class="stat-card"><div class="label">Grounding</div><div class="value" id="tqGrounding">‚Äî</div></div>
            <div class="stat-card"><div class="label">Confianza Avg</div><div class="value" id="tqConfidence">‚Äî</div></div>
            <div class="stat-card"><div class="label">Cache Hit</div><div class="value" id="tqCacheHit">‚Äî</div></div>
            <div class="stat-card"><div class="label">Feedback Total</div><div class="value" id="tqFeedback">‚Äî</div></div>
        </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
        <div class="section">
            <div class="section-title"><span class="icon">üí¨</span> Satisfacci√≥n</div>
            <div class="card" id="tenantSatisfactionPanel"><div class="loading"><div class="spinner"></div></div></div>
        </div>
        <div class="section">
            <div class="section-title"><span class="icon">üìä</span> Resumen del Tenant</div>
            <div class="card" id="tenantSummaryPanel"><div class="loading"><div class="spinner"></div></div></div>
        </div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">üìù</span> Feedback Reciente</div>
        <div class="card" style="overflow-x:auto;">
            <table>
                <thead><tr><th>Query</th><th>Rating</th><th>Confianza</th><th>Comentario</th><th>Revisado</th></tr></thead>
                <tbody id="tenantFeedbackBody"><tr><td colspan="5"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ MODULE: CONFIG ‚îÄ‚îÄ -->
<div class="module" id="mod-config">
    <h1 class="page-title">üîß Configuraci√≥n del Tenant</h1>
    <p class="page-desc">Datos del tenant y configuraci√≥n general</p>

    <div class="section">
        <div class="section-title"><span class="icon">üè¢</span> Informaci√≥n del Tenant</div>
        <div class="config-grid" id="tenantConfigGrid">
            <div class="loading"><div class="spinner"></div></div>
        </div>
    </div>

    <div class="section">
        <div class="section-title"><span class="icon">üîë</span> API Keys del Tenant</div>
        <div id="tenantApiKeys"><div class="loading"><div class="spinner"></div></div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê DANGER ZONE ‚ïê‚ïê‚ïê -->
    <div class="section" style="border:1px solid rgba(239,68,68,0.3);border-radius:var(--radius-lg);padding:20px;margin-top:24px;">
        <div class="section-title" style="color:var(--danger);"><span class="icon">‚ö†Ô∏è</span> Zona de Peligro</div>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap;">
            <div style="flex:1;min-width:200px;">
                <div style="font-size:14px;font-weight:700;color:var(--danger);">Eliminar Tenant <strong id="dangerTenantName"></strong></div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">Esto eliminar√° el tenant, <strong>todas sus DRAGAs</strong>, documentos, chunks y vectores. Borrado en cascada. Esta acci√≥n es irreversible.</div>
            </div>
            <button class="btn btn-danger" onclick="TenantApp.deleteTenant()" style="white-space:nowrap;">üóëÔ∏è Eliminar Tenant</button>
        </div>
    </div>
</div>

</main>
</div>

<!-- ‚ïê‚ïê‚ïê CREATE DRAGA MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="createDragaModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;display:none;align-items:center;justify-content:center;">
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:28px;max-width:520px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow);">
        <div style="font-size:18px;font-weight:900;margin-bottom:16px;"><i class="di" style="width:20px;height:20px;vertical-align:-2px"></i> Crear Nueva DRAGA</div>
        <div style="margin-bottom:14px;">
            <label style="display:block;font-size:12px;font-weight:700;color:var(--text-secondary);margin-bottom:6px;">ID de la DRAGA <span style="color:var(--danger)">*</span></label>
            <input type="text" id="newDragaId" placeholder="mi-agente" style="width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:13px;">
            <small style="color:var(--text-muted);font-size:11px">Identificador √∫nico. Solo letras min√∫sculas, n√∫meros y guiones.</small>
        </div>
        <div style="margin-bottom:14px;">
            <label style="display:block;font-size:12px;font-weight:700;color:var(--text-secondary);margin-bottom:6px;">Nombre</label>
            <input type="text" id="newDragaName" placeholder="Mi Asistente" style="width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:13px;">
        </div>
        <div style="margin-bottom:14px;">
            <label style="display:block;font-size:12px;font-weight:700;color:var(--text-secondary);margin-bottom:6px;">Descripci√≥n <span style="color:var(--text-muted);font-weight:400">(opcional)</span></label>
            <input type="text" id="newDragaDesc" placeholder="Asistente de soporte para..." style="width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:13px;">
        </div>
        <div id="createDragaResult" style="margin-bottom:12px;"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;">
            <button class="btn" onclick="TenantApp.closeCreateDragaModal()">Cancelar</button>
            <button class="btn btn-primary" id="createDragaBtn" onclick="TenantApp.createDraga()"><i class="di" style="width:12px;height:12px;vertical-align:-1px"></i> Crear DRAGA</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toasts"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TENANT DASHBOARD ‚Äî JavaScript
// Nivel 2: Vista de un tenant y sus DRAGAs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const MODULES = ['overview', 'dragas', 'analytics', 'search', 'config'];

function toast(msg, type = 'info', duration = 4000) {
    const el = document.createElement('div');
    el.className = 'toast toast-' + type;
    el.textContent = msg;
    document.getElementById('toasts').appendChild(el);
    setTimeout(() => el.remove(), duration);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN APP CONTROLLER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TenantApp = {
    tenantId: null,
    tenantData: null,
    tenants: [],
    agents: [],

    async init() {
        // Load all tenants
        try {
            const data = await api.listTenants(true);
            this.tenants = data.tenants || [];
        } catch { this.tenants = [{ tenant_id: 'default', name: 'Default' }]; }

        // Populate tenant selector
        const sel = document.getElementById('tenantSelect');
        sel.innerHTML = this.tenants.map(t =>
            `<option value="${t.tenant_id}">${t.name} (${t.tenant_id})</option>`
        ).join('');

        // Pick tenant from URL
        const params = new URLSearchParams(window.location.search);
        const urlTenant = params.get('tenant');
        const tenantExists = urlTenant && this.tenants.some(t => t.tenant_id === urlTenant);

        if (tenantExists) {
            this.tenantId = urlTenant;
        } else if (urlTenant) {
            toast(`El tenant "${urlTenant}" no existe. Se seleccion√≥ el primero disponible.`, 'warning');
            this.tenantId = this.tenants[0]?.tenant_id || 'default';
        } else {
            this.tenantId = this.tenants[0]?.tenant_id || 'default';
        }

        sel.value = this.tenantId;
        this.tenantData = this.tenants.find(t => t.tenant_id === this.tenantId) || { tenant_id: this.tenantId, name: this.tenantId };

        // Update breadcrumb
        document.getElementById('breadcrumbTenant').textContent = `üè¢ ${this.tenantData.name}`;

        // Load agents for this tenant
        await this.loadAgents();

        // Navigate from hash
        const hash = window.location.hash.replace('#', '') || 'overview';
        this.nav(hash);

        // Health check
        this.checkHealth();
        setInterval(() => this.checkHealth(), 30000);

        window.addEventListener('hashchange', () => {
            const h = window.location.hash.replace('#', '');
            if (MODULES.includes(h)) this.nav(h);
        });
    },

    async loadAgents() {
        try {
            const data = await api.listAgents(this.tenantId);
            this.agents = data.agents || data || [];
            if (!Array.isArray(this.agents)) this.agents = [];
        } catch {
            this.agents = [];
        }
        document.getElementById('navDragaCount').textContent = this.agents.length;

        // Populate search filter
        const filter = document.getElementById('searchDragaFilter');
        filter.innerHTML = '<option value="__all__">üîç Todas las DRAGAs</option>' +
            this.agents.map(a => `<option value="${a.agent_id}">${a.name || a.agent_id}</option>`).join('');
    },

    switchTenant(tid) {
        // Full page reload on level change (required by spec)
        window.location.href = `tenant.html?tenant=${tid}`;
    },

    nav(mod) {
        if (!MODULES.includes(mod)) mod = 'overview';
        MODULES.forEach(m => {
            document.getElementById('mod-' + m).classList.toggle('active', m === mod);
            document.querySelector(`[data-mod="${m}"]`)?.classList.toggle('active', m === mod);
        });
        window.location.hash = mod;

        const loaders = {
            overview: () => this.loadOverview(),
            dragas: () => this.loadDragas(),
            analytics: () => TenantAnalytics.load(),
            search: () => {},
            config: () => { this.loadConfig(); const dz = document.getElementById('dangerTenantName'); if (dz) dz.textContent = `"${this.tenantData?.name || this.tenantId}"`; },
        };
        loaders[mod]?.();
    },

    async loadOverview() {
        const t = this.tenantData;
        document.getElementById('overviewTitle').innerHTML = `üè¢ ${t.name}`;
        document.getElementById('overviewDesc').textContent = t.description || 'Vista a nivel de tenant: m√©tricas agregadas y acceso a cada DRAGA';

        // Stats
        document.getElementById('statDragas').textContent = this.agents.length;
        document.getElementById('statModel').textContent = (t.default_model || '‚Äî').split('/').pop();
        document.getElementById('statLang').textContent = t.response_language || '‚Äî';
        document.getElementById('statStatus').innerHTML = t.is_active !== false
            ? '<span style="color:var(--success)">‚úÖ Activo</span>'
            : '<span style="color:var(--danger)">‚õî Inactivo</span>';

        // Aggregate docs/chunks from per-agent documentStats (accurate per-DRAGA)
        let totalDocs = 0, totalChunks = 0;
        try {
            const perAgentStats = await Promise.all(
                this.agents.map(a => api.documentStats(this.tenantId, a.agent_id).catch(() => ({})))
            );
            perAgentStats.forEach(s => {
                totalDocs += s.total_documents || 0;
                totalChunks += s.total_chunks || 0;
            });
        } catch {}
        document.getElementById('statDocs').textContent = totalDocs;
        document.getElementById('statChunks').textContent = totalChunks;

        // DRAGA quick cards
        this._renderDragaCards('overviewDragaGrid');
    },

    async loadDragas() {
        this._renderDragaCards('dragasGrid');
    },

    async _renderDragaCards(containerId) {
        const grid = document.getElementById(containerId);
        if (this.agents.length === 0) {
            grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;">
                <div class="icon"><i class="di" style="font-size:48px;width:48px;height:48px"></i></div>
                <h3>Sin DRAGAs en este tenant</h3>
                <p>Crea tu primera DRAGA desde la <a href="admin.html" style="color:var(--draga-accent-light)">Plataforma</a></p>
            </div>`;
            return;
        }

        grid.innerHTML = '<div class="loading"><div class="spinner"></div> Cargando m√©tricas...</div>';

        // Fetch per-DRAGA stats ‚Äî documentStats is agent-scoped (accurate)
        const perAgentStats = await Promise.all(
            this.agents.map(a => api.documentStats(this.tenantId, a.agent_id).catch(() => ({})))
        );

        grid.innerHTML = this.agents.map((a, i) => {
            const s = perAgentStats[i] || {};
            const docs = s.total_documents || 0;
            const chunks = s.total_chunks || 0;
            const status = a.status || 'active';
            return `<div class="draga-card" onclick="window.location.href='draga.html?tenant=${this.tenantId}&agent=${a.agent_id}'">
                <div class="dc-name">
                    <i class="di" style="width:20px;height:20px"></i>
                    ${a.name || a.agent_id}
                    <span class="badge badge-success" style="font-size:9px;margin-left:8px;">${status}</span>
                </div>
                <div class="dc-id">ID: ${a.agent_id}</div>
                ${a.description ? `<div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">${a.description}</div>` : ''}
                <div class="dc-stats">
                    <div class="dc-stat"><span class="num">${docs}</span>Documentos</div>
                    <div class="dc-stat"><span class="num">${chunks}</span>Chunks</div>
                    <div class="dc-stat"><span class="num">${a.created_at ? new Date(a.created_at).toLocaleDateString('es') : '‚Äî'}</span>Creado</div>
                </div>
                <div class="dc-actions">
                    <a href="draga.html?tenant=${this.tenantId}&agent=${a.agent_id}" class="btn btn-primary btn-sm" onclick="event.stopPropagation()"><i class="di" style="width:12px;height:12px"></i> Dashboard</a>
                    <a href="draga.html?tenant=${this.tenantId}&agent=${a.agent_id}#knowledge" class="btn btn-sm" onclick="event.stopPropagation()">üìö KB</a>
                    <a href="draga.html?tenant=${this.tenantId}&agent=${a.agent_id}#chat" class="btn btn-sm" onclick="event.stopPropagation()">üí¨ Chat</a>
                    <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();TenantApp.deleteDraga('${a.agent_id}','${(a.name||'').replace(/'/g,"\\\'")}')" title="Eliminar DRAGA (cascada)">üóëÔ∏è</button>
                </div>
            </div>`;
        }).join('');
    },

    async loadConfig() {
        const grid = document.getElementById('tenantConfigGrid');
        const t = this.tenantData;

        grid.innerHTML = `
            <div class="config-item"><div class="ci-label">Tenant ID</div><div class="ci-value" style="font-family:monospace">${t.tenant_id}</div></div>
            <div class="config-item"><div class="ci-label">Nombre</div><div class="ci-value">${t.name}</div></div>
            <div class="config-item"><div class="ci-label">Descripci√≥n</div><div class="ci-value">${t.description || '‚Äî'}</div></div>
            <div class="config-item"><div class="ci-label">Modelo</div><div class="ci-value">${t.default_model || '‚Äî'}</div></div>
            <div class="config-item"><div class="ci-label">Idioma</div><div class="ci-value">${t.response_language || '‚Äî'}</div></div>
            <div class="config-item"><div class="ci-label">Estado</div><div class="ci-value">${t.is_active !== false ? '‚úÖ Activo' : '‚õî Inactivo'}</div></div>
            <div class="config-item"><div class="ci-label">DRAGAs</div><div class="ci-value">${this.agents.length}</div></div>
        `;

        // API Keys
        const keysDiv = document.getElementById('tenantApiKeys');
        try {
            const data = await api.listApiKeys();
            const keys = data.keys || [];
            if (keys.length === 0) {
                keysDiv.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:12px;">Sin API Keys para este tenant. Crea una desde la <a href="admin.html#apikeys" style="color:var(--draga-accent-light)">Plataforma</a>.</div>';
            } else {
                keysDiv.innerHTML = `<div style="overflow-x:auto;"><table style="width:100%;font-size:12px;">
                    <thead><tr><th>Label</th><th>Prefijo</th><th>Creada</th><th>Expira</th></tr></thead>
                    <tbody>${keys.map(k => `<tr>
                        <td><strong>${k.label || '‚Äî'}</strong></td>
                        <td><code style="font-size:11px">${k.key_prefix || '‚Äî'}</code></td>
                        <td>${k.created_at ? new Date(k.created_at).toLocaleDateString('es') : '‚Äî'}</td>
                        <td>${k.expires_at ? new Date(k.expires_at).toLocaleDateString('es') : 'Nunca'}</td>
                    </tr>`).join('')}</tbody></table></div>`;
            }
        } catch {
            keysDiv.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:12px;">No se pudieron cargar las API Keys.</div>';
        }
    },

    async checkHealth() {
        const pill = document.getElementById('healthPill');
        const text = document.getElementById('healthText');
        try {
            await api.health();
            pill.className = 'health-pill online';
            text.textContent = 'online';
        } catch {
            pill.className = 'health-pill offline';
            text.textContent = 'offline';
        }
    },

    openCreateDragaModal() {
        document.getElementById('createDragaModal').style.display = 'flex';
        document.getElementById('newDragaId').value = '';
        document.getElementById('newDragaName').value = '';
        document.getElementById('newDragaDesc').value = '';
        document.getElementById('createDragaResult').innerHTML = '';
        document.getElementById('newDragaId').focus();
    },

    closeCreateDragaModal() {
        document.getElementById('createDragaModal').style.display = 'none';
    },

    async createDraga() {
        const agentId = document.getElementById('newDragaId').value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');
        const name = document.getElementById('newDragaName').value.trim();
        const description = document.getElementById('newDragaDesc').value.trim();
        const resultDiv = document.getElementById('createDragaResult');

        if (!agentId) { toast('Introduce un ID para la DRAGA', 'warning'); return; }
        if (agentId.length < 2) { toast('El ID debe tener al menos 2 caracteres', 'warning'); return; }
        if (this.agents.some(a => a.agent_id === agentId)) {
            toast(`Ya existe una DRAGA con ID "${agentId}"`, 'error'); return;
        }

        const btn = document.getElementById('createDragaBtn');
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;display:inline-block"></div> Creando...';
        resultDiv.innerHTML = '';

        try {
            const data = {
                tenant_id: this.tenantId,
                agent_id: agentId,
                name: name || agentId,
                description: description || ''
            };
            await api.createAgent(data);
            toast(`‚úÖ DRAGA "${name || agentId}" creada correctamente`, 'success');

            // Reload agents list
            const agentsData = await api.listAgents(this.tenantId);
            this.agents = Array.isArray(agentsData) ? agentsData : (agentsData.agents || []);

            this._renderDragaCards('overviewDragaGrid');
            this._renderDragaCards('dragasGrid');
            document.getElementById('statDragas').textContent = this.agents.length;

            // Populate search DRAGA filter
            const sel = document.getElementById('searchDragaFilter');
            sel.innerHTML = '<option value="__all__">üîç Todas las DRAGAs</option>' +
                this.agents.map(a => `<option value="${a.agent_id}">${a.name || a.agent_id}</option>`).join('');

            this.closeCreateDragaModal();
        } catch (e) {
            resultDiv.innerHTML = `<div style="border-left:3px solid var(--danger);padding:10px 14px;background:var(--bg-input);border-radius:var(--radius-sm);color:var(--danger);font-size:13px;">‚ùå ${e.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="di" style="width:12px;height:12px;vertical-align:-1px"></i> Crear DRAGA';
        }
    },

    async deleteDraga(agentId, name) {
        if (!confirm(`¬øEliminar DRAGA "${name}" (${agentId})?\n\nEsto eliminar√° la DRAGA, sus documentos, chunks y vectores (cascada).`)) return;
        if (!confirm(`‚ò¢Ô∏è CONFIRMACI√ìN FINAL\n\nVas a eliminar la DRAGA "${name}".\nEsta acci√≥n es irreversible.\n\n¬øContinuar?`)) return;
        try {
            await api.deleteAgent(this.tenantId, agentId);
            toast(`DRAGA "${name}" eliminada`, 'success');
            this.agents = this.agents.filter(a => a.agent_id !== agentId);
            this._renderDragaCards('overviewDragaGrid');
            this._renderDragaCards('dragasGrid');
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    },

    async deleteTenant() {
        const name = this.tenantData?.name || this.tenantId;
        if (!confirm(`‚ö†Ô∏è ¬øEliminar tenant "${name}" (${this.tenantId})?\n\nEsto eliminar√° el tenant Y TODAS sus DRAGAs (${this.agents.length}), documentos, chunks y vectores.\nBorrado en cascada.`)) return;
        if (!confirm(`‚ò¢Ô∏è CONFIRMACI√ìN FINAL\n\nVas a eliminar:\n‚Ä¢ Tenant: ${name}\n‚Ä¢ ${this.agents.length} DRAGA(s)\n‚Ä¢ Todos los documentos y vectores\n\nEsta acci√≥n es IRREVERSIBLE.\n\n¬øContinuar?`)) return;
        try {
            await api.deleteTenant(this.tenantId, true);
            toast(`Tenant "${name}" y todas sus DRAGAs eliminados`, 'success');
            setTimeout(() => { window.location.href = 'admin.html'; }, 1500);
        } catch (e) { toast('Error: ' + e.message, 'error'); }
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TENANT-LEVEL ANALYTICS
// Health, quality metrics, satisfaction, feedback ‚Äî aggregated
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TenantAnalytics = {
    async load() {
        await Promise.all([this.loadHealth(), this.loadQuality(), this.loadSatisfaction(), this.loadSummary(), this.loadFeedbackList()]);
    },

    async loadHealth() {
        const grid = document.getElementById('tenantHealthGrid');
        const VECTOR_DBS = ['chromadb','chroma','qdrant','pgvector','milvus','weaviate','pinecone','faiss'];
        function serviceLabel(key) {
            const lower = key.toLowerCase();
            if (VECTOR_DBS.some(db => lower.includes(db))) return { role: 'üóÑÔ∏è Vector DB', impl: key };
            if (lower === 'redis' || lower.includes('cache'))  return { role: '‚ö° Cache', impl: key };
            if (lower.includes('embed'))   return { role: 'üî¢ Embeddings', impl: key };
            if (lower === 'llm' || lower.includes('model'))    return { role: 'üß† LLM', impl: key };
            return { role: key, impl: null };
        }
        try {
            const deep = await api.healthDeep();
            const status = deep.status || 'unknown';
            const checks = deep.checks || {};
            const sc = status === 'healthy' ? 'var(--success)' : status === 'degraded' ? 'var(--warning)' : 'var(--danger)';
            const si = status === 'healthy' ? '‚úÖ' : status === 'degraded' ? '‚ö†Ô∏è' : '‚ùå';

            let html = `<div class="stat-card" style="border-left:3px solid ${sc}">
                <div class="label">üß† DRAGA API</div>
                <div class="value" style="color:${sc};font-size:16px;">${si} ${status.charAt(0).toUpperCase() + status.slice(1)}</div></div>`;

            for (const [name, info] of Object.entries(checks)) {
                const ok = info.ok;
                const color = ok ? 'var(--success)' : 'var(--danger)';
                const icon = ok ? '‚úÖ' : '‚ùå';
                const latency = info.latency_ms != null ? `${info.latency_ms.toFixed(0)}ms` : '';
                const error = !ok && info.error ? `<div style="font-size:10px;color:var(--text-muted);margin-top:2px">${info.error}</div>` : '';
                const { role, impl } = serviceLabel(name);
                const implTag = impl ? `<div style="font-size:9px;color:var(--text-muted);font-family:monospace;margin-top:1px">${impl}</div>` : '';
                html += `<div class="stat-card" style="border-left:3px solid ${color}">
                    <div class="label">${role}</div>${implTag}
                    <div class="value" style="color:${color};font-size:14px;">${icon} ${ok ? 'OK' : 'Error'} ${latency ? '<span style="font-size:11px;color:var(--text-muted);font-weight:400">' + latency + '</span>' : ''}</div>${error}</div>`;
            }
            grid.innerHTML = html;
        } catch {
            grid.innerHTML = `<div class="stat-card" style="border-left:3px solid var(--danger)">
                <div class="label">üß† DRAGA API</div><div class="value" style="color:var(--danger);font-size:16px;">‚ùå Offline</div></div>`;
        }
    },

    async loadQuality() {
        const agents = TenantApp.agents;
        if (!agents.length) return;
        const tid = TenantApp.tenantId;

        try {
            // Parallel fetch: per-agent documentStats + grounding + coverage + feedback
            const [docStatsArr, groundingRes, coverageRes, fbRes] = await Promise.all([
                Promise.all(agents.map(a => api.documentStats(tid, a.agent_id).catch(() => ({})))),
                api.metricsGrounding(tid).catch(() => ({})),
                Promise.all(agents.map(a => api.metricsCoverage(tid, a.agent_id).catch(() => ({})))),
                api.feedbackStats(tid).catch(() => ({}))
            ]);

            // Aggregate docs & chunks from per-agent documentStats
            let totalDocs = 0, totalChunks = 0;
            docStatsArr.forEach(s => {
                totalDocs += s.total_documents || 0;
                totalChunks += s.total_chunks || 0;
            });
            document.getElementById('tqDocs').textContent = totalDocs || '‚Äî';
            document.getElementById('tqChunks').textContent = totalChunks || '‚Äî';

            // Coverage ‚Äî average across agents
            const covRates = coverageRes.filter(c => c.coverage_rate != null).map(c => c.coverage_rate);
            document.getElementById('tqCoverage').textContent = covRates.length
                ? (covRates.reduce((a, b) => a + b, 0) / covRates.length * 100).toFixed(0) + '%' : '‚Äî';

            // Grounding
            document.getElementById('tqGrounding').textContent = groundingRes.avg_grounding_rate != null
                ? (groundingRes.avg_grounding_rate * 100).toFixed(0) + '%'
                : groundingRes.grounding_rate != null ? (groundingRes.grounding_rate * 100).toFixed(0) + '%' : '‚Äî';
            document.getElementById('tqConfidence').textContent = groundingRes.avg_confidence != null
                ? (groundingRes.avg_confidence * 100).toFixed(0) + '%' : '‚Äî';
            document.getElementById('tqCacheHit').textContent = groundingRes.cache_hit_rate != null
                ? (groundingRes.cache_hit_rate * 100).toFixed(0) + '%' : '‚Äî';

            // Feedback
            document.getElementById('tqFeedback').textContent = fbRes.total_feedback ?? '‚Äî';
        } catch {
            // Silent ‚Äî reference metrics
        }
    },

    async loadSatisfaction() {
        const panel = document.getElementById('tenantSatisfactionPanel');
        try {
            const stats = await api.feedbackStats(TenantApp.tenantId);
            const posRate = stats.positive_rate || 0;
            panel.innerHTML = `
                <div style="margin-bottom:14px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px">
                        <span style="font-size:13px">Satisfacci√≥n</span>
                        <span style="font-size:13px;font-weight:700;color:${posRate >= 70 ? 'var(--success)' : posRate >= 40 ? 'var(--warning)' : 'var(--danger)'}">${posRate.toFixed(0)}%</span>
                    </div>
                    <div style="background:var(--bg-input);border-radius:6px;height:8px;overflow:hidden;">
                        <div style="height:100%;width:${posRate}%;background:${posRate >= 70 ? 'var(--success)' : posRate >= 40 ? 'var(--warning)' : 'var(--danger)'};border-radius:6px;transition:width 0.5s;"></div>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:12px">
                    <div>üëç Positivos: <strong>${stats.positive_count || 0}</strong></div>
                    <div>üëé Negativos: <strong>${stats.negative_count || 0}</strong></div>
                    <div>üìä Total: <strong>${stats.total_feedback || 0}</strong></div>
                    <div>üìã Sin revisar: <strong>${stats.unreviewed_count || 0}</strong></div>
                </div>`;
        } catch {
            panel.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text-muted)">
                <div style="font-size:24px;margin-bottom:8px">üìä</div>
                <div style="font-size:12px">Feedback service no disponible</div></div>`;
        }
    },

    async loadSummary() {
        const panel = document.getElementById('tenantSummaryPanel');
        try {
            const agents = TenantApp.agents;
            let totalDocs = 0, totalChunks = 0;
            const docStatsArr = await Promise.all(
                agents.map(a => api.documentStats(TenantApp.tenantId, a.agent_id).catch(() => ({})))
            );
            docStatsArr.forEach(s => {
                totalDocs += s.total_documents || 0;
                totalChunks += s.total_chunks || 0;
            });
            const items = [
                ['DRAGAs', agents.length],
                ['Documentos', totalDocs],
                ['Chunks', totalChunks],
                ['Modelo', (TenantApp.tenantData?.default_model || '‚Äî').split('/').pop()],
            ];
            panel.innerHTML = `<div style="font-size:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
                ${items.map(([k, v]) => `<div><span style="color:var(--text-muted)">${k}:</span> <strong>${v}</strong></div>`).join('')}
            </div>`;
        } catch {
            panel.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text-muted)">
                <div style="font-size:20px;margin-bottom:6px">üìä</div>
                <div style="font-size:12px">No disponible</div></div>`;
        }
    },

    async loadFeedbackList() {
        const tbody = document.getElementById('tenantFeedbackBody');
        try {
            // Fetch feedback across all DRAGAs of this tenant
            const allFeedback = [];
            const results = await Promise.all(
                TenantApp.agents.map(a =>
                    api.listFeedback({ limit: 10 }, TenantApp.tenantId, a.agent_id).catch(() => [])
                )
            );
            results.forEach(data => {
                const items = Array.isArray(data) ? data : (data.entries || data.feedback || data.items || []);
                allFeedback.push(...items);
            });

            // Sort by date desc, take top 20
            allFeedback.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
            const top = allFeedback.slice(0, 20);

            if (!top.length) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="icon">üìù</div><p>Sin feedback en este tenant</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = top.map(f => `<tr>
                <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${f.query || ''}">${f.query || '‚Äî'}</td>
                <td>${f.rating === 'positive' ? '<span class="badge badge-success">üëç</span>' : '<span class="badge badge-danger">üëé</span>'}</td>
                <td>${f.confidence != null ? (f.confidence * 100).toFixed(0) + '%' : '‚Äî'}</td>
                <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${f.comment || '‚Äî'}</td>
                <td>${f.reviewed ? '<span class="badge badge-success">‚úì</span>' : '<span class="badge badge-warning">pendiente</span>'}</td>
            </tr>`).join('');
        } catch {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text-muted)">Feedback service no disponible</td></tr>';
        }
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TENANT-LEVEL SEARCH
// Searches across all DRAGAs of this tenant
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TenantSearch = {
    async run() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) { toast('Escribe una consulta', 'warning'); return; }

        const filterVal = document.getElementById('searchDragaFilter').value;
        const container = document.getElementById('searchResults');
        container.innerHTML = '<div class="loading"><div class="spinner"></div> Buscando...</div>';

        // Update scope label
        if (filterVal === '__all__') {
            document.getElementById('searchScopeLabel').textContent = `Todas las KBs del tenant "${TenantApp.tenantData.name}"`;
        } else {
            const agent = TenantApp.agents.find(a => a.agent_id === filterVal);
            document.getElementById('searchScopeLabel').textContent = `Solo KB de DRAGA "${agent?.name || filterVal}"`;
        }

        try {
            const agentsToSearch = filterVal === '__all__'
                ? TenantApp.agents
                : TenantApp.agents.filter(a => a.agent_id === filterVal);

            if (agentsToSearch.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üîç</div><h3>Sin DRAGAs para buscar</h3></div>';
                return;
            }

            // Search each DRAGA in parallel
            const results = await Promise.all(
                agentsToSearch.map(a =>
                    api.query({
                        query,
                        tenant_id: TenantApp.tenantId,
                        agent_id: a.agent_id,
                        top_k: 5
                    }).then(r => ({ agent: a, result: r }))
                      .catch(e => ({ agent: a, error: e.message }))
                )
            );

            let html = '';
            let totalResults = 0;

            results.forEach(({ agent, result, error }) => {
                if (error) {
                    html += `<div class="search-result-item" style="border-left:3px solid var(--danger);">
                        <div class="sr-query"><i class="di" style="width:12px;height:12px"></i> <strong>${agent.name || agent.agent_id}</strong> ‚Äî Error</div>
                        <div class="sr-answer" style="color:var(--danger)">${error}</div>
                    </div>`;
                    return;
                }
                if (!result) return;

                totalResults++;
                const answer = result.answer || result.response || '‚Äî';
                const confidence = result.confidence != null ? `${(result.confidence * 100).toFixed(0)}%` : '‚Äî';
                const sources = result.sources || result.retrieved_chunks || [];
                const sourceList = sources.slice(0, 3).map(s =>
                    `<span style="background:var(--bg-input);padding:2px 6px;border-radius:4px;">${s.filename || s.document_id || '‚Äî'}</span>`
                ).join(' ');

                html += `<div class="search-result-item" style="border-left:3px solid var(--success);">
                    <div class="sr-query">
                        <i class="di" style="width:12px;height:12px"></i> <strong>${agent.name || agent.agent_id}</strong>
                        <span class="badge badge-info" style="margin-left:8px;">confianza: ${confidence}</span>
                    </div>
                    <div class="sr-answer">${answer}</div>
                    <div class="sr-meta">
                        ${sourceList ? '<span>üìÑ Fuentes: ' + sourceList + '</span>' : ''}
                        <a href="draga.html?tenant=${TenantApp.tenantId}&agent=${agent.agent_id}#chat" style="color:var(--draga-accent-light);text-decoration:none;">üí¨ Continuar en chat ‚Üí</a>
                    </div>
                </div>`;
            });

            if (totalResults === 0 && !html) {
                html = '<div class="empty-state"><div class="icon">üîç</div><h3>Sin resultados</h3><p>Intenta con otra consulta o verifica que las DRAGAs tengan documentos.</p></div>';
            }

            container.innerHTML = html;
        } catch (e) {
            container.innerHTML = `<div class="empty-state"><div class="icon">‚ùå</div><h3>Error</h3><p>${e.message}</p></div>`;
        }
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
{
    const _p = new URLSearchParams(window.location.search);
    const _tid = _p.get('tenant');
    if (AuthGuard.require({ requiredRole: Roles.DRAGA_USER, tenantId: _tid })) {
        TenantApp.init();
    }
}
</script>
</body>
</html>

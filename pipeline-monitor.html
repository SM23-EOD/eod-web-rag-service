<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRAGA Pipeline Monitor â€” 14 Steps</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš™ï¸</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="src/api-client.js"></script>
    <style>
:root {
    --draga-accent: #7c3aed; --draga-accent-light: #a78bfa;
    --draga-accent-alpha: rgba(124,58,237,0.15);
    --draga-gradient: linear-gradient(135deg, #7c3aed 0%, #4f46e5 50%, #2563eb 100%);
    --draga-glow: 0 0 40px rgba(124,58,237,0.25);
    --primary: #ec8951; --primary-alpha: rgba(236,137,81,0.15);
    --success: #22c55e; --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6;
    --bg-dark: #0c0f1a; --bg-main: #131a2b; --bg-card: #1a2236;
    --bg-card-hover: #212b42; --bg-input: #242e44;
    --text-primary: #f0f2f5; --text-secondary: #94a3b8; --text-muted: #64748b;
    --border: #243049; --border-light: #334155;
    --radius: 12px; --radius-sm: 8px; --radius-lg: 16px; --transition: 0.25s ease;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Lato',-apple-system,sans-serif; background:var(--bg-dark); color:var(--text-primary); min-height:100vh; }

.platform-header {
    background:var(--bg-main); border-bottom:1px solid var(--border);
    padding:0 32px; height:60px; display:flex; align-items:center;
    justify-content:space-between; position:sticky; top:0; z-index:100;
}
.header-brand { display:flex; align-items:center; gap:12px; }
.header-brand .logo { width:36px;height:36px;background:var(--draga-gradient);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:var(--draga-glow); }
.header-brand .name { font-size:20px;font-weight:900;background:var(--draga-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px; }
.header-brand .subtitle { font-size:11px;color:var(--text-muted);margin-top:-2px; }
.header-nav { display:flex;gap:4px; }
.header-nav a { padding:8px 16px;font-size:13px;font-weight:600;color:var(--text-secondary);text-decoration:none;border-radius:var(--radius-sm);transition:var(--transition); }
.header-nav a:hover,.header-nav a.active { color:var(--text-primary);background:var(--draga-accent-alpha); }
.header-nav a.active { color:var(--draga-accent-light); }

.breadcrumb { padding:10px 32px;font-size:12px;color:var(--text-muted);background:rgba(0,0,0,0.2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px; }
.breadcrumb a { color:var(--text-muted);text-decoration:none; }
.breadcrumb a:hover { color:var(--draga-accent-light); }
.breadcrumb .sep { opacity:0.4; }

.page { max-width:1100px; margin:0 auto; padding:32px; }
.section { margin-bottom:48px; }
.section-title { font-size:18px;font-weight:700;margin-bottom:20px;display:flex;align-items:center;gap:10px; }

/* â”€â”€ PIPELINE PHASES â”€â”€ */
.phase-header {
    display:flex; align-items:center; gap:12px;
    padding:14px 20px; margin-bottom:2px;
    border-radius:var(--radius) var(--radius) 0 0;
    font-size:14px; font-weight:700;
}
.phase-header .phase-icon { font-size:20px; }
.phase-header .phase-name { flex:1; }
.phase-header .phase-badge { font-size:11px; font-weight:700; padding:2px 10px; border-radius:10px; }

.phase-pre { background:rgba(59,130,246,0.1); color:var(--info); }
.phase-ret { background:rgba(245,158,11,0.1); color:var(--warning); }
.phase-post { background:rgba(34,197,94,0.1); color:var(--success); }
.phase-gen { background:rgba(239,68,68,0.1); color:var(--danger); }

/* â”€â”€ STEP CARDS â”€â”€ */
.step-list { display:flex; flex-direction:column; gap:2px; margin-bottom:24px; }

.step-card {
    background:var(--bg-card); border:1px solid var(--border);
    padding:20px 24px; display:grid;
    grid-template-columns: 40px 1fr 200px 120px;
    gap:16px; align-items:center;
    transition:var(--transition);
}

.step-card:first-child { border-radius:0 0 0 0; }
.step-card:last-child { border-radius:0 0 var(--radius) var(--radius); }

.step-card:hover { background:var(--bg-card-hover); border-color:var(--draga-accent); }

.step-num {
    width:36px; height:36px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-size:14px; font-weight:900; color:white;
}

.step-num.pre { background:rgba(59,130,246,0.3); color:var(--info); }
.step-num.ret { background:rgba(245,158,11,0.3); color:var(--warning); }
.step-num.post { background:rgba(34,197,94,0.3); color:var(--success); }
.step-num.gen { background:rgba(239,68,68,0.3); color:var(--danger); }

.step-info .step-name { font-size:15px; font-weight:700; margin-bottom:4px; }
.step-info .step-desc { font-size:12px; color:var(--text-muted); line-height:1.5; }

.step-agents { display:flex; gap:6px; flex-wrap:wrap; }
.step-agent-badge {
    padding:3px 10px; border-radius:8px; font-size:10px; font-weight:700;
    background:var(--draga-accent-alpha); color:var(--draga-accent-light);
    white-space:nowrap;
}

.step-status {
    text-align:right; font-size:12px; font-weight:600;
}

.step-status .status-active { color:var(--success); }
.step-status .status-flag { color:var(--warning); }
.step-status .status-roadmap { color:var(--text-muted); }

/* â”€â”€ CONNECTOR â”€â”€ */
.connector {
    display:flex; align-items:center; justify-content:center;
    padding:4px 0; color:var(--text-muted); font-size:14px;
}

/* â”€â”€ INVARIANTS â”€â”€ */
.invariants-grid {
    display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:16px;
}

.invariant-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:20px;
    border-left:3px solid;
}

.invariant-card .inv-num {
    font-size:11px; font-weight:700; text-transform:uppercase;
    letter-spacing:1px; margin-bottom:8px;
}
.invariant-card .inv-title { font-size:15px; font-weight:700; margin-bottom:6px; }
.invariant-card .inv-desc { font-size:12px; color:var(--text-muted); line-height:1.5; }

/* â”€â”€ DATA FLOW DIAGRAM â”€â”€ */
.data-flow {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius-lg); padding:32px;
    text-align:center;
}

.flow-row {
    display:flex; align-items:center; justify-content:center;
    gap:8px; margin-bottom:8px; flex-wrap:wrap;
}

.flow-box {
    padding:10px 18px; border-radius:var(--radius-sm);
    font-size:12px; font-weight:600;
    border:1px solid var(--border);
    background:var(--bg-input);
    min-width:120px;
}

.flow-arrow { color:var(--text-muted); font-size:18px; }
.flow-arrow.down { display:block; text-align:center; margin:4px 0; }

.flow-box.user { border-color:var(--info); color:var(--info); }
.flow-box.adapter { border-color:var(--draga-accent); color:var(--draga-accent-light); }
.flow-box.domain { border-color:var(--success); color:var(--success); background:rgba(34,197,94,0.08); }
.flow-box.output { border-color:var(--primary); color:var(--primary); }

/* â”€â”€ LIVE TEST â”€â”€ */
.live-test {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius-lg); padding:24px;
}

.test-input-row {
    display:flex; gap:12px; margin-bottom:20px;
}

.test-input {
    flex:1; padding:12px 16px; border-radius:var(--radius-sm);
    background:var(--bg-input); border:1px solid var(--border);
    color:var(--text-primary); font-family:inherit; font-size:14px;
    outline:none;
}
.test-input:focus { border-color:var(--draga-accent); }

.test-tenant {
    padding:12px 16px; border-radius:var(--radius-sm);
    background:var(--bg-input); border:1px solid var(--border);
    color:var(--text-primary); font-family:inherit; font-size:13px;
    cursor:pointer; outline:none;
}
.test-tenant option { background:var(--bg-card); }

.btn { padding:8px 18px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;font-family:inherit;border:1px solid var(--border);background:var(--bg-input);color:var(--text-primary);cursor:pointer;transition:var(--transition);text-decoration:none;display:inline-flex;align-items:center;gap:6px; }
.btn:hover { background:var(--bg-card-hover); }
.btn-primary { background:var(--draga-gradient);border:none;color:white; }
.btn-primary:hover { opacity:0.9;box-shadow:var(--draga-glow); }
.btn:disabled { opacity:0.5;cursor:not-allowed; }

.test-result {
    background:var(--bg-input); border:1px solid var(--border);
    border-radius:var(--radius-sm); padding:16px;
    font-size:13px; line-height:1.6; min-height:80px;
    display:none;
}

.test-result .result-answer { color:var(--text-primary); margin-bottom:12px; }
.test-result .result-meta { display:flex;gap:16px;flex-wrap:wrap;font-size:11px;color:var(--text-muted); }
.test-result .result-meta span { display:flex;align-items:center;gap:4px; }

.test-steps {
    margin-top:16px;
    display:none;
}

.test-steps-header {
    font-size:12px; font-weight:700; color:var(--text-muted);
    text-transform:uppercase; letter-spacing:1px;
    margin-bottom:8px;
}

.test-step-row {
    display:flex; align-items:center; gap:12px;
    padding:6px 12px; font-size:12px;
    border-bottom:1px solid var(--border);
}
.test-step-row:last-child { border-bottom:none; }
.test-step-row .ts-num { color:var(--draga-accent-light); font-weight:700; width:24px; }
.test-step-row .ts-name { flex:1; }
.test-step-row .ts-time { color:var(--text-muted); font-family:monospace; }
.test-step-row .ts-status { font-size:14px; }

.toast-container { position:fixed;top:72px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px; }
.toast { padding:12px 20px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;animation:slideIn .3s ease;max-width:400px; }
.toast-error { background:#991b1b;color:#fecaca; }
.toast-info { background:#1e3a5f;color:#93c5fd; }
.toast-success { background:#166534;color:#bbf7d0; }
@keyframes slideIn { from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1} }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

@media (max-width:900px) {
    .step-card { grid-template-columns:40px 1fr; }
    .step-agents,.step-status { display:none; }
}
    </style>
</head>
<body>

<header class="platform-header">
    <div class="header-brand">
        <div class="logo">ğŸ‰</div>
        <div><div class="name">DRAGA</div><div class="subtitle">Document Grounded RAG Agent</div></div>
    </div>
    <nav class="header-nav">
        <a href="platform.html">ğŸ  Console</a>
        <a href="draga-agents.html">ğŸ¤– Agents</a>
        <a href="pipeline-monitor.html" class="active">âš™ï¸ Pipeline</a>
        <a href="quality-dashboard.html">ğŸ›¡ï¸ Quality</a>
        <a href="roadmap.html">ğŸ—ºï¸ Roadmap</a>
        <a href="dashboard.html">ğŸ“Š Admin</a>
    </nav>
    <div style="width:100px"></div>
</header>

<nav class="breadcrumb">
    <a href="platform.html">ğŸ‰ DRAGA Platform</a><span class="sep">â€º</span>
    <span style="color:var(--text-secondary)">Pipeline Monitor</span>
</nav>

<div class="page">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â• DATA FLOW â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section">
        <div class="section-title"><span>ğŸ”„</span> Flujo de Datos</div>
        <div class="data-flow">
            <div class="flow-row">
                <div class="flow-box user">ğŸ‘¤ End User Query</div>
            </div>
            <div class="flow-arrow down">â†“</div>
            <div class="flow-row">
                <div class="flow-box adapter">ğŸŒ REST v2</div>
                <div class="flow-box adapter">ğŸ¤– OpenAI API</div>
                <div class="flow-box adapter">ğŸ”— MCP Server</div>
            </div>
            <div class="flow-arrow down">â†“</div>
            <div class="flow-row">
                <div class="flow-box domain">âš™ï¸ Orchestrator â€” 14 Step Pipeline</div>
            </div>
            <div class="flow-arrow down">â†“</div>
            <div class="flow-row">
                <div class="flow-box output">âœ… Respuesta verificada + confidence + sources + grounding rate</div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â• PIPELINE STEPS â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section">
        <div class="section-title"><span>âš™ï¸</span> Pipeline de 14 Pasos Composable</div>

        <!-- PRE-RETRIEVAL -->
        <div class="phase-header phase-pre">
            <span class="phase-icon">ğŸ”µ</span>
            <span class="phase-name">PRE-RETRIEVAL</span>
            <span class="phase-badge" style="background:rgba(59,130,246,0.2)">Steps 1â€“4</span>
        </div>
        <div class="step-list">
            <div class="step-card">
                <div class="step-num pre">01</div>
                <div class="step-info">
                    <div class="step-name">translate_query</div>
                    <div class="step-desc">Detecta idioma de la query, traduce si es cross-lingual al idioma de la KB</div>
                </div>
                <div class="step-agents"><span class="step-agent-badge">ğŸŒ Language Agent</span></div>
                <div class="step-status"><span class="status-active">â— Activo</span></div>
            </div>
            <div class="step-card">
                <div class="step-num pre">02</div>
                <div class="step-info">
                    <div class="step-name">enrich_from_feedback</div>
                    <div class="step-desc">Enriquece la query con feedback histÃ³rico de usuarios para mejorar retrieval</div>
                </div>
                <div class="step-agents"><span class="step-agent-badge">ğŸ’¬ Feedback Agent</span></div>
                <div class="step-status"><span class="status-active">â— Activo</span></div>
            </div>
            <div class="step-card">
                <div class="step-num pre">03</div>
                <div class="step-info">
                    <div class="step-name">normalize_query</div>
                    <div class="step-desc">Normaliza, corrige ortografÃ­a, elimina stopwords, limpia la query</div>
                </div>
                <div class="step-agents"></div>
                <div class="step-status"><span class="status-active">â— Activo</span></div>
            </div>
            <div class="step-card">
                <div class="step-num pre">04</div>
                <div class="step-info">
                    <div class="step-name">decompose_query</div>
                    <div class="step-desc">Descompone queries complejas en sub-queries para retrieval mÃ¡s preciso</div>
                </div>
                <div class="step-agents"></div>
                <div class="step-status"><span class="status-active">â— Activo</span></div>
            </div>
        </div>

        <div class="connector">â†“</div>

        <!-- RETRIEVAL -->
        <div class="phase-header phase-ret">
            <span class="phase-icon">ğŸŸ¡</span>
            <span class="phase-name">RETRIEVAL</span>
            <span class="phase-badge" style="background:rgba(245,158,11,0.2)">Steps 5â€“7</span>
        </div>
        <div class="step-list">
            <div class="step-card">
                <div class="step-num ret">05</div>
                <div class="step-info">
                    <div class="step-name">embed_query</div>
                    <div class="step-desc">Genera embedding vectorial de la query normalizada</div>
                </div>
                <div class="step-agents"><span class="step-agent-badge">ğŸ” Retrieval Agent</span></div>
                <div class="step-status"><span class="status-active">â— Activo</span></div>
            </div>
            <div class="step-card">
                <div class="step-num ret">06</div>
                <div class="step-info">
                    <div class="step-name">cache_lookup</div>
                    <div class="step-desc">Semantic cache â€” busca respuestas similares por similarity threshold</div>
                </div>
                <div class="step-agents"></div>
                <div class="step-status"><span class="status-active">â— Activo</span></div>
            </div>
            <div class="step-card">
                <div class="step-num ret">07</div>
                <div class="step-info">
                    <div class="step-name">retrieve_chunks</div>
                    <div class="step-desc">BÃºsqueda vectorial con adaptive top_k. Roadmap: + BM25 sparse (hybrid search)</div>
                </div>
                <div class="step-agents"><span class="step-agent-badge">ğŸ” Retrieval Agent</span></div>
                <div class="step-status"><span class="status-flag">âš‘ +Hybrid (S2)</span></div>
            </div>
        </div>

        <div class="connector">â†“</div>

        <!-- POST-RETRIEVAL -->
        <div class="phase-header phase-post">
            <span class="phase-icon">ğŸŸ¢</span>
            <span class="phase-name">POST-RETRIEVAL</span>
            <span class="phase-badge" style="background:rgba(34,197,94,0.2)">Steps 8â€“11</span>
        </div>
        <div class="step-list">
            <div class="step-card">
                <div class="step-num post">08</div>
                <div class="step-info">
                    <div class="step-name">deduplicate_chunks</div>
                    <div class="step-desc">DeduplicaciÃ³n por Jaccard similarity + diversificaciÃ³n de resultados</div>
                </div>
                <div class="step-agents"><span class="step-agent-badge">ğŸ” Retrieval Agent</span></div>
                <div class="step-status"><span class="status-active">â— Activo</span></div>
            </div>
            <div class="step-card">
                <div class="step-num post">09</div>
                <div class="step-info">
                    <div class="step-name">rerank_chunks</div>
                    <div class="step-desc">Cross-encoder reranking para reordenar chunks por relevancia semÃ¡ntica</div>
                </div>
                <div class="step-agents"><span class="step-agent-badge">ğŸ” Retrieval Agent</span></div>
                <div class="step-status"><span class="status-active">â— Activo</span></div>
            </div>
            <div class="step-card">
                <div class="step-num post">10</div>
                <div class="step-info">
                    <div class="step-name">evaluate_context</div>
                    <div class="step-desc">Self-RAG: evaluaciÃ³n de suficiencia del contexto recuperado antes de generar</div>
                </div>
                <div class="step-agents"><span class="step-agent-badge">ğŸ›¡ï¸ Grounding Agent</span></div>
                <div class="step-status"><span class="status-active">â— Activo</span></div>
            </div>
            <div class="step-card">
                <div class="step-num post">11</div>
                <div class="step-info">
                    <div class="step-name">record_gap</div>
                    <div class="step-desc">Logging de gaps en la Knowledge Base para mejora continua</div>
                </div>
                <div class="step-agents"><span class="step-agent-badge">ğŸ“Š Quality Agent</span></div>
                <div class="step-status"><span class="status-active">â— Activo</span></div>
            </div>
        </div>

        <div class="connector">â†“</div>

        <!-- GENERATION + VERIFICATION -->
        <div class="phase-header phase-gen">
            <span class="phase-icon">ğŸ”´</span>
            <span class="phase-name">GENERATION + VERIFICATION</span>
            <span class="phase-badge" style="background:rgba(239,68,68,0.2)">Steps 12â€“14</span>
        </div>
        <div class="step-list">
            <div class="step-card">
                <div class="step-num gen">12</div>
                <div class="step-info">
                    <div class="step-name">generate_response</div>
                    <div class="step-desc">GeneraciÃ³n con LLM (multi-provider via OpenRouter). Prompt Engineering v1.3.0 con 5 patrones defensivos</div>
                </div>
                <div class="step-agents"><span class="step-agent-badge">ğŸŒ Language Agent</span></div>
                <div class="step-status"><span class="status-active">â— Activo</span></div>
            </div>
            <div class="step-card">
                <div class="step-num gen">13</div>
                <div class="step-info">
                    <div class="step-name">verify_grounding</div>
                    <div class="step-desc">NLI hallucination detection + token overlap entre claims y chunks. El diferenciador central de DRAGA</div>
                </div>
                <div class="step-agents"><span class="step-agent-badge">ğŸ›¡ï¸ Grounding Agent</span></div>
                <div class="step-status"><span class="status-active">â— Activo</span></div>
            </div>
            <div class="step-card">
                <div class="step-num gen">14</div>
                <div class="step-info">
                    <div class="step-name">validate_response</div>
                    <div class="step-desc">ValidaciÃ³n final + cÃ¡lculo de mÃ©tricas (confidence, grounding rate) + cache store</div>
                </div>
                <div class="step-agents"><span class="step-agent-badge">ğŸ“Š Quality Agent</span></div>
                <div class="step-status"><span class="status-active">â— Activo</span></div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â• LIVE TEST â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section">
        <div class="section-title"><span>ğŸ§ª</span> Test en Vivo del Pipeline</div>
        <div class="live-test">
            <div class="test-input-row">
                <select class="test-tenant" id="testTenant"><option>Cargando...</option></select>
                <input class="test-input" id="testQuery" placeholder="Escribe una query para probar el pipeline..." />
                <button class="btn btn-primary" id="testBtn" onclick="runTest()">â–¶ Ejecutar</button>
            </div>
            <div class="test-result" id="testResult">
                <div class="result-answer" id="resultAnswer"></div>
                <div class="result-meta" id="resultMeta"></div>
            </div>
            <div class="test-steps" id="testSteps">
                <div class="test-steps-header">Pipeline Execution</div>
                <div id="stepsContainer"></div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â• INVARIANTS â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section">
        <div class="section-title"><span>ğŸ”’</span> Invariantes de Dominio</div>
        <div class="invariants-grid">
            <div class="invariant-card" style="border-left-color:var(--success)">
                <div class="inv-num" style="color:var(--success)">Invariante 1</div>
                <div class="inv-title">Grounding Absoluto</div>
                <div class="inv-desc">Un DRAGA nunca genera informaciÃ³n que no estÃ© en su KB. Si el contexto es insuficiente, deflecta. Sin excepciones.</div>
            </div>
            <div class="invariant-card" style="border-left-color:var(--danger)">
                <div class="inv-num" style="color:var(--danger)">Invariante 2</div>
                <div class="inv-title">Aislamiento de Tenant</div>
                <div class="inv-desc">Un tenant nunca accede a datos de otro tenant. Vector DB, cache, config, API keys, conversations: todo aislado.</div>
            </div>
            <div class="invariant-card" style="border-left-color:var(--info)">
                <div class="inv-num" style="color:var(--info)">Invariante 3</div>
                <div class="inv-title">Independencia de Infra</div>
                <div class="inv-desc">El domain layer tiene zero dependencias externas. Verificado con tests AST automatizados.</div>
            </div>
            <div class="invariant-card" style="border-left-color:var(--warning)">
                <div class="inv-num" style="color:var(--warning)">Invariante 4</div>
                <div class="inv-title">Verificabilidad</div>
                <div class="inv-desc">Toda respuesta incluye confidence score, grounding rate, sources, latency. Framework al 98% de cobertura.</div>
            </div>
            <div class="invariant-card" style="border-left-color:var(--draga-accent)">
                <div class="inv-num" style="color:var(--draga-accent-light)">Invariante 5</div>
                <div class="inv-title">Composabilidad del Pipeline</div>
                <div class="inv-desc">Cada paso es (PipelineContext) â†’ PipelineContext. Sustituible, desactivable, testeable en aislamiento.</div>
            </div>
            <div class="invariant-card" style="border-left-color:var(--primary)">
                <div class="inv-num" style="color:var(--primary)">Invariante 6</div>
                <div class="inv-title">Protocol Agnosticism</div>
                <div class="inv-desc">Un DRAGA es accesible por REST, OpenAI-compatible, y MCP con el mismo comportamiento.</div>
            </div>
        </div>
    </div>

</div>

<div class="toast-container" id="toastContainer"></div>

<script>
function toast(msg, type='info') {
    const el = document.createElement('div');
    el.className = `toast toast-${type}`;
    el.textContent = msg;
    document.getElementById('toastContainer').appendChild(el);
    setTimeout(() => { el.style.opacity='0'; setTimeout(()=>el.remove(),300); }, 4000);
}

// Load tenants for test
async function loadTenants() {
    try {
        const res = await api.listTenants(true);
        const tenants = res.tenants || [];
        const sel = document.getElementById('testTenant');
        sel.innerHTML = tenants.map(t =>
            `<option value="${t.tenant_id}">${t.name} (${t.tenant_id})</option>`
        ).join('');
    } catch(e) {
        toast('Error cargando tenants: ' + e.message, 'error');
    }
}

// Run test query through pipeline
async function runTest() {
    const query = document.getElementById('testQuery').value.trim();
    const tenantId = document.getElementById('testTenant').value;
    if (!query) { toast('Escribe una query', 'error'); return; }

    const btn = document.getElementById('testBtn');
    btn.disabled = true;
    btn.textContent = 'â³ Ejecutando...';

    const resultDiv = document.getElementById('testResult');
    const stepsDiv = document.getElementById('testSteps');
    resultDiv.style.display = 'block';
    stepsDiv.style.display = 'none';
    document.getElementById('resultAnswer').textContent = 'Procesando query por el pipeline de 14 pasos...';
    document.getElementById('resultMeta').innerHTML = '';

    try {
        const t0 = performance.now();
        const res = await api.query({
            question: query,
            tenant_id: tenantId,
            include_metadata: true
        });
        const elapsed = ((performance.now() - t0) / 1000).toFixed(2);

        const answer = res.answer || res.response || '(Sin respuesta)';
        document.getElementById('resultAnswer').textContent = answer;

        const confidence = res.confidence ?? res.metadata?.confidence ?? 'â€”';
        const grounding = res.grounding_rate ?? res.metadata?.grounding_rate ?? 'â€”';
        const sources = res.sources?.length ?? res.metadata?.source_count ?? 'â€”';
        const cached = res.cached ? 'âš¡ Cache' : 'ğŸ”„ Live';
        const model = res.model || res.metadata?.model || 'â€”';

        document.getElementById('resultMeta').innerHTML = `
            <span>ğŸ¯ Confidence: <strong>${typeof confidence === 'number' ? (confidence * 100).toFixed(0) + '%' : confidence}</strong></span>
            <span>ğŸ›¡ï¸ Grounding: <strong>${typeof grounding === 'number' ? (grounding * 100).toFixed(0) + '%' : grounding}</strong></span>
            <span>ğŸ“„ Sources: <strong>${sources}</strong></span>
            <span>â±ï¸ Latencia: <strong>${elapsed}s</strong></span>
            <span>${cached}</span>
            <span>ğŸ§  ${model}</span>
        `;

        // If we have pipeline step info, show it
        if (res.metadata?.pipeline_steps || res.pipeline_steps) {
            const steps = res.metadata?.pipeline_steps || res.pipeline_steps;
            stepsDiv.style.display = 'block';
            const container = document.getElementById('stepsContainer');
            container.innerHTML = steps.map((s, i) => `
                <div class="test-step-row">
                    <span class="ts-num">${String(i + 1).padStart(2, '0')}</span>
                    <span class="ts-name">${s.name || s.step}</span>
                    <span class="ts-time">${s.duration_ms ? s.duration_ms + 'ms' : 'â€”'}</span>
                    <span class="ts-status">${s.skipped ? 'â­ï¸' : 'âœ…'}</span>
                </div>
            `).join('');
        }

        toast('Pipeline executed successfully', 'success');
    } catch (e) {
        document.getElementById('resultAnswer').textContent = 'âŒ Error: ' + e.message;
        toast(e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'â–¶ Ejecutar';
    }
}

// Enter key
document.getElementById('testQuery').addEventListener('keypress', e => {
    if (e.key === 'Enter') runTest();
});

document.addEventListener('DOMContentLoaded', loadTenants);
</script>
</body>
</html>
